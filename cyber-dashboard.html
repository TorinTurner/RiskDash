<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUBFOR Cyber Risk Dashboard</title>
    <script src="libs/react.production.min.js"></script>
    <script src="libs/react-dom.production.min.js"></script>
    <script src="libs/babel.min.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    <script src="libs/tailwind.min.js"></script>
    <script src="libs/chart.min.js"></script>
    <style>
        /* Fonts - using system fonts for air-gapped access */
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f8fafc; min-height: 100vh; color: #1e293b; margin: 0; }
        .font-mono { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #e2e8f0; } ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .drag-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; background: #ffffff; border-radius: 8px; }
        .drag-zone:hover, .drag-zone.drag-active { border-color: #0891b2; background: #ecfeff; }
        .drag-zone.has-file { border-color: #10b981; background: #ecfdf5; }
        .risk-high { background: #fee2e2 !important; color: #991b1b !important; font-weight: bold; }
        .risk-med { background: #fef3c7 !important; color: #92400e !important; font-weight: bold; }
        .risk-low { background: #d1fae5 !important; color: #065f46 !important; }
        .alert-red { background: #fee2e2; } .alert-amber { background: #fef3c7; } .alert-blue { background: #dbeafe; }
        .tab-btn { position: relative; padding: 12px 24px; font-weight: 500; color: #64748b; transition: all 0.2s; background: none; border: none; cursor: pointer; }
        .tab-btn:hover { color: #0f172a; } .tab-btn.active { color: #0891b2; } .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #0891b2; }
        .btn-primary { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(8,145,178,0.3); } .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #475569; padding: 10px 20px; border-radius: 6px; font-weight: 500; border: none; cursor: pointer; } .btn-secondary:hover { background: #cbd5e1; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; }
        .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .data-table th { background: #f1f5f9; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 9px; letter-spacing: 0.3px; padding: 6px 4px; text-align: center; border: 1px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 5px 4px; text-align: center; border: 1px solid #e2e8f0; background: #ffffff; white-space: nowrap; }
        .data-table.settings-table { font-size: 14px; }
        .data-table.settings-table th { font-size: 12px; padding: 10px 12px; }
        .data-table.settings-table td { padding: 8px 12px; }
        .data-table.settings-table td.boat-name { font-size: 14px; }
        .data-table.hq-preview-table { font-size: 14px; }
        .data-table.hq-preview-table th { font-size: 12px; padding: 12px 16px; font-weight: 600; }
        .data-table.hq-preview-table td { padding: 10px 16px; font-size: 14px; }
        .table-scroll { overflow-x: auto; }
        .data-table td.boat-name { text-align: left; font-weight: 600; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; color: #0891b2; }
        .data-table .isic-header, .data-table .isic-cell { background: #1e293b; color: white; font-weight: 700; text-align: center; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); padding: 8px 4px; font-size: 9px; width: 28px; min-width: 28px; max-width: 28px; }
        .data-table .isic-first-row td { border-top: 2px solid #1e293b; }
        .col-ess-n { background: rgba(59,130,246,0.1) !important; } .col-ess-s { background: rgba(99,102,241,0.1) !important; }
        .col-vram-n { background: rgba(249,115,22,0.1) !important; } .col-vram-s { background: rgba(234,88,12,0.1) !important; }
        .col-ra { background: rgba(168,85,247,0.1) !important; } .col-tam { background: rgba(107,114,128,0.1) !important; } .col-status { background: rgba(16,185,129,0.1) !important; }
        input, select { background: #ffffff; border: 1px solid #cbd5e1; color: #1e293b; padding: 8px 12px; border-radius: 4px; }
        input:focus, select:focus { outline: none; border-color: #0891b2; box-shadow: 0 0 0 3px rgba(8,145,178,0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .overridden { box-shadow: inset 0 0 0 2px #7c3aed; }
        @media print { .no-print { display: none !important; } }
        @page { margin: 0.25in 0 0 0; size: landscape; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="application/json" id="app-settings">
{
    "_version": 1,
    "tycoms": ["CSL", "CSP"],
    "isics": [],
    "boats": [],
    "thresholds": {},
    "display": {},
    "user": {"default_name": ""}
}
</script>

<script type="text/babel">
// Utilities
const normalizeBoatName = (name) => { if (!name) return ''; const upper = name.toUpperCase().trim(); const match = upper.match(/\b(SSN|SSBN|SSGN|AS)\s*[-]?\s*(\d+)\b/); return match ? `${match[1]}-${match[2]}` : upper; };
const parseNumber = (val) => {
    if (val === null || val === undefined || val === '') return null;
    if (typeof val === 'number') return val;
    const strVal = String(val).trim().toLowerCase();
    // Handle 'None' as 0
    if (strVal === 'none') return 0;
    const num = parseFloat(strVal.replace(/[%,]/g, ''));
    return isNaN(num) ? null : num;
};
const parsePercent = (val) => {
    if (val === null || val === undefined || val === '') return null;
    const strVal = String(val).trim().toLowerCase();
    // Handle 'None' as 0
    if (strVal === 'none') return 0;
    const num = parseFloat(strVal.replace('%', ''));
    return isNaN(num) ? null : num;
};

// Helper to find header row in first 5 rows of sheet
const findHeaderRow = (wb, sheetName, columnMap) => {
    const sheet = wb.Sheets[sheetName];
    if (!sheet) return { headerRow: 0, data: [] };

    const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
    const requiredColumns = Object.values(columnMap).filter(c => c);

    // Check first 5 rows for header match
    for (let rowIdx = 0; rowIdx <= Math.min(4, range.e.r); rowIdx++) {
        const rowValues = [];
        for (let colIdx = 0; colIdx <= range.e.c; colIdx++) {
            const cellAddr = XLSX.utils.encode_cell({ r: rowIdx, c: colIdx });
            const cell = sheet[cellAddr];
            rowValues.push(cell ? String(cell.v || '').trim() : '');
        }

        // Count how many required columns match
        const matchCount = requiredColumns.filter(col => rowValues.some(v => v.toLowerCase() === col.toLowerCase())).length;

        // If we find at least 2 matching columns, use this row as header
        if (matchCount >= 2) {
            // Parse from this row onwards
            const opts = { range: rowIdx, header: 1 };
            const rawData = XLSX.utils.sheet_to_json(sheet, { range: rowIdx });
            return { headerRow: rowIdx, data: rawData };
        }
    }

    // Default: use first row as header
    return { headerRow: 0, data: XLSX.utils.sheet_to_json(sheet) };
};

// Default ISIC registry - US Navy Submarine Squadrons
const defaultIsics = [
    {isic_name: 'COMSUBRON 1', isic_short: 'CSS1', tycom: 'CSP'},
    {isic_name: 'COMSUBRON 7', isic_short: 'CSS7', tycom: 'CSP'},
    {isic_name: 'COMSUBRON 11', isic_short: 'CSS11', tycom: 'CSP'},
    {isic_name: 'COMSUBRON 15', isic_short: 'CSS15', tycom: 'CSP'},
    {isic_name: 'COMSUBRON 17', isic_short: 'CSS17', tycom: 'CSP'},
    {isic_name: 'COMSUBRON 19', isic_short: 'CSS19', tycom: 'CSP'},
    {isic_name: 'DEVRON 5', isic_short: 'DEVRON5', tycom: 'CSP'},
    {isic_name: 'TENDERS', isic_short: 'TENDERS', tycom: 'CSP'},
    {isic_name: 'COMSUBRON 4', isic_short: 'CSS4', tycom: 'CSL'},
    {isic_name: 'COMSUBRON 6', isic_short: 'CSS6', tycom: 'CSL'},
    {isic_name: 'COMSUBRON 8', isic_short: 'CSS8', tycom: 'CSL'},
    {isic_name: 'COMSUBRON 16', isic_short: 'CSS16', tycom: 'CSL'},
    {isic_name: 'COMSUBRON 20', isic_short: 'CSS20', tycom: 'CSL'}
];

// Default boat registry - US Navy Submarines with squadron assignments
const defaultBoats = [
    // COMSUBRON 1 - Pearl Harbor, HI (CSP)
    {boat_name: 'SSN-775', boat_full_name: 'USS Texas', isic: 'COMSUBRON 1', tycom: 'CSP'},
    {boat_name: 'SSN-776', boat_full_name: 'USS Hawaii', isic: 'COMSUBRON 1', tycom: 'CSP'},
    {boat_name: 'SSN-777', boat_full_name: 'USS North Carolina', isic: 'COMSUBRON 1', tycom: 'CSP'},
    {boat_name: 'SSN-786', boat_full_name: 'USS Illinois', isic: 'COMSUBRON 1', tycom: 'CSP'},
    {boat_name: 'SSN-792', boat_full_name: 'USS Vermont', isic: 'COMSUBRON 1', tycom: 'CSP'},
    {boat_name: 'SSN-794', boat_full_name: 'USS Montana', isic: 'COMSUBRON 1', tycom: 'CSP'},
    // COMSUBRON 7 - Pearl Harbor, HI (CSP)
    {boat_name: 'SSN-762', boat_full_name: 'USS Columbus', isic: 'COMSUBRON 7', tycom: 'CSP'},
    {boat_name: 'SSN-763', boat_full_name: 'USS Santa Fe', isic: 'COMSUBRON 7', tycom: 'CSP'},
    {boat_name: 'SSN-766', boat_full_name: 'USS Charlotte', isic: 'COMSUBRON 7', tycom: 'CSP'},
    {boat_name: 'SSN-771', boat_full_name: 'USS Columbia', isic: 'COMSUBRON 7', tycom: 'CSP'},
    {boat_name: 'SSN-772', boat_full_name: 'USS Greeneville', isic: 'COMSUBRON 7', tycom: 'CSP'},
    {boat_name: 'SSN-773', boat_full_name: 'USS Cheyenne', isic: 'COMSUBRON 7', tycom: 'CSP'},
    // COMSUBRON 11 - San Diego, CA (CSP)
    {boat_name: 'SSN-752', boat_full_name: 'USS Pasadena', isic: 'COMSUBRON 11', tycom: 'CSP'},
    {boat_name: 'SSN-754', boat_full_name: 'USS Topeka', isic: 'COMSUBRON 11', tycom: 'CSP'},
    {boat_name: 'SSN-758', boat_full_name: 'USS Asheville', isic: 'COMSUBRON 11', tycom: 'CSP'},
    {boat_name: 'SSN-767', boat_full_name: 'USS Hampton', isic: 'COMSUBRON 11', tycom: 'CSP'},
    // COMSUBRON 15 - Guam (CSP)
    {boat_name: 'SSN-722', boat_full_name: 'USS Key West', isic: 'COMSUBRON 15', tycom: 'CSP'},
    {boat_name: 'SSN-759', boat_full_name: 'USS Jefferson City', isic: 'COMSUBRON 15', tycom: 'CSP'},
    {boat_name: 'SSN-760', boat_full_name: 'USS Annapolis', isic: 'COMSUBRON 15', tycom: 'CSP'},
    {boat_name: 'SSN-761', boat_full_name: 'USS Springfield', isic: 'COMSUBRON 15', tycom: 'CSP'},
    {boat_name: 'SSN-783', boat_full_name: 'USS Minnesota', isic: 'COMSUBRON 15', tycom: 'CSP'},
    // COMSUBRON 17 - Bangor, WA (CSP) - SSBNs
    {boat_name: 'SSBN-730', boat_full_name: 'USS Henry M. Jackson', isic: 'COMSUBRON 17', tycom: 'CSP'},
    {boat_name: 'SSBN-731', boat_full_name: 'USS Alabama', isic: 'COMSUBRON 17', tycom: 'CSP'},
    {boat_name: 'SSBN-733', boat_full_name: 'USS Nevada', isic: 'COMSUBRON 17', tycom: 'CSP'},
    {boat_name: 'SSBN-739', boat_full_name: 'USS Nebraska', isic: 'COMSUBRON 17', tycom: 'CSP'},
    {boat_name: 'SSBN-741', boat_full_name: 'USS Maine', isic: 'COMSUBRON 17', tycom: 'CSP'},
    {boat_name: 'SSBN-743', boat_full_name: 'USS Louisiana', isic: 'COMSUBRON 17', tycom: 'CSP'},
    // COMSUBRON 19 - Bangor, WA (CSP) - SSGNs/SSBNs
    {boat_name: 'SSGN-726', boat_full_name: 'USS Ohio', isic: 'COMSUBRON 19', tycom: 'CSP'},
    {boat_name: 'SSGN-727', boat_full_name: 'USS Michigan', isic: 'COMSUBRON 19', tycom: 'CSP'},
    {boat_name: 'SSBN-735', boat_full_name: 'USS Pennsylvania', isic: 'COMSUBRON 19', tycom: 'CSP'},
    {boat_name: 'SSBN-737', boat_full_name: 'USS Kentucky', isic: 'COMSUBRON 19', tycom: 'CSP'},
    // DEVRON 5 - Bangor, WA (CSP) - Seawolf-class
    {boat_name: 'SSN-21', boat_full_name: 'USS Seawolf', isic: 'DEVRON 5', tycom: 'CSP'},
    {boat_name: 'SSN-22', boat_full_name: 'USS Connecticut', isic: 'DEVRON 5', tycom: 'CSP'},
    {boat_name: 'SSN-23', boat_full_name: 'USS Jimmy Carter', isic: 'DEVRON 5', tycom: 'CSP'},
    // TENDERS - Submarine Tenders (CSP)
    {boat_name: 'AS-39', boat_full_name: 'USS Emory S. Land', isic: 'TENDERS', tycom: 'CSP'},
    {boat_name: 'AS-40', boat_full_name: 'USS Frank Cable', isic: 'TENDERS', tycom: 'CSP'},
    // COMSUBRON 4 - Groton, CT (CSL)
    {boat_name: 'SSN-774', boat_full_name: 'USS Virginia', isic: 'COMSUBRON 4', tycom: 'CSL'},
    {boat_name: 'SSN-778', boat_full_name: 'USS New Hampshire', isic: 'COMSUBRON 4', tycom: 'CSL'},
    {boat_name: 'SSN-779', boat_full_name: 'USS New Mexico', isic: 'COMSUBRON 4', tycom: 'CSL'},
    {boat_name: 'SSN-780', boat_full_name: 'USS Missouri', isic: 'COMSUBRON 4', tycom: 'CSL'},
    {boat_name: 'SSN-781', boat_full_name: 'USS California', isic: 'COMSUBRON 4', tycom: 'CSL'},
    {boat_name: 'SSN-795', boat_full_name: 'USS Hyman G. Rickover', isic: 'COMSUBRON 4', tycom: 'CSL'},
    // COMSUBRON 6 - Norfolk, VA (CSL)
    {boat_name: 'SSN-753', boat_full_name: 'USS Albany', isic: 'COMSUBRON 6', tycom: 'CSL'},
    {boat_name: 'SSN-756', boat_full_name: 'USS Scranton', isic: 'COMSUBRON 6', tycom: 'CSL'},
    {boat_name: 'SSN-764', boat_full_name: 'USS Boise', isic: 'COMSUBRON 6', tycom: 'CSL'},
    {boat_name: 'SSN-765', boat_full_name: 'USS Montpelier', isic: 'COMSUBRON 6', tycom: 'CSL'},
    {boat_name: 'SSN-791', boat_full_name: 'USS Delaware', isic: 'COMSUBRON 6', tycom: 'CSL'},
    {boat_name: 'SSN-793', boat_full_name: 'USS Oregon', isic: 'COMSUBRON 6', tycom: 'CSL'},
    // COMSUBRON 8 - Norfolk, VA (CSL)
    {boat_name: 'SSN-750', boat_full_name: 'USS Newport News', isic: 'COMSUBRON 8', tycom: 'CSL'},
    {boat_name: 'SSN-751', boat_full_name: 'USS San Juan', isic: 'COMSUBRON 8', tycom: 'CSL'},
    {boat_name: 'SSN-768', boat_full_name: 'USS Hartford', isic: 'COMSUBRON 8', tycom: 'CSL'},
    {boat_name: 'SSN-769', boat_full_name: 'USS Toledo', isic: 'COMSUBRON 8', tycom: 'CSL'},
    {boat_name: 'SSN-785', boat_full_name: 'USS John Warner', isic: 'COMSUBRON 8', tycom: 'CSL'},
    // COMSUBRON 16 - Kings Bay, GA (CSL) - SSGNs
    {boat_name: 'SSGN-728', boat_full_name: 'USS Florida', isic: 'COMSUBRON 16', tycom: 'CSL'},
    {boat_name: 'SSGN-729', boat_full_name: 'USS Georgia', isic: 'COMSUBRON 16', tycom: 'CSL'},
    // COMSUBRON 20 - Kings Bay, GA (CSL) - SSBNs
    {boat_name: 'SSBN-734', boat_full_name: 'USS Tennessee', isic: 'COMSUBRON 20', tycom: 'CSL'},
    {boat_name: 'SSBN-736', boat_full_name: 'USS West Virginia', isic: 'COMSUBRON 20', tycom: 'CSL'},
    {boat_name: 'SSBN-738', boat_full_name: 'USS Maryland', isic: 'COMSUBRON 20', tycom: 'CSL'},
    {boat_name: 'SSBN-740', boat_full_name: 'USS Rhode Island', isic: 'COMSUBRON 20', tycom: 'CSL'},
    {boat_name: 'SSBN-742', boat_full_name: 'USS Wyoming', isic: 'COMSUBRON 20', tycom: 'CSL'}
];

// Default schema configuration - defines fields to extract from each file type
const defaultSchemaConfig = {
    vram: [
        {field: 'siteName', label: 'Site/Boat Name', column: 'Site Name', visible: true},
        {field: 'scanDate', label: 'Last Scan Date', column: 'Last Scan Date', visible: true},
        {field: 'assets', label: 'Asset Count', column: 'Valid Assets', visible: true},
        {field: 'raVph', label: 'RA VPH', column: 'RA VPH', visible: true},
        {field: 'raCrit', label: 'RA Critical', column: 'RA Critical', visible: false},
        {field: 'raHigh', label: 'RA High', column: 'RA High', visible: true},
        {field: 'scanIntegrity', label: 'Scan Integrity %', column: 'Scan Integrity', visible: true},
        {field: 'scanPercent', label: 'Percent Scanned', column: 'Percent Scanned', visible: true},
        {field: 'scanExempt', label: 'Scan Exempt', column: 'Scan Exempt', visible: true}
    ],
    ess: [
        {field: 'shipName', label: 'Ship/Boat Name', column: 'Ships', visible: true},
        {field: 'isic', label: 'ISIC Column', column: 'ISICs', visible: true},
        {field: 'productCompliance', label: 'Product Compliance %', column: 'Product Compliance', visible: true},
        {field: 'policyEnforced', label: 'Policy Enforced %', column: 'Policy Enforced', visible: true},
        {field: 'truePolicy', label: 'True Policy % (Calculated)', column: '[CALCULATED - NOT IN ESS SHEET]', visible: true},
        {field: 'breakfix', label: 'Breakfix Count', column: 'Assets in Breakfix', visible: true},
        {field: 'assets', label: 'Asset Count', column: 'Asset Count', visible: true}
    ],
    tam: [
        {field: 'boatName', label: 'Boat Name', column: 'Boat', visible: true},
        {field: 'pastDue', label: 'Past Due Count', column: '# Past Due', visible: true},
        {field: 'extensions', label: 'Extensions Count', column: '# Extensions', visible: true}
    ]
};

// Build column map from schema config (field -> column name)
const buildColumnMap = (schemaArr) => {
    const map = {};
    for (const item of schemaArr) {
        if (item.visible !== false) map[item.field] = item.column;
    }
    return map;
};

// Default analytics configuration
const defaultAnalyticsConfig = {
    statCards: [
        {id: 'totalBoats', label: 'Total Boats', visible: true},
        {id: 'highRisk', label: 'High Risk', visible: true},
        {id: 'medRisk', label: 'Medium Risk', visible: true},
        {id: 'lowRisk', label: 'Low Risk', visible: true},
        {id: 'avgVph', label: 'Avg RA VPH (Combined)', visible: true},
        {id: 'avgVphSipr', label: 'SIPR Avg RA VPH', visible: false},
        {id: 'avgVphNipr', label: 'NIPR Avg RA VPH', visible: false},
        {id: 'totalBreakfix', label: 'Total Breakfix', visible: true},
        {id: 'totalBreakfixSipr', label: 'SIPR Total Breakfix', visible: false},
        {id: 'totalBreakfixNipr', label: 'NIPR Total Breakfix', visible: false},
        {id: 'avgCompliance', label: 'True ESS Compliance (Combined)', visible: true},
        {id: 'avgComplianceSipr', label: 'SIPR True ESS Compliance', visible: false},
        {id: 'avgComplianceNipr', label: 'NIPR True ESS Compliance', visible: false},
        {id: 'avgProductCompliance', label: 'Avg Product Compliance %', visible: false},
        {id: 'avgProductComplianceSipr', label: 'SIPR Avg Product Compliance %', visible: false},
        {id: 'avgProductComplianceNipr', label: 'NIPR Avg Product Compliance %', visible: false},
        {id: 'scanExempt', label: 'Scan Exempt', visible: true}
    ],
    charts: [
        {id: 'riskDistribution', label: 'Risk Distribution - All', visible: true},
        {id: 'riskByTycom', label: 'Risk by TYCOM', visible: true},
        {id: 'vphByIsic', label: 'Average VPH by ISIC (Combined)', visible: true},
        {id: 'vphByIsicSipr', label: 'SIPR Average VPH by ISIC', visible: false},
        {id: 'vphByIsicNipr', label: 'NIPR Average VPH by ISIC', visible: false},
        {id: 'highRiskTable', label: 'High Risk Boats Table', visible: true}
    ],
    rankings: [
        {id: 'worstBoatsVph', label: 'Worst Boats by VPH (Worst Enclave)', visible: true, count: 5},
        {id: 'worstBoatsVphSipr', label: 'Worst Boats by SIPR VPH', visible: false, count: 5},
        {id: 'worstBoatsVphNipr', label: 'Worst Boats by NIPR VPH', visible: false, count: 5},
        {id: 'bestBoatsVph', label: 'Best Boats by VPH', visible: false, count: 5},
        {id: 'worstBoatsCompliance', label: 'Worst Boats by Compliance (Worst Enclave)', visible: true, count: 5},
        {id: 'worstBoatsComplianceSipr', label: 'Worst Boats by SIPR Compliance', visible: false, count: 5},
        {id: 'worstBoatsComplianceNipr', label: 'Worst Boats by NIPR Compliance', visible: false, count: 5},
        {id: 'bestBoatsCompliance', label: 'Best Boats by Compliance', visible: false, count: 5},
        {id: 'worstIsicsRisk', label: 'Worst ISICs by High Risk Count', visible: true, count: 3},
        {id: 'bestIsicsRisk', label: 'Best ISICs by Low Risk %', visible: false, count: 3},
        {id: 'worstIsicsVph', label: 'Worst ISICs by Avg VPH', visible: false, count: 3},
        {id: 'boatsWithBreakfix', label: 'Boats with Breakfix Issues', visible: true, count: 5},
        {id: 'tycomComparison', label: 'TYCOM vs TYCOM Comparison', visible: true, count: 0}
    ],
    summaryColumns: [
        {id: 'isic', label: 'ISIC', visible: true},
        {id: 'boats', label: 'Boats', visible: true},
        {id: 'high', label: 'High', visible: true},
        {id: 'med', label: 'Med', visible: true},
        {id: 'low', label: 'Low', visible: true},
        {id: 'avgVph', label: 'Avg VPH', visible: true},
        {id: 'avgVphSipr', label: 'SIPR VPH', visible: false},
        {id: 'avgVphNipr', label: 'NIPR VPH', visible: false},
        {id: 'breakfix', label: 'Breakfix', visible: true}
    ]
};

// Default HQ Status layout - controls which metrics are shown and their order
const defaultHQStatusLayout = [
    { id: 'niprProdComp', label: 'NIPR Prod Compliance', visible: true },
    { id: 'niprPolEnf', label: 'NIPR True Policy', visible: true },
    { id: 'niprPolRaw', label: 'NIPR Policy Enforced (Raw)', visible: false },
    { id: 'niprBreakfix', label: 'NIPR Breakfix', visible: true },
    { id: 'siprProdComp', label: 'SIPR Prod Compliance', visible: true },
    { id: 'siprPolEnf', label: 'SIPR True Policy', visible: true },
    { id: 'siprPolRaw', label: 'SIPR Policy Enforced (Raw)', visible: false },
    { id: 'siprBreakfix', label: 'SIPR Breakfix', visible: true },
    { id: 'highRisk', label: 'High Risk', visible: true },
    { id: 'scanExempt', label: 'Scan Exempt', visible: true },
];

// Default analytics layout (drag/drop grid) - also controls generated report visibility
const defaultAnalyticsLayout = [
    { id: 'totalBoats', type: 'stat', row: 0, col: 0 },
    { id: 'highRisk', type: 'stat', row: 0, col: 1 },
    { id: 'medRisk', type: 'stat', row: 0, col: 2 },
    { id: 'lowRisk', type: 'stat', row: 0, col: 3 },
    { id: 'avgVph', type: 'stat', row: 1, col: 0 },
    { id: 'totalBreakfix', type: 'stat', row: 1, col: 1 },
    { id: 'avgCompliance', type: 'stat', row: 1, col: 2 },
    { id: 'scanExempt', type: 'stat', row: 1, col: 3 },
    { id: 'riskDistribution', type: 'chart', row: 2, col: 0, width: 2 },
    { id: 'highRiskTable', type: 'chart', row: 2, col: 2, width: 2 },
    { id: 'worstBoatsVph', type: 'ranking', row: 3, col: 0 },
    { id: 'worstBoatsCompliance', type: 'ranking', row: 3, col: 1 },
    { id: 'boatsWithBreakfix', type: 'ranking', row: 3, col: 2 },
    { id: 'riskSummaryByIsic', type: 'table', row: 4, col: 0, width: 4 },
];

// Default ISIC analytics layout - focused metrics for squadron-level view
const defaultIsicAnalyticsLayout = [
    { id: 'isicBoatCount', type: 'stat', row: 0, col: 0 },
    { id: 'isicHighRisk', type: 'stat', row: 0, col: 1 },
    { id: 'isicMedRisk', type: 'stat', row: 0, col: 2 },
    { id: 'isicLowRisk', type: 'stat', row: 0, col: 3 },
    { id: 'isicAvgVph', type: 'stat', row: 1, col: 0 },
    { id: 'isicTotalBreakfix', type: 'stat', row: 1, col: 1 },
    { id: 'isicAvgCompliance', type: 'stat', row: 1, col: 2 },
    { id: 'isicScanExempt', type: 'stat', row: 1, col: 3 },
    { id: 'isicRiskPie', type: 'chart', row: 2, col: 0, width: 2 },
    { id: 'isicBoatsTable', type: 'table', row: 2, col: 2, width: 2 },
    { id: 'isicVphComparison', type: 'chart', row: 3, col: 0, width: 2 },
    { id: 'isicComplianceComparison', type: 'chart', row: 3, col: 2, width: 2 },
];

// Default Boat analytics layout - focused metrics for individual boat view
const defaultBoatAnalyticsLayout = [
    { id: 'boatRiskLevel', type: 'stat', row: 0, col: 0 },
    { id: 'boatVphNipr', type: 'stat', row: 0, col: 1 },
    { id: 'boatVphSipr', type: 'stat', row: 0, col: 2 },
    { id: 'boatScanAgeNipr', type: 'stat', row: 0, col: 3 },
    { id: 'boatScanAgeSipr', type: 'stat', row: 1, col: 0 },
    { id: 'boatBreakfixNipr', type: 'stat', row: 1, col: 1 },
    { id: 'boatBreakfixSipr', type: 'stat', row: 1, col: 2 },
    { id: 'boatComplianceNipr', type: 'stat', row: 1, col: 3 },
    { id: 'boatComplianceSipr', type: 'stat', row: 2, col: 0 },
    { id: 'boatRiskReasons', type: 'card', row: 2, col: 1, width: 1 },
    { id: 'boatMetricsSummary', type: 'table', row: 2, col: 2, width: 2 },
    // Consolidated comparison charts by enclave (4 charts instead of 6)
    { id: 'boatVphComparisonSipr', type: 'chart', row: 3, col: 0, width: 2 },
    { id: 'boatVphComparisonNipr', type: 'chart', row: 3, col: 2, width: 2 },
    { id: 'boatEssComparisonSipr', type: 'chart', row: 4, col: 0, width: 2 },
    { id: 'boatEssComparisonNipr', type: 'chart', row: 4, col: 2, width: 2 },
];

// Available ISIC analytics elements
const isicAnalyticsElements = [
    { id: 'isicBoatCount', type: 'stat', label: 'Boats in ISIC' },
    { id: 'isicHighRisk', type: 'stat', label: 'High Risk Count' },
    { id: 'isicMedRisk', type: 'stat', label: 'Medium Risk Count' },
    { id: 'isicLowRisk', type: 'stat', label: 'Low Risk Count' },
    { id: 'isicAvgVph', type: 'stat', label: 'Avg VPH (Combined)' },
    { id: 'isicAvgVphSipr', type: 'stat', label: 'SIPR Avg VPH' },
    { id: 'isicAvgVphNipr', type: 'stat', label: 'NIPR Avg VPH' },
    { id: 'isicTotalBreakfix', type: 'stat', label: 'Total Breakfix' },
    { id: 'isicTotalBreakfixSipr', type: 'stat', label: 'SIPR Total Breakfix' },
    { id: 'isicTotalBreakfixNipr', type: 'stat', label: 'NIPR Total Breakfix' },
    { id: 'isicAvgCompliance', type: 'stat', label: 'Avg True ESS Compliance (Combined)' },
    { id: 'isicAvgComplianceSipr', type: 'stat', label: 'SIPR Avg True ESS Compliance' },
    { id: 'isicAvgComplianceNipr', type: 'stat', label: 'NIPR Avg True ESS Compliance' },
    { id: 'isicAvgProductCompliance', type: 'stat', label: 'Avg Product Compliance' },
    { id: 'isicAvgProductComplianceSipr', type: 'stat', label: 'SIPR Avg Product Compliance' },
    { id: 'isicAvgProductComplianceNipr', type: 'stat', label: 'NIPR Avg Product Compliance' },
    { id: 'isicScanExempt', type: 'stat', label: 'Scan Exempt' },
    { id: 'isicRiskPie', type: 'chart', label: 'ISIC Risk Distribution' },
    { id: 'isicBoatsTable', type: 'table', label: 'Boats in ISIC Table' },
    { id: 'isicVphComparison', type: 'chart', label: 'VPH by Boat (Worst Enclave)' },
    { id: 'isicVphComparisonSipr', type: 'chart', label: 'SIPR VPH by Boat' },
    { id: 'isicVphComparisonNipr', type: 'chart', label: 'NIPR VPH by Boat' },
    { id: 'isicComplianceComparison', type: 'chart', label: 'True ESS % by Boat (Worst Enclave)' },
    { id: 'isicComplianceComparisonSipr', type: 'chart', label: 'SIPR True ESS % by Boat' },
    { id: 'isicComplianceComparisonNipr', type: 'chart', label: 'NIPR True ESS % by Boat' },
    { id: 'isicWorstBoatsVph', type: 'ranking', label: 'Worst Boats by VPH' },
    { id: 'isicBestBoatsVph', type: 'ranking', label: 'Best Boats by VPH' },
    { id: 'isicWorstBoatsCompliance', type: 'ranking', label: 'Worst Boats by True ESS' },
    { id: 'isicBestBoatsCompliance', type: 'ranking', label: 'Best Boats by True ESS' },
];

// Available Boat analytics elements
const boatAnalyticsElements = [
    { id: 'boatRiskLevel', type: 'stat', label: 'Risk Level' },
    { id: 'boatVphNipr', type: 'stat', label: 'NIPR VPH' },
    { id: 'boatVphSipr', type: 'stat', label: 'SIPR VPH' },
    { id: 'boatScanAgeNipr', type: 'stat', label: 'NIPR Scan Age (days)' },
    { id: 'boatScanAgeSipr', type: 'stat', label: 'SIPR Scan Age (days)' },
    { id: 'boatBreakfixNipr', type: 'stat', label: 'NIPR Breakfix' },
    { id: 'boatBreakfixSipr', type: 'stat', label: 'SIPR Breakfix' },
    { id: 'boatComplianceNipr', type: 'stat', label: 'NIPR True ESS Compliance' },
    { id: 'boatComplianceSipr', type: 'stat', label: 'SIPR True ESS Compliance' },
    { id: 'boatProductComplianceNipr', type: 'stat', label: 'NIPR Product Compliance' },
    { id: 'boatProductComplianceSipr', type: 'stat', label: 'SIPR Product Compliance' },
    { id: 'boatRiskReasons', type: 'card', label: 'Risk Factors' },
    { id: 'boatMetricsSummary', type: 'table', label: 'Metrics Table' },
    // Consolidated comparison charts by enclave
    { id: 'boatVphComparisonSipr', type: 'chart', label: 'SIPR VPH vs ISIC/TYCOM/SUBFOR' },
    { id: 'boatVphComparisonNipr', type: 'chart', label: 'NIPR VPH vs ISIC/TYCOM/SUBFOR' },
    { id: 'boatEssComparisonSipr', type: 'chart', label: 'SIPR True ESS vs ISIC/TYCOM/SUBFOR' },
    { id: 'boatEssComparisonNipr', type: 'chart', label: 'NIPR True ESS vs ISIC/TYCOM/SUBFOR' },
    // Legacy individual comparison charts (kept for backward compatibility)
    { id: 'boatIsicComparisonVph', type: 'chart', label: 'VPH vs ISIC Average (Legacy)' },
    { id: 'boatIsicComparisonEss', type: 'chart', label: 'True ESS vs ISIC Average (Legacy)' },
    { id: 'boatTycomComparisonVph', type: 'chart', label: 'VPH vs TYCOM Average (Legacy)' },
    { id: 'boatTycomComparisonEss', type: 'chart', label: 'True ESS vs TYCOM Average (Legacy)' },
    { id: 'boatSubforComparisonVph', type: 'chart', label: 'VPH vs SUBFOR Average (Legacy)' },
    { id: 'boatSubforComparisonEss', type: 'chart', label: 'True ESS vs SUBFOR Average (Legacy)' },
    { id: 'boatTamStatus', type: 'stat', label: 'TAM Status' },
    { id: 'boatOverrides', type: 'table', label: 'Active Overrides' },
];

// Default legend text - updated to match new baseline risk criteria
const defaultLegendText = {
    high: 'Breakfix &gt; 0 OR No VRAM Scan (TAM &gt;{high_tam_past_due} optional)',
    med: '2+ of: VPH &gt;{med_ra_vph}, Prod/Policy compliance &lt;{med_ess_compliance}%, Scan &gt;{med_scan_age_days}d, TAM &gt;{med_tam_past_due}',
    low: 'VPH &lt;{low_vph}, Scans within {low_scan_age_days}d, Compliance &gt;{low_product_compliance}%'
};

// Default threshold values for the new risk criteria
// Baseline: HIGH = Breakfix OR No Scan | MED = 2+ of criteria | LOW = all criteria met
const defaultThresholds = {
    // LOW risk thresholds (must meet ALL to be LOW)
    low_vph: 2.5,
    low_scan_age_days: 14,
    low_product_compliance: 95,          // Raw Product Compliance threshold
    low_true_policy_compliance: 95,      // True Policy Compliance threshold
    low_raw_policy_compliance: 95,       // Raw Policy Compliance threshold
    low_tam_past_due: 5,                 // TAM Past Due threshold
    // MED risk thresholds (2+ conditions trigger MED)
    med_ra_vph: 3.5,
    med_ess_compliance: 95,
    med_scan_age_days: 14,
    med_tam_past_due: 10,
    // HIGH risk thresholds (auto-HIGH if exceeded) - disabled by default except TAMs
    // Set to extreme values to effectively disable (Breakfix + No Scan are always HIGH)
    auto_high_ra_vph: 999,           // Disabled - VPH doesn't auto-trigger HIGH
    auto_high_scan_age_days: 999,    // Disabled - Old scans don't auto-trigger HIGH (No scan does)
    high_ess_compliance: 90,         // Enabled - True Policy compliance < 90% triggers HIGH
    high_raw_policy_compliance: 0,   // Disabled - Raw Policy compliance doesn't auto-trigger HIGH
    high_product_compliance: 0,      // Disabled - Low product compliance doesn't auto-trigger HIGH
    high_tam_past_due: 20,           // Optional - TAMs > 20 triggers HIGH (can be adjusted)
    // MED risk - policy toggles (both can be enabled/disabled independently)
    med_true_policy_compliance: 95,  // True policy threshold for MED (enabled by default)
    med_raw_policy_compliance: 0,    // Raw policy threshold for MED (disabled by default)
    // CSL/CSP Table Color scale thresholds (green/red, yellow is between)
    color_product_green: 95, color_product_red: 90,
    color_policy_green: 95, color_policy_red: 90,
    color_policy_raw_green: 95, color_policy_raw_red: 90,
    color_vph_green: 2.5, color_vph_red: 3.5,
    color_scan_green: 14, color_scan_red: 14,
    color_integrity_green: 95, color_integrity_red: 90,
    color_scanned_green: 95, color_scanned_red: 90,
    // HQ Status Table Color scale thresholds (separate from CSL/CSP)
    hq_color_product_green: 95, hq_color_product_red: 90,
    hq_color_policy_green: 95, hq_color_policy_red: 90,
    hq_color_policy_raw_green: 95, hq_color_policy_raw_red: 90,
    // LOW risk toggleable criteria (1 = enabled, 0 = disabled)
    low_product_compliance_enabled: 1,       // Always enabled (required for LOW)
    low_true_policy_compliance_enabled: 0,   // Disabled by default
    low_raw_policy_compliance_enabled: 0,    // Disabled by default
    low_tam_past_due_enabled: 0,             // Disabled by default
};

// Dynamic legend text generator - creates legend based on active thresholds
const generateDynamicLegend = (thresholds) => {
    const t = thresholds || defaultThresholds;

    // HIGH legend
    let highParts = ['Breakfix > 0', 'No VRAM Scan'];
    if ((t.high_tam_past_due || 999) < 999) highParts.push(`TAM >${t.high_tam_past_due}`);
    if ((t.auto_high_ra_vph || 999) < 999) highParts.push(`VPH >${t.auto_high_ra_vph}`);
    if ((t.auto_high_scan_age_days || 999) < 999) highParts.push(`Scan >${t.auto_high_scan_age_days}d`);
    if ((t.high_ess_compliance || 0) > 0) highParts.push(`TruePolicy <${t.high_ess_compliance}%`);
    if ((t.high_raw_policy_compliance || 0) > 0) highParts.push(`RawPolicy <${t.high_raw_policy_compliance}%`);
    if ((t.high_product_compliance || 0) > 0) highParts.push(`Product <${t.high_product_compliance}%`);
    const high = highParts.join(' OR ');

    // MED legend
    let medParts = [`VPH >${t.med_ra_vph || 3.5}`, `Product <${t.med_ess_compliance || 95}%`];
    if ((t.med_true_policy_compliance || 0) > 0) medParts.push(`TruePolicy <${t.med_true_policy_compliance}%`);
    if ((t.med_raw_policy_compliance || 0) > 0) medParts.push(`RawPolicy <${t.med_raw_policy_compliance}%`);
    medParts.push(`Scan >${t.med_scan_age_days || 14}d`, `TAM >${t.med_tam_past_due || 10}`);
    const med = `2+ of: ${medParts.join(', ')}`;

    // LOW legend
    let lowParts = [`VPH <${t.low_vph || 2.5}`, `Product ≥${t.low_product_compliance || 95}%`];
    if ((t.low_true_policy_compliance_enabled ?? 0) === 1) lowParts.push(`TruePolicy ≥${t.low_true_policy_compliance || 95}%`);
    if ((t.low_raw_policy_compliance_enabled ?? 0) === 1) lowParts.push(`RawPolicy ≥${t.low_raw_policy_compliance || 95}%`);
    lowParts.push(`Scan ≤${t.low_scan_age_days || 14}d`);
    if ((t.low_tam_past_due_enabled ?? 0) === 1) lowParts.push(`TAM ≤${t.low_tam_past_due || 5}`);
    const low = lowParts.join(', ');

    return { high, med, low };
};

// Dynamic help modal generator - creates help items based on active thresholds
const generateDynamicHelpModal = (thresholds) => {
    const t = thresholds || defaultThresholds;

    // HIGH items - always includes Breakfix and No VRAM
    let highItems = [
        'Breakfix > 0 - Any asset in either enclave in breakfix',
        'No VRAM Scan Data - Unable to assess risk without scan data'
    ];
    if ((t.high_tam_past_due || 999) < 999) highItems.push(`TAM Past Due > ${t.high_tam_past_due} - Too many overdue TAMs`);
    if ((t.auto_high_ra_vph || 999) < 999) highItems.push(`VPH > ${t.auto_high_ra_vph} - Critical vulnerabilities per host`);
    if ((t.auto_high_scan_age_days || 999) < 999) highItems.push(`Scan Age > ${t.auto_high_scan_age_days} days - Scan data too old`);
    if ((t.high_ess_compliance || 0) > 0) highItems.push(`True Policy < ${t.high_ess_compliance}% - Policy compliance critically low`);
    if ((t.high_raw_policy_compliance || 0) > 0) highItems.push(`Raw Policy < ${t.high_raw_policy_compliance}% - Raw policy compliance critically low`);
    if ((t.high_product_compliance || 0) > 0) highItems.push(`Product Compliance < ${t.high_product_compliance}% - Product compliance critically low`);

    // MED items - 2+ of these trigger MED
    let medItems = [
        `VPH > ${t.med_ra_vph || 3.5} - Vulnerabilities per host above threshold`,
        `Product Compliance < ${t.med_ess_compliance || 95}% - ESS compliance below threshold`
    ];
    if ((t.med_true_policy_compliance || 0) > 0) medItems.push(`True Policy < ${t.med_true_policy_compliance}% - True policy below threshold`);
    if ((t.med_raw_policy_compliance || 0) > 0) medItems.push(`Raw Policy < ${t.med_raw_policy_compliance}% - Raw policy below threshold`);
    medItems.push(`Scan Age > ${t.med_scan_age_days || 14} days - VRAM scan older than threshold`);
    medItems.push(`TAM Past Due > ${t.med_tam_past_due || 10} - Too many overdue TAMs`);

    // LOW items - all must be met
    let lowItems = [
        `VPH < ${t.low_vph || 2.5} - All enclaves below threshold`,
        `Scans within ${t.low_scan_age_days || 14} days - All enclaves current`,
        `Product Compliance ≥ ${t.low_product_compliance || 95}% - All above threshold`
    ];
    if ((t.low_true_policy_compliance_enabled ?? 0) === 1) lowItems.push(`True Policy ≥ ${t.low_true_policy_compliance || 95}% - True policy above threshold`);
    if ((t.low_raw_policy_compliance_enabled ?? 0) === 1) lowItems.push(`Raw Policy ≥ ${t.low_raw_policy_compliance || 95}% - Raw policy above threshold`);
    if ((t.low_tam_past_due_enabled ?? 0) === 1) lowItems.push(`TAM Past Due ≤ ${t.low_tam_past_due || 5} - TAMs under control`);
    lowItems.push('No breakfix issues in any enclave');

    // Static calculation explanations
    const calcItems = [
        'Scan Age = Days since last VRAM scan date',
        'VPH = Vulnerabilities Per Host (from VRAM RA VPH column)',
        'True ESS Compliance or True Policy % = PolicyEnforced × ProductCompliance / 100'
    ];

    // Scan exempt explanation
    const scanExempt = 'If a boat is marked Scan Exempt, HIGH risk is downgraded to MED only when HIGH is due to "No VRAM Scan Data". Breakfix or other HIGH triggers are NOT affected by Scan Exempt status. For NMCI boats, both NIPR and SIPR must be exempt to apply the override.';

    return { highItems, medItems, lowItems, calcItems, scanExempt };
};

// Default help modal text (? button content) - used when custom override is enabled
const defaultHelpModalText = {
    highItems: [
        'Breakfix > 0 - Any asset in either enclave in breakfix',
        'No VRAM Scan Data - Unable to assess risk without scan data',
        'TAM Past Due > {high_tam_past_due} - Optional HIGH trigger (adjustable)'
    ],
    medItems: [
        'VPH > {med_ra_vph} - Vulnerabilities per host above threshold',
        'Product/Policy Compliance < {med_ess_compliance}% - ESS compliance below threshold',
        'Scan Age > {med_scan_age_days} days - VRAM scan older than threshold',
        'TAM Past Due > {med_tam_past_due} - Too many overdue TAMs'
    ],
    lowItems: [
        'VPH < {low_vph} - Low vulnerabilities per host',
        'Scans within {low_scan_age_days} days - Recent scan data',
        'Compliance > {low_product_compliance}% - High product and policy compliance',
        'No HIGH risk triggers present'
    ],
    calcItems: [
        'Scan Age = Days since last VRAM scan date',
        'VPH = Vulnerabilities Per Host (from VRAM RA VPH column)',
        'True ESS Compliance or True Policy % = PolicyEnforced × ProductCompliance / 100'
    ],
    scanExempt: 'If a boat is marked Scan Exempt, HIGH risk is downgraded to MED only when HIGH is due to "No VRAM Scan Data". Breakfix or other HIGH triggers (like TAMs > {high_tam_past_due}) are NOT affected by Scan Exempt status. For NMCI boats, both NIPR and SIPR must be exempt to apply the override.'
};

// Settings Manager with localStorage
const SETTINGS_STORAGE_KEY = 'cyberDashboard_settings';
const SETTINGS_VERSION = '1.0';

const SettingsManager = {
    // Get embedded defaults from HTML
    getEmbeddedDefaults() {
        try {
            return JSON.parse(document.getElementById('app-settings').textContent);
        } catch { return null; }
    },

    // Ensure settings have all required fields and versioning
    ensureDefaults(settings, options = {}) {
        if (!settings.schemaConfig) {
            settings.schemaConfig = JSON.parse(JSON.stringify(defaultSchemaConfig));
        } else {
            // Merge in any missing schema fields from defaults
            for (const type of ['vram', 'ess', 'tam']) {
                if (!settings.schemaConfig[type]) {
                    settings.schemaConfig[type] = JSON.parse(JSON.stringify(defaultSchemaConfig[type]));
                } else {
                    const existingFields = new Set(settings.schemaConfig[type].map(f => f.field));
                    for (const defaultField of defaultSchemaConfig[type]) {
                        if (!existingFields.has(defaultField.field)) {
                            settings.schemaConfig[type].push(JSON.parse(JSON.stringify(defaultField)));
                        }
                    }
                }
            }
        }
        if (!settings.tabConfig) settings.tabConfig = [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}];
        if (!settings.analyticsConfig) settings.analyticsConfig = JSON.parse(JSON.stringify(defaultAnalyticsConfig));
        if (!settings.analyticsLayout) settings.analyticsLayout = JSON.parse(JSON.stringify(defaultAnalyticsLayout));
        if (!settings.hqStatusLayout) {
            settings.hqStatusLayout = JSON.parse(JSON.stringify(defaultHQStatusLayout));
        } else {
            // Merge in any missing HQ metrics from defaults
            const existingIds = new Set(settings.hqStatusLayout.map(m => m.id));
            for (const defaultMetric of defaultHQStatusLayout) {
                if (!existingIds.has(defaultMetric.id)) {
                    settings.hqStatusLayout.push(JSON.parse(JSON.stringify(defaultMetric)));
                }
            }
        }
        if (!settings.legendText) settings.legendText = JSON.parse(JSON.stringify(defaultLegendText));
        if (!settings.helpModalText) settings.helpModalText = JSON.parse(JSON.stringify(defaultHelpModalText));
        if (settings.useCustomHelpText === undefined) settings.useCustomHelpText = false;
        // Ensure thresholds are populated with defaults if empty or missing
        if (!settings.thresholds || Object.keys(settings.thresholds).length === 0) {
            settings.thresholds = JSON.parse(JSON.stringify(defaultThresholds));
        } else {
            // Merge in any missing threshold keys from defaults
            for (const key of Object.keys(defaultThresholds)) {
                if (settings.thresholds[key] === undefined) {
                    settings.thresholds[key] = defaultThresholds[key];
                }
            }
            // Remove obsolete threshold keys (e.g., ra_crit was removed)
            const obsoleteKeys = ['auto_high_ra_crit', 'high_ra_crit', 'med_ra_crit', 'low_ra_crit', 'auto_high_scan_integrity', 'high_scan_age_days'];
            for (const key of obsoleteKeys) {
                delete settings.thresholds[key];
            }
        }

        // Initialize versioning if missing
        if (!settings._settingsVersion) {
            settings._settingsVersion = SETTINGS_VERSION;
            settings._settingsAuthor = options.author || 'Unknown';
            settings._settingsModified = new Date().toISOString();
            settings._settingsHistory = [];
        }

        // Migrate old columnMappings
        if (settings.columnMappings && !settings.schemaConfig) {
            settings.schemaConfig = this.migrateColumnMappings(settings.columnMappings);
            delete settings.columnMappings;
        }
        return settings;
    },

    // Load settings from localStorage, fall back to embedded defaults
    load() {
        try {
            const stored = localStorage.getItem(SETTINGS_STORAGE_KEY);
            if (stored) {
                const settings = JSON.parse(stored);
                return this.ensureDefaults(settings);
            }
        } catch (err) {
            console.error('Failed to load settings from localStorage:', err);
        }

        // Fall back to embedded defaults
        const embedded = this.getEmbeddedDefaults();
        if (embedded) {
            return this.ensureDefaults(embedded, { author: 'Default' });
        }
        return this.getDefaults();
    },

    // Save settings to localStorage
    save(settings) {
        try {
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
            return { success: true };
        } catch (err) {
            console.error('Failed to save settings to localStorage:', err);
            return { success: false, error: err.message };
        }
    },

    // Update settings version info when user makes changes
    updateVersion(settings, authorName) {
        const now = new Date().toISOString();
        const prevVersion = settings._settingsVersion || '1.0';
        const prevAuthor = settings._settingsAuthor || 'Unknown';
        const prevModified = settings._settingsModified;

        // Add to history
        if (!settings._settingsHistory) settings._settingsHistory = [];
        if (prevModified) {
            settings._settingsHistory.push({
                version: prevVersion,
                author: prevAuthor,
                modified: prevModified,
                savedAt: now
            });
            // Keep only last 10 history entries
            if (settings._settingsHistory.length > 10) {
                settings._settingsHistory = settings._settingsHistory.slice(-10);
            }
        }

        // Increment version
        const [major, minor] = prevVersion.split('.').map(Number);
        settings._settingsVersion = `${major}.${minor + 1}`;
        settings._settingsAuthor = authorName || prevAuthor;
        settings._settingsModified = now;

        return settings;
    },

    // Export settings as JSON download
    exportSettings(settings) {
        const jsonStr = JSON.stringify(settings, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `settings-v${settings._settingsVersion || '1.0'}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
    },

    // Import settings from JSON file
    importSettings() {
        return new Promise((resolve) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const text = await file.text();
                        const settings = JSON.parse(text);
                        resolve({ success: true, settings: this.ensureDefaults(settings) });
                    } catch (err) {
                        resolve({ success: false, error: err.message });
                    }
                } else {
                    resolve({ success: false, error: 'No file selected' });
                }
            };
            input.click();
        });
    },

    // Clear localStorage settings
    clear() {
        try {
            localStorage.removeItem(SETTINGS_STORAGE_KEY);
            return { success: true };
        } catch (err) {
            return { success: false, error: err.message };
        }
    },

    // Check if localStorage has saved settings
    hasSavedSettings() {
        return localStorage.getItem(SETTINGS_STORAGE_KEY) !== null;
    },

    migrateColumnMappings(old) {
        const labels = {
            vram: {siteName:'Site/Boat Name',scanDate:'Last Scan Date',assets:'Asset Count',raVph:'RA VPH',raCrit:'RA Critical',raHigh:'RA High',scanIntegrity:'Scan Integrity %',scanPercent:'Percent Scanned',scanExempt:'Scan Exempt'},
            ess: {shipName:'Ship/Boat Name',isic:'ISIC Column',productCompliance:'Product Compliance %',policyEnforced:'Policy Enforced %',truePolicy:'True Policy % (Calculated)',breakfix:'Breakfix Count',assets:'Asset Count'},
            tam: {boatName:'Boat Name',pastDue:'Past Due Count',extensions:'Extensions Count'}
        };
        const result = {};
        for (const type of ['vram', 'ess', 'tam']) {
            result[type] = [];
            if (old[type]) {
                for (const [field, vals] of Object.entries(old[type])) {
                    const col = Array.isArray(vals) ? vals[0] : vals;
                    result[type].push({field, label: labels[type]?.[field] || field, column: col || '', visible: true});
                }
            }
        }
        return result;
    },

    getDefaults() {
        return {
            _version: 1,
            _settingsVersion: SETTINGS_VERSION,
            _settingsAuthor: 'Default',
            _settingsModified: new Date().toISOString(),
            _settingsHistory: [],
            tycoms: ['CSL', 'CSP'],
            isics: [],
            boats: [],
            thresholds: JSON.parse(JSON.stringify(defaultThresholds)),
            display: {},
            user: { default_name: '' },
            schemaConfig: JSON.parse(JSON.stringify(defaultSchemaConfig)),
            tabConfig: [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}],
            analyticsConfig: JSON.parse(JSON.stringify(defaultAnalyticsConfig)),
            analyticsLayout: JSON.parse(JSON.stringify(defaultAnalyticsLayout)),
            hqStatusLayout: JSON.parse(JSON.stringify(defaultHQStatusLayout)),
            legendText: JSON.parse(JSON.stringify(defaultLegendText)),
            helpModalText: JSON.parse(JSON.stringify(defaultHelpModalText)),
            useCustomHelpText: false
        };
    }
};

// Data Models
const createBoatData = (name, fullName, isic, tycom, isNmci = false) => ({
    boatName: name, boatFullName: fullName, isic, tycom, isNmci,
    essNiprAssets: null, essNiprBreakfix: null, essNiprProductCompliance: null, essNiprPolicyEnforced: null, essNiprTruePolicy: null,
    essSiprAssets: null, essSiprBreakfix: null, essSiprProductCompliance: null, essSiprPolicyEnforced: null, essSiprTruePolicy: null,
    vramNiprAssets: null, vramNiprScanDate: null, vramNiprRaVph: null, vramNiprRaCrit: null, vramNiprScanIntegrity: null, vramNiprScanPercent: null, vramNiprRaHigh: null, vramNiprScanExempt: false,
    vramSiprAssets: null, vramSiprScanDate: null, vramSiprRaVph: null, vramSiprRaCrit: null, vramSiprScanIntegrity: null, vramSiprScanPercent: null, vramSiprRaHigh: null, vramSiprScanExempt: false,
    tamPastDue: null, tamExtensions: null, riskLevel: 'LOW', riskReasons: [], overrides: [], notes: '',
    customFields: {} // Stores custom schema fields: { vramNipr: {}, vramSipr: {}, essNipr: {}, essSipr: {}, tam: {} }
});

// Standard fields for each schema type (used to identify custom fields)
const standardFields = {
    vram: ['siteName', 'scanDate', 'assets', 'raVph', 'raCrit', 'raHigh', 'scanIntegrity', 'scanPercent', 'scanExempt'],
    ess: ['shipName', 'isic', 'productCompliance', 'policyEnforced', 'truePolicy', 'breakfix', 'assets'],
    tam: ['boatName', 'pastDue', 'extensions']
};

// Get custom fields from schema (fields not in standard list)
const getCustomFields = (schemaArr, type) => {
    if (!schemaArr) return [];
    return schemaArr.filter(s => !standardFields[type].includes(s.field) && s.visible !== false);
};

// Parsers - use schema config from settings to build column maps
const parseVRAM = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.vram);
    const customFieldDefs = getCustomFields(schemaArr || defaultSchemaConfig.vram, 'vram');
    const wb = XLSX.read(data, { type: 'array', cellDates: true });
    // Find header row in first 5 rows
    const { data: rows } = findHeaderRow(wb, wb.SheetNames[0], m);
    const parsed = {};
    for (const row of rows) {
        const site = row[m.siteName]; if (!site) continue;
        const name = normalizeBoatName(site); if (!name) continue;
        let scanDate = null; const rawDate = row[m.scanDate];
        if (rawDate) { scanDate = rawDate instanceof Date ? rawDate : new Date(rawDate); if (isNaN(scanDate)) scanDate = null; }
        const custom = {};
        for (const cf of customFieldDefs) {
            if (m[cf.field]) custom[cf.field] = parseNumber(row[m[cf.field]]) ?? row[m[cf.field]] ?? null;
        }
        parsed[name] = { fullName: site, scanDate: scanDate?.toISOString() || null, assets: parseNumber(row[m.assets]), raVph: parseNumber(row[m.raVph]), raCrit: parseNumber(row[m.raCrit]), scanIntegrity: parseNumber(row[m.scanIntegrity]), scanPercent: parseNumber(row[m.scanPercent]), raHigh: parseNumber(row[m.raHigh]), scanExempt: String(row[m.scanExempt]).toLowerCase() === 'true', custom };
    }
    return { parsed, raw: rows, customFieldDefs };
};

const parseESS = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.ess);
    const customFieldDefs = getCustomFields(schemaArr || defaultSchemaConfig.ess, 'ess');
    const wb = XLSX.read(data, { type: 'array' });
    // Find header row in first 5 rows
    const { data: rows } = findHeaderRow(wb, wb.SheetNames[0], m);
    const parsed = {}; const isicMap = {};
    for (const row of rows) {
        const ship = row[m.shipName]; if (!ship) continue;
        const name = normalizeBoatName(ship); if (!name) continue;
        const isic = row[m.isic]; if (isic) isicMap[name] = String(isic).trim();
        const prodComp = parsePercent(row[m.productCompliance]); const polEnf = parsePercent(row[m.policyEnforced]);
        const truePolicy = (prodComp !== null && polEnf !== null) ? (polEnf * prodComp / 100) : null;
        const custom = {};
        for (const cf of customFieldDefs) {
            if (m[cf.field]) custom[cf.field] = parseNumber(row[m[cf.field]]) ?? row[m[cf.field]] ?? null;
        }
        parsed[name] = { assets: parseNumber(row[m.assets]), breakfix: parseNumber(row[m.breakfix]), productCompliance: prodComp, policyEnforced: polEnf, truePolicy, custom };
    }
    return { parsed, isicMap, raw: rows, customFieldDefs };
};

const parseTAM = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.tam);
    const customFieldDefs = getCustomFields(schemaArr || defaultSchemaConfig.tam, 'tam');
    const wb = XLSX.read(data, { type: 'array' });
    // Find header row in first 5 rows
    const { data: rows } = findHeaderRow(wb, wb.SheetNames[0], m);
    const parsed = {};
    for (const row of rows) {
        const boat = row[m.boatName]; if (!boat) continue;
        const name = normalizeBoatName(boat); if (!name) continue;
        const custom = {};
        for (const cf of customFieldDefs) {
            if (m[cf.field]) custom[cf.field] = parseNumber(row[m[cf.field]]) ?? row[m[cf.field]] ?? null;
        }
        parsed[name] = { pastDue: parseNumber(row[m.pastDue]), extensions: parseNumber(row[m.extensions]), custom };
    }
    return { parsed, raw: rows, customFieldDefs };
};

// Merge Data
const mergeData = (sources, settings) => {
    const { vramNipr, vramSipr, essNipr, essSipr, tam } = sources;
    const boats = []; const unregistered = new Set(); const registry = {};
    for (const b of settings.boats) if (b.active !== false) registry[b.boat_name] = b;
    const allNames = new Set([...Object.keys(vramNipr?.parsed||{}), ...Object.keys(vramSipr?.parsed||{}), ...Object.keys(essNipr?.parsed||{}), ...Object.keys(essSipr?.parsed||{}), ...Object.keys(tam?.parsed||{})]);

    for (const name of Object.keys(registry)) {
        const reg = registry[name]; const boat = createBoatData(reg.boat_name, reg.boat_full_name, reg.isic, reg.tycom, reg.nmci === true);
        boat.customFields = { vramNipr: {}, vramSipr: {}, essNipr: {}, essSipr: {}, tam: {} };
        // For NMCI boats, skip NIPR data entirely - mark columns as NMCI
        if (!boat.isNmci) {
            const vn = vramNipr?.parsed?.[name]; if (vn) { boat.vramNiprAssets = vn.assets; boat.vramNiprScanDate = vn.scanDate; boat.vramNiprRaVph = vn.raVph; boat.vramNiprRaCrit = vn.raCrit; boat.vramNiprScanIntegrity = vn.scanIntegrity; boat.vramNiprScanPercent = vn.scanPercent; boat.vramNiprRaHigh = vn.raHigh; boat.vramNiprScanExempt = vn.scanExempt; if (vn.custom) boat.customFields.vramNipr = vn.custom; }
            const en = essNipr?.parsed?.[name]; if (en) { boat.essNiprAssets = en.assets; boat.essNiprBreakfix = en.breakfix; boat.essNiprProductCompliance = en.productCompliance; boat.essNiprPolicyEnforced = en.policyEnforced; boat.essNiprTruePolicy = en.truePolicy; if (en.custom) boat.customFields.essNipr = en.custom; }
        }
        const vs = vramSipr?.parsed?.[name]; if (vs) { boat.vramSiprAssets = vs.assets; boat.vramSiprScanDate = vs.scanDate; boat.vramSiprRaVph = vs.raVph; boat.vramSiprRaCrit = vs.raCrit; boat.vramSiprScanIntegrity = vs.scanIntegrity; boat.vramSiprScanPercent = vs.scanPercent; boat.vramSiprRaHigh = vs.raHigh; boat.vramSiprScanExempt = vs.scanExempt; if (vs.custom) boat.customFields.vramSipr = vs.custom; }
        const es = essSipr?.parsed?.[name]; if (es) { boat.essSiprAssets = es.assets; boat.essSiprBreakfix = es.breakfix; boat.essSiprProductCompliance = es.productCompliance; boat.essSiprPolicyEnforced = es.policyEnforced; boat.essSiprTruePolicy = es.truePolicy; if (es.custom) boat.customFields.essSipr = es.custom; }
        const t = tam?.parsed?.[name]; if (t) { boat.tamPastDue = t.pastDue; boat.tamExtensions = t.extensions; if (t.custom) boat.customFields.tam = t.custom; }
        boats.push(boat);
    }
    for (const name of allNames) if (!registry[name]) unregistered.add(name);
    return { boats, unregistered: Array.from(unregistered) };
};

// Risk Calculator
// RISK CRITERIA (all thresholds are configurable in Settings > Thresholds):
// HIGH: Breakfix > 0, no VRAM data, Product Compliance < {high_product_compliance}%, VPH > {auto_high_ra_vph},
//       Scan > {auto_high_scan_age_days}d, Policy Compliance < {high_ess_compliance}%, TAMs > {high_tam_past_due}
// MED: 2+ of: VPH > {med_ra_vph}, Compliance < {med_ess_compliance}%, Scan > {med_scan_age_days}d, TAMs > {med_tam_past_due}
// LOW: VPH < {low_vph}, Scans within {low_scan_age_days}d, Compliance > {low_product_compliance}%, no HIGH triggers
// NOTE: For NMCI boats, NIPR data is ignored entirely (they use Navy network, not SUBFOR)
const calculateRisk = (boat, thresholds) => {
    const reasons = [];
    let level = 'LOW';
    let highDueToNoScans = false;
    const isNmci = boat.isNmci === true;

    const scanAge = (d) => {
        if (!d) return null;
        const date = new Date(d);
        if (isNaN(date.getTime())) return null;
        const age = Math.floor((new Date() - date) / 86400000);
        return (isFinite(age) && age >= 0) ? age : null;
    };

    const nAge = isNmci ? null : scanAge(boat.vramNiprScanDate);
    const sAge = scanAge(boat.vramSiprScanDate);

    // Check if we have VRAM data - if no VRAM data at all, it's HIGH risk (can't assess)
    // For NMCI boats, only check SIPR data (NIPR is on NMCI network)
    const hasNiprVramData = isNmci ? true : (boat.vramNiprScanDate !== null || boat.vramNiprRaVph !== null || boat.vramNiprAssets !== null);
    const hasSiprVramData = boat.vramSiprScanDate !== null || boat.vramSiprRaVph !== null || boat.vramSiprAssets !== null;
    const hasAnyVramData = hasNiprVramData || hasSiprVramData;

    // Check if we have ESS data
    // For NMCI boats, only check SIPR data
    const hasNiprEssData = isNmci ? true : (boat.essNiprProductCompliance !== null || boat.essNiprBreakfix !== null || boat.essNiprAssets !== null);
    const hasSiprEssData = boat.essSiprProductCompliance !== null || boat.essSiprBreakfix !== null || boat.essSiprAssets !== null;
    const hasAnyEssData = hasNiprEssData || hasSiprEssData;

    // HIGH RISK TRIGGERS
    // 1. Any asset in breakfix (either enclave) - skip NIPR for NMCI boats
    if (!isNmci && (boat.essNiprBreakfix || 0) > 0) {
        level = 'HIGH';
        reasons.push(`NIPR Breakfix: ${boat.essNiprBreakfix}`);
    }
    if ((boat.essSiprBreakfix || 0) > 0) {
        level = 'HIGH';
        reasons.push(`SIPR Breakfix: ${boat.essSiprBreakfix}`);
    }

    // 2. No VRAM scan data (can't assess risk) - for NMCI, only require SIPR
    if (!hasAnyVramData || (isNmci && !hasSiprVramData)) {
        level = 'HIGH';
        reasons.push('No VRAM data');
        highDueToNoScans = true;
    }

    // 3. ESS Product Compliance < high_product_compliance (critical compliance failure) - skip NIPR for NMCI
    const highProductComplianceThreshold = thresholds.high_product_compliance || 50;
    if (!isNmci && boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < highProductComplianceThreshold) {
        level = 'HIGH';
        reasons.push(`NIPR Prod: ${boat.essNiprProductCompliance.toFixed(1)}%`);
    }
    if (boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < highProductComplianceThreshold) {
        level = 'HIGH';
        reasons.push(`SIPR Prod: ${boat.essSiprProductCompliance.toFixed(1)}%`);
    }

    // 4. VPH exceeds auto_high_ra_vph threshold (critical vulnerability level) - skip NIPR for NMCI
    const autoHighVphThreshold = thresholds.auto_high_ra_vph || 5;
    if (!isNmci && boat.vramNiprRaVph !== null && boat.vramNiprRaVph > autoHighVphThreshold) {
        level = 'HIGH';
        reasons.push(`NIPR VPH: ${boat.vramNiprRaVph.toFixed(2)}`);
    }
    if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph > autoHighVphThreshold) {
        level = 'HIGH';
        reasons.push(`SIPR VPH: ${boat.vramSiprRaVph.toFixed(2)}`);
    }

    // 5. Scan age exceeds auto_high_scan_age_days threshold (critically outdated scans) - skip NIPR for NMCI
    const autoHighScanAgeThreshold = thresholds.auto_high_scan_age_days || 30;
    if (!isNmci && nAge !== null && nAge > autoHighScanAgeThreshold) {
        level = 'HIGH';
        reasons.push(`NIPR Scan: ${nAge}d`);
    }
    if (sAge !== null && sAge > autoHighScanAgeThreshold) {
        level = 'HIGH';
        reasons.push(`SIPR Scan: ${sAge}d`);
    }

    // 6. ESS True Policy Compliance below high_ess_compliance threshold - skip NIPR for NMCI
    const highEssComplianceThreshold = thresholds.high_ess_compliance || 0;
    if (highEssComplianceThreshold > 0) {
        if (!isNmci && boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < highEssComplianceThreshold) {
            level = 'HIGH';
            reasons.push(`NIPR True Policy: ${boat.essNiprTruePolicy.toFixed(1)}%`);
        }
        if (boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < highEssComplianceThreshold) {
            level = 'HIGH';
            reasons.push(`SIPR True Policy: ${boat.essSiprTruePolicy.toFixed(1)}%`);
        }
    }

    // 6b. ESS Raw Policy Compliance below high_raw_policy_compliance threshold - skip NIPR for NMCI
    const highRawPolicyThreshold = thresholds.high_raw_policy_compliance || 0;
    if (highRawPolicyThreshold > 0) {
        if (!isNmci && boat.essNiprPolicyEnforced !== null && boat.essNiprPolicyEnforced < highRawPolicyThreshold) {
            level = 'HIGH';
            reasons.push(`NIPR Raw Policy: ${boat.essNiprPolicyEnforced.toFixed(1)}%`);
        }
        if (boat.essSiprPolicyEnforced !== null && boat.essSiprPolicyEnforced < highRawPolicyThreshold) {
            level = 'HIGH';
            reasons.push(`SIPR Raw Policy: ${boat.essSiprPolicyEnforced.toFixed(1)}%`);
        }
    }

    // 7. TAM past due exceeds high_tam_past_due threshold (critical maintenance backlog)
    const highTamThreshold = thresholds.high_tam_past_due || 20;
    if ((boat.tamPastDue || 0) > highTamThreshold) {
        level = 'HIGH';
        reasons.push(`TAMs: ${boat.tamPastDue}`);
    }

    // If not already HIGH, check MEDIUM criteria
    if (level !== 'HIGH') {
        // MED RISK: 2 or more of the following conditions
        let medConditionCount = 0;
        const medReasons = [];

        // Condition 1: Any enclave VPH > 3.5 (or threshold med_ra_vph) - skip NIPR for NMCI
        const vphThreshold = thresholds.med_ra_vph || 3.5;
        if (!isNmci && boat.vramNiprRaVph !== null && boat.vramNiprRaVph > vphThreshold) {
            medConditionCount++;
            medReasons.push(`NIPR VPH: ${boat.vramNiprRaVph.toFixed(2)}`);
        }
        if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph > vphThreshold) {
            medConditionCount++;
            medReasons.push(`SIPR VPH: ${boat.vramSiprRaVph.toFixed(2)}`);
        }

        // Condition 2: Product Compliance - always enabled - skip NIPR for NMCI
        const complianceThreshold = thresholds.med_ess_compliance || 95;
        if (!isNmci && boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < complianceThreshold) {
            medConditionCount++;
            medReasons.push(`NIPR Prod: ${boat.essNiprProductCompliance.toFixed(1)}%`);
        }
        if (boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < complianceThreshold) {
            medConditionCount++;
            medReasons.push(`SIPR Prod: ${boat.essSiprProductCompliance.toFixed(1)}%`);
        }

        // Condition 2b: True Policy compliance check (toggleable) - skip NIPR for NMCI
        const truePolicyThreshold = thresholds.med_true_policy_compliance || 0;
        if (truePolicyThreshold > 0) {
            if (!isNmci && boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < truePolicyThreshold) {
                medConditionCount++;
                medReasons.push(`NIPR True Policy: ${boat.essNiprTruePolicy.toFixed(1)}%`);
            }
            if (boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < truePolicyThreshold) {
                medConditionCount++;
                medReasons.push(`SIPR True Policy: ${boat.essSiprTruePolicy.toFixed(1)}%`);
            }
        }

        // Condition 2c: Raw Policy compliance check (toggleable) - skip NIPR for NMCI
        const rawPolicyThreshold = thresholds.med_raw_policy_compliance || 0;
        if (rawPolicyThreshold > 0) {
            if (!isNmci && boat.essNiprPolicyEnforced !== null && boat.essNiprPolicyEnforced < rawPolicyThreshold) {
                medConditionCount++;
                medReasons.push(`NIPR Raw Policy: ${boat.essNiprPolicyEnforced.toFixed(1)}%`);
            }
            if (boat.essSiprPolicyEnforced !== null && boat.essSiprPolicyEnforced < rawPolicyThreshold) {
                medConditionCount++;
                medReasons.push(`SIPR Raw Policy: ${boat.essSiprPolicyEnforced.toFixed(1)}%`);
            }
        }

        // Condition 3: Any enclave with scan greater than 14 days - skip NIPR for NMCI
        const scanThreshold = thresholds.med_scan_age_days || 14;
        if (!isNmci && nAge !== null && nAge > scanThreshold) {
            medConditionCount++;
            medReasons.push(`NIPR Scan: ${nAge}d`);
        }
        if (sAge !== null && sAge > scanThreshold) {
            medConditionCount++;
            medReasons.push(`SIPR Scan: ${sAge}d`);
        }

        // Condition 4: TAMs past due > 10 (or threshold med_tam_past_due)
        const tamThreshold = thresholds.med_tam_past_due || 10;
        if ((boat.tamPastDue || 0) > tamThreshold) {
            medConditionCount++;
            medReasons.push(`TAMs: ${boat.tamPastDue}`);
        }

        // If 2 or more conditions, it's MED risk
        if (medConditionCount >= 2) {
            level = 'MED';
            reasons.push(...medReasons);
        } else if (medConditionCount === 1) {
            // Still track single condition issues but remain LOW
            // (unless VPH is above the higher threshold)
        }

        // Note: Per risk criteria, HIGH is ONLY for breakfix or no VRAM data
        // VPH conditions only contribute to MED risk threshold calculation
    }

    // Check if LOW risk criteria are actually met (for reporting purposes)
    // LOW: VPH <2.5, Product >=95%, TruePolicy >=95% (if enabled), RawPolicy >=95% (if enabled),
    //      Scans within 14 days, TAM <=5 (if enabled), no breakfix
    if (level === 'LOW') {
        const lowVphThreshold = thresholds.low_vph || 2.5;
        const lowProductThreshold = thresholds.low_product_compliance || 95;
        const lowTruePolicyThreshold = thresholds.low_true_policy_compliance || 95;
        const lowRawPolicyThreshold = thresholds.low_raw_policy_compliance || 95;
        const lowScanThreshold = thresholds.low_scan_age_days || 14;
        const lowTamThreshold = thresholds.low_tam_past_due || 5;

        // LOW criteria toggles (Product always enabled for LOW)
        const productCompEnabled = true; // Always required for LOW
        const truePolicyEnabled = (thresholds.low_true_policy_compliance_enabled ?? 0) === 1;
        const rawPolicyEnabled = (thresholds.low_raw_policy_compliance_enabled ?? 0) === 1;
        const tamEnabled = (thresholds.low_tam_past_due_enabled ?? 0) === 1;

        // Verify LOW criteria
        let meetsLowCriteria = true;

        // VPH check (always enabled)
        if (boat.vramNiprRaVph !== null && boat.vramNiprRaVph >= lowVphThreshold) meetsLowCriteria = false;
        if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph >= lowVphThreshold) meetsLowCriteria = false;

        // Product compliance check (always enabled)
        if (productCompEnabled) {
            if (boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < lowProductThreshold) meetsLowCriteria = false;
            if (boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < lowProductThreshold) meetsLowCriteria = false;
        }

        // True policy compliance check (if enabled)
        if (truePolicyEnabled) {
            if (boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < lowTruePolicyThreshold) meetsLowCriteria = false;
            if (boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < lowTruePolicyThreshold) meetsLowCriteria = false;
        }

        // Raw policy compliance check (if enabled)
        if (rawPolicyEnabled) {
            if (boat.essNiprPolicyEnforced !== null && boat.essNiprPolicyEnforced < lowRawPolicyThreshold) meetsLowCriteria = false;
            if (boat.essSiprPolicyEnforced !== null && boat.essSiprPolicyEnforced < lowRawPolicyThreshold) meetsLowCriteria = false;
        }

        // Scan age check (always enabled)
        if (nAge !== null && nAge > lowScanThreshold) meetsLowCriteria = false;
        if (sAge !== null && sAge > lowScanThreshold) meetsLowCriteria = false;

        // TAM past due check (if enabled)
        if (tamEnabled && (boat.tamPastDue || 0) > lowTamThreshold) meetsLowCriteria = false;

        if (!meetsLowCriteria) {
            // Upgrade to MED if doesn't meet LOW criteria but not bad enough for HIGH
            level = 'MED';
            if (boat.vramNiprRaVph !== null && boat.vramNiprRaVph >= lowVphThreshold) reasons.push(`NIPR VPH: ${boat.vramNiprRaVph.toFixed(2)}`);
            if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph >= lowVphThreshold) reasons.push(`SIPR VPH: ${boat.vramSiprRaVph.toFixed(2)}`);
            if (productCompEnabled && boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < lowProductThreshold) reasons.push(`NIPR Prod: ${boat.essNiprProductCompliance.toFixed(1)}%`);
            if (productCompEnabled && boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < lowProductThreshold) reasons.push(`SIPR Prod: ${boat.essSiprProductCompliance.toFixed(1)}%`);
            if (truePolicyEnabled && boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < lowTruePolicyThreshold) reasons.push(`NIPR TruePolicy: ${boat.essNiprTruePolicy.toFixed(1)}%`);
            if (truePolicyEnabled && boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < lowTruePolicyThreshold) reasons.push(`SIPR TruePolicy: ${boat.essSiprTruePolicy.toFixed(1)}%`);
            if (rawPolicyEnabled && boat.essNiprPolicyEnforced !== null && boat.essNiprPolicyEnforced < lowRawPolicyThreshold) reasons.push(`NIPR RawPolicy: ${boat.essNiprPolicyEnforced.toFixed(1)}%`);
            if (rawPolicyEnabled && boat.essSiprPolicyEnforced !== null && boat.essSiprPolicyEnforced < lowRawPolicyThreshold) reasons.push(`SIPR RawPolicy: ${boat.essSiprPolicyEnforced.toFixed(1)}%`);
            if (nAge !== null && nAge > lowScanThreshold) reasons.push(`NIPR Scan: ${nAge}d`);
            if (sAge !== null && sAge > lowScanThreshold) reasons.push(`SIPR Scan: ${sAge}d`);
            if (tamEnabled && (boat.tamPastDue || 0) > lowTamThreshold) reasons.push(`TAMs: ${boat.tamPastDue}`);
        }
    }

    // Scan Exempt Logic:
    // - For NMCI boats: Only apply exemption if BOTH NIPR AND SIPR are exempt
    //   (If only NIPR is exempt, ignore it since NMCI doesn't use NIPR)
    // - For non-NMCI boats: Apply exemption if either enclave is exempt
    // - Only downgrades HIGH to MED if HIGH was SOLELY due to no VRAM data
    // - Breakfix or other HIGH reasons are NOT overridden by Scan Exempt
    if (level === 'HIGH') {
        let isScanExempt = false;
        if (boat.isNmci) {
            // NMCI boats: only exempt if BOTH enclaves are exempt
            // (since NMCI doesn't use NIPR, only NIPR exempt = not truly exempt)
            isScanExempt = boat.vramNiprScanExempt && boat.vramSiprScanExempt;
        } else {
            // Non-NMCI boats: exempt if either enclave is exempt
            isScanExempt = boat.vramNiprScanExempt || boat.vramSiprScanExempt;
        }

        if (isScanExempt && highDueToNoScans && reasons.every(r => r.includes('VRAM data'))) {
            level = 'MED';
            reasons.push('Scan Exempt');
        }
    }

    return { level, reasons };
};

const calculateAllRisks = (boats, thresholds) => { for (const b of boats) { const { level, reasons } = calculateRisk(b, thresholds); b.riskLevel = level; b.riskReasons = reasons; } return boats; };

// Aggregations
const aggregateByISIC = (boats, settings) => {
    const groups = {};
    for (const b of boats) {
        if (!groups[b.isic]) { const info = settings.isics.find(i => i.isic_name === b.isic) || { isic_name: b.isic, isic_short: b.isic.slice(0,6), tycom: b.tycom }; groups[b.isic] = { ...info, boats: [] }; }
        groups[b.isic].boats.push(b);
    }
    const aggs = Object.values(groups).map(g => {
        let nProdSum = 0, nProdCnt = 0, nPolSum = 0, nPolCnt = 0, nPolRawSum = 0, nPolRawCnt = 0;
        let sProdSum = 0, sProdCnt = 0, sPolSum = 0, sPolCnt = 0, sPolRawSum = 0, sPolRawCnt = 0;
        const agg = { isicName: g.isic_name, isicShort: g.isic_short, tycom: g.tycom, boatCount: g.boats.length, niprBreakfixSum: 0, siprBreakfixSum: 0, highRiskCount: 0, scanExemptCount: 0, niprProdCompAvg: 0, niprPolEnfAvg: 0, niprPolRawAvg: 0, siprProdCompAvg: 0, siprPolEnfAvg: 0, siprPolRawAvg: 0 };
        for (const b of g.boats) {
            // Skip NIPR values for NMCI boats
            if (!b.isNmci) {
                agg.niprBreakfixSum += b.essNiprBreakfix || 0;
                if (b.essNiprProductCompliance !== null) { nProdSum += b.essNiprProductCompliance; nProdCnt++; }
                if (b.essNiprTruePolicy !== null) { nPolSum += b.essNiprTruePolicy; nPolCnt++; }
                if (b.essNiprPolicyEnforced !== null) { nPolRawSum += b.essNiprPolicyEnforced; nPolRawCnt++; }
            }
            agg.siprBreakfixSum += b.essSiprBreakfix || 0;
            if (b.essSiprProductCompliance !== null) { sProdSum += b.essSiprProductCompliance; sProdCnt++; }
            if (b.essSiprTruePolicy !== null) { sPolSum += b.essSiprTruePolicy; sPolCnt++; }
            if (b.essSiprPolicyEnforced !== null) { sPolRawSum += b.essSiprPolicyEnforced; sPolRawCnt++; }
            if (b.riskLevel === 'HIGH') agg.highRiskCount++;
            if (b.vramNiprScanExempt || b.vramSiprScanExempt) agg.scanExemptCount++;
        }
        agg.niprProdCompAvg = nProdCnt > 0 ? Math.min(100, nProdSum / nProdCnt) : 0;
        agg.niprPolEnfAvg = nPolCnt > 0 ? Math.min(100, nPolSum / nPolCnt) : 0;
        agg.niprPolRawAvg = nPolRawCnt > 0 ? Math.min(100, nPolRawSum / nPolRawCnt) : 0;
        agg.siprProdCompAvg = sProdCnt > 0 ? Math.min(100, sProdSum / sProdCnt) : 0;
        agg.siprPolEnfAvg = sPolCnt > 0 ? Math.min(100, sPolSum / sPolCnt) : 0;
        agg.siprPolRawAvg = sPolRawCnt > 0 ? Math.min(100, sPolRawSum / sPolRawCnt) : 0;
        return agg;
    });
    return { csl: aggs.filter(a => a.tycom === 'CSL'), csp: aggs.filter(a => a.tycom === 'CSP') };
};

// Encoding
const compressAndEncode = (data) => { const json = JSON.stringify(data); const b64 = btoa(unescape(encodeURIComponent(json))); let h = 0; for (let i = 0; i < json.length; i++) { h = ((h << 5) - h) + json.charCodeAt(i); h &= h; } return Math.abs(h).toString(16) + ':' + b64; };
const decodeAndDecompress = (str) => { const [hash, b64] = str.split(':'); const json = decodeURIComponent(escape(atob(b64))); const data = JSON.parse(json); let h = 0; for (let i = 0; i < json.length; i++) { h = ((h << 5) - h) + json.charCodeAt(i); h &= h; } return { data, valid: Math.abs(h).toString(16) === hash }; };

// Import Report
const importReportHTML = async (file) => new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const match = e.target.result.match(/<script type="application\/x-dashboard-report">([\s\S]*?)<\/script>/);
            if (!match) { resolve({ error: 'No embedded data' }); return; }
            const { data, valid } = decodeAndDecompress(match[1].trim());
            data.reportData.version++; data.reportData.lastModifiedAt = new Date().toISOString();
            resolve({ reportData: data.reportData, settings: data.settingsSnapshot, valid, error: null });
        } catch (err) { resolve({ error: err.message }); }
    };
    reader.readAsText(file);
});

// Report Generator
const generateReportHTML = (reportData, settings) => {
    const { boats } = reportData; const aggs = aggregateByISIC(boats, settings);
    const groupByISIC = (list) => { const g = {}; for (const b of list) { if (!g[b.isic]) g[b.isic] = []; g[b.isic].push(b); } return g; };
    const cslBoats = boats.filter(b => b.tycom === 'CSL'); const cspBoats = boats.filter(b => b.tycom === 'CSP');
    const cslByISIC = groupByISIC(cslBoats); const cspByISIC = groupByISIC(cspBoats);
    const embedded = compressAndEncode({ reportData, settingsSnapshot: settings, generatedAt: new Date().toISOString() });

    const fmt = (v, d=0) => v == null ? '-' : (d > 0 ? v.toFixed(d) : Math.round(v).toString());
    const fmtPct = (v) => v == null ? '-' : Math.min(100, v).toFixed(1) + '%';
    const fmtDate = (d) => d ? `${new Date(d).getMonth()+1}/${new Date(d).getDate()}` : '-';
    // ===================================================================================
    // COLOR CLASSIFICATION FUNCTIONS
    // ===================================================================================
    // Boundary Behavior: "Boundary Gets Better Color"
    // - Values exactly on a threshold boundary are assigned the better/healthier color
    // - For compliance metrics (higher is better): boundary value gets the better color
    //   Example: If green >= 95 and red < 90, then 95 = GREEN, 90 = YELLOW (not red)
    // - For VPH (lower is better): boundary value gets the better color
    //   Example: If green <= 2.5 and red > 3.5, then 2.5 = GREEN, 3.5 = YELLOW (not red)
    // ===================================================================================
    const sth = settings.thresholds || defaultThresholds;

    // Product Compliance (higher is better):
    //   GREEN: value >= green_threshold (e.g., >= 95)
    //   RED:   value < red_threshold (e.g., < 90)
    //   YELLOW: red_threshold <= value < green_threshold (e.g., 90-94.99)
    const prodCompClass = (v) => v === null ? '' : v >= (sth.color_product_green || 95) ? 'risk-low' : v < (sth.color_product_red || 90) ? 'risk-high' : 'risk-med';

    // Policy Compliance / True Policy (higher is better):
    //   GREEN: value >= green_threshold | RED: value < red_threshold | YELLOW: between
    const policyCompClass = (v) => v === null ? '' : v >= (sth.color_policy_green || 95) ? 'risk-low' : v < (sth.color_policy_red || 90) ? 'risk-high' : 'risk-med';

    // Policy Enforced Raw (higher is better):
    //   GREEN: value >= green_threshold | RED: value < red_threshold | YELLOW: between
    const policyRawClass = (v) => v === null ? '' : v >= (sth.color_policy_raw_green || 95) ? 'risk-low' : v < (sth.color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';

    // Generic compliance class (backward compat)
    const compClass = prodCompClass;

    // VPH - Vulnerabilities Per Host (lower is better):
    //   GREEN: value <= green_threshold (e.g., <= 2.5) - boundary gets better color
    //   RED:   value > red_threshold (e.g., > 3.5) - boundary gets better color
    //   YELLOW: green_threshold < value <= red_threshold (e.g., 2.51-3.5)
    const vphClass = (v) => v === null ? '' : v <= (sth.color_vph_green || 2.5) ? 'risk-low' : v > (sth.color_vph_red || 3.5) ? 'risk-high' : 'risk-med';

    // Scan Age in days (lower is better):
    //   GREEN: age <= green_threshold (e.g., <= 14 days)
    //   RED:   age > red_threshold (e.g., > 14 days)
    //   YELLOW: between (if thresholds differ)
    const scanAgeClass = (d) => {
        if (!d) return 'risk-high';
        const date = new Date(d);
        if (isNaN(date.getTime())) return 'risk-high';
        const age = Math.floor((new Date() - date) / 86400000);
        return age <= (sth.color_scan_green || 14) ? 'risk-low' : age > (sth.color_scan_red || 14) ? 'risk-high' : 'risk-med';
    };

    // Scan Integrity % (higher is better):
    //   GREEN: value >= green_threshold | RED: value < red_threshold | YELLOW: between
    const integrityClass = (v) => v === null ? '' : v >= (sth.color_integrity_green || 95) ? 'risk-low' : v < (sth.color_integrity_red || 90) ? 'risk-high' : 'risk-med';

    // Percent Scanned % (higher is better):
    //   GREEN: value >= green_threshold | RED: value < red_threshold | YELLOW: between
    const scannedClass = (v) => v === null ? '' : v >= (sth.color_scanned_green || 95) ? 'risk-low' : v < (sth.color_scanned_red || 90) ? 'risk-high' : 'risk-med';

    // Generate dynamic legend based on active thresholds (always up-to-date with risk equation)
    const dynamicLegend = generateDynamicLegend(settings.thresholds);
    // Use dynamic legend for reports (ignores custom legendText since it should always reflect active equation)
    const legendText = dynamicLegend;
    const formatLegend = (text) => {
        // For dynamic legend, text is already formatted, just escape HTML
        return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    };

    // Help modal text (? button content) - use dynamic generation to reflect current thresholds
    const helpModalText = generateDynamicHelpModal(settings.thresholds);
    const formatHelpText = (text) => {
        if (!text) return '';
        return text.replace(/\{(\w+)\}/g, (match, key) => {
            return settings.thresholds[key] !== undefined ? settings.thresholds[key] : match;
        });
    };

    // Stats for analytics
    const riskCounts = { HIGH: boats.filter(b => b.riskLevel === 'HIGH').length, MED: boats.filter(b => b.riskLevel === 'MED').length, LOW: boats.filter(b => b.riskLevel === 'LOW').length };
    const cslRiskCounts = { HIGH: cslBoats.filter(b => b.riskLevel === 'HIGH').length, MED: cslBoats.filter(b => b.riskLevel === 'MED').length, LOW: cslBoats.filter(b => b.riskLevel === 'LOW').length };
    const cspRiskCounts = { HIGH: cspBoats.filter(b => b.riskLevel === 'HIGH').length, MED: cspBoats.filter(b => b.riskLevel === 'MED').length, LOW: cspBoats.filter(b => b.riskLevel === 'LOW').length };
    // Avg VPH: average of all VPH values (NIPR for non-NMCI, SIPR for all) - only count non-null values
    const vphValues = boats.flatMap(b => {
        const vals = [];
        if (!b.isNmci && b.vramNiprRaVph !== null) vals.push(b.vramNiprRaVph);
        if (b.vramSiprRaVph !== null) vals.push(b.vramSiprRaVph);
        return vals;
    });
    const avgVph = vphValues.length > 0 ? (vphValues.reduce((s, v) => s + v, 0) / vphValues.length).toFixed(2) : 0;
    // Total breakfix: sum all (NIPR only for non-NMCI boats)
    const totalBreakfix = boats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
    // Avg compliance (True Policy): average of all true policy values (NIPR for non-NMCI, SIPR for all) - only count non-null
    const compValues = boats.flatMap(b => {
        const vals = [];
        if (!b.isNmci && b.essNiprTruePolicy !== null) vals.push(b.essNiprTruePolicy);
        if (b.essSiprTruePolicy !== null) vals.push(b.essSiprTruePolicy);
        return vals;
    });
    const avgCompliance = compValues.length > 0 ? Math.min(100, compValues.reduce((s, v) => s + v, 0) / compValues.length).toFixed(1) : 0;
    // Avg Product Compliance: average of product compliance values only (not true policy)
    const prodCompValues = boats.flatMap(b => {
        const vals = [];
        if (!b.isNmci && b.essNiprProductCompliance !== null) vals.push(b.essNiprProductCompliance);
        if (b.essSiprProductCompliance !== null) vals.push(b.essSiprProductCompliance);
        return vals;
    });
    const avgProductCompliance = prodCompValues.length > 0 ? Math.min(100, prodCompValues.reduce((s, v) => s + v, 0) / prodCompValues.length).toFixed(1) : 0;

    // SIPR-specific calculations
    const vphValuesSipr = boats.filter(b => b.vramSiprRaVph !== null).map(b => b.vramSiprRaVph);
    const avgVphSipr = vphValuesSipr.length > 0 ? (vphValuesSipr.reduce((s, v) => s + v, 0) / vphValuesSipr.length).toFixed(2) : 0;
    const totalBreakfixSipr = boats.reduce((s, b) => s + (b.essSiprBreakfix || 0), 0);
    const compValuesSipr = boats.filter(b => b.essSiprTruePolicy !== null).map(b => b.essSiprTruePolicy);
    const avgComplianceSipr = compValuesSipr.length > 0 ? Math.min(100, compValuesSipr.reduce((s, v) => s + v, 0) / compValuesSipr.length).toFixed(1) : 0;
    const prodCompValuesSipr = boats.filter(b => b.essSiprProductCompliance !== null).map(b => b.essSiprProductCompliance);
    const avgProductComplianceSipr = prodCompValuesSipr.length > 0 ? Math.min(100, prodCompValuesSipr.reduce((s, v) => s + v, 0) / prodCompValuesSipr.length).toFixed(1) : 0;

    // NIPR-specific calculations (exclude NMCI boats)
    const nonNmciBoats = boats.filter(b => !b.isNmci);
    const vphValuesNipr = nonNmciBoats.filter(b => b.vramNiprRaVph !== null).map(b => b.vramNiprRaVph);
    const avgVphNipr = vphValuesNipr.length > 0 ? (vphValuesNipr.reduce((s, v) => s + v, 0) / vphValuesNipr.length).toFixed(2) : 0;
    const totalBreakfixNipr = nonNmciBoats.reduce((s, b) => s + (b.essNiprBreakfix || 0), 0);
    const compValuesNipr = nonNmciBoats.filter(b => b.essNiprTruePolicy !== null).map(b => b.essNiprTruePolicy);
    const avgComplianceNipr = compValuesNipr.length > 0 ? Math.min(100, compValuesNipr.reduce((s, v) => s + v, 0) / compValuesNipr.length).toFixed(1) : 0;
    const prodCompValuesNipr = nonNmciBoats.filter(b => b.essNiprProductCompliance !== null).map(b => b.essNiprProductCompliance);
    const avgProductComplianceNipr = prodCompValuesNipr.length > 0 ? Math.min(100, prodCompValuesNipr.reduce((s, v) => s + v, 0) / prodCompValuesNipr.length).toFixed(1) : 0;

    // TYCOM data for charts (defined at outer scope so it's available for the script section)
    const tycomData = {};
    boats.forEach(b => {
        if (!tycomData[b.tycom]) tycomData[b.tycom] = {boats:0,high:0,med:0,low:0,vphVals:[],bfSum:0,compVals:[],prodCompVals:[]};
        const t=tycomData[b.tycom]; t.boats++;
        if(b.riskLevel==='HIGH')t.high++; if(b.riskLevel==='MED')t.med++; if(b.riskLevel==='LOW')t.low++;
        if (!b.isNmci && b.vramNiprRaVph !== null) t.vphVals.push(b.vramNiprRaVph);
        if (b.vramSiprRaVph !== null) t.vphVals.push(b.vramSiprRaVph);
        t.bfSum += (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);
        // True Policy values for compVals
        if (!b.isNmci && b.essNiprTruePolicy !== null) t.compVals.push(b.essNiprTruePolicy);
        if (b.essSiprTruePolicy !== null) t.compVals.push(b.essSiprTruePolicy);
        // Product Compliance values for prodCompVals
        if (!b.isNmci && b.essNiprProductCompliance !== null) t.prodCompVals.push(b.essNiprProductCompliance);
        if (b.essSiprProductCompliance !== null) t.prodCompVals.push(b.essSiprProductCompliance);
    });

    // Get label and visibility from schema config
    const schema = settings.schemaConfig || defaultSchemaConfig;
    const getLabel = (type, field, fallback) => {
        const item = schema[type]?.find(s => s.field === field);
        return item?.label || fallback;
    };
    const isVisible = (type, field) => {
        const item = schema[type]?.find(s => s.field === field);
        return item?.visible !== false;
    };

    // Custom fields for each type (visible fields not in standard list)
    const essCustomFields = getCustomFields(schema.ess, 'ess');
    const vramCustomFields = getCustomFields(schema.vram, 'vram');
    const tamCustomFields = getCustomFields(schema.tam, 'tam');

    // Get visible standard fields in schema order (excluding meta fields)
    const getVisibleStandardFields = (schemaArray, metaFields) => {
        return schemaArray.filter(f => f.visible !== false && !metaFields.includes(f.field) && standardFields[schemaArray === schema.ess ? 'ess' : schemaArray === schema.vram ? 'vram' : 'tam'].includes(f.field));
    };
    const essMetaFields = ['shipName', 'isic'];
    const vramMetaFields = ['siteName', 'scanExempt'];
    const tamMetaFields = ['boatName'];

    const essVisibleFields = getVisibleStandardFields(schema.ess, essMetaFields);
    const vramVisibleFields = getVisibleStandardFields(schema.vram, vramMetaFields);
    const tamVisibleFields = getVisibleStandardFields(schema.tam, tamMetaFields);

    // Column counts based on schema order
    const essNiprCount = essVisibleFields.length + essCustomFields.length;
    const essSiprCount = essNiprCount;
    const vramNiprCount = vramVisibleFields.length + vramCustomFields.length;
    const vramSiprCount = vramNiprCount;
    const tamCount = tamVisibleFields.length + tamCustomFields.length;
    const showVramExempt = isVisible('vram', 'scanExempt');
    const statusCount = 1 + (showVramExempt ? 1 : 0) + 1;

    // Field renderers for ESS (NIPR and SIPR)
    const essNiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.essNiprAssets)}</td>`,
        breakfix: (b) => `<td class="${(b.essNiprBreakfix||0)>0?'risk-high':''}">${fmt(b.essNiprBreakfix)}</td>`,
        productCompliance: (b) => `<td class="${prodCompClass(b.essNiprProductCompliance)}">${fmtPct(b.essNiprProductCompliance)}</td>`,
        policyEnforced: (b) => `<td class="${policyRawClass(b.essNiprPolicyEnforced)}">${fmtPct(b.essNiprPolicyEnforced)}</td>`,
        truePolicy: (b) => `<td class="${policyCompClass(b.essNiprTruePolicy)}">${fmtPct(b.essNiprTruePolicy)}</td>`
    };
    const essSiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.essSiprAssets)}</td>`,
        breakfix: (b) => `<td class="${(b.essSiprBreakfix||0)>0?'risk-high':''}">${fmt(b.essSiprBreakfix)}</td>`,
        productCompliance: (b) => `<td class="${prodCompClass(b.essSiprProductCompliance)}">${fmtPct(b.essSiprProductCompliance)}</td>`,
        policyEnforced: (b) => `<td class="${policyRawClass(b.essSiprPolicyEnforced)}">${fmtPct(b.essSiprPolicyEnforced)}</td>`,
        truePolicy: (b) => `<td class="${policyCompClass(b.essSiprTruePolicy)}">${fmtPct(b.essSiprTruePolicy)}</td>`
    };

    // Field renderers for VRAM (NIPR and SIPR)
    const vramNiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.vramNiprAssets)}</td>`,
        scanDate: (b) => `<td class="${scanAgeClass(b.vramNiprScanDate)}">${fmtDate(b.vramNiprScanDate)}</td>`,
        raVph: (b) => `<td class="${vphClass(b.vramNiprRaVph)}">${fmt(b.vramNiprRaVph,2)}</td>`,
        raCrit: (b) => `<td>${fmt(b.vramNiprRaCrit)}</td>`,
        raHigh: (b) => `<td>${fmt(b.vramNiprRaHigh)}</td>`,
        scanIntegrity: (b) => `<td class="${integrityClass(b.vramNiprScanIntegrity)}">${fmtPct(b.vramNiprScanIntegrity)}</td>`,
        scanPercent: (b) => `<td class="${scannedClass(b.vramNiprScanPercent)}">${fmtPct(b.vramNiprScanPercent)}</td>`
    };
    const vramSiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.vramSiprAssets)}</td>`,
        scanDate: (b) => `<td class="${scanAgeClass(b.vramSiprScanDate)}">${fmtDate(b.vramSiprScanDate)}</td>`,
        raVph: (b) => `<td class="${vphClass(b.vramSiprRaVph)}">${fmt(b.vramSiprRaVph,2)}</td>`,
        raCrit: (b) => `<td>${fmt(b.vramSiprRaCrit)}</td>`,
        raHigh: (b) => `<td>${fmt(b.vramSiprRaHigh)}</td>`,
        scanIntegrity: (b) => `<td class="${integrityClass(b.vramSiprScanIntegrity)}">${fmtPct(b.vramSiprScanIntegrity)}</td>`,
        scanPercent: (b) => `<td class="${scannedClass(b.vramSiprScanPercent)}">${fmtPct(b.vramSiprScanPercent)}</td>`
    };

    // Field renderers for TAM
    const tamCellRenderers = {
        pastDue: (b) => `<td class="${(b.tamPastDue||0)>10?'risk-high':''}">${fmt(b.tamPastDue)}</td>`,
        extensions: (b) => `<td>${fmt(b.tamExtensions)}</td>`
    };

    // Helper to format custom field value
    const fmtCustom = (v) => v === null || v === undefined ? '-' : (typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(2)) : String(v));

    // Helper for NMCI cell display in generated reports
    const nmciCell = `<td class="nmci-cell" style="background:#dbeafe;color:#1d4ed8;font-size:7pt;font-weight:600;">NMCI</td>`;

    const boatCells = (b) => {
        const isNmci = b.isNmci === true;
        let cells = `<td class="boat-name">${b.boatFullName || b.boatName}</td>`;
        // ESS NIPR - render in schema order (show NMCI for NMCI boats)
        for (const f of essVisibleFields) {
            const renderer = essNiprCellRenderers[f.field];
            if (renderer) cells += isNmci ? nmciCell : renderer(b);
        }
        for (const cf of essCustomFields) cells += isNmci ? nmciCell : `<td>${fmtCustom(b.customFields?.essNipr?.[cf.field])}</td>`;
        // ESS SIPR - render in schema order
        for (const f of essVisibleFields) {
            const renderer = essSiprCellRenderers[f.field];
            if (renderer) cells += renderer(b);
        }
        for (const cf of essCustomFields) cells += `<td>${fmtCustom(b.customFields?.essSipr?.[cf.field])}</td>`;
        // VRAM NIPR - render in schema order (show NMCI for NMCI boats)
        for (const f of vramVisibleFields) {
            const renderer = vramNiprCellRenderers[f.field];
            if (renderer) cells += isNmci ? nmciCell : renderer(b);
        }
        for (const cf of vramCustomFields) cells += isNmci ? nmciCell : `<td>${fmtCustom(b.customFields?.vramNipr?.[cf.field])}</td>`;
        // VRAM SIPR - render in schema order
        for (const f of vramVisibleFields) {
            const renderer = vramSiprCellRenderers[f.field];
            if (renderer) cells += renderer(b);
        }
        for (const cf of vramCustomFields) cells += `<td>${fmtCustom(b.customFields?.vramSipr?.[cf.field])}</td>`;
        // TAM - render in schema order
        for (const f of tamVisibleFields) {
            const renderer = tamCellRenderers[f.field];
            if (renderer) cells += renderer(b);
        }
        for (const cf of tamCustomFields) cells += `<td>${fmtCustom(b.customFields?.tam?.[cf.field])}</td>`;
        // Status
        cells += `<td class="risk-${b.riskLevel.toLowerCase()}">${b.riskLevel}</td>`;
        if (showVramExempt) cells += `<td class="${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'alert-blue':''}">${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'Y':'N'}</td>`;
        cells += `<td class="notes-cell" style="width:70px;min-width:70px;" title="${b.notes||''}">${b.notes||'-'}</td>`;
        return cells;
    };

    const getIsicShort = (isicName) => { const info = settings.isics.find(i => i.isic_name === isicName); return info?.isic_short || isicName.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS'); };
    const summaryTable = (byISIC) => {
        const entries = Object.entries(byISIC);
        if (entries.length === 0) return '<p>No data</p>';
        let bodyRows = '';
        for (const [isic, isicBoats] of entries) {
            isicBoats.forEach((b, i) => {
                bodyRows += `<tr class="${i === 0 ? 'isic-first-row' : ''}">`;
                if (i === 0) bodyRows += `<td rowspan="${isicBoats.length}" class="isic-cell">${getIsicShort(isic)}</td>`;
                bodyRows += boatCells(b) + '</tr>';
            });
        }
        // Build header row 1 with group spans
        let hdr1 = '<tr><th rowspan="2" class="isic-header">ISIC</th><th rowspan="2" style="width:90px">BOAT</th>';
        if (essNiprCount > 0) hdr1 += `<th colspan="${essNiprCount}" class="col-ess-n">ESS NIPR</th>`;
        if (essSiprCount > 0) hdr1 += `<th colspan="${essSiprCount}" class="col-ess-s">ESS SIPR</th>`;
        if (vramNiprCount > 0) hdr1 += `<th colspan="${vramNiprCount}" class="col-vram-n">VRAM NIPR</th>`;
        if (vramSiprCount > 0) hdr1 += `<th colspan="${vramSiprCount}" class="col-vram-s">VRAM SIPR</th>`;
        if (tamCount > 0) hdr1 += `<th colspan="${tamCount}" class="col-tam">TAM</th>`;
        hdr1 += `<th colspan="${statusCount}" class="col-status">STATUS</th></tr>`;
        // Build header row 2 with individual column names (in schema order, using label from schema config)
        let hdr2 = '<tr>';
        // ESS NIPR headers - in schema order
        for (const f of essVisibleFields) hdr2 += `<th class="col-ess-n">${f.label || f.field}</th>`;
        for (const cf of essCustomFields) hdr2 += `<th class="col-ess-n">${cf.label || cf.field}</th>`;
        // ESS SIPR headers - in schema order
        for (const f of essVisibleFields) hdr2 += `<th class="col-ess-s">${f.label || f.field}</th>`;
        for (const cf of essCustomFields) hdr2 += `<th class="col-ess-s">${cf.label || cf.field}</th>`;
        // VRAM NIPR headers - in schema order
        for (const f of vramVisibleFields) hdr2 += `<th class="col-vram-n">${f.label || f.field}</th>`;
        for (const cf of vramCustomFields) hdr2 += `<th class="col-vram-n">${cf.label || cf.field}</th>`;
        // VRAM SIPR headers - in schema order
        for (const f of vramVisibleFields) hdr2 += `<th class="col-vram-s">${f.label || f.field}</th>`;
        for (const cf of vramCustomFields) hdr2 += `<th class="col-vram-s">${cf.label || cf.field}</th>`;
        // TAM headers - in schema order
        for (const f of tamVisibleFields) hdr2 += `<th class="col-tam">${f.label || f.field}</th>`;
        for (const cf of tamCustomFields) hdr2 += `<th class="col-tam">${cf.label || cf.field}</th>`;
        // Status headers
        hdr2 += '<th class="col-status">Risk</th>';
        if (showVramExempt) hdr2 += `<th class="col-status">${getLabel('vram', 'scanExempt', 'Scan Exempt')}</th>`;
        hdr2 += '<th class="col-status" style="width:70px;min-width:70px">Notes</th></tr>';
        return `<table class="summary-table"><thead>${hdr1}${hdr2}</thead><tbody>${bodyRows}</tbody></table>`;
    };

    const allOverrides = boats.flatMap(b => (b.overrides || []).map(o => ({ ...o, boatName: b.boatName })));
    const thresholdChanges = reportData.thresholdChanges || [];
    const settingsHistory = settings._settingsHistory || [];
    const dataUpdates = reportData.dataUpdates || [];
    const hasChanges = allOverrides.length > 0 || thresholdChanges.length > 0 || settingsHistory.length > 0 || dataUpdates.length > 0;
    const changeCount = allOverrides.length + thresholdChanges.length + (settingsHistory.length > 0 ? 1 : 0) + dataUpdates.length;

    // Tab visibility helpers
    const tabConfig = settings.tabConfig || [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}];
    const isTabVisible = (id) => { const tab = tabConfig.find(t => t.id === id); return tab ? tab.visible : true; };
    const visibleTabs = tabConfig.filter(t => t.visible && (t.id !== 'changelog' || hasChanges));
    const firstVisibleTab = visibleTabs.length > 0 ? visibleTabs[0].id : 'csl';
    const pageInfo = `<div class="page-info print-only">Generated: ${new Date().toLocaleString()} by ${reportData.createdBy || 'Unknown'} | v${reportData.version}</div>`;

    // ===================================================================================
    // HQ STATUS TABLE - COLOR CLASSIFICATION FUNCTIONS
    // ===================================================================================
    // Uses same "Boundary Gets Better Color" logic as CSL/CSP tables (see above)
    // These use separate HQ-specific thresholds (hq_color_*) for independent control
    // ===================================================================================
    const th = settings.thresholds || defaultThresholds;

    // HQ Product Compliance: GREEN >= threshold, RED < threshold, YELLOW = between
    const hqProdClass = (v) => v === null ? '' : v >= (th.hq_color_product_green || 95) ? 'risk-low' : v < (th.hq_color_product_red || 90) ? 'risk-high' : 'risk-med';

    // HQ Policy Compliance: GREEN >= threshold, RED < threshold, YELLOW = between
    const hqPolicyClass = (v) => v === null ? '' : v >= (th.hq_color_policy_green || 95) ? 'risk-low' : v < (th.hq_color_policy_red || 90) ? 'risk-high' : 'risk-med';

    // HQ Policy Raw: GREEN >= threshold, RED < threshold, YELLOW = between
    const hqPolicyRawClass = (v) => v === null ? '' : v >= (th.hq_color_policy_raw_green || 95) ? 'risk-low' : v < (th.hq_color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';

    // HQ Status table with customizable metrics based on hqStatusLayout
    const hqLayout = settings.hqStatusLayout || defaultHQStatusLayout;
    const visibleHqMetrics = hqLayout.filter(m => m.visible);
    const getHqMetricRow = (metric, list) => {
        const getValue = (a) => {
            switch(metric.id) {
                case 'niprProdComp': return { value: a.niprProdCompAvg.toFixed(1) + '%', className: hqProdClass(a.niprProdCompAvg) };
                case 'niprPolEnf': return { value: a.niprPolEnfAvg.toFixed(1) + '%', className: hqPolicyClass(a.niprPolEnfAvg) };
                case 'niprPolRaw': return { value: a.niprPolRawAvg.toFixed(1) + '%', className: hqPolicyRawClass(a.niprPolRawAvg) };
                case 'niprBreakfix': return { value: a.niprBreakfixSum, className: a.niprBreakfixSum > 0 ? 'risk-high' : '' };
                case 'siprProdComp': return { value: a.siprProdCompAvg.toFixed(1) + '%', className: hqProdClass(a.siprProdCompAvg) };
                case 'siprPolEnf': return { value: a.siprPolEnfAvg.toFixed(1) + '%', className: hqPolicyClass(a.siprPolEnfAvg) };
                case 'siprPolRaw': return { value: a.siprPolRawAvg.toFixed(1) + '%', className: hqPolicyRawClass(a.siprPolRawAvg) };
                case 'siprBreakfix': return { value: a.siprBreakfixSum, className: a.siprBreakfixSum > 0 ? 'risk-high' : '' };
                case 'highRisk': return { value: a.highRiskCount, className: a.highRiskCount > 0 ? 'risk-high' : '' };
                case 'scanExempt': return { value: a.scanExemptCount, className: a.scanExemptCount > 0 ? 'alert-blue' : '' };
                default: return { value: '-', className: '' };
            }
        };
        return `<tr><td style="text-align:left;font-weight:600">${metric.label}</td>${list.map(a => { const { value, className } = getValue(a); return `<td class="${className}">${value}</td>`; }).join('')}</tr>`;
    };
    const hqTable = (list, label) => list.length === 0 ? '<p>No data</p>' : `<h3 style="font-size:11pt;margin:16px 0 8px;color:#1e293b;">${label}</h3><table class="summary-table hq-table"><thead><tr><th style="text-align:left;width:150px">Metric</th>${list.map(a=>`<th>${a.isicShort} (${a.boatCount})</th>`).join('')}</tr></thead><tbody>${visibleHqMetrics.map(m => getHqMetricRow(m, list)).join('')}</tbody></table>`;

    // High risk boats table for analytics - show max VPH across enclaves
    const highRiskBoats = boats.filter(b => b.riskLevel === 'HIGH');
    const getBoatVph = (b) => {
        const nipr = b.isNmci ? null : b.vramNiprRaVph;
        const sipr = b.vramSiprRaVph;
        if (nipr !== null && sipr !== null) return Math.max(nipr, sipr);
        return nipr !== null ? nipr : sipr;
    };
    const getBoatBreakfix = (b) => (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);
    const highRiskTable = highRiskBoats.length === 0 ? '<p style="color:#065f46;font-weight:600;">No high-risk boats</p>' : `<table class="summary-table"><thead><tr><th style="text-align:left">Boat</th><th>ISIC</th><th>VPH</th><th>Breakfix</th><th style="text-align:left">Risk Reasons</th></tr></thead><tbody>${highRiskBoats.map(b => `<tr><td style="text-align:left;font-family:monospace;font-weight:600;">${b.boatFullName || b.boatName}</td><td>${b.isic}</td><td>${fmt(getBoatVph(b),2)}</td><td class="${getBoatBreakfix(b)>0?'alert-red':''}">${getBoatBreakfix(b)}</td><td style="text-align:left;font-size:7pt;">${b.riskReasons?.join(', ') || '-'}</td></tr>`).join('')}</tbody></table>`;

    // VPH by ISIC for bar chart - use both enclaves, handle NMCI
    const isicVph = {};
    const isicVphSipr = {};
    const isicVphNipr = {};
    boats.forEach(b => {
        if (!isicVph[b.isic]) isicVph[b.isic] = [];
        if (!isicVphSipr[b.isic]) isicVphSipr[b.isic] = [];
        if (!isicVphNipr[b.isic]) isicVphNipr[b.isic] = [];
        if (!b.isNmci && b.vramNiprRaVph !== null) {
            isicVph[b.isic].push(b.vramNiprRaVph);
            isicVphNipr[b.isic].push(b.vramNiprRaVph);
        }
        if (b.vramSiprRaVph !== null) {
            isicVph[b.isic].push(b.vramSiprRaVph);
            isicVphSipr[b.isic].push(b.vramSiprRaVph);
        }
    });
    const isicVphAvg = Object.entries(isicVph).map(([isic, vphs]) => ({ isic, avg: vphs.length > 0 ? (vphs.reduce((a,b)=>a+b,0)/vphs.length).toFixed(2) : '0' }));
    const isicVphAvgSipr = Object.entries(isicVphSipr).map(([isic, vphs]) => ({ isic, avg: vphs.length > 0 ? (vphs.reduce((a,b)=>a+b,0)/vphs.length).toFixed(2) : '0' }));
    const isicVphAvgNipr = Object.entries(isicVphNipr).map(([isic, vphs]) => ({ isic, avg: vphs.length > 0 ? (vphs.reduce((a,b)=>a+b,0)/vphs.length).toFixed(2) : '0' }));

    // Get unique ISICs for analytics dropdowns and data export
    const uniqueIsics = [...new Set(boats.map(b => b.isic))].sort();

    return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Cyber Report ${new Date().toLocaleDateString()}</title>
<script src="libs/chart.min.js"><\/script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Arial,sans-serif;font-size:9pt;line-height:1.3;background:#f1f5f9}
.header{background:#1e293b;color:white;padding:12px 24px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:16pt;font-weight:600}
.header-info{font-size:9pt;opacity:0.8}
.tabs{display:flex;background:#334155;padding:0 24px}
.tab-btn{padding:12px 24px;color:#94a3b8;font-weight:500;border:none;background:none;cursor:pointer;border-bottom:3px solid transparent}
.tab-btn:hover{color:white}
.tab-btn.active{color:white;border-bottom-color:#0ea5e9;background:#1e293b}
.tab-content{display:none;padding:24px;max-width:95vw;margin:0 auto}
.tab-content.active{display:block}
.page{background:white;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px}
.page-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #e2e8f0;padding-bottom:12px;margin-bottom:16px}
.page-header h2{font-size:14pt;color:#1e293b}
.toolbar{display:flex;gap:8px;align-items:center}
.toolbar button{background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:9pt}
.toolbar button:hover{background:#2563eb}
.toolbar button.purple{background:#7c3aed}
.toolbar button.purple:hover{background:#6d28d9}
.legend{display:flex;gap:16px;margin-bottom:12px;font-size:8pt;flex-wrap:wrap}
.legend span{display:flex;align-items:center;gap:4px}
.legend-box{width:14px;height:14px;border:1px solid #333;display:inline-block}
.risk-criteria{font-size:7pt;color:#475569;margin-bottom:12px;padding:8px 12px;background:#f8fafc;border-radius:4px;border:1px solid #e2e8f0}
.risk-criteria span{padding:2px 6px;border-radius:3px;font-weight:600}
.summary-table{width:100%;border-collapse:collapse;font-size:8pt}
.summary-table th{background:#e2e8f0;color:#1e293b;font-weight:600;font-size:7pt;padding:5px 4px;text-align:center;border:1px solid #cbd5e1}
.summary-table td{padding:4px;text-align:center;border:1px solid #e2e8f0}
.summary-table td.boat-name{text-align:left;font-weight:600;font-family:monospace;background:#f8fafc;white-space:normal;overflow-wrap:break-word;word-break:keep-all;max-height:36px;overflow:hidden;line-height:1.2;width:90px;min-width:90px;max-width:90px}
.summary-table .isic-header,.summary-table .isic-cell{background:#1e293b;color:white;font-weight:700;text-align:center;writing-mode:vertical-rl;text-orientation:mixed;transform:rotate(180deg);padding:4px 2px;font-size:7pt;width:20px;min-width:20px;max-width:20px}
.summary-table td.notes-cell{white-space:normal;overflow-wrap:break-word;word-break:keep-all;max-height:36px;overflow:hidden;line-height:1.2;text-align:left;width:70px;min-width:70px;max-width:70px}
.summary-table .isic-first-row td{border-top:2px solid #1e293b}
.col-ess-n{background:rgba(59,130,246,0.2)!important}.col-ess-s{background:rgba(99,102,241,0.2)!important}
.col-vram-n{background:rgba(249,115,22,0.2)!important}.col-vram-s{background:rgba(234,88,12,0.2)!important}
.col-ra{background:rgba(168,85,247,0.2)!important}.col-tam{background:rgba(107,114,128,0.2)!important}.col-status{background:rgba(16,185,129,0.2)!important}
.risk-high{background:#fee2e2!important;color:#991b1b!important;font-weight:bold}
.risk-med{background:#fef3c7!important;color:#92400e!important;font-weight:bold}
.risk-low{background:#d1fae5!important;color:#065f46!important}
.alert-red{background:#fee2e2!important}.alert-amber{background:#fef3c7!important}.alert-blue{background:#dbeafe!important}
.hq-table{font-size:11pt}
.hq-table th{font-size:10pt;padding:10px 12px}
.hq-table td{padding:8px 12px;font-size:11pt}
.hq-table th:first-child,.hq-table td:first-child{text-align:left;white-space:normal;word-wrap:break-word;min-width:120px}
.stat-cards{display:grid;gap:16px;margin-bottom:24px;width:100%}
.stat-card{background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.stat-card h3{font-size:10pt;color:#64748b;margin-bottom:8px}
.stat-card .value{font-size:28pt;font-weight:700;color:#1e293b}
.stat-card .value.high{color:#dc2626}.stat-card .value.med{color:#d97706}.stat-card .value.low{color:#059669}
.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:24px}
.chart-box{background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;flex-direction:column;height:100%}
.chart-box h3{font-size:11pt;color:#1e293b;margin-bottom:16px;border-bottom:1px solid #e2e8f0;padding-bottom:8px}
.rankings-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;width:100%}
.ranking-box{background:white;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;overflow:hidden}
.ranking-box.wide{grid-column:1/-1}
.ranking-box h4{font-size:10pt;color:#0891b2;margin:0 0 12px 0;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.ranking-box .mini-table{width:100%;table-layout:fixed}
.ranking-box .mini-table td,.ranking-box .mini-table th{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mini-table{width:100%;border-collapse:collapse;font-size:9pt}
.mini-table th{background:#f1f5f9;padding:6px 8px;text-align:left;font-weight:600;color:#475569;border-bottom:1px solid #e2e8f0}
.mini-table td{padding:5px 8px;border-bottom:1px solid #f1f5f9}
.mini-table tr:last-child td{border-bottom:none}
.high-risk-table{}
.high-risk-table .reason-cell{white-space:normal;word-wrap:break-word;overflow-wrap:break-word;font-size:9pt}
.print-only{display:none}
.print-header{padding:0;margin-bottom:16px}
.print-header h1{font-size:14pt;font-weight:600;color:#1e293b;margin-bottom:4px}
.print-header .date{font-size:9pt;color:#475569}
.page-info{font-size:9pt;color:#475569;margin-bottom:8px}
@media print{
    .no-print{display:none!important}
    .print-only{display:block!important}
    body{background:white;-webkit-print-color-adjust:exact;print-color-adjust:exact;font-size:11pt!important}
    .tab-content{display:none!important;padding:8px}
    .tab-content.print-active{display:block!important}
    .page{box-shadow:none;margin:0 0 10px 0;page-break-inside:avoid;border:none;padding:8px;overflow:visible!important}
    .isic-section{page-break-inside:avoid}
    /* Analytics grid - auto-fit rows to content */
    .analytics-grid{display:grid!important;grid-template-columns:repeat(4,1fr)!important;gap:8px!important;grid-auto-rows:auto!important;width:100%!important;box-sizing:border-box!important}
    .stat-cards{display:grid!important;gap:8px!important}
    .stat-card{padding:8px!important;page-break-inside:avoid;overflow:visible!important;height:auto!important}
    .stat-card h3{font-size:10pt!important;margin-bottom:4px!important}
    .stat-card .value{font-size:18pt!important}
    .chart-grid{display:grid!important;grid-template-columns:repeat(2,1fr)!important;gap:8px!important}
    /* Chart containers */
    .chart-box{page-break-inside:avoid;padding:8px!important;overflow:hidden!important;box-sizing:border-box!important;max-width:100%!important}
    .chart-box h3{font-size:11pt!important;margin-bottom:6px!important}
    .chart-box > div{overflow:hidden!important;max-width:100%!important;box-sizing:border-box!important}
    .chart-box canvas{max-width:100%!important;width:100%!important}
    /* Horizontal bar charts need constrained width */
    .horizontal-chart{max-width:100%!important;width:100%!important;box-sizing:border-box!important}
    .horizontal-chart canvas{max-width:100%!important}
    .rankings-grid{display:grid!important;grid-template-columns:repeat(3,1fr)!important;gap:8px!important;width:100%!important}
    .ranking-box{padding:8px!important;page-break-inside:avoid;overflow:visible!important;box-sizing:border-box!important}
    .ranking-box h4{font-size:10pt!important;margin-bottom:4px!important}
    .mini-table{font-size:9pt!important;width:100%!important;table-layout:fixed!important}
    .mini-table th,.mini-table td{padding:3px 4px!important;overflow:hidden!important;text-overflow:ellipsis!important;white-space:nowrap!important}
    .high-risk-table{max-height:none!important;overflow:visible!important}
    .high-risk-table .reason-cell{white-space:normal!important;word-wrap:break-word!important;overflow-wrap:break-word!important;text-overflow:clip!important}
    .summary-table{font-size:6pt!important;width:100%!important;table-layout:fixed!important}
    .summary-table th{padding:2px 1px!important;font-size:5pt!important;overflow:hidden!important;text-overflow:ellipsis!important}
    .summary-table td{padding:2px 1px!important;overflow:hidden!important;text-overflow:ellipsis!important;white-space:nowrap!important}
    .summary-table td.boat-name{white-space:normal!important;overflow-wrap:break-word!important;word-break:keep-all!important;max-height:36px!important;line-height:1.2!important;width:70px!important;min-width:70px!important;max-width:70px!important}
    .summary-table td.notes-cell{white-space:normal!important;overflow-wrap:break-word!important;word-break:keep-all!important;max-height:36px!important;line-height:1.2!important;width:70px!important;min-width:70px!important;max-width:70px!important}
    .summary-table .isic-first-row td{border-top:2px solid #1e293b!important}
    .summary-table .isic-header,.summary-table .isic-cell{font-size:5pt!important;width:16px!important;min-width:16px!important;max-width:16px!important;padding:2px 1px!important}
    /* Keep table header with table body - prevent splitting */
    .summary-table thead{display:table-header-group!important}
    .summary-table tbody{display:table-row-group!important}
    .summary-table tr{page-break-inside:avoid!important;break-inside:avoid!important}
    .hq-table{font-size:8pt!important}
    .hq-table th{font-size:7pt!important;padding:4px 6px!important}
    .hq-table td{font-size:8pt!important;padding:4px 6px!important}
    .hq-table th:first-child,.hq-table td:first-child{white-space:normal!important;word-wrap:break-word!important;min-width:100px!important;max-width:150px!important}
    .page-header{page-break-after:avoid!important;break-after:avoid!important}
    .page-header + .table-wrapper,.page-header + div{page-break-before:avoid!important;break-before:avoid!important}
    .table-wrapper{page-break-inside:auto!important}
    h2{font-size:14pt!important;page-break-after:avoid!important}
    h3{font-size:12pt!important;page-break-after:avoid!important}
    .legend-box{page-break-inside:avoid!important;break-inside:avoid!important}
}
@media print and (orientation:landscape){
    .chart-grid{grid-template-columns:repeat(2,1fr)!important}
    .stat-cards{grid-template-columns:repeat(4,1fr)!important}
}
@page{margin:0.25in 0 0 0;size:landscape}
</style></head><body>
<div class="header no-print">
<div><h1>SUBFOR Cyber Risk Dashboard</h1><div class="header-info">Generated: ${new Date().toLocaleString()} by ${reportData.createdBy || 'Unknown'} | v${reportData.version}</div></div>
<button onclick="showHelpModal()" style="background:#64748b;color:white;border:none;padding:10px 16px;border-radius:6px;font-weight:600;cursor:pointer;" title="Calculation Help">?</button>
</div>
<div class="tabs no-print">
${tabConfig.filter(t => t.visible && (t.id !== 'changelog' || hasChanges)).map((t, i) => `<button class="tab-btn${i===0?' active':''}" onclick="showTab('${t.id}')">${t.id === 'changelog' ? `Changes (${changeCount})` : t.label}</button>`).join('')}
</div>

${isTabVisible('csl') ? `<div id="tab-csl" class="tab-content${firstVisibleTab==='csl'?' active':''}">
<div class="page">
<div class="page-header no-print">
<h2>CSL Cyber Summary</h2>
<div class="toolbar">
<select onchange="filterISIC('csl',this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;">
<option value="">All Squadrons</option>${Object.keys(cslByISIC).map(i=>`<option value="${getIsicShort(i)}">${getIsicShort(i)}</option>`).join('')}
</select>
<button onclick="showPrintScaleModal('csl')">Print CSL</button>
</div>
</div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">CSL Cyber Summary</h2>
${pageInfo}
<div class="legend"><span><span class="legend-box risk-high"></span>High</span><span><span class="legend-box risk-med"></span>Med</span><span><span class="legend-box risk-low"></span>Low</span><span><span class="legend-box alert-red"></span>Critical</span><span><span class="legend-box alert-blue"></span>Exempt</span></div>
<div class="risk-criteria">
<strong>Risk Criteria:</strong>
<span class="risk-high">HIGH</span> = ${formatLegend(legendText.high)}
&nbsp;|&nbsp;
<span class="risk-med">MED</span> = ${formatLegend(legendText.med)}
&nbsp;|&nbsp;
<span class="risk-low">LOW</span> = ${formatLegend(legendText.low)}
</div>
<div id="csl-content">${summaryTable(cslByISIC)}</div>
</div>
</div>` : ''}

${isTabVisible('csp') ? `<div id="tab-csp" class="tab-content${firstVisibleTab==='csp'?' active':''}">
<div class="page">
<div class="page-header no-print">
<h2>CSP Cyber Summary</h2>
<div class="toolbar">
<select onchange="filterISIC('csp',this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;">
<option value="">All Squadrons</option>${Object.keys(cspByISIC).map(i=>`<option value="${getIsicShort(i)}">${getIsicShort(i)}</option>`).join('')}
</select>
<button onclick="showPrintScaleModal('csp')">Print CSP</button>
</div>
</div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">CSP Cyber Summary</h2>
${pageInfo}
<div class="legend"><span><span class="legend-box risk-high"></span>High</span><span><span class="legend-box risk-med"></span>Med</span><span><span class="legend-box risk-low"></span>Low</span><span><span class="legend-box alert-red"></span>Critical</span><span><span class="legend-box alert-blue"></span>Exempt</span></div>
<div class="risk-criteria">
<strong>Risk Criteria:</strong>
<span class="risk-high">HIGH</span> = ${formatLegend(legendText.high)}
&nbsp;|&nbsp;
<span class="risk-med">MED</span> = ${formatLegend(legendText.med)}
&nbsp;|&nbsp;
<span class="risk-low">LOW</span> = ${formatLegend(legendText.low)}
</div>
<div id="csp-content">${summaryTable(cspByISIC)}</div>
</div>
</div>` : ''}

${isTabVisible('hq') ? `<div id="tab-hq" class="tab-content${firstVisibleTab==='hq'?' active':''}">
<div class="page">
<div class="page-header no-print">
<h2>HQ Cyber Status</h2>
<div class="toolbar"><button onclick="showPrintScaleModal('hq')">Print HQ Status</button></div>
</div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">HQ Cyber Status</h2>
${pageInfo}
${hqTable(aggs.csl, 'CSL Status')}
${hqTable(aggs.csp, 'CSP Status')}
</div>
</div>` : ''}

${isTabVisible('analytics') ? (() => {
    // Use analyticsLayout for visibility and positioning
    const al = settings.analyticsLayout || defaultAnalyticsLayout;
    const getLayoutItem = (id) => al.find(item => item.id === id);
    const isInLayout = (id) => al.some(item => item.id === id);
    const scanExemptCount = boats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length;

    // Helper functions for boat data
    const getBoatMaxVph = (b) => {
        const nipr = b.isNmci ? null : b.vramNiprRaVph;
        const sipr = b.vramSiprRaVph;
        if (nipr !== null && sipr !== null) return Math.max(nipr, sipr);
        return nipr !== null ? nipr : sipr;
    };
    const getBoatMinCompliance = (b) => {
        const nipr = b.isNmci ? null : b.essNiprTruePolicy;
        const sipr = b.essSiprTruePolicy;
        if (nipr !== null && sipr !== null) return Math.min(nipr, sipr);
        return nipr !== null ? nipr : sipr;
    };
    const getBoatTotalBreakfix = (b) => (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);

    // ISIC data for rankings
    const isicData = Object.entries(groupByISIC(boats)).map(([isic, ib]) => {
        const vphVals = ib.flatMap(b => {
            const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph);
            if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v;
        });
        const compVals = ib.flatMap(b => {
            const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy);
            if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v;
        });
        return {isic, boats: ib.length, high: ib.filter(b=>b.riskLevel==='HIGH').length, med: ib.filter(b=>b.riskLevel==='MED').length, low: ib.filter(b=>b.riskLevel==='LOW').length, lowPct: ib.length ? (ib.filter(b=>b.riskLevel==='LOW').length/ib.length*100) : 0, avgVph: vphVals.length > 0 ? vphVals.reduce((s,v)=>s+v,0)/vphVals.length : 0, avgComp: compVals.length > 0 ? Math.min(100, compVals.reduce((s,v)=>s+v,0)/compVals.length) : 0};
    });

    // Pie chart using CSS conic-gradient
    const total = boats.length || 1;
    const highPct = (riskCounts.HIGH / total) * 100;
    const medPct = (riskCounts.MED / total) * 100;
    const pieGradient = `conic-gradient(#dc2626 0% ${highPct}%, #d97706 ${highPct}% ${highPct + medPct}%, #059669 ${highPct + medPct}% 100%)`;

    // TYCOM data
    const tycomData = {};
    boats.forEach(b => {
        if (!tycomData[b.tycom]) tycomData[b.tycom] = {boats:0,high:0,med:0,low:0,vphVals:[],bfSum:0,compVals:[]};
        const t=tycomData[b.tycom]; t.boats++;
        if(b.riskLevel==='HIGH')t.high++; if(b.riskLevel==='MED')t.med++; if(b.riskLevel==='LOW')t.low++;
        if (!b.isNmci && b.vramNiprRaVph !== null) t.vphVals.push(b.vramNiprRaVph);
        if (b.vramSiprRaVph !== null) t.vphVals.push(b.vramSiprRaVph);
        t.bfSum += getBoatTotalBreakfix(b);
        if (!b.isNmci && b.essNiprProductCompliance !== null) t.compVals.push(b.essNiprProductCompliance);
        if (b.essSiprProductCompliance !== null) t.compVals.push(b.essSiprProductCompliance);
    });

    // Render a widget by ID with explicit grid positioning
    const renderWidget = (id) => {
        const item = getLayoutItem(id);
        if (!item) return '';
        const w = item.width || 1;
        const h = item.height || 1;
        // Use explicit grid positioning to ensure consistent order with preview
        const style = `grid-column: ${item.col + 1} / span ${w}; grid-row: ${item.row + 1} / span ${h};`;

        switch(id) {
            case 'totalBoats': return `<div class="stat-card" style="${style}"><h3>Total Boats</h3><div class="value">${boats.length}</div></div>`;
            case 'highRisk': return `<div class="stat-card" style="${style}"><h3>High Risk</h3><div class="value high">${riskCounts.HIGH}</div></div>`;
            case 'medRisk': return `<div class="stat-card" style="${style}"><h3>Medium Risk</h3><div class="value med">${riskCounts.MED}</div></div>`;
            case 'lowRisk': return `<div class="stat-card" style="${style}"><h3>Low Risk</h3><div class="value low">${riskCounts.LOW}</div></div>`;
            case 'avgVph': return `<div class="stat-card" style="${style}"><h3>Avg RA VPH</h3><div class="value">${avgVph}</div></div>`;
            case 'totalBreakfix': return `<div class="stat-card" style="${style}"><h3>Total Breakfix</h3><div class="value ${totalBreakfix > 0 ? 'high' : ''}">${totalBreakfix}</div></div>`;
            case 'avgCompliance': return `<div class="stat-card" style="${style}"><h3>True ESS Compliance</h3><div class="value">${avgCompliance}%</div></div>`;
            case 'avgProductCompliance': return `<div class="stat-card" style="${style}"><h3>Avg Product Compliance %</h3><div class="value">${avgProductCompliance}%</div></div>`;
            case 'scanExempt': return `<div class="stat-card" style="${style}"><h3>Scan Exempt</h3><div class="value">${scanExemptCount}</div></div>`;
            case 'riskPieChart': return `<div class="chart-box" style="${style}"><h3>Risk Pie Chart</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskPieChart"></canvas></div></div>`;
            case 'riskDonutChart': return `<div class="chart-box" style="${style}"><h3>Overall Risk</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskDonutChart"></canvas></div></div>`;
            case 'riskDistribution': return `<div class="chart-box" style="${style}"><h3>Risk Bar Chart</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskDistribution"></canvas></div></div>`;
            case 'highRiskTable': {
                const highRiskBoats = boats.filter(b => b.riskLevel === 'HIGH');
                const showReasons = w > 1;
                const tableContent = showReasons
                    ? `<div class="high-risk-table"><table class="mini-table"><thead><tr><th style="text-align:left">Boat</th><th style="text-align:left">Reason</th></tr></thead><tbody>${highRiskBoats.map(b => `<tr><td style="font-family:monospace">${b.boatFullName || b.boatName}</td><td class="reason-cell" style="color:#dc2626">${b.riskReasons?.join(', ') || '-'}</td></tr>`).join('')}</tbody></table></div>`
                    : `<div class="high-risk-table"><table class="mini-table"><thead><tr><th>Boat</th></tr></thead><tbody>${highRiskBoats.map(b => `<tr><td>${b.boatFullName || b.boatName}</td></tr>`).join('')}</tbody></table></div>`;
                return `<div class="chart-box" style="${style}"><h3>High Risk Boats (${highRiskBoats.length})</h3>${highRiskBoats.length === 0 ? '<div style="color:#059669;font-weight:500;padding:16px;">No high-risk boats</div>' : tableContent}</div>`;
            }
            case 'riskByTycom': return `<div class="chart-box" style="${style}"><h3>Risk by TYCOM</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskByTycom"></canvas></div></div>`;
            case 'vphByIsic': return `<div class="chart-box" style="${style}"><h3>VPH by ISIC</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-vphByIsic"></canvas></div></div>`;
            case 'worstBoatsVph': {
                const sorted = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(b)||0) - (getBoatMaxVph(a)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'bestBoatsVph': {
                const sorted = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(a)||0) - (getBoatMaxVph(b)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Best Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-low">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstBoatsCompliance': {
                const sorted = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(a)||0) - (getBoatMinCompliance(b)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by Compliance</h4><table class="mini-table"><thead><tr><th>Boat</th><th>True ESS</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${Math.min(100, getBoatMinCompliance(b)||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'bestBoatsCompliance': {
                const sorted = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(b)||0) - (getBoatMinCompliance(a)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Best Boats by Compliance</h4><table class="mini-table"><thead><tr><th>Boat</th><th>True ESS</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-low">${Math.min(100, getBoatMinCompliance(b)||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'boatsWithBreakfix': {
                const sorted = [...boats].filter(b => getBoatTotalBreakfix(b) > 0).sort((a,b) => getBoatTotalBreakfix(b) - getBoatTotalBreakfix(a)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Boats with Breakfix</h4>${sorted.length === 0 ? '<div style="color:#059669;padding:8px;">None</div>' : `<table class="mini-table"><thead><tr><th>Boat</th><th>Breakfix</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="alert-red">${getBoatTotalBreakfix(b)}</td></tr>`).join('')}</tbody></table>`}</div>`;
            }
            case 'worstIsicsRisk': {
                const sorted = [...isicData].sort((a,b) => b.high - a.high).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Worst ISICs by High Risk</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>High</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-high">${i.high}</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'bestIsicsRisk': {
                const sorted = [...isicData].sort((a,b) => b.lowPct - a.lowPct).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Best ISICs by Low Risk %</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>Low %</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-low">${i.lowPct.toFixed(0)}%</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstIsicsVph': {
                const sorted = [...isicData].sort((a,b) => b.avgVph - a.avgVph).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Worst ISICs by Avg VPH</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>Avg VPH</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-high">${i.avgVph.toFixed(2)}</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstIsicsCompliance': {
                const sorted = [...isicData].sort((a,b) => a.avgComp - b.avgComp).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Worst ISICs by True ESS</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>True ESS</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-high">${i.avgComp.toFixed(1)}%</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'bestIsicsCompliance': {
                const sorted = [...isicData].sort((a,b) => b.avgComp - a.avgComp).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Best ISICs by True ESS</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>True ESS</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-low">${i.avgComp.toFixed(1)}%</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'tycomComparison': {
                const rows = Object.entries(tycomData).map(([tycom,d]) => {
                    const avgVph = d.vphVals.length > 0 ? d.vphVals.reduce((s,v)=>s+v,0)/d.vphVals.length : 0;
                    const comp = d.compVals.length > 0 ? Math.min(100, d.compVals.reduce((s,v)=>s+v,0)/d.compVals.length) : null;
                    return `<tr><td style="font-weight:600">${tycom}</td><td>${d.boats}</td><td class="${d.high>0?'risk-high':''}">${d.high}</td><td class="${d.med>0?'risk-med':''}">${d.med}</td><td class="risk-low">${d.low}</td><td>${avgVph.toFixed(2)}</td><td class="${d.bfSum>0?'alert-red':''}">${d.bfSum}</td><td class="${comp!==null?compClass(comp):''}">${comp!==null?comp.toFixed(1)+'%':'-'}</td></tr>`;
                }).join('');
                return `<div class="ranking-box" style="${style}"><h4>TYCOM Comparison</h4><table class="mini-table"><thead><tr><th>TYCOM</th><th>Boats</th><th>High</th><th>Med</th><th>Low</th><th>Avg VPH</th><th>Breakfix</th><th>True ESS</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
            case 'riskSummaryByIsic': {
                const summaryRows = isicData.sort((a,b) => b.high - a.high).map(i => {
                    const isicBoats = boats.filter(b => b.isic === i.isic);
                    const bf = isicBoats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
                    return `<tr><td style="text-align:left;font-weight:600">${i.isic}</td><td>${i.boats}</td><td class="${i.high>0?'risk-high':''}">${i.high}</td><td class="${i.med>0?'risk-med':''}">${i.med}</td><td class="risk-low">${i.low}</td><td>${i.avgVph.toFixed(2)}</td><td class="${bf>0?'alert-red':''}">${bf}</td></tr>`;
                }).join('');
                return `<div class="ranking-box" style="${style}"><h4>Risk Summary by ISIC</h4><table class="mini-table"><thead><tr><th style="text-align:left">ISIC</th><th>Boats</th><th>High</th><th>Med</th><th>Low</th><th>Avg VPH</th><th>Breakfix</th></tr></thead><tbody>${summaryRows}</tbody></table></div>`;
            }
            // SIPR-specific stat cards
            case 'avgVphSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Avg RA VPH</h3><div class="value">${avgVphSipr}</div></div>`;
            case 'totalBreakfixSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Total Breakfix</h3><div class="value ${totalBreakfixSipr > 0 ? 'high' : ''}">${totalBreakfixSipr}</div></div>`;
            case 'avgComplianceSipr': return `<div class="stat-card" style="${style}"><h3>SIPR True ESS Compliance</h3><div class="value">${avgComplianceSipr}%</div></div>`;
            case 'avgProductComplianceSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Avg Product Compliance</h3><div class="value">${avgProductComplianceSipr}%</div></div>`;
            // NIPR-specific stat cards
            case 'avgVphNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Avg RA VPH</h3><div class="value">${avgVphNipr}</div></div>`;
            case 'totalBreakfixNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Total Breakfix</h3><div class="value ${totalBreakfixNipr > 0 ? 'high' : ''}">${totalBreakfixNipr}</div></div>`;
            case 'avgComplianceNipr': return `<div class="stat-card" style="${style}"><h3>NIPR True ESS Compliance</h3><div class="value">${avgComplianceNipr}%</div></div>`;
            case 'avgProductComplianceNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Avg Product Compliance</h3><div class="value">${avgProductComplianceNipr}%</div></div>`;
            // SIPR/NIPR VPH by ISIC charts
            case 'vphByIsicSipr': return `<div class="chart-box" style="${style}"><h3>SIPR VPH by ISIC</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-vphByIsicSipr"></canvas></div></div>`;
            case 'vphByIsicNipr': return `<div class="chart-box" style="${style}"><h3>NIPR VPH by ISIC</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-vphByIsicNipr"></canvas></div></div>`;
            // SIPR-specific rankings
            case 'worstBoatsVphSipr': {
                const sorted = [...boats].filter(b => b.vramSiprRaVph !== null).sort((a,b) => (b.vramSiprRaVph||0) - (a.vramSiprRaVph||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by SIPR VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>SIPR VPH</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${(b.vramSiprRaVph||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstBoatsVphNipr': {
                const sorted = [...boats].filter(b => !b.isNmci && b.vramNiprRaVph !== null).sort((a,b) => (b.vramNiprRaVph||0) - (a.vramNiprRaVph||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by NIPR VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>NIPR VPH</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${(b.vramNiprRaVph||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstBoatsComplianceSipr': {
                const sorted = [...boats].filter(b => b.essSiprTruePolicy !== null).sort((a,b) => (a.essSiprTruePolicy||0) - (b.essSiprTruePolicy||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by SIPR Compliance</h4><table class="mini-table"><thead><tr><th>Boat</th><th>SIPR ESS</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${Math.min(100, b.essSiprTruePolicy||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstBoatsComplianceNipr': {
                const sorted = [...boats].filter(b => !b.isNmci && b.essNiprTruePolicy !== null).sort((a,b) => (a.essNiprTruePolicy||0) - (b.essNiprTruePolicy||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by NIPR Compliance</h4><table class="mini-table"><thead><tr><th>Boat</th><th>NIPR ESS</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${Math.min(100, b.essNiprTruePolicy||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            default: return '';
        }
    };

    // Sort layout items by row then col for proper grid placement
    const sortedLayout = [...al].sort((a, b) => {
        if (a.row !== b.row) return a.row - b.row;
        return a.col - b.col;
    });

    // Calculate max row for grid
    const maxRow = Math.max(...al.map(l => l.row + (l.height || 1) - 1), 0) + 1;

    // Render all widgets in order
    const gridWidgets = sortedLayout.map(item => renderWidget(item.id)).filter(Boolean).join('');

    // ISIC Analytics layout and widgets
    const isicAl = settings.isicAnalyticsLayout || defaultIsicAnalyticsLayout;
    const renderIsicWidget = (id, selectedIsic) => {
        const item = isicAl.find(l => l.id === id);
        if (!item) return '';
        const w = item.width || 1;
        const h = item.height || 1;
        const style = `grid-column: ${item.col + 1} / span ${w}; grid-row: ${item.row + 1} / span ${h};`;
        const isicBoats = boats.filter(b => b.isic === selectedIsic);
        const isicRiskCounts = { HIGH: isicBoats.filter(b => b.riskLevel === 'HIGH').length, MED: isicBoats.filter(b => b.riskLevel === 'MED').length, LOW: isicBoats.filter(b => b.riskLevel === 'LOW').length };
        const isicVphVals = isicBoats.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
        const isicAvgVphVal = isicVphVals.length > 0 ? (isicVphVals.reduce((s, v) => s + v, 0) / isicVphVals.length).toFixed(2) : '0';
        const isicBreakfix = isicBoats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
        const isicCompVals = isicBoats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy); if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v; });
        const isicCompAvg = isicCompVals.length > 0 ? Math.min(100, isicCompVals.reduce((s, v) => s + v, 0) / isicCompVals.length).toFixed(1) : '0';
        const isicProdCompVals = isicBoats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprProductCompliance !== null) v.push(b.essNiprProductCompliance); if (b.essSiprProductCompliance !== null) v.push(b.essSiprProductCompliance); return v; });
        const isicProdCompAvg = isicProdCompVals.length > 0 ? Math.min(100, isicProdCompVals.reduce((s, v) => s + v, 0) / isicProdCompVals.length).toFixed(1) : '0';
        const isicExempt = isicBoats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length;
        const isicIdSafe = selectedIsic.replace(/\s+/g, '_');

        // SIPR-specific calculations for ISIC
        const isicVphValsSipr = isicBoats.filter(b => b.vramSiprRaVph !== null).map(b => b.vramSiprRaVph);
        const isicAvgVphSipr = isicVphValsSipr.length > 0 ? (isicVphValsSipr.reduce((s, v) => s + v, 0) / isicVphValsSipr.length).toFixed(2) : '0';
        const isicBreakfixSipr = isicBoats.reduce((s, b) => s + (b.essSiprBreakfix || 0), 0);
        const isicCompValsSipr = isicBoats.filter(b => b.essSiprTruePolicy !== null).map(b => b.essSiprTruePolicy);
        const isicCompAvgSipr = isicCompValsSipr.length > 0 ? Math.min(100, isicCompValsSipr.reduce((s, v) => s + v, 0) / isicCompValsSipr.length).toFixed(1) : '0';
        const isicProdCompValsSipr = isicBoats.filter(b => b.essSiprProductCompliance !== null).map(b => b.essSiprProductCompliance);
        const isicProdCompAvgSipr = isicProdCompValsSipr.length > 0 ? Math.min(100, isicProdCompValsSipr.reduce((s, v) => s + v, 0) / isicProdCompValsSipr.length).toFixed(1) : '0';

        // NIPR-specific calculations for ISIC (exclude NMCI boats)
        const isicNonNmciBoats = isicBoats.filter(b => !b.isNmci);
        const isicVphValsNipr = isicNonNmciBoats.filter(b => b.vramNiprRaVph !== null).map(b => b.vramNiprRaVph);
        const isicAvgVphNipr = isicVphValsNipr.length > 0 ? (isicVphValsNipr.reduce((s, v) => s + v, 0) / isicVphValsNipr.length).toFixed(2) : '0';
        const isicBreakfixNipr = isicNonNmciBoats.reduce((s, b) => s + (b.essNiprBreakfix || 0), 0);
        const isicCompValsNipr = isicNonNmciBoats.filter(b => b.essNiprTruePolicy !== null).map(b => b.essNiprTruePolicy);
        const isicCompAvgNipr = isicCompValsNipr.length > 0 ? Math.min(100, isicCompValsNipr.reduce((s, v) => s + v, 0) / isicCompValsNipr.length).toFixed(1) : '0';
        const isicProdCompValsNipr = isicNonNmciBoats.filter(b => b.essNiprProductCompliance !== null).map(b => b.essNiprProductCompliance);
        const isicProdCompAvgNipr = isicProdCompValsNipr.length > 0 ? Math.min(100, isicProdCompValsNipr.reduce((s, v) => s + v, 0) / isicProdCompValsNipr.length).toFixed(1) : '0';

        switch(id) {
            case 'isicBoatCount': return `<div class="stat-card" style="${style}"><h3>Boats in ISIC</h3><div class="value">${isicBoats.length}</div></div>`;
            case 'isicHighRisk': return `<div class="stat-card" style="${style}"><h3>High Risk</h3><div class="value high">${isicRiskCounts.HIGH}</div></div>`;
            case 'isicMedRisk': return `<div class="stat-card" style="${style}"><h3>Medium Risk</h3><div class="value med">${isicRiskCounts.MED}</div></div>`;
            case 'isicLowRisk': return `<div class="stat-card" style="${style}"><h3>Low Risk</h3><div class="value low">${isicRiskCounts.LOW}</div></div>`;
            case 'isicAvgVph': return `<div class="stat-card" style="${style}"><h3>Avg VPH</h3><div class="value">${isicAvgVphVal}</div></div>`;
            case 'isicTotalBreakfix': return `<div class="stat-card" style="${style}"><h3>Total Breakfix</h3><div class="value ${isicBreakfix > 0 ? 'high' : ''}">${isicBreakfix}</div></div>`;
            case 'isicAvgCompliance': return `<div class="stat-card" style="${style}"><h3>Avg True ESS Compliance</h3><div class="value">${isicCompAvg}%</div></div>`;
            case 'isicAvgProductCompliance': return `<div class="stat-card" style="${style}"><h3>Avg Product Compliance</h3><div class="value">${isicProdCompAvg}%</div></div>`;
            case 'isicScanExempt': return `<div class="stat-card" style="${style}"><h3>Scan Exempt</h3><div class="value">${isicExempt}</div></div>`;
            case 'isicRiskPie': return `<div class="chart-box" style="${style}"><h3>ISIC Risk Distribution</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-isic-${isicIdSafe}-pie"></canvas></div></div>`;
            case 'isicBoatsTable': return `<div class="chart-box" style="${style}"><h3>Boats in ${selectedIsic}</h3><div style="overflow:auto;max-height:200px;"><table class="mini-table"><thead><tr><th>Boat</th><th>Risk</th><th>VPH</th><th>ESS Comp</th><th>BF</th></tr></thead><tbody>${isicBoats.map(b => `<tr><td style="font-family:monospace">${b.boatName}</td><td class="risk-${b.riskLevel.toLowerCase()}">${b.riskLevel}</td><td>${(getBoatMaxVph(b)||0).toFixed(2)}</td><td>${(getBoatMinCompliance(b)||0).toFixed(1)}%</td><td class="${getBoatTotalBreakfix(b)>0?'risk-high':''}">${getBoatTotalBreakfix(b)}</td></tr>`).join('')}</tbody></table></div></div>`;
            case 'isicVphComparison': return `<div class="chart-box" style="${style}"><h3>VPH by Boat</h3><div class="horizontal-chart" style="flex:1;position:relative;min-height:150px;max-width:100%;overflow:hidden;"><canvas id="chart-isic-${isicIdSafe}-vph" style="max-width:100%;"></canvas></div></div>`;
            case 'isicComplianceComparison': return `<div class="chart-box" style="${style}"><h3>True ESS Compliance % by Boat</h3><div class="horizontal-chart" style="flex:1;position:relative;min-height:150px;max-width:100%;overflow:hidden;"><canvas id="chart-isic-${isicIdSafe}-comp" style="max-width:100%;"></canvas></div></div>`;
            case 'isicWorstBoatsVph': {
                const worstVph = [...isicBoats].filter(b => getBoatMaxVph(b) != null).sort((a, b) => (getBoatMaxVph(b) || 0) - (getBoatMaxVph(a) || 0)).slice(0, 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${worstVph.map(b => `<tr><td>${b.boatName}</td><td class="risk-high">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'isicBestBoatsVph': {
                const bestVph = [...isicBoats].filter(b => getBoatMaxVph(b) != null).sort((a, b) => (getBoatMaxVph(a) || 0) - (getBoatMaxVph(b) || 0)).slice(0, 5);
                return `<div class="ranking-box" style="${style}"><h4>Best Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${bestVph.map(b => `<tr><td>${b.boatName}</td><td class="risk-low">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'isicWorstBoatsCompliance': {
                const worstComp = [...isicBoats].filter(b => getBoatMinCompliance(b) != null).sort((a, b) => (getBoatMinCompliance(a) || 0) - (getBoatMinCompliance(b) || 0)).slice(0, 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by True ESS</h4><table class="mini-table"><thead><tr><th>Boat</th><th>True ESS</th></tr></thead><tbody>${worstComp.map(b => `<tr><td>${b.boatName}</td><td class="risk-high">${(getBoatMinCompliance(b)||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'isicBestBoatsCompliance': {
                const bestComp = [...isicBoats].filter(b => getBoatMinCompliance(b) != null).sort((a, b) => (getBoatMinCompliance(b) || 0) - (getBoatMinCompliance(a) || 0)).slice(0, 5);
                return `<div class="ranking-box" style="${style}"><h4>Best Boats by True ESS</h4><table class="mini-table"><thead><tr><th>Boat</th><th>True ESS</th></tr></thead><tbody>${bestComp.map(b => `<tr><td>${b.boatName}</td><td class="risk-low">${(getBoatMinCompliance(b)||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'isicWorstBoats': {
                const worstVph = [...isicBoats].filter(b => getBoatMaxVph(b) != null).sort((a, b) => (getBoatMaxVph(b) || 0) - (getBoatMaxVph(a) || 0)).slice(0, 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${worstVph.map(b => `<tr><td>${b.boatName}</td><td class="risk-high">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'isicBestBoats': {
                const bestVph = [...isicBoats].filter(b => getBoatMaxVph(b) != null).sort((a, b) => (getBoatMaxVph(a) || 0) - (getBoatMaxVph(b) || 0)).slice(0, 5);
                return `<div class="ranking-box" style="${style}"><h4>Best Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${bestVph.map(b => `<tr><td>${b.boatName}</td><td class="risk-low">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            // SIPR-specific ISIC widgets
            case 'isicAvgVphSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Avg VPH</h3><div class="value">${isicAvgVphSipr}</div></div>`;
            case 'isicTotalBreakfixSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Total Breakfix</h3><div class="value ${isicBreakfixSipr > 0 ? 'high' : ''}">${isicBreakfixSipr}</div></div>`;
            case 'isicAvgComplianceSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Avg True ESS</h3><div class="value">${isicCompAvgSipr}%</div></div>`;
            case 'isicAvgProductComplianceSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Avg Product Comp</h3><div class="value">${isicProdCompAvgSipr}%</div></div>`;
            // NIPR-specific ISIC widgets
            case 'isicAvgVphNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Avg VPH</h3><div class="value">${isicAvgVphNipr}</div></div>`;
            case 'isicTotalBreakfixNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Total Breakfix</h3><div class="value ${isicBreakfixNipr > 0 ? 'high' : ''}">${isicBreakfixNipr}</div></div>`;
            case 'isicAvgComplianceNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Avg True ESS</h3><div class="value">${isicCompAvgNipr}%</div></div>`;
            case 'isicAvgProductComplianceNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Avg Product Comp</h3><div class="value">${isicProdCompAvgNipr}%</div></div>`;
            // SIPR/NIPR specific bar charts
            case 'isicVphComparisonSipr': return `<div class="chart-box" style="${style}"><h3>SIPR VPH by Boat</h3><div class="horizontal-chart" style="flex:1;position:relative;min-height:150px;max-width:100%;overflow:hidden;"><canvas id="chart-isic-${isicIdSafe}-vph-sipr" style="max-width:100%;"></canvas></div></div>`;
            case 'isicVphComparisonNipr': return `<div class="chart-box" style="${style}"><h3>NIPR VPH by Boat</h3><div class="horizontal-chart" style="flex:1;position:relative;min-height:150px;max-width:100%;overflow:hidden;"><canvas id="chart-isic-${isicIdSafe}-vph-nipr" style="max-width:100%;"></canvas></div></div>`;
            case 'isicComplianceComparisonSipr': return `<div class="chart-box" style="${style}"><h3>SIPR True ESS % by Boat</h3><div class="horizontal-chart" style="flex:1;position:relative;min-height:150px;max-width:100%;overflow:hidden;"><canvas id="chart-isic-${isicIdSafe}-comp-sipr" style="max-width:100%;"></canvas></div></div>`;
            case 'isicComplianceComparisonNipr': return `<div class="chart-box" style="${style}"><h3>NIPR True ESS % by Boat</h3><div class="horizontal-chart" style="flex:1;position:relative;min-height:150px;max-width:100%;overflow:hidden;"><canvas id="chart-isic-${isicIdSafe}-comp-nipr" style="max-width:100%;"></canvas></div></div>`;
            default: return '';
        }
    };

    // Boat Analytics layout and widgets
    const boatAl = settings.boatAnalyticsLayout || defaultBoatAnalyticsLayout;
    const renderBoatWidget = (id, selectedBoat) => {
        const item = boatAl.find(l => l.id === id);
        if (!item) return '';
        const w = item.width || 1;
        const h = item.height || 1;
        const style = `grid-column: ${item.col + 1} / span ${w}; grid-row: ${item.row + 1} / span ${h};`;
        const b = boats.find(bt => bt.boatName === selectedBoat);
        if (!b) return '';
        const scanAgeNipr = b.vramNiprScanDate ? Math.floor((new Date() - new Date(b.vramNiprScanDate)) / 86400000) : null;
        const scanAgeSipr = b.vramSiprScanDate ? Math.floor((new Date() - new Date(b.vramSiprScanDate)) / 86400000) : null;
        const maxScanAge = Math.max(scanAgeNipr || 0, scanAgeSipr || 0);
        const boatIdSafe = selectedBoat.replace(/\\s+/g, '_');

        switch(id) {
            case 'boatRiskLevel': return `<div class="stat-card" style="${style}"><h3>Risk Level</h3><div class="value ${b.riskLevel.toLowerCase()}">${b.riskLevel}</div></div>`;
            case 'boatVphNipr': return `<div class="stat-card" style="${style}"><h3>NIPR VPH</h3><div class="value">${b.isNmci ? 'NMCI' : (b.vramNiprRaVph !== null ? b.vramNiprRaVph.toFixed(2) : '-')}</div></div>`;
            case 'boatVphSipr': return `<div class="stat-card" style="${style}"><h3>SIPR VPH</h3><div class="value">${b.vramSiprRaVph !== null ? b.vramSiprRaVph.toFixed(2) : '-'}</div></div>`;
            case 'boatScanAgeNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Scan Age</h3><div class="value ${(scanAgeNipr || 0) > 14 ? 'high' : ''}">${b.isNmci ? 'NMCI' : (scanAgeNipr !== null ? scanAgeNipr + ' days' : '-')}</div></div>`;
            case 'boatScanAgeSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Scan Age</h3><div class="value ${(scanAgeSipr || 0) > 14 ? 'high' : ''}">${scanAgeSipr !== null ? scanAgeSipr + ' days' : '-'}</div></div>`;
            case 'boatScanAge': return `<div class="stat-card" style="${style}"><h3>Scan Age</h3><div class="value ${maxScanAge > 14 ? 'high' : ''}">${maxScanAge || '-'} days</div></div>`;
            case 'boatBreakfixNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Breakfix</h3><div class="value ${(b.essNiprBreakfix || 0) > 0 ? 'high' : ''}">${b.isNmci ? 'NMCI' : (b.essNiprBreakfix || 0)}</div></div>`;
            case 'boatBreakfixSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Breakfix</h3><div class="value ${(b.essSiprBreakfix || 0) > 0 ? 'high' : ''}">${b.essSiprBreakfix || 0}</div></div>`;
            case 'boatComplianceNipr': return `<div class="stat-card" style="${style}"><h3>NIPR True ESS Compliance</h3><div class="value">${b.isNmci ? 'NMCI' : (b.essNiprTruePolicy !== null ? b.essNiprTruePolicy.toFixed(1) + '%' : '-')}</div></div>`;
            case 'boatComplianceSipr': return `<div class="stat-card" style="${style}"><h3>SIPR True ESS Compliance</h3><div class="value">${b.essSiprTruePolicy !== null ? b.essSiprTruePolicy.toFixed(1) + '%' : '-'}</div></div>`;
            case 'boatProductComplianceNipr': return `<div class="stat-card" style="${style}"><h3>NIPR Product Compliance</h3><div class="value">${b.isNmci ? 'NMCI' : (b.essNiprProductCompliance !== null ? b.essNiprProductCompliance.toFixed(1) + '%' : '-')}</div></div>`;
            case 'boatProductComplianceSipr': return `<div class="stat-card" style="${style}"><h3>SIPR Product Compliance</h3><div class="value">${b.essSiprProductCompliance !== null ? b.essSiprProductCompliance.toFixed(1) + '%' : '-'}</div></div>`;
            case 'boatRiskReasons': return `<div class="chart-box" style="${style}"><h3>Risk Factors</h3><div style="padding:8px;">${b.riskReasons?.length > 0 ? b.riskReasons.map(r => `<div style="color:#dc2626;padding:4px 0;border-bottom:1px solid #f1f5f9;">${r}</div>`).join('') : '<div style="color:#059669;">No risk factors</div>'}</div></div>`;
            case 'boatMetricsSummary': return `<div class="chart-box" style="${style}"><h3>Metrics</h3><div style="overflow:auto;"><table class="mini-table"><thead><tr><th>Metric</th><th>NIPR</th><th>SIPR</th></tr></thead><tbody><tr><td>VPH</td><td>${b.isNmci ? 'NMCI' : (b.vramNiprRaVph?.toFixed(2) || '-')}</td><td>${b.vramSiprRaVph?.toFixed(2) || '-'}</td></tr><tr><td>Breakfix</td><td class="${b.essNiprBreakfix > 0 ? 'risk-high' : ''}">${b.isNmci ? 'NMCI' : (b.essNiprBreakfix || 0)}</td><td class="${b.essSiprBreakfix > 0 ? 'risk-high' : ''}">${b.essSiprBreakfix || 0}</td></tr><tr><td>Prod ESS</td><td>${b.isNmci ? 'NMCI' : (b.essNiprProductCompliance?.toFixed(1) + '%' || '-')}</td><td>${b.essSiprProductCompliance?.toFixed(1) + '%' || '-'}</td></tr><tr><td>True ESS</td><td>${b.isNmci ? 'NMCI' : (b.essNiprTruePolicy?.toFixed(1) + '%' || '-')}</td><td>${b.essSiprTruePolicy?.toFixed(1) + '%' || '-'}</td></tr><tr><td>Scan Age</td><td>${b.isNmci ? 'NMCI' : (scanAgeNipr !== null ? scanAgeNipr + 'd' : '-')}</td><td>${scanAgeSipr !== null ? scanAgeSipr + 'd' : '-'}</td></tr></tbody></table></div></div>`;
            case 'boatIsicComparisonVph': return `<div class="chart-box" style="${style}"><h3>VPH vs ISIC Avg</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-isic-vph"></canvas></div></div>`;
            case 'boatIsicComparisonEss': return `<div class="chart-box" style="${style}"><h3>True ESS vs ISIC Avg</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-isic-ess"></canvas></div></div>`;
            case 'boatTycomComparisonVph': return `<div class="chart-box" style="${style}"><h3>VPH vs ${b.tycom || 'TYCOM'} Avg</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-tycom-vph"></canvas></div></div>`;
            case 'boatTycomComparisonEss': return `<div class="chart-box" style="${style}"><h3>True ESS vs ${b.tycom || 'TYCOM'} Avg</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-tycom-ess"></canvas></div></div>`;
            case 'boatSubforComparisonVph': return `<div class="chart-box" style="${style}"><h3>VPH vs SUBFOR Avg</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-subfor-vph"></canvas></div></div>`;
            case 'boatSubforComparisonEss': return `<div class="chart-box" style="${style}"><h3>True ESS vs SUBFOR Avg</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-subfor-ess"></canvas></div></div>`;
            // Keep old IDs for backward compatibility
            case 'boatIsicComparison': return `<div class="chart-box" style="${style}"><h3>vs ISIC Average</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-isic"></canvas></div></div>`;
            case 'boatTycomComparison': return `<div class="chart-box" style="${style}"><h3>vs ${b.tycom || 'TYCOM'} Average</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-tycom"></canvas></div></div>`;
            case 'boatSubforComparison': return `<div class="chart-box" style="${style}"><h3>vs SUBFOR Average</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-subfor"></canvas></div></div>`;
            case 'boatTamStatus': return `<div class="stat-card" style="${style}"><h3>TAM Past Due</h3><div class="value ${(b.tamPastDue || 0) > 10 ? 'high' : ''}">${b.tamPastDue || 0}</div></div>`;
            case 'boatOverrides': return `<div class="chart-box" style="${style}"><h3>Active Overrides</h3><div style="padding:8px;">${b.overrides?.length > 0 ? b.overrides.map(o => `<div style="padding:4px 0;border-bottom:1px solid #f1f5f9;"><span style="color:#7c3aed;font-weight:500;">${o.field}:</span> ${o.originalValue} → ${o.overrideValue}</div>`).join('') : '<div style="color:#94a3b8;">No overrides</div>'}</div></div>`;
            // New consolidated comparison charts by enclave
            case 'boatVphComparisonSipr': return `<div class="chart-box" style="${style}"><h3>SIPR VPH vs ISIC/TYCOM/SUBFOR</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-vph-sipr"></canvas></div></div>`;
            case 'boatVphComparisonNipr': return `<div class="chart-box" style="${style}"><h3>NIPR VPH vs ISIC/TYCOM/SUBFOR</h3><div style="flex:1;position:relative;min-height:150px;">${b.isNmci ? '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;font-style:italic;">N/A - NMCI Boat</div>' : `<canvas id="chart-boat-${boatIdSafe}-vph-nipr"></canvas>`}</div></div>`;
            case 'boatEssComparisonSipr': return `<div class="chart-box" style="${style}"><h3>SIPR True ESS vs ISIC/TYCOM/SUBFOR</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="chart-boat-${boatIdSafe}-ess-sipr"></canvas></div></div>`;
            case 'boatEssComparisonNipr': return `<div class="chart-box" style="${style}"><h3>NIPR True ESS vs ISIC/TYCOM/SUBFOR</h3><div style="flex:1;position:relative;min-height:150px;">${b.isNmci ? '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;font-style:italic;">N/A - NMCI Boat</div>' : `<canvas id="chart-boat-${boatIdSafe}-ess-nipr"></canvas>`}</div></div>`;
            default: return '';
        }
    };

    // Get unique ISICs and boats for dropdowns
    const uniqueIsics = [...new Set(boats.map(b => b.isic))].sort();
    const uniqueBoats = [...boats].sort((a, b) => a.boatName.localeCompare(b.boatName));
    const defaultIsic = uniqueIsics[0] || '';
    const defaultBoat = uniqueBoats[0]?.boatName || '';

    // Pre-render ISIC widgets for each ISIC (will be shown/hidden by JS)
    const isicWidgetsHtml = uniqueIsics.map(isic => {
        const sortedIsicLayout = [...isicAl].sort((a, b) => a.row !== b.row ? a.row - b.row : a.col - b.col);
        const widgets = sortedIsicLayout.map(item => renderIsicWidget(item.id, isic)).filter(Boolean).join('');
        return `<div id="isic-analytics-${isic.replace(/\s+/g, '_')}" class="isic-analytics-content" style="display:none;"><div class="analytics-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;grid-auto-rows:minmax(100px,auto);">${widgets}</div></div>`;
    }).join('');

    // Pre-render Boat widgets for each boat (will be shown/hidden by JS)
    const boatWidgetsHtml = uniqueBoats.map(boat => {
        const sortedBoatLayout = [...boatAl].sort((a, b) => a.row !== b.row ? a.row - b.row : a.col - b.col);
        const widgets = sortedBoatLayout.map(item => renderBoatWidget(item.id, boat.boatName)).filter(Boolean).join('');
        return `<div id="boat-analytics-${boat.boatName.replace(/\s+/g, '_')}" class="boat-analytics-content" style="display:none;"><div class="analytics-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;grid-auto-rows:minmax(100px,auto);">${widgets}</div></div>`;
    }).join('');

    return `<div id="tab-analytics" class="tab-content${firstVisibleTab==='analytics'?' active':''}">
<div class="page-header no-print" style="margin-bottom:16px;">
    <h2>Analytics</h2>
    <div class="toolbar">
        <button onclick="showPrintScaleModal('analytics')">Print Analytics</button>
    </div>
</div>
<h2 id="analytics-print-header" class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">Analytics</h2>
${pageInfo}

<!-- Sub-tab Navigation -->
<div class="analytics-subtabs no-print" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e2e8f0;">
    <div style="display:flex;gap:4px;">
        <button id="analytics-subtab-main" class="analytics-subtab-btn active" onclick="showAnalyticsSubTab('main')" style="padding:8px 16px;border:none;border-radius:4px;font-weight:500;cursor:pointer;background:#0891b2;color:white;">Main</button>
        <button id="analytics-subtab-isic" class="analytics-subtab-btn" onclick="showAnalyticsSubTab('isic')" style="padding:8px 16px;border:none;border-radius:4px;font-weight:500;cursor:pointer;background:#f1f5f9;color:#475569;">ISIC</button>
        <button id="analytics-subtab-boat" class="analytics-subtab-btn" onclick="showAnalyticsSubTab('boat')" style="padding:8px 16px;border:none;border-radius:4px;font-weight:500;cursor:pointer;background:#f1f5f9;color:#475569;">Boat</button>
    </div>
    <div id="isic-selector" style="display:none;align-items:center;gap:8px;">
        <label style="font-size:9pt;color:#475569;">Select ISIC:</label>
        <select id="analytics-isic-select" onchange="updateIsicAnalytics(this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;font-size:9pt;">
            <option value="">-- Select ISIC --</option>
            ${uniqueIsics.map(isic => `<option value="${isic}">${isic}</option>`).join('')}
        </select>
    </div>
    <div id="boat-selector" style="display:none;align-items:center;gap:8px;">
        <label style="font-size:9pt;color:#475569;">Select Boat:</label>
        <select id="analytics-boat-select" onchange="updateBoatAnalytics(this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;font-size:9pt;">
            <option value="">-- Select Boat --</option>
            ${uniqueBoats.map(b => `<option value="${b.boatName}">${b.boatName} - ${b.boatFullName}</option>`).join('')}
        </select>
    </div>
</div>

<!-- Main Analytics Content -->
<div id="analytics-main-content">
    <div class="analytics-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;grid-auto-rows:minmax(100px,auto);">
    ${gridWidgets}
    </div>
</div>

<!-- ISIC Analytics Content -->
<div id="analytics-isic-content" style="display:none;">
    ${isicWidgetsHtml}
</div>

<!-- Boat Analytics Content -->
<div id="analytics-boat-content" style="display:none;">
    ${boatWidgetsHtml}
</div>
</div>`;
})() : ''}

${(hasChanges && isTabVisible('changelog')) ? `<div id="tab-changelog" class="tab-content${firstVisibleTab==='changelog'?' active':''}">
<div class="page">
<div class="page-header no-print"><h2>Change Log</h2><div class="toolbar"><button onclick="printTab('changelog')">Print Changes</button></div></div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">Change Log</h2>
${pageInfo}

<div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:6px;padding:12px 16px;margin-bottom:16px;">
<h4 style="font-size:10pt;color:#0369a1;margin:0 0 8px;">Current Settings</h4>
<p style="font-size:9pt;color:#0c4a6e;margin:0;">Version <strong>${settings._settingsVersion || '1.0'}</strong> by <strong>${settings._settingsAuthor || 'Unknown'}</strong> • Last modified: ${settings._settingsModified ? new Date(settings._settingsModified).toLocaleString() : 'Unknown'}</p>
</div>

${settingsHistory.length > 0 ? `<h3 style="font-size:11pt;margin:16px 0 8px;color:#0891b2;">Settings Version History</h3>
<table class="summary-table"><thead><tr><th>Version</th><th style="text-align:left">Author</th><th style="text-align:left">Modified</th></tr></thead>
<tbody>${settingsHistory.slice().reverse().map(h => `<tr><td style="font-weight:bold;">${h.version}</td><td style="text-align:left">${h.author}</td><td style="text-align:left">${new Date(h.modified).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}

${thresholdChanges.length > 0 ? `<h3 style="font-size:11pt;margin:16px 0 8px;color:#b45309;">Threshold Adjustments</h3>
<table class="summary-table"><thead><tr><th style="text-align:left">Threshold</th><th>Default</th><th>Used</th><th>By</th><th>Time</th></tr></thead>
<tbody>${thresholdChanges.map(t => `<tr><td style="text-align:left">${t.field.replace(/_/g, ' ')}</td><td>${t.defaultValue}</td><td style="font-weight:bold;color:#b45309;">${t.newValue}</td><td>${t.user}</td><td>${new Date(t.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}

${allOverrides.length > 0 ? `<h3 style="font-size:11pt;margin:24px 0 8px;color:#7c3aed;">Value Overrides</h3>
<table class="summary-table"><thead><tr><th style="text-align:left">Boat</th><th style="text-align:left">Field</th><th>Original</th><th>New</th><th style="text-align:left">Reason</th><th>By</th><th>Time</th></tr></thead>
<tbody>${allOverrides.map(o => `<tr><td style="text-align:left;font-family:monospace;">${o.boatName}</td><td style="text-align:left">${o.field}</td><td>${o.originalValue}</td><td style="font-weight:bold;color:#7c3aed;">${o.overrideValue}</td><td style="text-align:left">${o.reason}</td><td>${o.user}</td><td>${new Date(o.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}

${dataUpdates.length > 0 ? `<h3 style="font-size:11pt;margin:24px 0 8px;color:#0891b2;">Data Source Updates</h3>
<table class="summary-table"><thead><tr><th>Update</th><th style="text-align:left">Sources</th><th style="text-align:left">Files</th><th>By</th><th>Time</th></tr></thead>
<tbody>${dataUpdates.map((u, i) => `<tr><td style="font-weight:bold;">#${i + 1}</td><td style="text-align:left">${u.sources.join(', ')}</td><td style="text-align:left;font-size:7pt;">${u.files.join(', ')}</td><td>${u.user}</td><td>${new Date(u.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}
</div>
</div>` : ''}

<script type="application/x-dashboard-report">${embedded}<\/script>
<script>
const riskData = ${JSON.stringify(riskCounts)};
const cslRisk = ${JSON.stringify(cslRiskCounts)};
const cspRisk = ${JSON.stringify(cspRiskCounts)};
const isicVphData = ${JSON.stringify(isicVphAvg)};
const isicVphDataSipr = ${JSON.stringify(isicVphAvgSipr)};
const isicVphDataNipr = ${JSON.stringify(isicVphAvgNipr)};
const tycomChartData = ${JSON.stringify(Object.entries(tycomData).map(([tycom, d]) => ({ tycom, high: d.high, med: d.med, low: d.low })))};
const allBoatsData = ${JSON.stringify(boats.map(b => ({
    boatName: b.boatName,
    boatFullName: b.boatFullName,
    isic: b.isic,
    tycom: b.tycom,
    isNmci: b.isNmci,
    riskLevel: b.riskLevel,
    riskReasons: b.riskReasons,
    vramNiprRaVph: b.vramNiprRaVph,
    vramSiprRaVph: b.vramSiprRaVph,
    essNiprBreakfix: b.essNiprBreakfix,
    essSiprBreakfix: b.essSiprBreakfix,
    essNiprTruePolicy: b.essNiprTruePolicy,
    essSiprTruePolicy: b.essSiprTruePolicy,
    essNiprProductCompliance: b.essNiprProductCompliance,
    essSiprProductCompliance: b.essSiprProductCompliance,
    vramNiprScanDate: b.vramNiprScanDate,
    vramSiprScanDate: b.vramSiprScanDate,
    vramNiprScanExempt: b.vramNiprScanExempt,
    vramSiprScanExempt: b.vramSiprScanExempt,
    tamPastDue: b.tamPastDue,
    overrides: b.overrides
})))};
const allIsicsData = ${JSON.stringify(uniqueIsics.map(isic => {
    const isicBoats = boats.filter(b => b.isic === isic);
    const tycom = isicBoats[0]?.tycom || '';
    return { isic, tycom, boatCount: isicBoats.length };
}))};

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
    event.target.classList.add('active');
    if (id === 'analytics' && !window.chartsInit) { initCharts(); window.chartsInit = true; }
}
function printTab(id) {
    // Add print-active class to the tab we want to print
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('print-active'));
    document.getElementById('tab-' + id).classList.add('print-active');

    // Update analytics print header with selected ISIC/Boat if applicable
    let originalHeader = '';
    const analyticsHeader = document.getElementById('analytics-print-header');
    if (id === 'analytics' && analyticsHeader) {
        originalHeader = analyticsHeader.textContent;
        if (currentAnalyticsSubTab === 'isic' && currentSelectedIsic) {
            const shortIsic = currentSelectedIsic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS');
            analyticsHeader.textContent = 'Analytics - ' + shortIsic;
        } else if (currentAnalyticsSubTab === 'boat' && currentSelectedBoat) {
            const boat = allBoatsData.find(b => b.boatName === currentSelectedBoat);
            if (boat) {
                analyticsHeader.textContent = 'Analytics - ' + boat.boatName + ' (' + boat.boatFullName + ')';
            } else {
                analyticsHeader.textContent = 'Analytics - ' + currentSelectedBoat;
            }
        }
    }

    window.print();

    // Restore original header and remove print-active class after printing
    if (analyticsHeader && originalHeader) {
        analyticsHeader.textContent = originalHeader;
    }
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('print-active'));
}
function filterISIC(p, v) {
    const c = document.getElementById(p + '-content');
    const rows = c.querySelectorAll('tbody tr');
    let currentISIC = '';
    rows.forEach(row => {
        const isicCell = row.querySelector('.isic-cell');
        if (isicCell) currentISIC = isicCell.textContent;
        row.style.display = !v || currentISIC === v ? '' : 'none';
    });
}
function initCharts() {
    const el1 = document.getElementById('chart-risk-all');
    if (el1) new Chart(el1, {
        type: 'doughnut',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { plugins: { legend: { position: 'bottom' } } }
    });
    const el2 = document.getElementById('chart-risk-tycom');
    if (el2) new Chart(el2, {
        type: 'bar',
        data: { labels: ['CSL', 'CSP'], datasets: [
            { label: 'High', data: [cslRisk.HIGH, cspRisk.HIGH], backgroundColor: '#dc2626' },
            { label: 'Med', data: [cslRisk.MED, cspRisk.MED], backgroundColor: '#d97706' },
            { label: 'Low', data: [cslRisk.LOW, cspRisk.LOW], backgroundColor: '#059669' }
        ] },
        options: { plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
    });
    const el3 = document.getElementById('chart-vph-isic');
    if (el3) new Chart(el3, {
        type: 'bar',
        data: { labels: isicVphData.map(d => d.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'Avg VPH', data: isicVphData.map(d => d.avg), backgroundColor: '#3b82f6' }] },
        options: { indexAxis: 'y', plugins: { legend: { display: false } } }
    });
    // Analytics section charts
    const pieChart = document.getElementById('analytics-chart-riskPieChart');
    if (pieChart) new Chart(pieChart, {
        type: 'pie',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
    });
    const donutChart = document.getElementById('analytics-chart-riskDonutChart');
    if (donutChart) new Chart(donutChart, {
        type: 'doughnut',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { responsive: true, maintainAspectRatio: true, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
    });
    const barChart = document.getElementById('analytics-chart-riskDistribution');
    if (barChart) new Chart(barChart, {
        type: 'bar',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    const tycomChart = document.getElementById('analytics-chart-riskByTycom');
    if (tycomChart) new Chart(tycomChart, {
        type: 'bar',
        data: {
            labels: tycomChartData.map(t => t.tycom),
            datasets: [
                { label: 'High', data: tycomChartData.map(t => t.high), backgroundColor: '#dc2626' },
                { label: 'Med', data: tycomChartData.map(t => t.med), backgroundColor: '#d97706' },
                { label: 'Low', data: tycomChartData.map(t => t.low), backgroundColor: '#059669' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
    });
    const vphChart = document.getElementById('analytics-chart-vphByIsic');
    if (vphChart) new Chart(vphChart, {
        type: 'bar',
        data: { labels: isicVphData.slice(0,8).map(d => d.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'Avg VPH', data: isicVphData.slice(0,8).map(d => d.avg), backgroundColor: '#3b82f6' }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
    });
    // SIPR VPH by ISIC chart
    const vphChartSipr = document.getElementById('analytics-chart-vphByIsicSipr');
    if (vphChartSipr) new Chart(vphChartSipr, {
        type: 'bar',
        data: { labels: isicVphDataSipr.slice(0,8).map(d => d.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'SIPR Avg VPH', data: isicVphDataSipr.slice(0,8).map(d => d.avg), backgroundColor: '#3b82f6' }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
    });
    // NIPR VPH by ISIC chart
    const vphChartNipr = document.getElementById('analytics-chart-vphByIsicNipr');
    if (vphChartNipr) new Chart(vphChartNipr, {
        type: 'bar',
        data: { labels: isicVphDataNipr.slice(0,8).map(d => d.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'NIPR Avg VPH', data: isicVphDataNipr.slice(0,8).map(d => d.avg), backgroundColor: '#3b82f6' }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
    });
}
function showHelpModal() { document.getElementById('help-modal').style.display = 'flex'; }
function hideHelpModal() { document.getElementById('help-modal').style.display = 'none'; }

let pendingPrintTabId = null;
function showPrintScaleModal(tabId) {
    pendingPrintTabId = tabId;
    const modal = document.getElementById('print-scale-modal');
    const scaleText = document.getElementById('print-scale-text');
    if (tabId === 'analytics') {
        scaleText.innerHTML = 'For best results, set your Chrome print scale to <strong>75%</strong>';
    } else {
        scaleText.innerHTML = 'For best results, set your Chrome print scale between <strong>90% - 100%</strong>';
    }
    modal.style.display = 'flex';
}
function hidePrintScaleModal() { document.getElementById('print-scale-modal').style.display = 'none'; }
function proceedToPrint() {
    const tabId = pendingPrintTabId;
    hidePrintScaleModal();
    pendingPrintTabId = null;
    if (tabId) {
        printTab(tabId);
    }
}

// Analytics Sub-tab Navigation
let currentAnalyticsSubTab = 'main';
let currentSelectedIsic = '';
let currentSelectedBoat = '';

function showAnalyticsSubTab(tab) {
    currentAnalyticsSubTab = tab;

    // Update button styles
    document.querySelectorAll('.analytics-subtab-btn').forEach(btn => {
        btn.style.background = '#f1f5f9';
        btn.style.color = '#475569';
    });
    const activeBtn = document.getElementById('analytics-subtab-' + tab);
    if (activeBtn) {
        activeBtn.style.background = '#0891b2';
        activeBtn.style.color = 'white';
    }

    // Show/hide selectors
    document.getElementById('isic-selector').style.display = tab === 'isic' ? 'flex' : 'none';
    document.getElementById('boat-selector').style.display = tab === 'boat' ? 'flex' : 'none';

    // Show/hide content sections
    document.getElementById('analytics-main-content').style.display = tab === 'main' ? 'block' : 'none';
    document.getElementById('analytics-isic-content').style.display = tab === 'isic' ? 'block' : 'none';
    document.getElementById('analytics-boat-content').style.display = tab === 'boat' ? 'block' : 'none';

    // Initialize first selection if switching to ISIC or Boat tab
    if (tab === 'isic' && !currentSelectedIsic) {
        const isicSelect = document.getElementById('analytics-isic-select');
        if (isicSelect && isicSelect.options.length > 0) {
            updateIsicAnalytics(isicSelect.options[0].value);
        }
    }
    if (tab === 'boat' && !currentSelectedBoat) {
        const boatSelect = document.getElementById('analytics-boat-select');
        if (boatSelect && boatSelect.options.length > 0) {
            updateBoatAnalytics(boatSelect.options[0].value);
        }
    }
}

// Helper functions for boat data
function getBoatMaxVph(b) {
    const nipr = b.isNmci ? null : b.vramNiprRaVph;
    const sipr = b.vramSiprRaVph;
    if (nipr !== null && sipr !== null) return Math.max(nipr, sipr);
    return nipr !== null ? nipr : sipr;
}
function getBoatMinCompliance(b) {
    const nipr = b.isNmci ? null : b.essNiprTruePolicy;
    const sipr = b.essSiprTruePolicy;
    if (nipr !== null && sipr !== null) return Math.min(nipr, sipr);
    return nipr !== null ? nipr : sipr;
}
function getBoatTotalBreakfix(b) {
    return (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);
}

// Chart instances for cleanup
const isicCharts = {};
const boatCharts = {};

function updateIsicAnalytics(isic) {
    currentSelectedIsic = isic;
    // Hide all ISIC content
    document.querySelectorAll('.isic-analytics-content').forEach(el => el.style.display = 'none');

    if (!isic) return;

    // Show selected ISIC content
    const isicId = 'isic-analytics-' + isic.replace(/\\s+/g, '_');
    const content = document.getElementById(isicId);
    if (content) {
        content.style.display = 'block';
        // Initialize ISIC charts after a short delay to ensure DOM is ready
        setTimeout(() => initIsicCharts(isic), 100);
    }
}

function initIsicCharts(isic) {
    // Destroy existing charts
    Object.values(isicCharts).forEach(c => { if (c) c.destroy(); });

    // Get boats for this ISIC
    const isicBoats = allBoatsData.filter(b => b.isic === isic);
    const isicRiskCounts = {
        HIGH: isicBoats.filter(b => b.riskLevel === 'HIGH').length,
        MED: isicBoats.filter(b => b.riskLevel === 'MED').length,
        LOW: isicBoats.filter(b => b.riskLevel === 'LOW').length
    };
    const isicIdSafe = isic.replace(/\\s+/g, '_');

    // ISIC Risk Pie Chart
    const pieEl = document.getElementById('chart-isic-' + isicIdSafe + '-pie');
    if (pieEl) {
        isicCharts.pie = new Chart(pieEl, {
            type: 'pie',
            data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [isicRiskCounts.HIGH, isicRiskCounts.MED, isicRiskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
        });
    }

    // VPH by Boat Chart
    const vphEl = document.getElementById('chart-isic-' + isicIdSafe + '-vph');
    if (vphEl) {
        const boatVphs = isicBoats.map(b => ({ name: b.boatName, vph: getBoatMaxVph(b) || 0 })).sort((a, b) => b.vph - a.vph);
        isicCharts.vph = new Chart(vphEl, {
            type: 'bar',
            data: { labels: boatVphs.map(b => b.name), datasets: [{ label: 'VPH', data: boatVphs.map(b => b.vph), backgroundColor: '#3b82f6' }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 } } } }
        });
    }

    // Compliance by Boat Chart
    const compEl = document.getElementById('chart-isic-' + isicIdSafe + '-comp');
    if (compEl) {
        const boatComps = isicBoats.map(b => ({ name: b.boatName, comp: getBoatMinCompliance(b) || 0 })).sort((a, b) => a.comp - b.comp);
        isicCharts.comp = new Chart(compEl, {
            type: 'bar',
            data: { labels: boatComps.map(b => b.name), datasets: [{ label: 'True ESS Compliance %', data: boatComps.map(b => b.comp), backgroundColor: '#10b981' }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 }, max: 100 } } }
        });
    }

    // SIPR VPH by Boat Chart
    const vphSiprEl = document.getElementById('chart-isic-' + isicIdSafe + '-vph-sipr');
    if (vphSiprEl) {
        const boatVphsSipr = isicBoats.filter(b => b.vramSiprRaVph !== null).map(b => ({ name: b.boatName, vph: b.vramSiprRaVph })).sort((a, b) => b.vph - a.vph);
        isicCharts.vphSipr = new Chart(vphSiprEl, {
            type: 'bar',
            data: { labels: boatVphsSipr.map(b => b.name), datasets: [{ label: 'SIPR VPH', data: boatVphsSipr.map(b => b.vph), backgroundColor: '#3b82f6' }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 } } } }
        });
    }

    // NIPR VPH by Boat Chart (exclude NMCI boats)
    const vphNiprEl = document.getElementById('chart-isic-' + isicIdSafe + '-vph-nipr');
    if (vphNiprEl) {
        const boatVphsNipr = isicBoats.filter(b => !b.isNmci && b.vramNiprRaVph !== null).map(b => ({ name: b.boatName, vph: b.vramNiprRaVph })).sort((a, b) => b.vph - a.vph);
        isicCharts.vphNipr = new Chart(vphNiprEl, {
            type: 'bar',
            data: { labels: boatVphsNipr.map(b => b.name), datasets: [{ label: 'NIPR VPH', data: boatVphsNipr.map(b => b.vph), backgroundColor: '#3b82f6' }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 } } } }
        });
    }

    // SIPR True ESS Compliance by Boat Chart
    const compSiprEl = document.getElementById('chart-isic-' + isicIdSafe + '-comp-sipr');
    if (compSiprEl) {
        const boatCompsSipr = isicBoats.filter(b => b.essSiprTruePolicy !== null).map(b => ({ name: b.boatName, comp: b.essSiprTruePolicy })).sort((a, b) => a.comp - b.comp);
        isicCharts.compSipr = new Chart(compSiprEl, {
            type: 'bar',
            data: { labels: boatCompsSipr.map(b => b.name), datasets: [{ label: 'SIPR True ESS %', data: boatCompsSipr.map(b => b.comp), backgroundColor: '#10b981' }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 }, max: 100 } } }
        });
    }

    // NIPR True ESS Compliance by Boat Chart (exclude NMCI boats)
    const compNiprEl = document.getElementById('chart-isic-' + isicIdSafe + '-comp-nipr');
    if (compNiprEl) {
        const boatCompsNipr = isicBoats.filter(b => !b.isNmci && b.essNiprTruePolicy !== null).map(b => ({ name: b.boatName, comp: b.essNiprTruePolicy })).sort((a, b) => a.comp - b.comp);
        isicCharts.compNipr = new Chart(compNiprEl, {
            type: 'bar',
            data: { labels: boatCompsNipr.map(b => b.name), datasets: [{ label: 'NIPR True ESS %', data: boatCompsNipr.map(b => b.comp), backgroundColor: '#10b981' }] },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 }, max: 100 } } }
        });
    }
}

function updateBoatAnalytics(boatName) {
    currentSelectedBoat = boatName;
    // Hide all Boat content
    document.querySelectorAll('.boat-analytics-content').forEach(el => el.style.display = 'none');

    if (!boatName) return;

    // Show selected Boat content
    const boatId = 'boat-analytics-' + boatName.replace(/\\s+/g, '_');
    const content = document.getElementById(boatId);
    if (content) {
        content.style.display = 'block';
        // Initialize Boat charts after a short delay to ensure DOM is ready
        setTimeout(() => initBoatCharts(boatName), 100);
    }
}

function initBoatCharts(boatName) {
    // Destroy existing charts
    Object.values(boatCharts).forEach(c => { if (c) c.destroy(); });

    // Get boat data
    const boat = allBoatsData.find(b => b.boatName === boatName);
    if (!boat) return;

    const boatIdSafe = boatName.replace(/\\s+/g, '_');
    const boatVph = getBoatMaxVph(boat) || 0;
    const boatComp = getBoatMinCompliance(boat) || 0;

    // Get boat's enclave-specific values
    const boatVphSipr = boat.vramSiprRaVph !== null ? boat.vramSiprRaVph : null;
    const boatVphNipr = !boat.isNmci && boat.vramNiprRaVph !== null ? boat.vramNiprRaVph : null;
    const boatEssSipr = boat.essSiprTruePolicy !== null ? boat.essSiprTruePolicy : null;
    const boatEssNipr = !boat.isNmci && boat.essNiprTruePolicy !== null ? boat.essNiprTruePolicy : null;

    // Helper functions for enclave-specific averages
    const calcAvgSipr = (boats, field) => {
        const vals = boats.filter(b => b[field] !== null).map(b => b[field]);
        return vals.length > 0 ? vals.reduce((s, v) => s + v, 0) / vals.length : 0;
    };
    const calcAvgNipr = (boats, field) => {
        const vals = boats.filter(b => !b.isNmci && b[field] !== null).map(b => b[field]);
        return vals.length > 0 ? vals.reduce((s, v) => s + v, 0) / vals.length : 0;
    };

    // ISIC averages by enclave
    const isicBoats = allBoatsData.filter(b => b.isic === boat.isic);
    const isicAvgVphSipr = calcAvgSipr(isicBoats, 'vramSiprRaVph');
    const isicAvgVphNipr = calcAvgNipr(isicBoats, 'vramNiprRaVph');
    const isicAvgEssSipr = calcAvgSipr(isicBoats, 'essSiprTruePolicy');
    const isicAvgEssNipr = calcAvgNipr(isicBoats, 'essNiprTruePolicy');

    // TYCOM averages by enclave
    const tycomBoats = allBoatsData.filter(b => b.tycom === boat.tycom);
    const tycomAvgVphSipr = calcAvgSipr(tycomBoats, 'vramSiprRaVph');
    const tycomAvgVphNipr = calcAvgNipr(tycomBoats, 'vramNiprRaVph');
    const tycomAvgEssSipr = calcAvgSipr(tycomBoats, 'essSiprTruePolicy');
    const tycomAvgEssNipr = calcAvgNipr(tycomBoats, 'essNiprTruePolicy');

    // SUBFOR averages by enclave
    const subforAvgVphSipr = calcAvgSipr(allBoatsData, 'vramSiprRaVph');
    const subforAvgVphNipr = calcAvgNipr(allBoatsData, 'vramNiprRaVph');
    const subforAvgEssSipr = calcAvgSipr(allBoatsData, 'essSiprTruePolicy');
    const subforAvgEssNipr = calcAvgNipr(allBoatsData, 'essNiprTruePolicy');

    // Combined averages (legacy)
    const isicVphs = isicBoats.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
    const isicAvgVph = isicVphs.length > 0 ? isicVphs.reduce((s, v) => s + v, 0) / isicVphs.length : 0;
    const isicComps = isicBoats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy); if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v; });
    const isicAvgComp = isicComps.length > 0 ? isicComps.reduce((s, v) => s + v, 0) / isicComps.length : 0;
    const tycomVphs = tycomBoats.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
    const tycomAvgVph = tycomVphs.length > 0 ? tycomVphs.reduce((s, v) => s + v, 0) / tycomVphs.length : 0;
    const tycomComps = tycomBoats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy); if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v; });
    const tycomAvgComp = tycomComps.length > 0 ? tycomComps.reduce((s, v) => s + v, 0) / tycomComps.length : 0;
    const subforVphs = allBoatsData.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
    const subforAvgVph = subforVphs.length > 0 ? subforVphs.reduce((s, v) => s + v, 0) / subforVphs.length : 0;
    const subforComps = allBoatsData.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy); if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v; });
    const subforAvgComp = subforComps.length > 0 ? subforComps.reduce((s, v) => s + v, 0) / subforComps.length : 0;

    // Color helper: VPH lower is better (green if <= avg, red if > avg) - NO BLUE for equal
    const vphColor = (val, avg) => val <= avg ? '#22c55e' : '#ef4444';
    // Color helper: ESS higher is better (green if >= avg, red if < avg) - NO BLUE for equal
    const essColor = (val, avg) => val >= avg ? '#22c55e' : '#ef4444';

    // NEW: Consolidated SIPR VPH comparison chart (boat vs ISIC/TYCOM/SUBFOR averages)
    const vphSiprEl = document.getElementById('chart-boat-' + boatIdSafe + '-vph-sipr');
    if (vphSiprEl && boatVphSipr !== null) {
        const boatVal = boatVphSipr;
        // Color boat bar based on comparison to averages (green if better than or equal to all)
        const boatColor = boatVal <= isicAvgVphSipr && boatVal <= tycomAvgVphSipr && boatVal <= subforAvgVphSipr ? '#22c55e' : '#ef4444';
        boatCharts.vphSipr = new Chart(vphSiprEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'ISIC Avg', (boat.tycom || 'TYCOM') + ' Avg', 'SUBFOR Avg'],
                datasets: [{ data: [boatVal, isicAvgVphSipr, tycomAvgVphSipr, subforAvgVphSipr], backgroundColor: [boatColor, '#3b82f6', '#3b82f6', '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }

    // NEW: Consolidated NIPR VPH comparison chart (skip for NMCI boats)
    const vphNiprEl = document.getElementById('chart-boat-' + boatIdSafe + '-vph-nipr');
    if (vphNiprEl && boatVphNipr !== null && !boat.isNmci) {
        const boatVal = boatVphNipr;
        const boatColor = boatVal <= isicAvgVphNipr && boatVal <= tycomAvgVphNipr && boatVal <= subforAvgVphNipr ? '#22c55e' : '#ef4444';
        boatCharts.vphNipr = new Chart(vphNiprEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'ISIC Avg', (boat.tycom || 'TYCOM') + ' Avg', 'SUBFOR Avg'],
                datasets: [{ data: [boatVal, isicAvgVphNipr, tycomAvgVphNipr, subforAvgVphNipr], backgroundColor: [boatColor, '#3b82f6', '#3b82f6', '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }

    // NEW: Consolidated SIPR ESS comparison chart
    const essSiprEl = document.getElementById('chart-boat-' + boatIdSafe + '-ess-sipr');
    if (essSiprEl && boatEssSipr !== null) {
        const boatVal = boatEssSipr;
        // Color boat bar: green if >= all averages
        const boatColor = boatVal >= isicAvgEssSipr && boatVal >= tycomAvgEssSipr && boatVal >= subforAvgEssSipr ? '#22c55e' : '#ef4444';
        boatCharts.essSipr = new Chart(essSiprEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'ISIC Avg', (boat.tycom || 'TYCOM') + ' Avg', 'SUBFOR Avg'],
                datasets: [{ data: [boatVal, isicAvgEssSipr, tycomAvgEssSipr, subforAvgEssSipr], backgroundColor: [boatColor, '#3b82f6', '#3b82f6', '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    // NEW: Consolidated NIPR ESS comparison chart (skip for NMCI boats)
    const essNiprEl = document.getElementById('chart-boat-' + boatIdSafe + '-ess-nipr');
    if (essNiprEl && boatEssNipr !== null && !boat.isNmci) {
        const boatVal = boatEssNipr;
        const boatColor = boatVal >= isicAvgEssNipr && boatVal >= tycomAvgEssNipr && boatVal >= subforAvgEssNipr ? '#22c55e' : '#ef4444';
        boatCharts.essNipr = new Chart(essNiprEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'ISIC Avg', (boat.tycom || 'TYCOM') + ' Avg', 'SUBFOR Avg'],
                datasets: [{ data: [boatVal, isicAvgEssNipr, tycomAvgEssNipr, subforAvgEssNipr], backgroundColor: [boatColor, '#3b82f6', '#3b82f6', '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    // Legacy VPH vs ISIC comparison chart (lower VPH is better: green if <= avg, red if > avg) - FIXED: no blue
    const isicVphEl = document.getElementById('chart-boat-' + boatIdSafe + '-isic-vph');
    if (isicVphEl) {
        const isicVphBoatColor = vphColor(boatVph, isicAvgVph);
        boatCharts.isicVph = new Chart(isicVphEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'ISIC Avg'],
                datasets: [{ data: [boatVph, isicAvgVph], backgroundColor: [isicVphBoatColor, '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
    // Legacy True ESS vs ISIC comparison chart (higher ESS is better: green if >= avg, red if < avg) - FIXED: no blue
    const isicEssEl = document.getElementById('chart-boat-' + boatIdSafe + '-isic-ess');
    if (isicEssEl) {
        const isicEssBoatColor = essColor(boatComp, isicAvgComp);
        boatCharts.isicEss = new Chart(isicEssEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'ISIC Avg'],
                datasets: [{ data: [boatComp, isicAvgComp], backgroundColor: [isicEssBoatColor, '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    // Legacy VPH vs TYCOM comparison chart - FIXED: no blue
    const tycomVphEl = document.getElementById('chart-boat-' + boatIdSafe + '-tycom-vph');
    if (tycomVphEl) {
        const tycomVphBoatColor = vphColor(boatVph, tycomAvgVph);
        boatCharts.tycomVph = new Chart(tycomVphEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, (boat.tycom || 'TYCOM') + ' Avg'],
                datasets: [{ data: [boatVph, tycomAvgVph], backgroundColor: [tycomVphBoatColor, '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
    // Legacy True ESS vs TYCOM comparison chart - FIXED: no blue
    const tycomEssEl = document.getElementById('chart-boat-' + boatIdSafe + '-tycom-ess');
    if (tycomEssEl) {
        const tycomEssBoatColor = essColor(boatComp, tycomAvgComp);
        boatCharts.tycomEss = new Chart(tycomEssEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, (boat.tycom || 'TYCOM') + ' Avg'],
                datasets: [{ data: [boatComp, tycomAvgComp], backgroundColor: [tycomEssBoatColor, '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    // Legacy VPH vs SUBFOR comparison chart - FIXED: no blue
    const subforVphEl = document.getElementById('chart-boat-' + boatIdSafe + '-subfor-vph');
    if (subforVphEl) {
        const subforVphBoatColor = vphColor(boatVph, subforAvgVph);
        boatCharts.subforVph = new Chart(subforVphEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'SUBFOR Avg'],
                datasets: [{ data: [boatVph, subforAvgVph], backgroundColor: [subforVphBoatColor, '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
    // Legacy True ESS vs SUBFOR comparison chart - FIXED: no blue
    const subforEssEl = document.getElementById('chart-boat-' + boatIdSafe + '-subfor-ess');
    if (subforEssEl) {
        const subforEssBoatColor = essColor(boatComp, subforAvgComp);
        boatCharts.subforEss = new Chart(subforEssEl, {
            type: 'bar',
            data: {
                labels: [boat.boatName, 'SUBFOR Avg'],
                datasets: [{ data: [boatComp, subforAvgComp], backgroundColor: [subforEssBoatColor, '#3b82f6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    // Legacy combined charts (for backward compatibility)
    const isicCompEl = document.getElementById('chart-boat-' + boatIdSafe + '-isic');
    if (isicCompEl) {
        boatCharts.isic = new Chart(isicCompEl, {
            type: 'bar',
            data: {
                labels: ['VPH', 'True ESS Compliance %'],
                datasets: [
                    { label: boat.boatName, data: [boatVph, boatComp], backgroundColor: '#3b82f6' },
                    { label: 'ISIC Avg', data: [isicAvgVph, isicAvgComp], backgroundColor: '#94a3b8' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
        });
    }
    const tycomCompEl = document.getElementById('chart-boat-' + boatIdSafe + '-tycom');
    if (tycomCompEl) {
        boatCharts.tycom = new Chart(tycomCompEl, {
            type: 'bar',
            data: {
                labels: ['VPH', 'True ESS Compliance %'],
                datasets: [
                    { label: boat.boatName, data: [boatVph, boatComp], backgroundColor: '#3b82f6' },
                    { label: (boat.tycom || 'TYCOM') + ' Avg', data: [tycomAvgVph, tycomAvgComp], backgroundColor: '#94a3b8' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
        });
    }
    const subforCompEl = document.getElementById('chart-boat-' + boatIdSafe + '-subfor');
    if (subforCompEl) {
        boatCharts.subfor = new Chart(subforCompEl, {
            type: 'bar',
            data: {
                labels: ['VPH', 'True ESS Compliance %'],
                datasets: [
                    { label: boat.boatName, data: [boatVph, boatComp], backgroundColor: '#3b82f6' },
                    { label: 'SUBFOR Avg', data: [subforAvgVph, subforAvgComp], backgroundColor: '#94a3b8' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
        });
    }
}

<\/script>
<div id="help-modal" class="no-print" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;" onclick="hideHelpModal()">
<div style="background:white;border-radius:12px;padding:24px;max-width:600px;max-height:80vh;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
<h3 style="font-size:16pt;font-weight:bold;margin-bottom:16px;color:#334155;">Risk Calculation Reference</h3>
<div style="font-size:10pt;">
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#dc2626;margin-bottom:6px;">HIGH Risk</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.highItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#d97706;margin-bottom:6px;">MEDIUM Risk (2 or more of the following)</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.medItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#059669;margin-bottom:6px;">LOW Risk</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.lowItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#334155;margin-bottom:6px;">Key Calculations</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.calcItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div>
<h4 style="font-weight:bold;color:#0ea5e9;margin-bottom:6px;">Scan Exempt</h4>
<p style="color:#475569;">${formatHelpText(helpModalText.scanExempt || '')}</p>
</div>
</div>
<div style="margin-top:20px;"><button onclick="hideHelpModal()" style="background:#0ea5e9;color:white;border:none;padding:10px 24px;border-radius:6px;font-weight:600;cursor:pointer;">Close</button></div>
</div>
</div>
<div id="print-scale-modal" class="no-print" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;" onclick="hidePrintScaleModal()">
<div style="background:white;border-radius:12px;padding:24px;max-width:400px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
<h3 style="font-size:14pt;font-weight:bold;margin-bottom:16px;color:#334155;">Print Scale Recommendation</h3>
<p id="print-scale-text" style="font-size:11pt;color:#475569;margin-bottom:20px;"></p>
<p style="font-size:9pt;color:#94a3b8;margin-bottom:12px;">You can adjust the scale in Chrome's print dialog under "More settings"</p>
<p style="font-size:9pt;color:#94a3b8;margin-bottom:20px;">For printing, set custom margins: <strong style="color:#475569;">Top 0.25"</strong>, all other sides <strong style="color:#475569;">0"</strong> (not necessary for PDF saving)</p>
<div style="display:flex;gap:12px;justify-content:center;">
<button onclick="hidePrintScaleModal()" style="background:#94a3b8;color:white;border:none;padding:10px 20px;border-radius:6px;font-weight:600;cursor:pointer;">Cancel</button>
<button onclick="proceedToPrint()" style="background:#0ea5e9;color:white;border:none;padding:10px 20px;border-radius:6px;font-weight:600;cursor:pointer;">Continue to Print</button>
</div>
</div>
</div>
</body></html>`;
};

// Components
const DragDropZone = ({ label, file, onDrop, onClear }) => {
    const [drag, setDrag] = React.useState(false);
    return (
        <div className={`drag-zone p-6 text-center cursor-pointer ${drag ? 'drag-active' : ''} ${file ? 'has-file' : ''}`}
            onDragOver={(e) => { e.preventDefault(); setDrag(true); }} onDragLeave={() => setDrag(false)}
            onDrop={(e) => { e.preventDefault(); setDrag(false); if (e.dataTransfer.files[0]) onDrop(e.dataTransfer.files[0]); }}
            onClick={() => document.getElementById('file-' + label).click()}>
            <div className="font-medium text-slate-600 mb-2">{label}</div>
            {file ? <div className="flex items-center justify-center gap-2"><span className="text-emerald-600">[OK] {file.name}</span><button onClick={(e) => { e.stopPropagation(); onClear(); }} className="text-red-500 ml-2">x</button></div> : <div className="text-slate-400 text-sm">Drag & drop or click</div>}
            <input type="file" accept=".xlsx,.xls,.csv,.ods" onChange={(e) => { if (e.target.files[0]) onDrop(e.target.files[0]); }} className="hidden" id={'file-' + label} />
        </div>
    );
};

const ImportTab = ({ importedFiles, setImportedFiles, settings, setSettings, reportData, onProcess, onAlert, onReportImport }) => {
    const [reportDrag, setReportDrag] = React.useState(false);
    const handleDrop = (key) => (file) => { const r = new FileReader(); r.onload = (e) => setImportedFiles(p => ({...p, [key]: { name: file.name, data: new Uint8Array(e.target.result) }})); r.readAsArrayBuffer(file); };

    const handleReportDrop = async (e) => {
        e.preventDefault(); e.stopPropagation(); setReportDrag(false);
        const file = e.dataTransfer?.files?.[0];
        if (file?.name.endsWith('.html')) { onReportImport(file); }
        else { onAlert({ type: 'error', msg: 'Please drop an HTML report file' }); }
    };

    const handleReportClick = () => { document.getElementById('report-file-input').click(); };
    const handleReportFileChange = (e) => { if (e.target.files?.[0]) onReportImport(e.target.files[0]); };

    const process = () => {
        try {
            const schema = settings.schemaConfig || defaultSchemaConfig;
            const sources = {
                vramNipr: importedFiles.vramNipr ? parseVRAM(importedFiles.vramNipr.data, schema.vram) : null,
                vramSipr: importedFiles.vramSipr ? parseVRAM(importedFiles.vramSipr.data, schema.vram) : null,
                essNipr: importedFiles.essNipr ? parseESS(importedFiles.essNipr.data, schema.ess) : null,
                essSipr: importedFiles.essSipr ? parseESS(importedFiles.essSipr.data, schema.ess) : null,
                tam: importedFiles.tam ? parseTAM(importedFiles.tam.data, schema.tam) : null
            };

            // Check if this is an update to existing report
            const isUpdate = reportData && reportData.boats && reportData.boats.length > 0;
            const updatedSources = Object.entries(sources).filter(([k, v]) => v !== null).map(([k]) => k);

            // Strip raw data from sources to reduce file size (only keep parsed data needed for merging)
            const stripRaw = (src) => src ? { parsed: src.parsed, customFieldDefs: src.customFieldDefs, isicMap: src.isicMap } : null;

            let boats, report;
            if (isUpdate && updatedSources.length > 0) {
                // Merge new sources with existing source data
                const mergedSources = { ...reportData.sourceData };
                Object.entries(sources).forEach(([key, val]) => { if (val !== null) mergedSources[key] = stripRaw(val); });
                const result = mergeData(mergedSources, settings);
                boats = result.boats;

                // Preserve overrides only for fields NOT being updated by new data
                // Map sources to the fields they update
                const sourceFields = {
                    vramNipr: ['vramNiprScanDate', 'vramNiprAssets', 'vramNiprRaVph'],
                    vramSipr: ['vramSiprScanDate', 'vramSiprAssets', 'vramSiprRaVph'],
                    essNipr: ['essNiprProductCompliance', 'essNiprPolicyEnforced', 'essNiprBreakfix', 'essNiprAssets'],
                    essSipr: ['essSiprProductCompliance', 'essSiprPolicyEnforced', 'essSiprBreakfix', 'essSiprAssets'],
                    tam: ['tamPastDue', 'tamExtensions']
                };
                // Get all fields being updated by new sources
                const updatedFields = new Set(updatedSources.flatMap(src => sourceFields[src] || []));

                boats.forEach(newBoat => {
                    const oldBoat = reportData.boats.find(b => b.boatName === newBoat.boatName);
                    // Only keep overrides for fields NOT being updated
                    if (oldBoat?.overrides?.length) {
                        newBoat.overrides = oldBoat.overrides.filter(o => !updatedFields.has(o.field));
                    }
                    if (oldBoat?.notes) newBoat.notes = oldBoat.notes;
                });

                calculateAllRisks(boats, settings.thresholds);

                // Build update changelog entry
                const sourceLabels = { vramNipr: 'VRAM NIPR', vramSipr: 'VRAM SIPR', essNipr: 'ESS NIPR', essSipr: 'ESS SIPR', tam: 'TAM' };
                const updateEntry = { type: 'dataUpdate', sources: updatedSources.map(k => sourceLabels[k] || k), files: updatedSources.map(k => importedFiles[k]?.name).filter(Boolean), timestamp: new Date().toISOString(), user: 'User' };

                report = {
                    ...reportData,
                    boats,
                    sourceData: mergedSources,
                    lastModifiedAt: new Date().toISOString(),
                    version: (reportData.version || 1) + 1,
                    sourceFiles: { ...reportData.sourceFiles, ...Object.fromEntries(updatedSources.map(k => [k, importedFiles[k]?.name])) },
                    dataUpdates: [...(reportData.dataUpdates || []), updateEntry]
                };
                onAlert({ type: 'info', msg: `Updated ${updatedSources.map(k => sourceLabels[k]).join(', ')} - overrides for updated fields were replaced with new data` });
            } else {
                // Fresh report - strip raw data to reduce file size
                const result = mergeData(sources, settings);
                boats = result.boats;
                calculateAllRisks(boats, settings.thresholds);
                const strippedSources = { vramNipr: stripRaw(sources.vramNipr), vramSipr: stripRaw(sources.vramSipr), essNipr: stripRaw(sources.essNipr), essSipr: stripRaw(sources.essSipr), tam: stripRaw(sources.tam) };
                report = { boats, settingsSnapshot: JSON.parse(JSON.stringify(settings)), sourceData: strippedSources, createdAt: new Date().toISOString(), createdBy: '', lastModifiedAt: new Date().toISOString(), lastModifiedBy: '', version: 1, sourceFiles: { vramNipr: importedFiles.vramNipr?.name, vramSipr: importedFiles.vramSipr?.name, essNipr: importedFiles.essNipr?.name, essSipr: importedFiles.essSipr?.name, tam: importedFiles.tam?.name }, dataUpdates: [] };
                if (result.unregistered.length > 0) onAlert({ type: 'warning', msg: `Unregistered: ${result.unregistered.slice(0,5).join(', ')}${result.unregistered.length>5?'...':''} - Add in Settings` });
            }
            onProcess(report);
        } catch (err) { onAlert({ type: 'error', msg: err.message }); }
    };

    const slots = [{ key: 'vramNipr', label: 'VRAM NIPR' }, { key: 'vramSipr', label: 'VRAM SIPR' }, { key: 'essNipr', label: 'ESS NIPR' }, { key: 'essSipr', label: 'ESS SIPR' }, { key: 'tam', label: 'TAM Overdue' }];
    const hasExistingReport = reportData && reportData.boats && reportData.boats.length > 0;
    const hasNewFiles = Object.values(importedFiles).some(f => f);

    return (
        <div>
            {hasExistingReport && (
                <div className="mb-4 p-3 bg-cyan-50 border border-cyan-200 rounded-lg flex items-center gap-3">
                    <span className="text-cyan-700 font-medium">Active Report: v{reportData.version || 1}</span>
                    <span className="text-cyan-600 text-sm">({reportData.boats.length} boats)</span>
                    <span className="text-cyan-500 text-sm">• Drop new files below to update data sources (overrides for updated fields will be replaced)</span>
                </div>
            )}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <h2 className="text-2xl font-bold mb-4 text-slate-800">{hasExistingReport ? 'Update Data Sources' : 'Import Data Files'}</h2>
                    <div className="grid grid-cols-2 gap-3">{slots.map(s => <DragDropZone key={s.key} label={s.label} file={importedFiles[s.key]} onDrop={handleDrop(s.key)} onClear={() => setImportedFiles(p => ({...p, [s.key]: null}))} />)}</div>
                </div>
                <div>
                    <h2 className="text-2xl font-bold mb-4 text-purple-700">Re-Edit Previous Report</h2>
                    <div className={`drag-zone p-8 text-center cursor-pointer h-full min-h-[200px] flex flex-col items-center justify-center ${reportDrag ? 'drag-active' : ''}`}
                        style={{borderColor: reportDrag ? '#7c3aed' : '#cbd5e1', background: reportDrag ? '#f5f3ff' : '#ffffff'}}
                        onDragOver={(e) => { e.preventDefault(); setReportDrag(true); }} onDragLeave={() => setReportDrag(false)} onDrop={handleReportDrop} onClick={handleReportClick}>
                        <div className="text-2xl mb-3 text-purple-600 font-bold">[RE-EDIT]</div>
                        <div className="font-medium text-slate-600 mb-2">Drop Generated Report HTML</div>
                        <div className="text-slate-400 text-sm">Re-edit with original settings & data</div>
                        <input type="file" accept=".html" onChange={handleReportFileChange} className="hidden" id="report-file-input" />
                    </div>
                </div>
            </div>
            <div className="flex gap-4 flex-wrap">
                <button onClick={process} disabled={!hasNewFiles} className="btn-primary">{hasExistingReport && hasNewFiles ? 'Update & Preview' : 'Process & Preview'}</button>
                <button onClick={() => setImportedFiles({vramNipr:null,vramSipr:null,essNipr:null,essSipr:null,tam:null})} className="btn-secondary">Clear All</button>
            </div>
        </div>
    );
};

// HQ Status Preview Component with customizable metrics
const HQStatusPreview = ({ boats, settings, onLayoutChange }) => {
    const [layout, setLayout] = React.useState(() => settings.hqStatusLayout || defaultHQStatusLayout);
    const [draggedIdx, setDraggedIdx] = React.useState(null);
    const [showAddModal, setShowAddModal] = React.useState(false);

    // Get color thresholds from settings
    const th = settings.thresholds || defaultThresholds;

    // Compute aggregates by ISIC and TYCOM
    const groupByISIC = (boats) => boats.reduce((acc, b) => { (acc[b.isic] = acc[b.isic] || []).push(b); return acc; }, {});

    // Color class functions using HQ-specific thresholds
    const prodCompClass = (v) => v === null ? '' : v >= (th.hq_color_product_green || 95) ? 'risk-low' : v < (th.hq_color_product_red || 90) ? 'risk-high' : 'risk-med';
    const policyCompClass = (v) => v === null ? '' : v >= (th.hq_color_policy_green || 95) ? 'risk-low' : v < (th.hq_color_policy_red || 90) ? 'risk-high' : 'risk-med';
    const policyRawClass = (v) => v === null ? '' : v >= (th.hq_color_policy_raw_green || 95) ? 'risk-low' : v < (th.hq_color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';

    const aggregateByISIC = (boats) => {
        const groups = groupByISIC(boats);
        return Object.entries(groups).map(([isic, isicBoats]) => {
            const nProdVals = isicBoats.filter(b => !b.isNmci && b.essNiprProductCompliance !== null).map(b => b.essNiprProductCompliance);
            const nPolVals = isicBoats.filter(b => !b.isNmci && b.essNiprTruePolicy !== null).map(b => b.essNiprTruePolicy);
            const nPolRawVals = isicBoats.filter(b => !b.isNmci && b.essNiprPolicyEnforced !== null).map(b => b.essNiprPolicyEnforced);
            const sProdVals = isicBoats.filter(b => b.essSiprProductCompliance !== null).map(b => b.essSiprProductCompliance);
            const sPolVals = isicBoats.filter(b => b.essSiprTruePolicy !== null).map(b => b.essSiprTruePolicy);
            const sPolRawVals = isicBoats.filter(b => b.essSiprPolicyEnforced !== null).map(b => b.essSiprPolicyEnforced);
            return {
                isicName: isic,
                isicShort: isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS'),
                boatCount: isicBoats.length,
                niprProdCompAvg: nProdVals.length ? nProdVals.reduce((s,v)=>s+v,0)/nProdVals.length : 0,
                niprPolEnfAvg: nPolVals.length ? nPolVals.reduce((s,v)=>s+v,0)/nPolVals.length : 0,
                niprPolRawAvg: nPolRawVals.length ? nPolRawVals.reduce((s,v)=>s+v,0)/nPolRawVals.length : 0,
                niprBreakfixSum: isicBoats.reduce((s,b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)), 0),
                siprProdCompAvg: sProdVals.length ? sProdVals.reduce((s,v)=>s+v,0)/sProdVals.length : 0,
                siprPolEnfAvg: sPolVals.length ? sPolVals.reduce((s,v)=>s+v,0)/sPolVals.length : 0,
                siprPolRawAvg: sPolRawVals.length ? sPolRawVals.reduce((s,v)=>s+v,0)/sPolRawVals.length : 0,
                siprBreakfixSum: isicBoats.reduce((s,b) => s + (b.essSiprBreakfix || 0), 0),
                highRiskCount: isicBoats.filter(b => b.riskLevel === 'HIGH').length,
                scanExemptCount: isicBoats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length
            };
        }).sort((a,b) => a.isicName.localeCompare(b.isicName));
    };

    const cslBoats = boats.filter(b => b.tycom === 'CSL');
    const cspBoats = boats.filter(b => b.tycom === 'CSP');
    const aggs = { csl: aggregateByISIC(cslBoats), csp: aggregateByISIC(cspBoats) };

    const visibleMetrics = layout.filter(m => m.visible);

    const getMetricValue = (agg, metricId) => {
        switch(metricId) {
            case 'niprProdComp': return { value: agg.niprProdCompAvg.toFixed(1) + '%', className: prodCompClass(agg.niprProdCompAvg) };
            case 'niprPolEnf': return { value: agg.niprPolEnfAvg.toFixed(1) + '%', className: policyCompClass(agg.niprPolEnfAvg) };
            case 'niprPolRaw': return { value: agg.niprPolRawAvg.toFixed(1) + '%', className: policyRawClass(agg.niprPolRawAvg) };
            case 'niprBreakfix': return { value: agg.niprBreakfixSum, className: agg.niprBreakfixSum > 0 ? 'risk-high' : '' };
            case 'siprProdComp': return { value: agg.siprProdCompAvg.toFixed(1) + '%', className: prodCompClass(agg.siprProdCompAvg) };
            case 'siprPolEnf': return { value: agg.siprPolEnfAvg.toFixed(1) + '%', className: policyCompClass(agg.siprPolEnfAvg) };
            case 'siprPolRaw': return { value: agg.siprPolRawAvg.toFixed(1) + '%', className: policyRawClass(agg.siprPolRawAvg) };
            case 'siprBreakfix': return { value: agg.siprBreakfixSum, className: agg.siprBreakfixSum > 0 ? 'risk-high' : '' };
            case 'highRisk': return { value: agg.highRiskCount, className: agg.highRiskCount > 0 ? 'risk-high' : '' };
            case 'scanExempt': return { value: agg.scanExemptCount, className: agg.scanExemptCount > 0 ? 'alert-blue' : '' };
            default: return { value: '-', className: '' };
        }
    };

    const handleDragStart = (idx) => setDraggedIdx(idx);
    const handleDragOver = (e) => e.preventDefault();
    const handleDrop = (targetIdx) => {
        if (draggedIdx === null || draggedIdx === targetIdx) return;
        const newLayout = [...layout];
        const [dragged] = newLayout.splice(draggedIdx, 1);
        newLayout.splice(targetIdx, 0, dragged);
        setLayout(newLayout);
        setDraggedIdx(null);
        if (onLayoutChange) onLayoutChange(newLayout);
    };

    const toggleVisibility = (idx) => {
        const newLayout = [...layout];
        newLayout[idx] = { ...newLayout[idx], visible: !newLayout[idx].visible };
        setLayout(newLayout);
        if (onLayoutChange) onLayoutChange(newLayout);
    };

    const renderTable = (tycom, aggs) => (
        <div className="mb-6">
            <h3 className="text-lg font-bold mb-3 text-slate-700">{tycom} Status</h3>
            <div className="overflow-x-auto">
                <table className="data-table hq-preview-table">
                    <thead>
                        <tr>
                            <th style={{textAlign:'left'}}>Metric</th>
                            {aggs.map(a => <th key={a.isicName}>{a.isicShort} ({a.boatCount})</th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {visibleMetrics.map(metric => (
                            <tr key={metric.id}>
                                <td style={{textAlign:'left',fontWeight:600}}>{metric.label}</td>
                                {aggs.map(a => {
                                    const { value, className } = getMetricValue(a, metric.id);
                                    return <td key={a.isicName} className={className}>{value}</td>;
                                })}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );

    return (
        <div className="card p-4">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-slate-700">HQ Status Preview</h3>
                <button onClick={() => setShowAddModal(!showAddModal)} className="px-3 py-1 bg-cyan-600 text-white rounded text-sm">{showAddModal ? 'Hide' : 'Configure'} Metrics</button>
            </div>

            {showAddModal && (
                <div className="mb-4 p-4 bg-slate-50 rounded border border-slate-200">
                    <p className="text-sm text-slate-600 mb-3">Drag to reorder, click checkbox to show/hide:</p>
                    <div className="space-y-2">
                        {layout.map((metric, idx) => (
                            <div key={metric.id} draggable onDragStart={() => handleDragStart(idx)} onDragOver={handleDragOver} onDrop={() => handleDrop(idx)}
                                className="flex items-center gap-3 p-2 bg-white rounded border border-slate-200 cursor-move hover:bg-slate-50">
                                <span className="text-slate-400">☰</span>
                                <input type="checkbox" checked={metric.visible} onChange={() => toggleVisibility(idx)} />
                                <span className={`text-sm ${metric.visible ? 'text-slate-700' : 'text-slate-400'}`}>{metric.label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {renderTable('CSL', aggs.csl)}
            {renderTable('CSP', aggs.csp)}
        </div>
    );
};

// Analytics Preview Component with drag/drop grid
const AnalyticsPreview = ({ boats, settings, onLayoutChange, onIsicLayoutChange, onBoatLayoutChange }) => {
    const [showSidebar, setShowSidebar] = React.useState(false);
    const [draggedItem, setDraggedItem] = React.useState(null);
    const [analyticsSubTab, setAnalyticsSubTab] = React.useState('main');
    const [selectedIsic, setSelectedIsic] = React.useState('');
    const [selectedBoat, setSelectedBoat] = React.useState('');
    const [layout, setLayout] = React.useState(() => {
        // Initialize from settings or use default
        return settings.analyticsLayout || defaultAnalyticsLayout;
    });
    const [isicLayout, setIsicLayout] = React.useState(() => {
        return settings.isicAnalyticsLayout || defaultIsicAnalyticsLayout;
    });
    const [boatLayout, setBoatLayout] = React.useState(() => {
        return settings.boatAnalyticsLayout || defaultBoatAnalyticsLayout;
    });
    const chartRefs = React.useRef({});

    // Compute analytics data
    const riskCounts = { HIGH: boats.filter(b => b.riskLevel === 'HIGH').length, MED: boats.filter(b => b.riskLevel === 'MED').length, LOW: boats.filter(b => b.riskLevel === 'LOW').length };
    const vphValues = boats.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
    const avgVph = vphValues.length > 0 ? (vphValues.reduce((s, v) => s + v, 0) / vphValues.length).toFixed(2) : '0';
    const totalBreakfix = boats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
    const compValues = boats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy); if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v; });
    const avgCompliance = compValues.length > 0 ? Math.min(100, compValues.reduce((s, v) => s + v, 0) / compValues.length).toFixed(1) : '0';
    const prodCompValues = boats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprProductCompliance !== null) v.push(b.essNiprProductCompliance); if (b.essSiprProductCompliance !== null) v.push(b.essSiprProductCompliance); return v; });
    const avgProductCompliance = prodCompValues.length > 0 ? Math.min(100, prodCompValues.reduce((s, v) => s + v, 0) / prodCompValues.length).toFixed(1) : '0';
    const scanExemptCount = boats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length;

    // Helper functions
    const getBoatMaxVph = (b) => { const nipr = b.isNmci ? null : b.vramNiprRaVph; const sipr = b.vramSiprRaVph; if (nipr !== null && sipr !== null) return Math.max(nipr, sipr); return nipr !== null ? nipr : sipr; };
    const getBoatMinCompliance = (b) => { const nipr = b.isNmci ? null : b.essNiprTruePolicy; const sipr = b.essSiprTruePolicy; if (nipr !== null && sipr !== null) return Math.min(nipr, sipr); return nipr !== null ? nipr : sipr; };
    const getBoatMinProductCompliance = (b) => { const nipr = b.isNmci ? null : b.essNiprProductCompliance; const sipr = b.essSiprProductCompliance; if (nipr !== null && sipr !== null) return Math.min(nipr, sipr); return nipr !== null ? nipr : sipr; };
    const getBoatTotalBreakfix = (b) => (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);

    // Rankings data
    const worstVph = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(b)||0) - (getBoatMaxVph(a)||0)).slice(0, 5);
    const bestVph = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(a)||0) - (getBoatMaxVph(b)||0)).slice(0, 5);
    const worstCompliance = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(a)||0) - (getBoatMinCompliance(b)||0)).slice(0, 5);
    const bestCompliance = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(b)||0) - (getBoatMinCompliance(a)||0)).slice(0, 5);
    const boatsBreakfix = [...boats].filter(b => getBoatTotalBreakfix(b) > 0).sort((a,b) => getBoatTotalBreakfix(b) - getBoatTotalBreakfix(a)).slice(0, 5);
    const highRiskBoats = boats.filter(b => b.riskLevel === 'HIGH');

    // ISIC data for rankings
    const groupByISIC = (boats) => boats.reduce((acc, b) => { acc[b.isic] = acc[b.isic] || []; acc[b.isic].push(b); return acc; }, {});
    const isicData = Object.entries(groupByISIC(boats)).map(([isic, ib]) => {
        const vphVals = ib.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
        const compVals = ib.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy); if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v; });
        return { isic, boats: ib.length, high: ib.filter(b=>b.riskLevel==='HIGH').length, low: ib.filter(b=>b.riskLevel==='LOW').length, lowPct: ib.length ? (ib.filter(b=>b.riskLevel==='LOW').length/ib.length*100) : 0, avgVph: vphVals.length > 0 ? vphVals.reduce((s,v)=>s+v,0)/vphVals.length : 0, avgComp: compVals.length > 0 ? Math.min(100, compVals.reduce((s,v)=>s+v,0)/compVals.length) : 0 };
    });
    const worstIsicsRisk = [...isicData].sort((a,b) => b.high - a.high).slice(0, 5);
    const bestIsicsRisk = [...isicData].sort((a,b) => b.lowPct - a.lowPct).slice(0, 5);
    const worstIsicsVph = [...isicData].sort((a,b) => b.avgVph - a.avgVph).slice(0, 5);
    const worstIsicsCompliance = [...isicData].sort((a,b) => a.avgComp - b.avgComp).slice(0, 5);
    const bestIsicsCompliance = [...isicData].sort((a,b) => b.avgComp - a.avgComp).slice(0, 5);

    // TYCOM data
    const groupByTycom = (boats) => boats.reduce((acc, b) => { const t = b.tycom || 'Unknown'; acc[t] = acc[t] || []; acc[t].push(b); return acc; }, {});
    const tycomData = Object.entries(groupByTycom(boats)).map(([tycom, tb]) => ({
        tycom, boats: tb.length, high: tb.filter(b=>b.riskLevel==='HIGH').length, med: tb.filter(b=>b.riskLevel==='MED').length, low: tb.filter(b=>b.riskLevel==='LOW').length
    }));

    // Available elements for sidebar
    const availableElements = [
        { id: 'totalBoats', type: 'stat', label: 'Total Boats' },
        { id: 'highRisk', type: 'stat', label: 'High Risk Count' },
        { id: 'medRisk', type: 'stat', label: 'Medium Risk Count' },
        { id: 'lowRisk', type: 'stat', label: 'Low Risk Count' },
        { id: 'avgVph', type: 'stat', label: 'Avg VPH' },
        { id: 'totalBreakfix', type: 'stat', label: 'Total Breakfix' },
        { id: 'avgCompliance', type: 'stat', label: 'True ESS Compliance' },
        { id: 'avgProductCompliance', type: 'stat', label: 'Avg Product Compliance %' },
        { id: 'scanExempt', type: 'stat', label: 'Scan Exempt' },
        { id: 'riskPieChart', type: 'chart', label: 'Risk Pie Chart' },
        { id: 'riskDonutChart', type: 'chart', label: 'Overall Risk' },
        { id: 'riskDistribution', type: 'chart', label: 'Risk Bar Chart' },
        { id: 'riskByTycom', type: 'chart', label: 'Risk by TYCOM' },
        { id: 'vphByIsic', type: 'chart', label: 'VPH by ISIC' },
        { id: 'highRiskTable', type: 'chart', label: 'High Risk Boats Table' },
        { id: 'worstBoatsVph', type: 'ranking', label: 'Worst Boats by VPH' },
        { id: 'bestBoatsVph', type: 'ranking', label: 'Best Boats by VPH' },
        { id: 'worstBoatsCompliance', type: 'ranking', label: 'Worst by True ESS Compliance' },
        { id: 'bestBoatsCompliance', type: 'ranking', label: 'Best by True ESS Compliance' },
        { id: 'boatsWithBreakfix', type: 'ranking', label: 'Boats with Breakfix' },
        { id: 'worstIsicsRisk', type: 'ranking', label: 'Worst ISICs by Risk' },
        { id: 'bestIsicsRisk', type: 'ranking', label: 'Best ISICs by Risk' },
        { id: 'worstIsicsVph', type: 'ranking', label: 'Worst ISICs by VPH' },
        { id: 'worstIsicsCompliance', type: 'ranking', label: 'Worst ISICs by True ESS' },
        { id: 'bestIsicsCompliance', type: 'ranking', label: 'Best ISICs by True ESS' },
        { id: 'tycomComparison', type: 'ranking', label: 'TYCOM Comparison' },
        { id: 'riskSummaryByIsic', type: 'table', label: 'Risk Summary by ISIC' },
    ];

    const activeIds = layout.map(l => l.id);
    const inactiveElements = availableElements.filter(e => !activeIds.includes(e.id));

    // Initialize Chart.js charts
    React.useEffect(() => {
        if (typeof Chart === 'undefined') return;

        const initChart = (id, config) => {
            const canvas = document.getElementById(`preview-chart-${id}`);
            if (!canvas) return;
            if (chartRefs.current[id]) {
                chartRefs.current[id].destroy();
            }
            chartRefs.current[id] = new Chart(canvas, config);
        };

        // Risk Pie Chart
        if (activeIds.includes('riskPieChart')) {
            initChart('riskPieChart', {
                type: 'pie',
                data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskCounts.HIGH, riskCounts.MED, riskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }

        // Risk Donut Chart
        if (activeIds.includes('riskDonutChart')) {
            initChart('riskDonutChart', {
                type: 'doughnut',
                data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskCounts.HIGH, riskCounts.MED, riskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
                options: { responsive: true, maintainAspectRatio: true, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }

        // Risk Bar Chart
        if (activeIds.includes('riskDistribution')) {
            initChart('riskDistribution', {
                type: 'bar',
                data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskCounts.HIGH, riskCounts.MED, riskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        // Risk by TYCOM Chart
        if (activeIds.includes('riskByTycom')) {
            initChart('riskByTycom', {
                type: 'bar',
                data: {
                    labels: tycomData.map(t => t.tycom),
                    datasets: [
                        { label: 'High', data: tycomData.map(t => t.high), backgroundColor: '#dc2626' },
                        { label: 'Med', data: tycomData.map(t => t.med), backgroundColor: '#d97706' },
                        { label: 'Low', data: tycomData.map(t => t.low), backgroundColor: '#059669' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        }

        // VPH by ISIC Chart
        if (activeIds.includes('vphByIsic')) {
            const sortedIsic = [...isicData].sort((a,b) => b.avgVph - a.avgVph).slice(0, 8);
            initChart('vphByIsic', {
                type: 'bar',
                data: { labels: sortedIsic.map(i => i.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'Avg VPH', data: sortedIsic.map(i => i.avgVph), backgroundColor: '#3b82f6' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        return () => {
            Object.values(chartRefs.current).forEach(chart => chart?.destroy());
        };
    }, [layout, riskCounts.HIGH, riskCounts.MED, riskCounts.LOW, tycomData, isicData]);

    const handleDragStart = (item) => setDraggedItem(item);
    const handleDragEnd = () => setDraggedItem(null);

    const handleDrop = (targetRow, targetCol) => {
        if (!draggedItem) return;

        const draggedWidth = draggedItem.width || 1;
        const draggedHeight = draggedItem.height || 1;

        // Check if target cell already has an item
        const existingItem = layout.find(l => l.row === targetRow && l.col === targetCol);

        // Check if target cell is covered by a multi-cell widget
        const isCovered = layout.some(item => {
            if (item.id === draggedItem.id) return false;
            const iw = item.width || 1;
            const ih = item.height || 1;
            const inWidthRange = targetCol >= item.col && targetCol < item.col + iw;
            const inHeightRange = targetRow >= item.row && targetRow < item.row + ih;
            const isOrigin = targetRow === item.row && targetCol === item.col;
            return inWidthRange && inHeightRange && !isOrigin;
        });

        // Check if dropping widget would go off grid or overlap another widget
        const wouldOverlap = (draggedWidth > 1 || draggedHeight > 1) && (
            targetCol + draggedWidth > 4 ||
            layout.some(l => {
                if (l.id === draggedItem.id) return false;
                const lw = l.width || 1;
                const lh = l.height || 1;
                // Check if any cell in the dragged widget's area would overlap with this layout item
                for (let r = targetRow; r < targetRow + draggedHeight; r++) {
                    for (let c = targetCol; c < targetCol + draggedWidth; c++) {
                        if (r >= l.row && r < l.row + lh && c >= l.col && c < l.col + lw) return true;
                    }
                }
                return false;
            })
        );

        if (isCovered || wouldOverlap) {
            setDraggedItem(null);
            return;
        }

        if (draggedItem.isNew) {
            // Adding from sidebar - only if cell is empty
            if (!existingItem) {
                setLayout(prev => {
                    const newLayout = [...prev, { id: draggedItem.id, type: draggedItem.type, row: targetRow, col: targetCol, width: 1, height: 1 }];
                    if (onLayoutChange) onLayoutChange(newLayout);
                    return newLayout;
                });
            }
        } else {
            // Moving existing item - swap positions if target has item
            if (existingItem && existingItem.id !== draggedItem.id) {
                // Swap: move existing item to dragged item's old position
                const draggedOld = layout.find(l => l.id === draggedItem.id);
                setLayout(prev => {
                    const newLayout = prev.map(item => {
                        if (item.id === draggedItem.id) return { ...item, row: targetRow, col: targetCol };
                        if (item.id === existingItem.id) return { ...item, row: draggedOld?.row, col: draggedOld?.col };
                        return item;
                    });
                    if (onLayoutChange) onLayoutChange(newLayout);
                    return newLayout;
                });
            } else if (!existingItem) {
                // Move to empty cell (preserve width/height)
                setLayout(prev => {
                    const newLayout = prev.map(item => item.id === draggedItem.id ? { ...item, row: targetRow, col: targetCol } : item);
                    if (onLayoutChange) onLayoutChange(newLayout);
                    return newLayout;
                });
            }
        }
        setDraggedItem(null);
    };

    const removeItem = (id) => {
        setLayout(prev => {
            const newLayout = prev.filter(item => item.id !== id);
            if (onLayoutChange) onLayoutChange(newLayout);
            return newLayout;
        });
    };

    // Render element content
    const renderElement = (item) => {
        const statStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full";
        const chartStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full flex flex-col";
        const valueStyle = "text-3xl font-bold";
        const labelStyle = "text-sm text-slate-500";

        switch(item.id) {
            case 'totalBoats': return <div className={statStyle}><div className={labelStyle}>Total Boats</div><div className={valueStyle}>{boats.length}</div></div>;
            case 'highRisk': return <div className={statStyle}><div className={labelStyle}>High Risk</div><div className={`${valueStyle} text-red-600`}>{riskCounts.HIGH}</div></div>;
            case 'medRisk': return <div className={statStyle}><div className={labelStyle}>Medium Risk</div><div className={`${valueStyle} text-amber-600`}>{riskCounts.MED}</div></div>;
            case 'lowRisk': return <div className={statStyle}><div className={labelStyle}>Low Risk</div><div className={`${valueStyle} text-emerald-600`}>{riskCounts.LOW}</div></div>;
            case 'avgVph': return <div className={statStyle}><div className={labelStyle}>Avg RA VPH</div><div className={valueStyle}>{avgVph}</div></div>;
            case 'totalBreakfix': return <div className={statStyle}><div className={labelStyle}>Total Breakfix</div><div className={`${valueStyle} ${totalBreakfix > 0 ? 'text-red-600' : ''}`}>{totalBreakfix}</div></div>;
            case 'avgCompliance': return <div className={statStyle}><div className={labelStyle}>True ESS Compliance</div><div className={valueStyle}>{avgCompliance}%</div></div>;
            case 'avgProductCompliance': return <div className={statStyle}><div className={labelStyle}>Avg Product Compliance %</div><div className={valueStyle}>{avgProductCompliance}%</div></div>;
            case 'scanExempt': return <div className={statStyle}><div className={labelStyle}>Scan Exempt</div><div className={valueStyle}>{scanExemptCount}</div></div>;
            case 'riskPieChart': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Risk Pie Chart</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskPieChart"></canvas>
                    </div>
                </div>
            );
            case 'riskDonutChart': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Overall Risk</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskDonutChart"></canvas>
                    </div>
                </div>
            );
            case 'riskDistribution': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Risk Bar Chart</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskDistribution"></canvas>
                    </div>
                </div>
            );
            case 'highRiskTable': {
                const showReasons = (item.width || 1) > 1;
                return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">High Risk Boats ({highRiskBoats.length})</div>
                    {highRiskBoats.length === 0 ? <div className="text-emerald-600 font-medium">No high-risk boats</div> : (
                        <div className="text-sm flex-1">
                            {showReasons ? (
                                <table className="w-full text-left">
                                    <thead><tr><th className="pb-1 border-b border-slate-200 text-slate-500 font-medium">Boat</th><th className="pb-1 border-b border-slate-200 text-slate-500 font-medium">Reason</th></tr></thead>
                                    <tbody>
                                        {highRiskBoats.map(b => <tr key={b.boatName} className="border-b border-slate-100"><td className="py-1 font-mono text-cyan-600">{b.boatName}</td><td className="py-1 text-xs text-red-600" style={{wordWrap:'break-word',overflowWrap:'break-word',whiteSpace:'normal'}}>{b.riskReasons?.join(', ') || '-'}</td></tr>)}
                                    </tbody>
                                </table>
                            ) : (
                                highRiskBoats.map(b => <div key={b.boatName} className="py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span></div>)
                            )}
                        </div>
                    )}
                </div>
            );
            }
            case 'worstBoatsVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst Boats by VPH</div>
                    <div className="text-sm flex-1 overflow-auto">{worstVph.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-red-600">{(getBoatMaxVph(b)||0).toFixed(2)}</span></div>)}</div>
                </div>
            );
            case 'bestBoatsVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Best Boats by VPH</div>
                    <div className="text-sm flex-1 overflow-auto">{bestVph.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-emerald-600">{(getBoatMaxVph(b)||0).toFixed(2)}</span></div>)}</div>
                </div>
            );
            case 'worstBoatsCompliance': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst by Compliance</div>
                    <div className="text-sm flex-1 overflow-auto">{worstCompliance.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-red-600">{(getBoatMinCompliance(b)||0).toFixed(1)}%</span></div>)}</div>
                </div>
            );
            case 'bestBoatsCompliance': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Best by Compliance</div>
                    <div className="text-sm flex-1 overflow-auto">{bestCompliance.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-emerald-600">{(getBoatMinCompliance(b)||0).toFixed(1)}%</span></div>)}</div>
                </div>
            );
            case 'boatsWithBreakfix': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Boats with Breakfix</div>
                    {boatsBreakfix.length === 0 ? <div className="text-emerald-600">None</div> : (
                        <div className="text-sm flex-1 overflow-auto">{boatsBreakfix.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-red-600">{getBoatTotalBreakfix(b)}</span></div>)}</div>
                    )}
                </div>
            );
            case 'riskByTycom': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Risk by TYCOM</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskByTycom"></canvas>
                    </div>
                </div>
            );
            case 'vphByIsic': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">VPH by ISIC</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-vphByIsic"></canvas>
                    </div>
                </div>
            );
            case 'worstIsicsRisk': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst ISICs by Risk</div>
                    <div className="text-sm flex-1 overflow-auto">{worstIsicsRisk.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-red-600">{i.high} high</span></div>)}</div>
                </div>
            );
            case 'bestIsicsRisk': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Best ISICs by Risk</div>
                    <div className="text-sm flex-1 overflow-auto">{bestIsicsRisk.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-emerald-600">{i.lowPct.toFixed(0)}% low</span></div>)}</div>
                </div>
            );
            case 'worstIsicsVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst ISICs by VPH</div>
                    <div className="text-sm flex-1 overflow-auto">{worstIsicsVph.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-red-600">{i.avgVph.toFixed(2)}</span></div>)}</div>
                </div>
            );
            case 'worstIsicsCompliance': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst ISICs by True ESS</div>
                    <div className="text-sm flex-1 overflow-auto">{worstIsicsCompliance.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-red-600">{i.avgComp.toFixed(1)}%</span></div>)}</div>
                </div>
            );
            case 'bestIsicsCompliance': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Best ISICs by True ESS</div>
                    <div className="text-sm flex-1 overflow-auto">{bestIsicsCompliance.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-green-600">{i.avgComp.toFixed(1)}%</span></div>)}</div>
                </div>
            );
            case 'tycomComparison': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">TYCOM Comparison</div>
                    <div className="text-sm flex-1 overflow-auto">
                        <div className="grid grid-cols-5 gap-1 text-xs font-medium text-slate-500 mb-1"><span>TYCOM</span><span>Boats</span><span>High</span><span>Med</span><span>Low</span></div>
                        {tycomData.map(t => <div key={t.tycom} className="grid grid-cols-5 gap-1 text-xs py-1 border-b border-slate-100"><span className="truncate">{t.tycom}</span><span>{t.boats}</span><span className="text-red-600">{t.high}</span><span className="text-amber-600">{t.med}</span><span className="text-emerald-600">{t.low}</span></div>)}
                    </div>
                </div>
            );
            case 'riskSummaryByIsic': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Risk Summary by ISIC</div>
                    <div className="text-sm flex-1 overflow-auto">
                        <div className="grid grid-cols-7 gap-1 text-xs font-medium text-slate-500 mb-1 sticky top-0 bg-white"><span>ISIC</span><span>Boats</span><span>High</span><span>Med</span><span>Low</span><span>VPH</span><span>BF</span></div>
                        {isicData.sort((a,b) => b.high - a.high).map(i => {
                            const isicBoats = boats.filter(b => b.isic === i.isic);
                            const bf = isicBoats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
                            const med = isicBoats.filter(b => b.riskLevel === 'MED').length;
                            return <div key={i.isic} className="grid grid-cols-7 gap-1 text-xs py-1 border-b border-slate-100"><span className="truncate font-medium">{i.isic}</span><span>{i.boats}</span><span className={i.high > 0 ? 'text-red-600 font-bold' : ''}>{i.high}</span><span className={med > 0 ? 'text-amber-600 font-bold' : ''}>{med}</span><span className="text-emerald-600">{i.low}</span><span>{i.avgVph.toFixed(2)}</span><span className={bf > 0 ? 'text-red-600' : ''}>{bf}</span></div>;
                        })}
                    </div>
                </div>
            );
            default: return <div className="bg-slate-100 rounded-lg p-4">{item.id}</div>;
        }
    };

    // Cycle through sizes: 1x1 -> 2x1 -> 4x1 -> 1x2 -> 2x2 -> 4x2 -> 1x1 (auto-saves)
    const cycleSize = (id) => {
        setLayout(prev => {
            const newLayout = prev.map(item => {
                if (item.id === id) {
                    const w = item.width || 1;
                    const h = item.height || 1;
                    let newW = 1, newH = 1;
                    if (w === 1 && h === 1) { newW = 2; newH = 1; }      // 1x1 -> 2x1
                    else if (w === 2 && h === 1) { newW = 4; newH = 1; } // 2x1 -> 4x1 (full width)
                    else if (w === 4 && h === 1) { newW = 1; newH = 2; } // 4x1 -> 1x2
                    else if (w === 1 && h === 2) { newW = 2; newH = 2; } // 1x2 -> 2x2
                    else if (w === 2 && h === 2) { newW = 4; newH = 2; } // 2x2 -> 4x2 (full width tall)
                    else { newW = 1; newH = 1; }                         // 4x2 -> 1x1
                    // Ensure we don't go off grid - full width items must be at col 0
                    let newCol = item.col;
                    if (newW === 4) { newCol = 0; }
                    else if (newW === 2) { newCol = Math.min(item.col, 2); }
                    return { ...item, width: newW, height: newH, col: newCol };
                }
                return item;
            });
            // Auto-save to settings
            if (onLayoutChange) onLayoutChange(newLayout);
            return newLayout;
        });
    };

    // Check if a cell is covered by a multi-cell widget
    const isCellCovered = (row, col) => {
        return layout.some(item => {
            const iw = item.width || 1;
            const ih = item.height || 1;
            // Check if this cell falls within the item's area (but not the origin cell)
            const inWidthRange = col >= item.col && col < item.col + iw;
            const inHeightRange = row >= item.row && row < item.row + ih;
            const isOrigin = row === item.row && col === item.col;
            return inWidthRange && inHeightRange && !isOrigin;
        });
    };

    // Grid cells (4 columns x many rows)
    const maxRow = Math.max(...layout.map(l => l.row + (l.height || 1) - 1), 3) + 1;
    const gridCells = [];
    for (let row = 0; row <= maxRow; row++) {
        for (let col = 0; col < 4; col++) {
            // Skip cells that are covered by multi-cell widgets
            if (!isCellCovered(row, col)) {
                gridCells.push({ row, col });
            }
        }
    }

    // Get unique ISICs and boats for dropdowns
    const uniqueIsics = [...new Set(boats.map(b => b.isic))].sort();
    const uniqueBoats = [...boats].sort((a, b) => a.boatName.localeCompare(b.boatName));

    // ISIC-filtered data when an ISIC is selected
    const isicBoats = selectedIsic ? boats.filter(b => b.isic === selectedIsic) : [];
    const isicRiskCounts = {
        HIGH: isicBoats.filter(b => b.riskLevel === 'HIGH').length,
        MED: isicBoats.filter(b => b.riskLevel === 'MED').length,
        LOW: isicBoats.filter(b => b.riskLevel === 'LOW').length
    };
    const isicVphValues = isicBoats.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
    const isicAvgVph = isicVphValues.length > 0 ? (isicVphValues.reduce((s, v) => s + v, 0) / isicVphValues.length).toFixed(2) : '0';
    const isicTotalBreakfix = isicBoats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
    const isicCompValues = isicBoats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprTruePolicy !== null) v.push(b.essNiprTruePolicy); if (b.essSiprTruePolicy !== null) v.push(b.essSiprTruePolicy); return v; });
    const isicAvgCompliance = isicCompValues.length > 0 ? Math.min(100, isicCompValues.reduce((s, v) => s + v, 0) / isicCompValues.length).toFixed(1) : '0';
    const isicScanExemptCount = isicBoats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length;

    // Boat-specific data when a boat is selected
    const selectedBoatData = selectedBoat ? boats.find(b => b.boatName === selectedBoat) : null;
    const boatIsicData = selectedBoatData ? boats.filter(b => b.isic === selectedBoatData.isic) : [];

    // Calculate scan age for selected boat
    const calcScanAge = (scanDate) => {
        if (!scanDate) return null;
        const date = new Date(scanDate);
        if (isNaN(date.getTime())) return null;
        return Math.floor((new Date() - date) / 86400000);
    };

    // Render ISIC element
    const renderIsicElement = (item) => {
        const statStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full";
        const chartStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full flex flex-col";
        const valueStyle = "text-3xl font-bold";
        const labelStyle = "text-sm text-slate-500";

        if (!selectedIsic) {
            return <div className={statStyle}><div className={labelStyle}>Select an ISIC</div><div className="text-slate-400 text-xl">-</div></div>;
        }

        switch(item.id) {
            case 'isicBoatCount': return <div className={statStyle}><div className={labelStyle}>Boats in ISIC</div><div className={valueStyle}>{isicBoats.length}</div></div>;
            case 'isicHighRisk': return <div className={statStyle}><div className={labelStyle}>High Risk</div><div className={`${valueStyle} text-red-600`}>{isicRiskCounts.HIGH}</div></div>;
            case 'isicMedRisk': return <div className={statStyle}><div className={labelStyle}>Medium Risk</div><div className={`${valueStyle} text-amber-600`}>{isicRiskCounts.MED}</div></div>;
            case 'isicLowRisk': return <div className={statStyle}><div className={labelStyle}>Low Risk</div><div className={`${valueStyle} text-emerald-600`}>{isicRiskCounts.LOW}</div></div>;
            case 'isicAvgVph': return <div className={statStyle}><div className={labelStyle}>Avg VPH</div><div className={valueStyle}>{isicAvgVph}</div></div>;
            case 'isicTotalBreakfix': return <div className={statStyle}><div className={labelStyle}>Total Breakfix</div><div className={`${valueStyle} ${isicTotalBreakfix > 0 ? 'text-red-600' : ''}`}>{isicTotalBreakfix}</div></div>;
            case 'isicAvgCompliance': return <div className={statStyle}><div className={labelStyle}>Avg True ESS Compliance</div><div className={valueStyle}>{isicAvgCompliance}%</div></div>;
            case 'isicScanExempt': return <div className={statStyle}><div className={labelStyle}>Scan Exempt</div><div className={valueStyle}>{isicScanExemptCount}</div></div>;
            case 'isicRiskPie': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">ISIC Risk Distribution</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-isicRiskPie"></canvas>
                    </div>
                </div>
            );
            case 'isicBoatsTable': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Boats in {selectedIsic}</div>
                    <div className="text-sm flex-1 overflow-auto">
                        <div className="grid grid-cols-5 gap-1 text-xs font-medium text-slate-500 mb-1 sticky top-0 bg-white"><span>Boat</span><span>Risk</span><span>VPH</span><span>ESS</span><span>BF</span></div>
                        {isicBoats.map(b => (
                            <div key={b.boatName} className="grid grid-cols-5 gap-1 text-xs py-1 border-b border-slate-100">
                                <span className="font-mono text-cyan-600 truncate">{b.boatName}</span>
                                <span className={`font-bold ${b.riskLevel === 'HIGH' ? 'text-red-600' : b.riskLevel === 'MED' ? 'text-amber-600' : 'text-emerald-600'}`}>{b.riskLevel}</span>
                                <span>{(getBoatMaxVph(b) || 0).toFixed(2)}</span>
                                <span>{(getBoatMinCompliance(b) || 0).toFixed(1)}%</span>
                                <span className={getBoatTotalBreakfix(b) > 0 ? 'text-red-600' : ''}>{getBoatTotalBreakfix(b)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
            case 'isicVphComparison': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">VPH by Boat</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-isicVphComparison"></canvas>
                    </div>
                </div>
            );
            case 'isicComplianceComparison': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">True ESS Compliance % by Boat</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-isicComplianceComparison"></canvas>
                    </div>
                </div>
            );
            case 'isicWorstBoats':
            case 'isicWorstBoatsVph': {
                const worstByVph = [...isicBoats].filter(b => getBoatMaxVph(b) != null).sort((a, b) => (getBoatMaxVph(b) || 0) - (getBoatMaxVph(a) || 0)).slice(0, 5);
                return (
                    <div className={chartStyle}>
                        <div className="font-bold text-slate-700 mb-3">Worst Boats by VPH</div>
                        <div className="text-sm flex-1 overflow-auto">
                            {worstByVph.length === 0 ? <div className="text-slate-400">No data</div> : worstByVph.map(b => (
                                <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100">
                                    <span className="font-mono text-cyan-600">{b.boatName}</span>
                                    <span className="text-red-600">{(getBoatMaxVph(b) || 0).toFixed(2)}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
            case 'isicBestBoats':
            case 'isicBestBoatsVph': {
                const bestByVph = [...isicBoats].filter(b => getBoatMaxVph(b) != null).sort((a, b) => (getBoatMaxVph(a) || 0) - (getBoatMaxVph(b) || 0)).slice(0, 5);
                return (
                    <div className={chartStyle}>
                        <div className="font-bold text-slate-700 mb-3">Best Boats by VPH</div>
                        <div className="text-sm flex-1 overflow-auto">
                            {bestByVph.length === 0 ? <div className="text-slate-400">No data</div> : bestByVph.map(b => (
                                <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100">
                                    <span className="font-mono text-cyan-600">{b.boatName}</span>
                                    <span className="text-emerald-600">{(getBoatMaxVph(b) || 0).toFixed(2)}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
            case 'isicWorstBoatsCompliance': {
                const worstByComp = [...isicBoats].filter(b => getBoatMinCompliance(b) != null).sort((a, b) => (getBoatMinCompliance(a) || 0) - (getBoatMinCompliance(b) || 0)).slice(0, 5);
                return (
                    <div className={chartStyle}>
                        <div className="font-bold text-slate-700 mb-3">Worst Boats by True ESS</div>
                        <div className="text-sm flex-1 overflow-auto">
                            {worstByComp.length === 0 ? <div className="text-slate-400">No data</div> : worstByComp.map(b => (
                                <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100">
                                    <span className="font-mono text-cyan-600">{b.boatName}</span>
                                    <span className="text-red-600">{(getBoatMinCompliance(b) || 0).toFixed(1)}%</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
            case 'isicBestBoatsCompliance': {
                const bestByComp = [...isicBoats].filter(b => getBoatMinCompliance(b) != null).sort((a, b) => (getBoatMinCompliance(b) || 0) - (getBoatMinCompliance(a) || 0)).slice(0, 5);
                return (
                    <div className={chartStyle}>
                        <div className="font-bold text-slate-700 mb-3">Best Boats by True ESS</div>
                        <div className="text-sm flex-1 overflow-auto">
                            {bestByComp.length === 0 ? <div className="text-slate-400">No data</div> : bestByComp.map(b => (
                                <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100">
                                    <span className="font-mono text-cyan-600">{b.boatName}</span>
                                    <span className="text-emerald-600">{(getBoatMinCompliance(b) || 0).toFixed(1)}%</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
            default: return <div className="bg-slate-100 rounded-lg p-4">{item.id}</div>;
        }
    };

    // Render Boat element
    const renderBoatElement = (item) => {
        const statStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full";
        const chartStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full flex flex-col";
        const valueStyle = "text-3xl font-bold";
        const labelStyle = "text-sm text-slate-500";

        if (!selectedBoatData) {
            return <div className={statStyle}><div className={labelStyle}>Select a Boat</div><div className="text-slate-400 text-xl">-</div></div>;
        }

        const b = selectedBoatData;
        const scanAgeNipr = calcScanAge(b.vramNiprScanDate);
        const scanAgeSipr = calcScanAge(b.vramSiprScanDate);
        const maxScanAge = Math.max(scanAgeNipr || 0, scanAgeSipr || 0);

        switch(item.id) {
            case 'boatRiskLevel': return (
                <div className={statStyle}>
                    <div className={labelStyle}>Risk Level</div>
                    <div className={`${valueStyle} ${b.riskLevel === 'HIGH' ? 'text-red-600' : b.riskLevel === 'MED' ? 'text-amber-600' : 'text-emerald-600'}`}>{b.riskLevel}</div>
                </div>
            );
            case 'boatVphNipr': return <div className={statStyle}><div className={labelStyle}>NIPR VPH</div><div className={valueStyle}>{b.isNmci ? 'NMCI' : (b.vramNiprRaVph !== null ? b.vramNiprRaVph.toFixed(2) : '-')}</div></div>;
            case 'boatVphSipr': return <div className={statStyle}><div className={labelStyle}>SIPR VPH</div><div className={valueStyle}>{b.vramSiprRaVph !== null ? b.vramSiprRaVph.toFixed(2) : '-'}</div></div>;
            case 'boatScanAgeNipr': return <div className={statStyle}><div className={labelStyle}>NIPR Scan Age</div><div className={`${valueStyle} ${(scanAgeNipr || 0) > 14 ? 'text-red-600' : ''}`}>{b.isNmci ? 'NMCI' : (scanAgeNipr !== null ? scanAgeNipr + ' days' : '-')}</div></div>;
            case 'boatScanAgeSipr': return <div className={statStyle}><div className={labelStyle}>SIPR Scan Age</div><div className={`${valueStyle} ${(scanAgeSipr || 0) > 14 ? 'text-red-600' : ''}`}>{scanAgeSipr !== null ? scanAgeSipr + ' days' : '-'}</div></div>;
            case 'boatScanAge': return <div className={statStyle}><div className={labelStyle}>Scan Age</div><div className={`${valueStyle} ${maxScanAge > 14 ? 'text-red-600' : ''}`}>{maxScanAge || '-'} days</div></div>;
            case 'boatBreakfixNipr': return <div className={statStyle}><div className={labelStyle}>NIPR Breakfix</div><div className={`${valueStyle} ${(b.essNiprBreakfix || 0) > 0 ? 'text-red-600' : ''}`}>{b.isNmci ? 'NMCI' : (b.essNiprBreakfix || 0)}</div></div>;
            case 'boatBreakfixSipr': return <div className={statStyle}><div className={labelStyle}>SIPR Breakfix</div><div className={`${valueStyle} ${(b.essSiprBreakfix || 0) > 0 ? 'text-red-600' : ''}`}>{b.essSiprBreakfix || 0}</div></div>;
            case 'boatComplianceNipr': return <div className={statStyle}><div className={labelStyle}>NIPR True ESS Compliance</div><div className={valueStyle}>{b.isNmci ? 'NMCI' : (b.essNiprTruePolicy !== null ? b.essNiprTruePolicy.toFixed(1) + '%' : '-')}</div></div>;
            case 'boatComplianceSipr': return <div className={statStyle}><div className={labelStyle}>SIPR True ESS Compliance</div><div className={valueStyle}>{b.essSiprTruePolicy !== null ? b.essSiprTruePolicy.toFixed(1) + '%' : '-'}</div></div>;
            case 'boatRiskReasons': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Risk Factors</div>
                    {b.riskReasons?.length > 0 ? (
                        <div className="text-sm flex-1 overflow-auto">
                            {b.riskReasons.map((r, i) => <div key={i} className="py-1 border-b border-slate-100 text-red-600">{r}</div>)}
                        </div>
                    ) : (
                        <div className="text-emerald-600">No risk factors</div>
                    )}
                </div>
            );
            case 'boatMetricsSummary': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Metrics</div>
                    <div className="text-sm flex-1 overflow-auto">
                        <div className="grid grid-cols-3 gap-1 text-xs font-medium text-slate-500 mb-1 sticky top-0 bg-white"><span>Metric</span><span>NIPR</span><span>SIPR</span></div>
                        <div className="grid grid-cols-3 gap-1 text-xs py-1 border-b border-slate-100"><span>VPH</span><span>{b.isNmci ? 'NMCI' : (b.vramNiprRaVph?.toFixed(2) || '-')}</span><span>{b.vramSiprRaVph?.toFixed(2) || '-'}</span></div>
                        <div className="grid grid-cols-3 gap-1 text-xs py-1 border-b border-slate-100"><span>Breakfix</span><span className={b.essNiprBreakfix > 0 ? 'text-red-600' : ''}>{b.isNmci ? 'NMCI' : (b.essNiprBreakfix || 0)}</span><span className={b.essSiprBreakfix > 0 ? 'text-red-600' : ''}>{b.essSiprBreakfix || 0}</span></div>
                        <div className="grid grid-cols-3 gap-1 text-xs py-1 border-b border-slate-100"><span>Product Comp</span><span>{b.isNmci ? 'NMCI' : (b.essNiprProductCompliance?.toFixed(1) + '%' || '-')}</span><span>{b.essSiprProductCompliance?.toFixed(1) + '%' || '-'}</span></div>
                        <div className="grid grid-cols-3 gap-1 text-xs py-1 border-b border-slate-100"><span>True Policy</span><span>{b.isNmci ? 'NMCI' : (b.essNiprTruePolicy?.toFixed(1) + '%' || '-')}</span><span>{b.essSiprTruePolicy?.toFixed(1) + '%' || '-'}</span></div>
                        <div className="grid grid-cols-3 gap-1 text-xs py-1 border-b border-slate-100"><span>Scan Age</span><span>{b.isNmci ? 'NMCI' : (scanAgeNipr !== null ? scanAgeNipr + 'd' : '-')}</span><span>{scanAgeSipr !== null ? scanAgeSipr + 'd' : '-'}</span></div>
                    </div>
                </div>
            );
            case 'boatIsicComparisonVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">VPH vs ISIC Avg</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatIsicComparisonVph"></canvas>
                    </div>
                </div>
            );
            case 'boatIsicComparisonEss': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">True ESS vs ISIC Avg</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatIsicComparisonEss"></canvas>
                    </div>
                </div>
            );
            case 'boatTycomComparisonVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">VPH vs {b.tycom || 'TYCOM'} Avg</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatTycomComparisonVph"></canvas>
                    </div>
                </div>
            );
            case 'boatTycomComparisonEss': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">True ESS vs {b.tycom || 'TYCOM'} Avg</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatTycomComparisonEss"></canvas>
                    </div>
                </div>
            );
            case 'boatSubforComparisonVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">VPH vs SUBFOR Avg</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatSubforComparisonVph"></canvas>
                    </div>
                </div>
            );
            case 'boatSubforComparisonEss': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">True ESS vs SUBFOR Avg</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatSubforComparisonEss"></canvas>
                    </div>
                </div>
            );
            // Legacy combined charts
            case 'boatIsicComparison': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">vs ISIC Average</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatIsicComparison"></canvas>
                    </div>
                </div>
            );
            case 'boatTycomComparison': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">vs {b.tycom || 'TYCOM'} Average</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatTycomComparison"></canvas>
                    </div>
                </div>
            );
            case 'boatSubforComparison': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">vs SUBFOR Average</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-boatSubforComparison"></canvas>
                    </div>
                </div>
            );
            case 'boatTamStatus': return <div className={statStyle}><div className={labelStyle}>TAM Past Due</div><div className={`${valueStyle} ${(b.tamPastDue || 0) > 10 ? 'text-red-600' : ''}`}>{b.tamPastDue || 0}</div></div>;
            case 'boatOverrides': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Active Overrides</div>
                    {b.overrides?.length > 0 ? (
                        <div className="text-sm flex-1 overflow-auto">
                            {b.overrides.map((o, i) => <div key={i} className="py-1 border-b border-slate-100"><span className="text-purple-600 font-medium">{o.field}:</span> {o.originalValue} → {o.overrideValue}</div>)}
                        </div>
                    ) : (
                        <div className="text-slate-400">No overrides</div>
                    )}
                </div>
            );
            default: return <div className="bg-slate-100 rounded-lg p-4">{item.id}</div>;
        }
    };

    // Initialize ISIC charts
    React.useEffect(() => {
        if (analyticsSubTab !== 'isic' || !selectedIsic || typeof Chart === 'undefined') return;

        const initChart = (id, config) => {
            const canvas = document.getElementById(`preview-chart-${id}`);
            if (!canvas) return;
            if (chartRefs.current[id]) chartRefs.current[id].destroy();
            chartRefs.current[id] = new Chart(canvas, config);
        };

        // ISIC Risk Pie
        if (isicLayout.some(l => l.id === 'isicRiskPie')) {
            initChart('isicRiskPie', {
                type: 'pie',
                data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [isicRiskCounts.HIGH, isicRiskCounts.MED, isicRiskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }

        // VPH by Boat in ISIC
        if (isicLayout.some(l => l.id === 'isicVphComparison')) {
            const boatVphs = isicBoats.map(b => ({ name: b.boatName, vph: getBoatMaxVph(b) || 0 })).sort((a, b) => b.vph - a.vph);
            initChart('isicVphComparison', {
                type: 'bar',
                data: { labels: boatVphs.map(b => b.name), datasets: [{ label: 'VPH', data: boatVphs.map(b => b.vph), backgroundColor: '#3b82f6' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 } } } }
            });
        }

        // Compliance by Boat in ISIC
        if (isicLayout.some(l => l.id === 'isicComplianceComparison')) {
            const boatComps = isicBoats.map(b => ({ name: b.boatName, comp: getBoatMinCompliance(b) || 0 })).sort((a, b) => a.comp - b.comp);
            initChart('isicComplianceComparison', {
                type: 'bar',
                data: { labels: boatComps.map(b => b.name), datasets: [{ label: 'True ESS Compliance %', data: boatComps.map(b => b.comp), backgroundColor: '#10b981' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', layout: { padding: { right: 20 } }, plugins: { legend: { display: false } }, scales: { x: { ticks: { padding: 5 }, max: 100 } } }
            });
        }
    }, [analyticsSubTab, selectedIsic, isicLayout, JSON.stringify(isicRiskCounts)]);

    // Initialize Boat charts
    React.useEffect(() => {
        if (analyticsSubTab !== 'boat' || !selectedBoatData || typeof Chart === 'undefined') return;

        const initChart = (id, config) => {
            const canvas = document.getElementById(`preview-chart-${id}`);
            if (!canvas) return;
            if (chartRefs.current[id]) chartRefs.current[id].destroy();
            chartRefs.current[id] = new Chart(canvas, config);
        };

        const b = selectedBoatData;
        const boatVph = getBoatMaxVph(b) || 0;
        const boatComp = getBoatMinCompliance(b) || 0;

        // ISIC average
        const isicVphs = boatIsicData.flatMap(x => { const v = []; if (!x.isNmci && x.vramNiprRaVph !== null) v.push(x.vramNiprRaVph); if (x.vramSiprRaVph !== null) v.push(x.vramSiprRaVph); return v; });
        const isicAvg = isicVphs.length > 0 ? isicVphs.reduce((s, v) => s + v, 0) / isicVphs.length : 0;
        const isicCompAvg = boatIsicData.flatMap(x => { const v = []; if (!x.isNmci && x.essNiprTruePolicy !== null) v.push(x.essNiprTruePolicy); if (x.essSiprTruePolicy !== null) v.push(x.essSiprTruePolicy); return v; });
        const isicCompAvgVal = isicCompAvg.length > 0 ? isicCompAvg.reduce((s, v) => s + v, 0) / isicCompAvg.length : 0;

        // TYCOM average (CSL or CSP boats only)
        const tycomBoats = boats.filter(boat => boat.tycom === b.tycom);
        const tycomVphs = tycomBoats.flatMap(x => { const v = []; if (!x.isNmci && x.vramNiprRaVph !== null) v.push(x.vramNiprRaVph); if (x.vramSiprRaVph !== null) v.push(x.vramSiprRaVph); return v; });
        const tycomAvg = tycomVphs.length > 0 ? tycomVphs.reduce((s, v) => s + v, 0) / tycomVphs.length : 0;
        const tycomCompAvg = tycomBoats.flatMap(x => { const v = []; if (!x.isNmci && x.essNiprTruePolicy !== null) v.push(x.essNiprTruePolicy); if (x.essSiprTruePolicy !== null) v.push(x.essSiprTruePolicy); return v; });
        const tycomCompAvgVal = tycomCompAvg.length > 0 ? tycomCompAvg.reduce((s, v) => s + v, 0) / tycomCompAvg.length : 0;

        // SUBFOR average (all boats)
        const subforAvg = parseFloat(avgVph);
        const subforCompAvg = parseFloat(avgCompliance);

        // VPH vs ISIC (lower VPH is better: green if below avg, red if above)
        if (boatLayout.some(l => l.id === 'boatIsicComparisonVph')) {
            const vphColor = boatVph < isicAvg ? '#22c55e' : boatVph > isicAvg ? '#ef4444' : '#3b82f6';
            initChart('boatIsicComparisonVph', {
                type: 'bar',
                data: { labels: [b.boatName, 'ISIC Avg'], datasets: [{ data: [boatVph, isicAvg], backgroundColor: [vphColor, '#3b82f6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
        // True ESS vs ISIC (higher ESS is better: green if above avg, red if below)
        if (boatLayout.some(l => l.id === 'boatIsicComparisonEss')) {
            const essColor = boatComp > isicCompAvgVal ? '#22c55e' : boatComp < isicCompAvgVal ? '#ef4444' : '#3b82f6';
            initChart('boatIsicComparisonEss', {
                type: 'bar',
                data: { labels: [b.boatName, 'ISIC Avg'], datasets: [{ data: [boatComp, isicCompAvgVal], backgroundColor: [essColor, '#3b82f6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        // VPH vs TYCOM (lower VPH is better)
        if (boatLayout.some(l => l.id === 'boatTycomComparisonVph')) {
            const vphColor = boatVph < tycomAvg ? '#22c55e' : boatVph > tycomAvg ? '#ef4444' : '#3b82f6';
            initChart('boatTycomComparisonVph', {
                type: 'bar',
                data: { labels: [b.boatName, (b.tycom || 'TYCOM') + ' Avg'], datasets: [{ data: [boatVph, tycomAvg], backgroundColor: [vphColor, '#3b82f6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
        // True ESS vs TYCOM (higher ESS is better)
        if (boatLayout.some(l => l.id === 'boatTycomComparisonEss')) {
            const essColor = boatComp > tycomCompAvgVal ? '#22c55e' : boatComp < tycomCompAvgVal ? '#ef4444' : '#3b82f6';
            initChart('boatTycomComparisonEss', {
                type: 'bar',
                data: { labels: [b.boatName, (b.tycom || 'TYCOM') + ' Avg'], datasets: [{ data: [boatComp, tycomCompAvgVal], backgroundColor: [essColor, '#3b82f6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        // VPH vs SUBFOR (lower VPH is better)
        if (boatLayout.some(l => l.id === 'boatSubforComparisonVph')) {
            const vphColor = boatVph < subforAvg ? '#22c55e' : boatVph > subforAvg ? '#ef4444' : '#3b82f6';
            initChart('boatSubforComparisonVph', {
                type: 'bar',
                data: { labels: [b.boatName, 'SUBFOR Avg'], datasets: [{ data: [boatVph, subforAvg], backgroundColor: [vphColor, '#3b82f6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
        // True ESS vs SUBFOR (higher ESS is better)
        if (boatLayout.some(l => l.id === 'boatSubforComparisonEss')) {
            const essColor = boatComp > subforCompAvg ? '#22c55e' : boatComp < subforCompAvg ? '#ef4444' : '#3b82f6';
            initChart('boatSubforComparisonEss', {
                type: 'bar',
                data: { labels: [b.boatName, 'SUBFOR Avg'], datasets: [{ data: [boatComp, subforCompAvg], backgroundColor: [essColor, '#3b82f6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        // Legacy combined charts
        if (boatLayout.some(l => l.id === 'boatIsicComparison')) {
            initChart('boatIsicComparison', {
                type: 'bar',
                data: {
                    labels: ['VPH', 'True ESS Compliance %'],
                    datasets: [
                        { label: b.boatName, data: [boatVph, boatComp], backgroundColor: '#3b82f6' },
                        { label: 'ISIC Avg', data: [isicAvg, isicCompAvgVal], backgroundColor: '#94a3b8' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }
        if (boatLayout.some(l => l.id === 'boatTycomComparison')) {
            initChart('boatTycomComparison', {
                type: 'bar',
                data: {
                    labels: ['VPH', 'True ESS Compliance %'],
                    datasets: [
                        { label: b.boatName, data: [boatVph, boatComp], backgroundColor: '#3b82f6' },
                        { label: (b.tycom || 'TYCOM') + ' Avg', data: [tycomAvg, tycomCompAvgVal], backgroundColor: '#94a3b8' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }
        if (boatLayout.some(l => l.id === 'boatSubforComparison')) {
            initChart('boatSubforComparison', {
                type: 'bar',
                data: {
                    labels: ['VPH', 'True ESS Compliance %'],
                    datasets: [
                        { label: b.boatName, data: [boatVph, boatComp], backgroundColor: '#3b82f6' },
                        { label: 'SUBFOR Avg', data: [subforAvg, subforCompAvg], backgroundColor: '#94a3b8' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }
    }, [analyticsSubTab, selectedBoat, boatLayout]);

    // Get current layout and elements based on sub-tab
    const getCurrentLayout = () => {
        if (analyticsSubTab === 'isic') return isicLayout;
        if (analyticsSubTab === 'boat') return boatLayout;
        return layout;
    };

    const getCurrentElements = () => {
        if (analyticsSubTab === 'isic') return isicAnalyticsElements;
        if (analyticsSubTab === 'boat') return boatAnalyticsElements;
        return availableElements;
    };

    const getCurrentRenderer = () => {
        if (analyticsSubTab === 'isic') return renderIsicElement;
        if (analyticsSubTab === 'boat') return renderBoatElement;
        return renderElement;
    };

    const currentLayout = getCurrentLayout();
    const currentElements = getCurrentElements();
    const currentRenderer = getCurrentRenderer();
    const currentActiveIds = currentLayout.map(l => l.id);
    const currentInactiveElements = currentElements.filter(e => !currentActiveIds.includes(e.id));

    // Handle layout changes for sub-tabs
    const handleSubTabLayoutChange = (newLayout) => {
        if (analyticsSubTab === 'isic') {
            setIsicLayout(newLayout);
            if (onIsicLayoutChange) onIsicLayoutChange(newLayout);
        } else if (analyticsSubTab === 'boat') {
            setBoatLayout(newLayout);
            if (onBoatLayoutChange) onBoatLayoutChange(newLayout);
        } else {
            setLayout(newLayout);
            if (onLayoutChange) onLayoutChange(newLayout);
        }
    };

    // Handle drop for current sub-tab
    const handleSubTabDrop = (targetRow, targetCol) => {
        if (!draggedItem) return;
        const currentLay = getCurrentLayout();
        const setCurrentLayout = analyticsSubTab === 'isic' ? setIsicLayout : analyticsSubTab === 'boat' ? setBoatLayout : setLayout;

        const draggedWidth = draggedItem.width || 1;
        const draggedHeight = draggedItem.height || 1;
        const existingItem = currentLay.find(l => l.row === targetRow && l.col === targetCol);
        const isCovered = currentLay.some(item => {
            if (item.id === draggedItem.id) return false;
            const iw = item.width || 1;
            const ih = item.height || 1;
            return targetCol >= item.col && targetCol < item.col + iw && targetRow >= item.row && targetRow < item.row + ih && !(targetRow === item.row && targetCol === item.col);
        });
        const wouldOverlap = (draggedWidth > 1 || draggedHeight > 1) && (targetCol + draggedWidth > 4 || currentLay.some(l => {
            if (l.id === draggedItem.id) return false;
            const lw = l.width || 1; const lh = l.height || 1;
            for (let r = targetRow; r < targetRow + draggedHeight; r++) {
                for (let c = targetCol; c < targetCol + draggedWidth; c++) {
                    if (r >= l.row && r < l.row + lh && c >= l.col && c < l.col + lw) return true;
                }
            }
            return false;
        }));

        if (isCovered || wouldOverlap) { setDraggedItem(null); return; }

        if (draggedItem.isNew) {
            if (!existingItem) {
                setCurrentLayout(prev => {
                    const newLayout = [...prev, { id: draggedItem.id, type: draggedItem.type, row: targetRow, col: targetCol, width: 1, height: 1 }];
                    handleSubTabLayoutChange(newLayout);
                    return newLayout;
                });
            }
        } else {
            if (existingItem && existingItem.id !== draggedItem.id) {
                const draggedOld = currentLay.find(l => l.id === draggedItem.id);
                setCurrentLayout(prev => {
                    const newLayout = prev.map(item => {
                        if (item.id === draggedItem.id) return { ...item, row: targetRow, col: targetCol };
                        if (item.id === existingItem.id) return { ...item, row: draggedOld?.row, col: draggedOld?.col };
                        return item;
                    });
                    handleSubTabLayoutChange(newLayout);
                    return newLayout;
                });
            } else if (!existingItem) {
                setCurrentLayout(prev => {
                    const newLayout = prev.map(item => item.id === draggedItem.id ? { ...item, row: targetRow, col: targetCol } : item);
                    handleSubTabLayoutChange(newLayout);
                    return newLayout;
                });
            }
        }
        setDraggedItem(null);
    };

    // Remove item for current sub-tab
    const removeSubTabItem = (id) => {
        const setCurrentLayout = analyticsSubTab === 'isic' ? setIsicLayout : analyticsSubTab === 'boat' ? setBoatLayout : setLayout;
        setCurrentLayout(prev => {
            const newLayout = prev.filter(item => item.id !== id);
            handleSubTabLayoutChange(newLayout);
            return newLayout;
        });
    };

    // Cycle size for current sub-tab
    const cycleSubTabSize = (id) => {
        const setCurrentLayout = analyticsSubTab === 'isic' ? setIsicLayout : analyticsSubTab === 'boat' ? setBoatLayout : setLayout;
        setCurrentLayout(prev => {
            const newLayout = prev.map(item => {
                if (item.id === id) {
                    const w = item.width || 1; const h = item.height || 1;
                    let newW = 1, newH = 1;
                    if (w === 1 && h === 1) { newW = 2; newH = 1; }
                    else if (w === 2 && h === 1) { newW = 4; newH = 1; }
                    else if (w === 4 && h === 1) { newW = 1; newH = 2; }
                    else if (w === 1 && h === 2) { newW = 2; newH = 2; }
                    else if (w === 2 && h === 2) { newW = 4; newH = 2; }
                    else { newW = 1; newH = 1; }
                    let newCol = item.col;
                    if (newW === 4) { newCol = 0; } else if (newW === 2) { newCol = Math.min(item.col, 2); }
                    return { ...item, width: newW, height: newH, col: newCol };
                }
                return item;
            });
            handleSubTabLayoutChange(newLayout);
            return newLayout;
        });
    };

    // Check if cell is covered for current sub-tab
    const isSubTabCellCovered = (row, col) => {
        return getCurrentLayout().some(item => {
            const iw = item.width || 1; const ih = item.height || 1;
            return col >= item.col && col < item.col + iw && row >= item.row && row < item.row + ih && !(row === item.row && col === item.col);
        });
    };

    // Grid cells for current sub-tab
    const currentMaxRow = Math.max(...currentLayout.map(l => l.row + (l.height || 1) - 1), 3) + 1;
    const currentGridCells = [];
    for (let row = 0; row <= currentMaxRow; row++) {
        for (let col = 0; col < 4; col++) {
            if (!isSubTabCellCovered(row, col)) currentGridCells.push({ row, col });
        }
    }

    return (
        <div className="flex flex-col gap-4">
            {/* Sub-tab navigation */}
            <div className="flex items-center gap-4 border-b border-slate-200 pb-3">
                <div className="flex gap-2">
                    <button
                        onClick={() => setAnalyticsSubTab('main')}
                        className={`px-4 py-2 rounded-t font-medium text-sm ${analyticsSubTab === 'main' ? 'bg-cyan-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                    >
                        Main
                    </button>
                    <button
                        onClick={() => setAnalyticsSubTab('isic')}
                        className={`px-4 py-2 rounded-t font-medium text-sm ${analyticsSubTab === 'isic' ? 'bg-cyan-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                    >
                        ISIC
                    </button>
                    <button
                        onClick={() => setAnalyticsSubTab('boat')}
                        className={`px-4 py-2 rounded-t font-medium text-sm ${analyticsSubTab === 'boat' ? 'bg-cyan-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                    >
                        Boat
                    </button>
                </div>

                {/* ISIC Selector */}
                {analyticsSubTab === 'isic' && (
                    <div className="flex items-center gap-2">
                        <label className="text-sm text-slate-600">Select ISIC:</label>
                        <select
                            value={selectedIsic}
                            onChange={(e) => setSelectedIsic(e.target.value)}
                            className="px-3 py-1 border border-slate-300 rounded text-sm"
                        >
                            <option value="">-- Select ISIC --</option>
                            {uniqueIsics.map(isic => (
                                <option key={isic} value={isic}>{isic}</option>
                            ))}
                        </select>
                    </div>
                )}

                {/* Boat Selector */}
                {analyticsSubTab === 'boat' && (
                    <div className="flex items-center gap-2">
                        <label className="text-sm text-slate-600">Select Boat:</label>
                        <select
                            value={selectedBoat}
                            onChange={(e) => setSelectedBoat(e.target.value)}
                            className="px-3 py-1 border border-slate-300 rounded text-sm"
                        >
                            <option value="">-- Select Boat --</option>
                            {uniqueBoats.map(b => (
                                <option key={b.boatName} value={b.boatName}>{b.boatName} - {b.boatFullName}</option>
                            ))}
                        </select>
                    </div>
                )}
            </div>

            <div className="flex gap-4">
                <div className="flex-1">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-slate-700">
                            {analyticsSubTab === 'main' ? 'Main Analytics' : analyticsSubTab === 'isic' ? `ISIC Analytics${selectedIsic ? ` - ${selectedIsic}` : ''}` : `Boat Analytics${selectedBoatData ? ` - ${selectedBoatData.boatName}` : ''}`}
                        </h3>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSidebar(!showSidebar)} className="px-3 py-1 bg-cyan-600 text-white rounded text-sm">{showSidebar ? 'Hide' : 'Add'} Widgets</button>
                            <span className="text-xs text-slate-400 self-center">Auto-saves</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-4 gap-3 min-h-[400px]" style={{gridAutoRows: 'minmax(100px, auto)'}}>
                        {currentGridCells.map(cell => {
                            const item = currentLayout.find(l => l.row === cell.row && l.col === cell.col);
                            const itemWidth = item?.width || 1;
                            const itemHeight = item?.height || 1;
                            const sizeLabel = `${itemWidth}x${itemHeight}`;
                            return (
                                <div
                                    key={`${cell.row}-${cell.col}`}
                                    className={`relative rounded border-2 border-dashed ${item ? 'border-transparent' : 'border-slate-200 bg-slate-50'} ${draggedItem ? 'hover:bg-cyan-50 hover:border-cyan-400' : ''}`}
                                    style={{
                                        gridColumn: `${cell.col + 1} / span ${itemWidth}`,
                                        gridRow: `${cell.row + 1} / span ${itemHeight}`
                                    }}
                                    onDragOver={(e) => { e.preventDefault(); }}
                                    onDrop={() => handleSubTabDrop(cell.row, cell.col)}
                                >
                                    {item && (
                                        <div
                                            draggable
                                            onDragStart={() => handleDragStart(item)}
                                            onDragEnd={handleDragEnd}
                                            className="cursor-move h-full"
                                        >
                                            <button onClick={() => removeSubTabItem(item.id)} className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs z-10 hover:bg-red-600">×</button>
                                            <button onClick={() => cycleSubTabSize(item.id)} className="absolute top-1 right-7 px-1 h-5 bg-blue-500 text-white rounded text-xs z-10 hover:bg-blue-600" title="Cycle size">
                                                {sizeLabel}
                                            </button>
                                            {currentRenderer(item)}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
                {showSidebar && (
                    <div className="w-64 bg-slate-100 rounded-lg p-4">
                        <h4 className="font-bold text-slate-700 mb-3">Available Widgets</h4>
                        <p className="text-xs text-slate-500 mb-3">Drag widgets to the grid to add them</p>
                        <div className="space-y-2">
                            {currentInactiveElements.map(el => (
                                <div
                                    key={el.id}
                                    draggable
                                    onDragStart={() => handleDragStart({ ...el, isNew: true })}
                                    onDragEnd={handleDragEnd}
                                    className="p-2 bg-white rounded border border-slate-200 cursor-move hover:bg-cyan-50 hover:border-cyan-400 text-sm"
                                >
                                    {el.label}
                                </div>
                            ))}
                            {currentInactiveElements.length === 0 && <div className="text-slate-400 text-sm">All widgets are on the grid</div>}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

const PreviewTab = ({ reportData, setReportData, settings, setSettings, onRequestName }) => {
    const [subTab, setSubTab] = React.useState('csl');
    const [selectedISIC, setSelectedISIC] = React.useState('');
    const [overrideModal, setOverrideModal] = React.useState(null);
    const [showOverrideLog, setShowOverrideLog] = React.useState(false);
    const [showThresholds, setShowThresholds] = React.useState(false);
    const [previewThresholds, setPreviewThresholds] = React.useState(null);
    const [notesModal, setNotesModal] = React.useState(null);
    const [showHelp, setShowHelp] = React.useState(false);
    const [showGenerateConfirm, setShowGenerateConfirm] = React.useState(false);

    // Sync preview thresholds and recalculate risk levels when settings change
    React.useEffect(() => {
        if (reportData) {
            const newThresholds = { ...settings.thresholds };
            setPreviewThresholds(newThresholds);
            // Recalculate risk levels with new thresholds for instant updates
            setReportData(prev => {
                const updatedBoats = prev.boats.map(b => {
                    const { level, reasons } = calculateRisk(b, newThresholds);
                    return { ...b, riskLevel: level, riskReasons: reasons };
                });
                return { ...prev, boats: updatedBoats };
            });
        }
    }, [JSON.stringify(settings.thresholds)]);

    if (!reportData) return <div className="text-center py-12 text-slate-400">No data loaded. Import files or drop a report.</div>;

    const activeThresholds = previewThresholds || settings.thresholds;
    const thresholdChanges = previewThresholds ? Object.keys(settings.thresholds).filter(k => settings.thresholds[k] !== previewThresholds[k]) : [];

    const { boats } = reportData; const aggs = aggregateByISIC(boats, settings);
    const current = subTab === 'csl' ? boats.filter(b => b.tycom === 'CSL') : subTab === 'csp' ? boats.filter(b => b.tycom === 'CSP') : [];
    const isics = [...new Set(current.map(b => b.isic))];
    const filtered = selectedISIC ? current.filter(b => b.isic === selectedISIC) : current;
    const groupByISIC = (list) => { const g = {}; for (const b of list) { if (!g[b.isic]) g[b.isic] = []; g[b.isic].push(b); } return g; };

    // Schema visibility helpers
    const schema = settings.schemaConfig || defaultSchemaConfig;
    const isVisible = (type, field) => { const item = schema[type]?.find(s => s.field === field); return item?.visible !== false; };
    const getLabel = (type, field, fallback) => { const item = schema[type]?.find(s => s.field === field); return item?.label || fallback; };

    // Get visible standard fields in schema order (excluding meta fields)
    const getVisibleStandardFields = (schemaArray, metaFields, type) => {
        return schemaArray.filter(f => f.visible !== false && !metaFields.includes(f.field) && standardFields[type].includes(f.field));
    };
    const essMetaFields = ['shipName', 'isic'];
    const vramMetaFields = ['siteName', 'scanExempt'];
    const tamMetaFields = ['boatName'];

    const essVisibleFields = getVisibleStandardFields(schema.ess, essMetaFields, 'ess');
    const vramVisibleFields = getVisibleStandardFields(schema.vram, vramMetaFields, 'vram');
    const tamVisibleFields = getVisibleStandardFields(schema.tam, tamMetaFields, 'tam');

    // Custom fields
    const essCustomFields = getCustomFields(schema.ess, 'ess');
    const vramCustomFields = getCustomFields(schema.vram, 'vram');
    const tamCustomFields = getCustomFields(schema.tam, 'tam');
    const fmtCustom = (v) => v === null || v === undefined ? '-' : (typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(2)) : String(v));

    // Column counts based on schema order
    const essNiprCount = essVisibleFields.length + essCustomFields.length;
    const essSiprCount = essNiprCount;
    const vramNiprCount = vramVisibleFields.length + vramCustomFields.length;
    const vramSiprCount = vramNiprCount;
    const tamCount = tamVisibleFields.length + tamCustomFields.length;
    const showVramExempt = isVisible('vram', 'scanExempt');
    const statusCount = 1 + (showVramExempt ? 1 : 0) + 1;

    const allOverrides = boats.flatMap(b => (b.overrides || []).map(o => ({ ...o, boatName: b.boatName })));

    const generate = () => {
        onRequestName((name) => {
            const userName = name || 'Unknown';
            // Build threshold change log if thresholds were modified
            const thresholdLog = thresholdChanges.map(k => ({
                field: k,
                defaultValue: settings.thresholds[k],
                newValue: previewThresholds[k],
                reason: 'Adjusted for this report',
                timestamp: new Date().toISOString(),
                user: userName
            }));
            // Update boats with user name in overrides (replace "User" placeholder)
            const updatedBoats = reportData.boats.map(b => ({
                ...b,
                overrides: (b.overrides || []).map(o => ({
                    ...o,
                    user: o.user === 'User' ? userName : o.user
                }))
            }));
            // Update dataUpdates with user name (replace "User" placeholder)
            const updatedDataUpdates = (reportData.dataUpdates || []).map(u => ({
                ...u,
                user: u.user === 'User' ? userName : u.user
            }));
            const updatedReport = {
                ...reportData,
                boats: updatedBoats,
                dataUpdates: updatedDataUpdates,
                createdBy: userName,
                lastModifiedBy: userName,
                thresholdChanges: thresholdLog,
                usedThresholds: previewThresholds || settings.thresholds
            };
            const html = generateReportHTML(updatedReport, settings);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], { type: 'text/html' })); a.download = `cyber-report-${new Date().toISOString().slice(0,10)}.html`; a.click();
        });
    };

    // Update the current user name for overrides
    const [currentUserName, setCurrentUserName] = React.useState('');

    const fmt = (v, d=0) => v == null ? '-' : (d > 0 ? v.toFixed(d) : Math.round(v).toString());
    const fmtPct = (v) => v == null ? '-' : Math.min(100, v).toFixed(1) + '%';
    const fmtDate = (d) => d ? `${new Date(d).getMonth()+1}/${new Date(d).getDate()}` : '-';
    // Updated color classes using activeThresholds for real-time updates with separate thresholds per metric
    // Product Compliance: green/yellow/red
    const prodCompClass = (v) => v === null ? '' : v >= (activeThresholds.color_product_green || 95) ? 'risk-low' : v < (activeThresholds.color_product_red || 90) ? 'risk-high' : 'risk-med';
    // Policy Compliance (True Policy): green/yellow/red
    const policyCompClass = (v) => v === null ? '' : v >= (activeThresholds.color_policy_green || 95) ? 'risk-low' : v < (activeThresholds.color_policy_red || 90) ? 'risk-high' : 'risk-med';
    // Policy Enforced Raw: green/yellow/red
    const policyRawClass = (v) => v === null ? '' : v >= (activeThresholds.color_policy_raw_green || 95) ? 'risk-low' : v < (activeThresholds.color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';
    // Generic compliance class (backward compat, uses product thresholds)
    const compClass = prodCompClass;
    // VPH: green < threshold, red >= threshold, else yellow
    const vphClass = (v) => v === null ? '' : v < (activeThresholds.color_vph_green || 2.5) ? 'risk-low' : v >= (activeThresholds.color_vph_red || 3.5) ? 'risk-high' : 'risk-med';
    // Scan age: green <= threshold, red > threshold
    const scanAgeClass = (d) => {
        if (!d) return 'risk-high';
        const date = new Date(d);
        if (isNaN(date.getTime())) return 'risk-high';
        const age = Math.floor((new Date() - date) / 86400000);
        return age <= (activeThresholds.color_scan_green || 14) ? 'risk-low' : age > (activeThresholds.color_scan_red || 14) ? 'risk-high' : 'risk-med';
    };
    // Scan Integrity %: green >= threshold, red < threshold
    const integrityClass = (v) => v === null ? '' : v >= (activeThresholds.color_integrity_green || 95) ? 'risk-low' : v < (activeThresholds.color_integrity_red || 90) ? 'risk-high' : 'risk-med';
    // Percent Scanned %: green >= threshold, red < threshold
    const scannedClass = (v) => v === null ? '' : v >= (activeThresholds.color_scanned_green || 95) ? 'risk-low' : v < (activeThresholds.color_scanned_red || 90) ? 'risk-high' : 'risk-med';

    const fieldLabels = {
        essNiprAssets: 'ESS NIPR Assets', essNiprBreakfix: 'ESS NIPR Breakfix', essNiprProductCompliance: 'ESS NIPR Compliance', essNiprPolicyEnforced: 'ESS NIPR Policy Enforced', essNiprTruePolicy: 'ESS NIPR True Policy',
        essSiprAssets: 'ESS SIPR Assets', essSiprBreakfix: 'ESS SIPR Breakfix', essSiprProductCompliance: 'ESS SIPR Compliance', essSiprPolicyEnforced: 'ESS SIPR Policy Enforced', essSiprTruePolicy: 'ESS SIPR True Policy',
        vramNiprAssets: 'VRAM NIPR Assets', vramNiprRaVph: 'VRAM NIPR VPH', vramNiprRaCrit: 'VRAM NIPR RA Critical', vramNiprRaHigh: 'VRAM NIPR RA High', vramNiprScanIntegrity: 'VRAM NIPR Integrity', vramNiprScanPercent: 'VRAM NIPR Percent',
        vramSiprAssets: 'VRAM SIPR Assets', vramSiprRaVph: 'VRAM SIPR VPH', vramSiprRaCrit: 'VRAM SIPR RA Critical', vramSiprRaHigh: 'VRAM SIPR RA High', vramSiprScanIntegrity: 'VRAM SIPR Integrity', vramSiprScanPercent: 'VRAM SIPR Percent',
        tamPastDue: 'TAM Past Due', tamExtensions: 'TAM Extensions', riskLevel: 'Risk Level',
        vramNiprScanExempt: 'NIPR Scan Exempt', vramSiprScanExempt: 'SIPR Scan Exempt',
        vramNiprScanDate: 'NIPR Last Scan Date', vramSiprScanDate: 'SIPR Last Scan Date'
    };
    const dateFields = ['vramNiprScanDate', 'vramSiprScanDate'];

    // Recalculate risks with current thresholds when thresholds change
    const recalculateWithThresholds = (newThresholds) => {
        setPreviewThresholds(newThresholds);
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                const { level, reasons } = calculateRisk(b, newThresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
    };

    const resetThresholds = () => {
        setPreviewThresholds({ ...settings.thresholds });
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                const { level, reasons } = calculateRisk(b, settings.thresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
    };

    const openOverride = (boatName, field, currentValue) => {
        const boat = boats.find(b => b.boatName === boatName);
        const existingOverride = boat?.overrides?.find(o => o.field === field);
        setOverrideModal({ boatName, field, currentValue, newValue: existingOverride?.overrideValue ?? currentValue ?? '', reason: existingOverride?.reason || '', originalValue: existingOverride?.originalValue ?? currentValue });
    };

    const saveOverride = () => {
        if (!overrideModal) return;
        const { boatName, field, newValue, reason, originalValue } = overrideModal;
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                if (b.boatName !== boatName) return b;
                const overrides = (b.overrides || []).filter(o => o.field !== field);
                let parsedValue;
                if (field === 'riskLevel') {
                    parsedValue = newValue;
                } else if (field === 'vramNiprScanExempt' || field === 'vramSiprScanExempt') {
                    parsedValue = newValue === 'true' || newValue === true;
                } else if (dateFields.includes(field)) {
                    parsedValue = newValue ? new Date(newValue).toISOString() : null;
                } else {
                    parsedValue = parseFloat(newValue);
                }
                if (String(parsedValue) !== String(originalValue)) {
                    overrides.push({ field, originalValue, overrideValue: parsedValue, reason: reason || 'Manual override', timestamp: new Date().toISOString(), user: currentUserName || 'User' });
                }
                const updated = { ...b, [field]: parsedValue, overrides };
                if (field !== 'riskLevel' && !dateFields.includes(field)) { const { level, reasons } = calculateRisk(updated, activeThresholds); updated.riskLevel = level; updated.riskReasons = reasons; }
                return updated;
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
        setOverrideModal(null);
    };

    const isOverridden = (boat, field) => boat.overrides?.some(o => o.field === field);

    const openNotesEdit = (boatName, currentNotes) => {
        setNotesModal({ boatName, notes: currentNotes });
    };

    const saveNotes = () => {
        if (!notesModal) return;
        setReportData(prev => ({
            ...prev,
            boats: prev.boats.map(b => b.boatName === notesModal.boatName ? { ...b, notes: notesModal.notes } : b),
            lastModifiedAt: new Date().toISOString()
        }));
        setNotesModal(null);
    };

    // Check if field is a NIPR field (for NMCI display)
    const isNiprField = (field) => field && (field.includes('Nipr') || field.includes('nipr'));

    const Cell = ({ boat, field, value, format = 'num', className = '' }) => {
        const overridden = isOverridden(boat, field);
        // For NMCI boats, show "NMCI" instead of data for NIPR fields
        if (boat.isNmci && isNiprField(field)) {
            return <td className="bg-blue-100 text-blue-700 text-xs font-semibold" title="This boat uses NMCI for NIPR network">NMCI</td>;
        }
        return <td className={`${className} ${overridden ? 'overridden' : ''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(boat.boatName, field, boat[field])} title={overridden ? 'Overridden - click to edit' : 'Click to override'}>{format === 'pct' ? fmtPct(value) : format === 'date' ? fmtDate(value) : format === 'num2' ? fmt(value, 2) : value ?? '-'}</td>;
    };

    // Cell renderer configs for dynamic schema-based rendering
    const essNiprCellConfigs = {
        assets: (b) => ({ field: 'essNiprAssets', value: fmt(b.essNiprAssets) }),
        breakfix: (b) => ({ field: 'essNiprBreakfix', value: fmt(b.essNiprBreakfix), className: (b.essNiprBreakfix||0)>0?'risk-high':'' }),
        productCompliance: (b) => ({ field: 'essNiprProductCompliance', value: b.essNiprProductCompliance, format: 'pct', className: prodCompClass(b.essNiprProductCompliance) }),
        policyEnforced: (b) => ({ field: 'essNiprPolicyEnforced', value: b.essNiprPolicyEnforced, format: 'pct', className: policyRawClass(b.essNiprPolicyEnforced) }),
        truePolicy: (b) => ({ field: 'essNiprTruePolicy', value: b.essNiprTruePolicy, format: 'pct', className: policyCompClass(b.essNiprTruePolicy) })
    };
    const essSiprCellConfigs = {
        assets: (b) => ({ field: 'essSiprAssets', value: fmt(b.essSiprAssets) }),
        breakfix: (b) => ({ field: 'essSiprBreakfix', value: fmt(b.essSiprBreakfix), className: (b.essSiprBreakfix||0)>0?'risk-high':'' }),
        productCompliance: (b) => ({ field: 'essSiprProductCompliance', value: b.essSiprProductCompliance, format: 'pct', className: prodCompClass(b.essSiprProductCompliance) }),
        policyEnforced: (b) => ({ field: 'essSiprPolicyEnforced', value: b.essSiprPolicyEnforced, format: 'pct', className: policyRawClass(b.essSiprPolicyEnforced) }),
        truePolicy: (b) => ({ field: 'essSiprTruePolicy', value: b.essSiprTruePolicy, format: 'pct', className: policyCompClass(b.essSiprTruePolicy) })
    };
    const vramNiprCellConfigs = {
        assets: (b) => ({ field: 'vramNiprAssets', value: fmt(b.vramNiprAssets) }),
        scanDate: (b) => ({ field: 'vramNiprScanDate', value: b.vramNiprScanDate, format: 'date', className: scanAgeClass(b.vramNiprScanDate) }),
        raVph: (b) => ({ field: 'vramNiprRaVph', value: b.vramNiprRaVph, format: 'num2', className: vphClass(b.vramNiprRaVph) }),
        raCrit: (b) => ({ field: 'vramNiprRaCrit', value: fmt(b.vramNiprRaCrit) }),
        raHigh: (b) => ({ field: 'vramNiprRaHigh', value: fmt(b.vramNiprRaHigh) }),
        scanIntegrity: (b) => ({ field: 'vramNiprScanIntegrity', value: b.vramNiprScanIntegrity, format: 'pct', className: integrityClass(b.vramNiprScanIntegrity) }),
        scanPercent: (b) => ({ field: 'vramNiprScanPercent', value: b.vramNiprScanPercent, format: 'pct', className: scannedClass(b.vramNiprScanPercent) })
    };
    const vramSiprCellConfigs = {
        assets: (b) => ({ field: 'vramSiprAssets', value: fmt(b.vramSiprAssets) }),
        scanDate: (b) => ({ field: 'vramSiprScanDate', value: b.vramSiprScanDate, format: 'date', className: scanAgeClass(b.vramSiprScanDate) }),
        raVph: (b) => ({ field: 'vramSiprRaVph', value: b.vramSiprRaVph, format: 'num2', className: vphClass(b.vramSiprRaVph) }),
        raCrit: (b) => ({ field: 'vramSiprRaCrit', value: fmt(b.vramSiprRaCrit) }),
        raHigh: (b) => ({ field: 'vramSiprRaHigh', value: fmt(b.vramSiprRaHigh) }),
        scanIntegrity: (b) => ({ field: 'vramSiprScanIntegrity', value: b.vramSiprScanIntegrity, format: 'pct', className: integrityClass(b.vramSiprScanIntegrity) }),
        scanPercent: (b) => ({ field: 'vramSiprScanPercent', value: b.vramSiprScanPercent, format: 'pct', className: scannedClass(b.vramSiprScanPercent) })
    };
    const tamCellConfigs = {
        pastDue: (b) => ({ field: 'tamPastDue', value: fmt(b.tamPastDue), className: (b.tamPastDue||0)>10?'risk-high':'' }),
        extensions: (b) => ({ field: 'tamExtensions', value: fmt(b.tamExtensions) })
    };

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-slate-800">Preview Report</h2>
                <div className="flex gap-2">
                    <button onClick={() => setShowHelp(true)} className="btn-secondary text-sm" title="Calculation Help">?</button>
                    <button onClick={() => setShowThresholds(!showThresholds)} className={`btn-secondary text-sm ${thresholdChanges.length > 0 ? 'ring-2 ring-amber-400' : ''}`}>{showThresholds ? 'Hide' : 'Adjust'} Thresholds{thresholdChanges.length > 0 ? ` (${thresholdChanges.length})` : ''}</button>
                    {allOverrides.length > 0 && <button onClick={() => setShowOverrideLog(!showOverrideLog)} className="btn-secondary text-sm">{showOverrideLog ? 'Hide' : 'Show'} Override Log ({allOverrides.length})</button>}
                    <button onClick={() => setShowGenerateConfirm(true)} className="btn-success">Generate HTML Report</button>
                </div>
            </div>

            {showOverrideLog && allOverrides.length > 0 && (
                <div className="card p-4 mb-6">
                    <h3 className="text-lg font-bold mb-3 text-purple-700">Override Log</h3>
                    <div className="overflow-x-auto"><table className="data-table text-xs"><thead><tr><th>Boat</th><th>Field</th><th>Original</th><th>New</th><th>Reason</th><th>By</th><th>Time</th></tr></thead>
                    <tbody>{allOverrides.map((o, i) => <tr key={i}><td className="boat-name">{o.boatName}</td><td>{fieldLabels[o.field] || o.field}</td><td>{String(o.originalValue)}</td><td>{String(o.overrideValue)}</td><td>{o.reason}</td><td>{o.user}</td><td>{new Date(o.timestamp).toLocaleString()}</td></tr>)}</tbody></table></div>
                </div>
            )}

            {showThresholds && previewThresholds && (
                <div className="card p-4 mb-6 border-2 border-amber-300">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-amber-700">Temporary Risk Criteria Builder</h3>
                        <div className="flex gap-2">
                            {thresholdChanges.length > 0 && <span className="text-sm text-amber-600 bg-amber-50 px-2 py-1 rounded">{thresholdChanges.length} changed</span>}
                            <button onClick={resetThresholds} className="btn-secondary text-sm">Reset to Defaults</button>
                        </div>
                    </div>
                    <p className="text-sm text-slate-500 mb-4">These adjustments only apply to this preview session and will be logged in the generated report.</p>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {/* HIGH Risk Column */}
                        <div className="border-2 border-red-200 rounded-lg p-3 bg-red-50">
                            <h4 className="font-bold text-red-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-high">HIGH</span>
                                Any triggers HIGH
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.auto_high_ra_vph || 999) < 999} onChange={(e) => recalculateWithThresholds({...previewThresholds, auto_high_ra_vph: e.target.checked ? 5 : 999})} />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    {(previewThresholds.auto_high_ra_vph || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" step="0.1" value={previewThresholds.auto_high_ra_vph || 5} onChange={(e) => recalculateWithThresholds({...previewThresholds, auto_high_ra_vph: parseFloat(e.target.value) || 5})} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.high_product_compliance || 0) > 0} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_product_compliance: e.target.checked ? 50 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">Raw Product Compliance</span>
                                    </div>
                                    {(previewThresholds.high_product_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={previewThresholds.high_product_compliance || 50} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_product_compliance: parseInt(e.target.value) || 50})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.high_ess_compliance || 0) > 0} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_ess_compliance: e.target.checked ? 90 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(previewThresholds.high_ess_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={previewThresholds.high_ess_compliance || 90} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_ess_compliance: parseInt(e.target.value) || 90})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.high_raw_policy_compliance || 0) > 0} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_raw_policy_compliance: e.target.checked ? 90 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(previewThresholds.high_raw_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={previewThresholds.high_raw_policy_compliance || 90} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_raw_policy_compliance: parseInt(e.target.value) || 90})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.auto_high_scan_age_days || 999) < 999} onChange={(e) => recalculateWithThresholds({...previewThresholds, auto_high_scan_age_days: e.target.checked ? 30 : 999})} />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    {(previewThresholds.auto_high_scan_age_days || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={previewThresholds.auto_high_scan_age_days || 30} onChange={(e) => recalculateWithThresholds({...previewThresholds, auto_high_scan_age_days: parseInt(e.target.value) || 30})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.high_tam_past_due || 999) < 999} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_tam_past_due: e.target.checked ? 20 : 999})} />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    {(previewThresholds.high_tam_past_due || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={previewThresholds.high_tam_past_due || 20} onChange={(e) => recalculateWithThresholds({...previewThresholds, high_tam_past_due: parseInt(e.target.value) || 20})} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">No VRAM Scan Data</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Breakfix &gt; 0</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprBreakfix, essSiprBreakfix</div>
                                </div>
                            </div>
                        </div>

                        {/* MED Risk Column */}
                        <div className="border-2 border-amber-200 rounded-lg p-3 bg-amber-50">
                            <h4 className="font-bold text-amber-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-med">MED</span>
                                2+ triggers MED
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" step="0.1" value={previewThresholds.med_ra_vph || 3.5} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_ra_vph: parseFloat(e.target.value) || 3.5})} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Raw Product Compliance</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={previewThresholds.med_ess_compliance || 95} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_ess_compliance: parseInt(e.target.value) || 95})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.med_true_policy_compliance || 0) > 0} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_true_policy_compliance: e.target.checked ? 95 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(previewThresholds.med_true_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={previewThresholds.med_true_policy_compliance || 95} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_true_policy_compliance: parseInt(e.target.value) || 95})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.med_raw_policy_compliance || 0) > 0} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_raw_policy_compliance: e.target.checked ? 95 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(previewThresholds.med_raw_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={previewThresholds.med_raw_policy_compliance || 95} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_raw_policy_compliance: parseInt(e.target.value) || 95})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={previewThresholds.med_scan_age_days || 14} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_scan_age_days: parseInt(e.target.value) || 14})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={previewThresholds.med_tam_past_due || 10} onChange={(e) => recalculateWithThresholds({...previewThresholds, med_tam_past_due: parseInt(e.target.value) || 10})} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                            </div>
                            <div className="mt-3 p-2 bg-amber-100 rounded text-xs text-amber-700">
                                <strong>Note:</strong> If 2+ conditions are met, boat is MED risk.
                            </div>
                        </div>

                        {/* LOW Risk Column */}
                        <div className="border-2 border-green-200 rounded-lg p-3 bg-green-50">
                            <h4 className="font-bold text-green-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-low">LOW</span>
                                All criteria met
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" step="0.1" value={previewThresholds.low_vph || 2.5} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_vph: parseFloat(e.target.value) || 2.5})} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Raw Product Compliance</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≥</span><input type="number" value={previewThresholds.low_product_compliance || 95} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_product_compliance: parseInt(e.target.value) || 95})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.low_true_policy_compliance_enabled ?? 0) === 1} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_true_policy_compliance_enabled: e.target.checked ? 1 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(previewThresholds.low_true_policy_compliance_enabled ?? 0) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≥</span><input type="number" value={previewThresholds.low_true_policy_compliance || 95} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_true_policy_compliance: parseInt(e.target.value) || 95})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.low_raw_policy_compliance_enabled ?? 0) === 1} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_raw_policy_compliance_enabled: e.target.checked ? 1 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(previewThresholds.low_raw_policy_compliance_enabled ?? 0) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≥</span><input type="number" value={previewThresholds.low_raw_policy_compliance || 95} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_raw_policy_compliance: parseInt(e.target.value) || 95})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≤</span><input type="number" value={previewThresholds.low_scan_age_days || 14} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_scan_age_days: parseInt(e.target.value) || 14})} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(previewThresholds.low_tam_past_due_enabled ?? 0) === 1} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_tam_past_due_enabled: e.target.checked ? 1 : 0})} />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    {(previewThresholds.low_tam_past_due_enabled ?? 0) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≤</span><input type="number" value={previewThresholds.low_tam_past_due || 5} onChange={(e) => recalculateWithThresholds({...previewThresholds, low_tam_past_due: parseInt(e.target.value) || 5})} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">No Breakfix</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprBreakfix, essSiprBreakfix</div>
                                </div>
                            </div>
                            <div className="mt-3 p-2 bg-green-100 rounded text-xs text-green-700">
                                <strong>Note:</strong> Must meet ALL criteria to be LOW.
                            </div>
                        </div>
                    </div>

                    {/* Risk Equation Summary */}
                    <div className="mt-4 p-3 bg-slate-100 rounded border border-slate-300">
                        <h4 className="font-bold text-slate-700 mb-2 text-sm">Current Risk Equation</h4>
                        <div className="text-xs font-mono text-slate-600 space-y-1">
                            <div><span className="risk-high px-1 rounded">HIGH</span> = {generateDynamicLegend(previewThresholds).high}</div>
                            <div><span className="risk-med px-1 rounded">MED</span> = {generateDynamicLegend(previewThresholds).med}</div>
                            <div><span className="risk-low px-1 rounded">LOW</span> = {generateDynamicLegend(previewThresholds).low}, No Breakfix</div>
                        </div>
                    </div>

                    <div className="mt-4 p-3 bg-slate-50 rounded border border-slate-200">
                        <h4 className="font-bold text-slate-700 mb-2">Scan Exempt Override</h4>
                        <p className="text-xs text-slate-500">When a boat is marked Scan Exempt, HIGH risk is downgraded to MED <strong>only if</strong> the sole reason for HIGH was "No VRAM Scan Data". Breakfix or other HIGH triggers are NOT affected. For NMCI boats, both NIPR and SIPR must be exempt.</p>
                    </div>
                </div>
            )}

            <div className="flex gap-2 mb-4">
                {['csl', 'csp', 'hq', 'analytics'].map(t => <button key={t} onClick={() => { setSubTab(t); setSelectedISIC(''); }} className={`px-4 py-2 rounded font-medium uppercase text-sm ${subTab === t ? 'bg-cyan-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{t === 'hq' ? 'HQ Status' : t === 'analytics' ? 'Analytics' : `${t} Summary`}</button>)}
            </div>
            {(subTab === 'csl' || subTab === 'csp') && <div className="mb-4"><select value={selectedISIC} onChange={(e) => setSelectedISIC(e.target.value)} className="px-4 py-2 rounded"><option value="">All Squadrons</option>{isics.map(i => <option key={i} value={i}>{settings.isics.find(x => x.isic_name === i)?.isic_short || i.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')}</option>)}</select><span className="ml-4 text-sm text-slate-500">Click any cell to override</span></div>}

            {subTab === 'hq' ? (
                <HQStatusPreview boats={boats} settings={settings} onLayoutChange={(newLayout) => setSettings(prev => ({ ...prev, hqStatusLayout: newLayout }))} />
            ) : subTab === 'analytics' ? (
                <AnalyticsPreview
                    boats={boats}
                    settings={settings}
                    onLayoutChange={(newLayout) => setSettings(prev => ({ ...prev, analyticsLayout: newLayout }))}
                    onIsicLayoutChange={(newLayout) => setSettings(prev => ({ ...prev, isicAnalyticsLayout: newLayout }))}
                    onBoatLayoutChange={(newLayout) => setSettings(prev => ({ ...prev, boatAnalyticsLayout: newLayout }))}
                />
            ) : (
                <div className="card p-4 overflow-x-auto">
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th rowSpan="2" className="isic-header">ISIC</th>
                                <th rowSpan="2" style={{width:'70px'}}>BOAT</th>
                                {essNiprCount > 0 && <th colSpan={essNiprCount} className="col-ess-n">ESS NIPR</th>}
                                {essSiprCount > 0 && <th colSpan={essSiprCount} className="col-ess-s">ESS SIPR</th>}
                                {vramNiprCount > 0 && <th colSpan={vramNiprCount} className="col-vram-n">VRAM NIPR</th>}
                                {vramSiprCount > 0 && <th colSpan={vramSiprCount} className="col-vram-s">VRAM SIPR</th>}
                                {tamCount > 0 && <th colSpan={tamCount} className="col-tam">TAM</th>}
                                <th colSpan={statusCount} className="col-status">STATUS</th>
                            </tr>
                            <tr>
                                {/* ESS NIPR headers - in schema order (using label from schema config) */}
                                {essVisibleFields.map(f => <th key={`essn-${f.field}`} className="col-ess-n">{f.label || f.field}</th>)}
                                {essCustomFields.map(cf => <th key={`essn-c-${cf.field}`} className="col-ess-n">{cf.label || cf.field}</th>)}
                                {/* ESS SIPR headers - in schema order */}
                                {essVisibleFields.map(f => <th key={`esss-${f.field}`} className="col-ess-s">{f.label || f.field}</th>)}
                                {essCustomFields.map(cf => <th key={`esss-c-${cf.field}`} className="col-ess-s">{cf.label || cf.field}</th>)}
                                {/* VRAM NIPR headers - in schema order */}
                                {vramVisibleFields.map(f => <th key={`vramn-${f.field}`} className="col-vram-n">{f.label || f.field}</th>)}
                                {vramCustomFields.map(cf => <th key={`vramn-c-${cf.field}`} className="col-vram-n">{cf.label || cf.field}</th>)}
                                {/* VRAM SIPR headers - in schema order */}
                                {vramVisibleFields.map(f => <th key={`vrams-${f.field}`} className="col-vram-s">{f.label || f.field}</th>)}
                                {vramCustomFields.map(cf => <th key={`vrams-c-${cf.field}`} className="col-vram-s">{cf.label || cf.field}</th>)}
                                {/* TAM headers - in schema order */}
                                {tamVisibleFields.map(f => <th key={`tam-${f.field}`} className="col-tam">{f.label || f.field}</th>)}
                                {tamCustomFields.map(cf => <th key={`tam-c-${cf.field}`} className="col-tam">{cf.label || cf.field}</th>)}
                                <th className="col-status">Risk</th>
                                {showVramExempt && <th className="col-status">{getLabel('vram', 'scanExempt', 'Scan Exempt')}</th>}
                                <th className="col-status" style={{width:'70px',minWidth:'70px'}}>Notes</th>
                            </tr>
                        </thead>
                        <tbody>{Object.entries(groupByISIC(filtered)).map(([isic, isicBoats]) =>
                            isicBoats.map((b, idx) => <tr key={b.boatName} className={idx === 0 ? 'isic-first-row' : ''}>
                                {idx === 0 && <td rowSpan={isicBoats.length} className="isic-cell">{settings.isics.find(i => i.isic_name === isic)?.isic_short || isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')}</td>}
                                <td className="boat-name" style={{overflowWrap:'break-word',wordBreak:'keep-all',whiteSpace:'normal',maxHeight:'36px',overflow:'hidden',lineHeight:'1.2'}}>{b.boatFullName || b.boatName}</td>
                                {/* ESS NIPR cells - in schema order */}
                                {essVisibleFields.map(f => { const cfg = essNiprCellConfigs[f.field]; return cfg ? <Cell key={`essn-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {essCustomFields.map(cf => <td key={`essn-c-${cf.field}`}>{fmtCustom(b.customFields?.essNipr?.[cf.field])}</td>)}
                                {/* ESS SIPR cells - in schema order */}
                                {essVisibleFields.map(f => { const cfg = essSiprCellConfigs[f.field]; return cfg ? <Cell key={`esss-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {essCustomFields.map(cf => <td key={`esss-c-${cf.field}`}>{fmtCustom(b.customFields?.essSipr?.[cf.field])}</td>)}
                                {/* VRAM NIPR cells - in schema order */}
                                {vramVisibleFields.map(f => { const cfg = vramNiprCellConfigs[f.field]; return cfg ? <Cell key={`vramn-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {vramCustomFields.map(cf => <td key={`vramn-c-${cf.field}`}>{fmtCustom(b.customFields?.vramNipr?.[cf.field])}</td>)}
                                {/* VRAM SIPR cells - in schema order */}
                                {vramVisibleFields.map(f => { const cfg = vramSiprCellConfigs[f.field]; return cfg ? <Cell key={`vrams-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {vramCustomFields.map(cf => <td key={`vrams-c-${cf.field}`}>{fmtCustom(b.customFields?.vramSipr?.[cf.field])}</td>)}
                                {/* TAM cells - in schema order */}
                                {tamVisibleFields.map(f => { const cfg = tamCellConfigs[f.field]; return cfg ? <Cell key={`tam-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {tamCustomFields.map(cf => <td key={`tam-c-${cf.field}`}>{fmtCustom(b.customFields?.tam?.[cf.field])}</td>)}
                                <td className={`risk-${b.riskLevel.toLowerCase()} ${isOverridden(b,'riskLevel')?'overridden':''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(b.boatName, 'riskLevel', b.riskLevel)}>{b.riskLevel}</td>
                                {showVramExempt && <td className={`${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'alert-blue':''} ${(isOverridden(b,'vramNiprScanExempt')||isOverridden(b,'vramSiprScanExempt'))?'overridden':''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(b.boatName, 'vramNiprScanExempt', b.vramNiprScanExempt)} title="Click to override scan exempt status">{(b.vramNiprScanExempt||b.vramSiprScanExempt)?'Y':'N'}</td>}
                                <td className="text-xs cursor-pointer hover:bg-cyan-50" style={{width:'70px',minWidth:'70px',overflowWrap:'break-word',wordBreak:'keep-all',whiteSpace:'normal',maxHeight:'36px',overflow:'hidden',lineHeight:'1.2'}} onClick={() => openNotesEdit(b.boatName, b.notes || '')} title={b.notes || 'Click to add note'}>{b.notes || '-'}</td>
                            </tr>)
                        )}</tbody>
                    </table>
                </div>
            )}

            {overrideModal && (
                <div className="modal-overlay" onClick={() => setOverrideModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-purple-700">Override Value</h3>
                        <div className="space-y-4">
                            <div className="text-sm text-slate-500">Boat: <span className="text-cyan-600 font-mono">{overrideModal.boatName}</span></div>
                            <div className="text-sm text-slate-500">Field: <span className="text-slate-800">{fieldLabels[overrideModal.field] || overrideModal.field}</span></div>
                            <div className="text-sm text-slate-500">Original: <span className="text-slate-600">{overrideModal.originalValue ?? 'null'}</span></div>
                            <div>
                                <label className="block text-sm text-slate-500 mb-1">New Value</label>
                                {overrideModal.field === 'riskLevel' ? (
                                    <select value={overrideModal.newValue} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full">
                                        <option value="LOW">LOW</option><option value="MED">MED</option><option value="HIGH">HIGH</option>
                                    </select>
                                ) : (overrideModal.field === 'vramNiprScanExempt' || overrideModal.field === 'vramSiprScanExempt') ? (
                                    <select value={String(overrideModal.newValue)} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full">
                                        <option value="false">No (N)</option><option value="true">Yes (Y)</option>
                                    </select>
                                ) : dateFields.includes(overrideModal.field) ? (
                                    <input type="date" value={overrideModal.newValue ? new Date(overrideModal.newValue).toISOString().split('T')[0] : ''} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full" />
                                ) : (
                                    <input type="number" step="any" value={overrideModal.newValue} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full" />
                                )}
                            </div>
                            <div>
                                <label className="block text-sm text-slate-500 mb-1">Reason for Override</label>
                                <input value={overrideModal.reason} onChange={(e) => setOverrideModal({...overrideModal, reason: e.target.value})} placeholder="Why is this being overridden?" className="w-full" />
                            </div>
                        </div>
                        <div className="flex gap-2 mt-6">
                            <button onClick={saveOverride} className="btn-primary">Save Override</button>
                            <button onClick={() => setOverrideModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {notesModal && (
                <div className="modal-overlay" onClick={() => setNotesModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Edit Note</h3>
                        <div className="text-sm text-slate-500 mb-2">Boat: <span className="text-cyan-600 font-mono">{notesModal.boatName}</span></div>
                        <input type="text" maxLength={30} value={notesModal.notes} onChange={(e) => setNotesModal({...notesModal, notes: e.target.value})} className="w-full mb-4" placeholder="Short note (3-5 words)" autoFocus onKeyDown={(e) => e.key === 'Enter' && saveNotes()} />
                        <div className="flex gap-2">
                            <button onClick={saveNotes} className="btn-primary">Save</button>
                            <button onClick={() => setNotesModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {showHelp && (() => {
                const dynamicHelp = generateDynamicHelpModal(activeThresholds);
                const customHelp = settings.helpModalText || defaultHelpModalText;
                const useCustom = settings.useCustomHelpText;
                const formatText = (text) => text.replace(/\{(\w+)\}/g, (m, k) => activeThresholds[k] !== undefined ? activeThresholds[k] : m);
                const helpData = useCustom ? {
                    highItems: (customHelp.highItems || []).map(formatText),
                    medItems: (customHelp.medItems || []).map(formatText),
                    lowItems: (customHelp.lowItems || []).map(formatText),
                    calcItems: (customHelp.calcItems || []).map(formatText),
                    scanExempt: formatText(customHelp.scanExempt || '')
                } : dynamicHelp;
                return (
                <div className="modal-overlay" onClick={() => setShowHelp(false)}>
                    <div className="modal-content" style={{maxWidth:'650px',maxHeight:'80vh',overflow:'auto'}} onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Risk Calculation Reference</h3>
                        <div className="text-sm space-y-4">
                            <div className="p-3 bg-red-50 rounded border border-red-200">
                                <h4 className="font-bold text-red-600 mb-2">HIGH Risk</h4>
                                <ul className="list-disc ml-5 text-slate-700 space-y-1">
                                    {helpData.highItems.map((item, i) => <li key={i}>{item}</li>)}
                                </ul>
                            </div>
                            <div className="p-3 bg-amber-50 rounded border border-amber-200">
                                <h4 className="font-bold text-amber-600 mb-2">MEDIUM Risk (2+ of the following)</h4>
                                <ul className="list-disc ml-5 text-slate-700 space-y-1">
                                    {helpData.medItems.map((item, i) => <li key={i}>{item}</li>)}
                                </ul>
                            </div>
                            <div className="p-3 bg-green-50 rounded border border-green-200">
                                <h4 className="font-bold text-green-600 mb-2">LOW Risk (All conditions met)</h4>
                                <ul className="list-disc ml-5 text-slate-700 space-y-1">
                                    {helpData.lowItems.map((item, i) => <li key={i}>{item}</li>)}
                                </ul>
                            </div>
                            <div className="p-3 bg-blue-50 rounded border border-blue-200">
                                <h4 className="font-bold text-blue-600 mb-2">Scan Exempt Override</h4>
                                <p className="text-slate-700">{helpData.scanExempt}</p>
                            </div>
                            <div>
                                <h4 className="font-bold text-slate-700 mb-1">Key Calculations</h4>
                                <ul className="list-disc ml-5 text-slate-600 space-y-1">
                                    {helpData.calcItems.map((item, i) => <li key={i}>{item}</li>)}
                                </ul>
                            </div>
                        </div>
                        <div className="mt-6"><button onClick={() => setShowHelp(false)} className="btn-primary">Close</button></div>
                    </div>
                </div>
                );
            })()}

            {showGenerateConfirm && (
                <div className="modal-overlay" onClick={() => setShowGenerateConfirm(false)}>
                    <div className="modal-content" style={{maxWidth:'500px'}} onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Generate Report</h3>
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                            <div className="flex items-start gap-3">
                                <span className="text-amber-500 text-xl">&#9888;</span>
                                <div className="text-sm text-amber-800">
                                    <strong>Important for Charts to Display:</strong>
                                    <p className="mt-2">For the Analytics page charts to display correctly in the generated report, you must:</p>
                                    <ol className="list-decimal ml-5 mt-2 space-y-1">
                                        <li>Place the downloaded report file in the <strong>same location</strong> as this dashboard tool</li>
                                        <li>Ensure the <strong>libs/</strong> folder is present in the same directory</li>
                                    </ol>
                                    <p className="mt-2 text-xs">The report requires the local Chart.js library from the libs folder to render charts.</p>
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button onClick={() => setShowGenerateConfirm(false)} className="btn-secondary">Cancel</button>
                            <button onClick={() => { setShowGenerateConfirm(false); generate(); }} className="btn-success">Continue &amp; Generate</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const SettingsTab = ({ settings, setSettings, onAlert, isUsingImportedSettings, onSaveToMySettings }) => {
    const [subTab, setSubTab] = React.useState('registry');
    const [editingBoat, setEditingBoat] = React.useState(null);
    const [editingISIC, setEditingISIC] = React.useState(null);
    const [authorName, setAuthorName] = React.useState(settings.user?.default_name || '');
    const [showAuthorPrompt, setShowAuthorPrompt] = React.useState(false);

    const saveBoat = () => {
        if (!editingBoat.boat_name) return;
        const isic = settings.isics.find(i => i.isic_name === editingBoat.isic);
        const boat = { ...editingBoat, tycom: isic?.tycom || 'CSL' }; delete boat.isNew;
        setSettings(prev => ({ ...prev, boats: editingBoat.isNew ? [...prev.boats, boat] : prev.boats.map(b => b.boat_name === boat.boat_name ? boat : b) }));
        setEditingBoat(null);
    };

    const deleteBoat = (boatName) => {
        if (confirm(`Delete boat "${boatName}"?`)) {
            setSettings(prev => ({ ...prev, boats: prev.boats.filter(b => b.boat_name !== boatName) }));
        }
    };

    const saveISIC = () => {
        if (!editingISIC.isic_name) return;
        const isic = { ...editingISIC }; delete isic.isNew;
        setSettings(prev => {
            const newIsics = editingISIC.isNew ? [...prev.isics, isic] : prev.isics.map(i => i.isic_name === isic.isic_name ? isic : i);
            // Update tycom on all boats belonging to this ISIC
            const newBoats = prev.boats.map(b => b.isic === isic.isic_name ? { ...b, tycom: isic.tycom } : b);
            return { ...prev, isics: newIsics, boats: newBoats };
        });
        setEditingISIC(null);
    };

    const deleteISIC = (isicName) => {
        const boatsUsingISIC = settings.boats.filter(b => b.isic === isicName);
        if (boatsUsingISIC.length > 0) {
            onAlert && onAlert({ type: 'error', msg: `Cannot delete ISIC: ${boatsUsingISIC.length} boats are assigned to it` });
            return;
        }
        if (confirm(`Delete ISIC "${isicName}"?`)) {
            setSettings(prev => ({ ...prev, isics: prev.isics.filter(i => i.isic_name !== isicName) }));
        }
    };

    // Auto-save to localStorage whenever settings change
    React.useEffect(() => {
        if (!isUsingImportedSettings) {
            SettingsManager.save(settings);
        }
    }, [settings, isUsingImportedSettings]);

    const handleImportSettings = async () => {
        const result = await SettingsManager.importSettings();
        if (result.success) {
            setSettings(result.settings);
            SettingsManager.save(result.settings);
            onAlert && onAlert({ type: 'info', msg: `Settings imported (v${result.settings._settingsVersion} by ${result.settings._settingsAuthor})` });
        } else if (result.error) {
            onAlert && onAlert({ type: 'error', msg: 'Failed to import: ' + result.error });
        }
    };

    const handleExportSettings = () => {
        SettingsManager.exportSettings(settings);
        onAlert && onAlert({ type: 'info', msg: `Settings exported as settings-v${settings._settingsVersion}.json` });
    };

    const handleSaveAsMySettings = () => {
        if (!authorName.trim()) {
            setShowAuthorPrompt(true);
            return;
        }
        const updated = SettingsManager.updateVersion({...settings}, authorName);
        updated.user = { ...updated.user, default_name: authorName };
        setSettings(updated);
        SettingsManager.save(updated);
        onSaveToMySettings && onSaveToMySettings();
        onAlert && onAlert({ type: 'info', msg: `Settings saved as v${updated._settingsVersion}` });
    };

    const handleResetToDefaults = () => {
        if (confirm('Reset all settings to defaults? This cannot be undone.')) {
            SettingsManager.clear();
            const defaults = SettingsManager.getDefaults();
            setSettings(defaults);
            onAlert && onAlert({ type: 'info', msg: 'Settings reset to defaults' });
        }
    };

    const saveAuthorAndSettings = () => {
        if (!authorName.trim()) return;
        setShowAuthorPrompt(false);
        const updated = SettingsManager.updateVersion({...settings}, authorName);
        updated.user = { ...updated.user, default_name: authorName };
        setSettings(updated);
        SettingsManager.save(updated);
        onSaveToMySettings && onSaveToMySettings();
        onAlert && onAlert({ type: 'info', msg: `Settings saved as v${updated._settingsVersion}` });
    };

    // Legend text helpers
    const legend = settings.legendText || JSON.parse(JSON.stringify(defaultLegendText));
    const updateLegend = (key, value) => {
        setSettings(prev => ({ ...prev, legendText: { ...prev.legendText, [key]: value } }));
    };

    // Help modal text helpers (? button content)
    const helpModal = settings.helpModalText || JSON.parse(JSON.stringify(defaultHelpModalText));
    const updateHelpModal = (key, value) => {
        setSettings(prev => ({ ...prev, helpModalText: { ...prev.helpModalText, [key]: value } }));
    };
    const updateHelpModalItem = (key, index, value) => {
        setSettings(prev => {
            const items = [...(prev.helpModalText?.[key] || defaultHelpModalText[key])];
            items[index] = value;
            return { ...prev, helpModalText: { ...prev.helpModalText, [key]: items } };
        });
    };
    const addHelpModalItem = (key) => {
        setSettings(prev => {
            const items = [...(prev.helpModalText?.[key] || defaultHelpModalText[key]), ''];
            return { ...prev, helpModalText: { ...prev.helpModalText, [key]: items } };
        });
    };
    const removeHelpModalItem = (key, index) => {
        setSettings(prev => {
            const items = [...(prev.helpModalText?.[key] || defaultHelpModalText[key])];
            items.splice(index, 1);
            return { ...prev, helpModalText: { ...prev.helpModalText, [key]: items } };
        });
    };

    // Schema config helpers
    const schema = settings.schemaConfig || JSON.parse(JSON.stringify(defaultSchemaConfig));
    const [newFieldModal, setNewFieldModal] = React.useState(null);

    const updateSchemaField = (type, idx, updates) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type][idx] = { ...newSchema[type][idx], ...updates };
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const reorderSchema = (type, fromIdx, toIdx) => {
        if (fromIdx === toIdx) return;
        const newSchema = JSON.parse(JSON.stringify(schema));
        const [moved] = newSchema[type].splice(fromIdx, 1);
        newSchema[type].splice(toIdx, 0, moved);
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const removeSchemaField = (type, idx) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type].splice(idx, 1);
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const addSchemaField = (type, field, label, column) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type].push({ field, label, column, visible: true });
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const schemaTypeLabels = { vram: 'VRAM Files', ess: 'ESS Files', tam: 'TAM Files' };
    const schemaTypeColors = { vram: 'text-cyan-700', ess: 'text-indigo-700', tam: 'text-orange-700' };

    return (
        <div>
            {/* Warning Box */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-3">
                    <span className="text-blue-500 text-xl">ℹ</span>
                    <div>
                        <h4 className="font-semibold text-blue-800 mb-1">Settings are saved automatically in this browser</h4>
                        <p className="text-sm text-blue-700">Changes are auto-saved to your browser's local storage. Use <strong>Export</strong> to backup or share settings, and <strong>Import</strong> to restore from a backup file.</p>
                        {isUsingImportedSettings && <p className="text-sm text-amber-700 mt-2 font-medium">You're currently using settings from an imported report. Click "Save to My Settings" to make these your default.</p>}
                    </div>
                </div>
            </div>

            {/* Header with version info */}
            <div className="flex justify-between items-start mb-6">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800">Settings</h2>
                    <p className="text-sm text-slate-500 mt-1">
                        v{settings._settingsVersion || '1.0'} by {settings._settingsAuthor || 'Unknown'}
                        {settings._settingsModified && <span className="ml-2">• Last modified: {new Date(settings._settingsModified).toLocaleDateString()}</span>}
                    </p>
                </div>
                <div className="flex gap-2 flex-wrap justify-end">
                    <button onClick={handleImportSettings} className="btn-secondary text-sm">Import</button>
                    <button onClick={handleExportSettings} className="btn-secondary text-sm">Export</button>
                    {isUsingImportedSettings && <button onClick={handleSaveAsMySettings} className="btn-success text-sm">Save to My Settings</button>}
                    <button onClick={handleResetToDefaults} className="text-sm text-red-600 hover:text-red-800 px-3">Reset</button>
                </div>
            </div>

            <div className="flex gap-2 mb-6 flex-wrap">{['registry', 'riskconfig', 'colors', 'legend', 'columns'].map(t => <button key={t} onClick={() => setSubTab(t)} className={`px-4 py-2 rounded font-medium capitalize text-sm ${subTab === t ? 'bg-cyan-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{t === 'columns' ? 'File Schema' : t === 'legend' ? 'Risk Legend' : t === 'colors' ? 'Color Scales' : t === 'riskconfig' ? 'Risk Builder' : t}</button>)}</div>

            {subTab === 'registry' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Boats ({settings.boats.length})</h3>
                        <div className="overflow-x-auto"><table className="data-table settings-table"><thead><tr><th style={{textAlign:'left'}}>Name</th><th style={{textAlign:'left'}}>Full Name</th><th>ISIC</th><th>TYCOM</th><th>NMCI</th><th>Actions</th></tr></thead><tbody>{settings.boats.map(b => <tr key={b.boat_name}><td className="boat-name">{b.boat_name}</td><td style={{textAlign:'left'}}>{b.boat_full_name}</td><td>{b.isic}</td><td>{b.tycom}</td><td className={b.nmci ? 'bg-blue-100 text-blue-700 font-semibold' : ''}>{b.nmci ? 'Yes' : 'No'}</td><td><button onClick={() => setEditingBoat(b)} className="text-cyan-600 mr-3">Edit</button><button onClick={() => deleteBoat(b.boat_name)} className="text-red-500">Delete</button></td></tr>)}</tbody></table></div>
                        <button onClick={() => setEditingBoat({ boat_name: '', boat_full_name: '', isic: settings.isics[0]?.isic_name || '', tycom: 'CSL', active: true, nmci: false, isNew: true })} className="btn-primary mt-4">+ Add Boat</button>
                    </div>
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-4 text-slate-700">ISICs ({settings.isics.length})</h3>
                        <table className="data-table settings-table"><thead><tr><th style={{textAlign:'left'}}>Name</th><th>Short</th><th>TYCOM</th><th>Actions</th></tr></thead><tbody>{settings.isics.map(i => <tr key={i.isic_name}><td style={{textAlign:'left'}}>{i.isic_name}</td><td>{i.isic_short}</td><td>{i.tycom}</td><td><button onClick={() => setEditingISIC(i)} className="text-cyan-600 mr-3">Edit</button><button onClick={() => deleteISIC(i.isic_name)} className="text-red-500">Delete</button></td></tr>)}</tbody></table>
                        <button onClick={() => setEditingISIC({ isic_name: '', isic_short: '', tycom: 'CSL', isNew: true })} className="btn-primary mt-4">+ Add ISIC</button>
                    </div>
                </div>
            )}

            {subTab === 'riskconfig' && (
                <div className="card p-4">
                    <h3 className="text-lg font-bold mb-2 text-slate-700">Risk Criteria Builder</h3>
                    <p className="text-sm text-slate-500 mb-4">Configure which criteria trigger each risk level. Toggle criteria on/off and adjust thresholds. Baseline: HIGH = Breakfix or No Scan, MED = 2+ conditions, LOW = all criteria met.</p>

                    <div className="grid grid-cols-3 gap-4">
                        {/* HIGH Risk Column */}
                        <div className="border-2 border-red-200 rounded-lg p-3 bg-red-50">
                            <h4 className="font-bold text-red-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-high">HIGH</span>
                                Auto-triggers HIGH
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.auto_high_ra_vph || 999) < 999} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_ra_vph: e.target.checked ? 5 : 999}}))} />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    {(settings.thresholds.auto_high_ra_vph || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" step="0.1" value={settings.thresholds.auto_high_ra_vph || 5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_ra_vph: parseFloat(e.target.value) || 5}}))} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_product_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_product_compliance: e.target.checked ? 50 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Raw Product Compliance</span>
                                    </div>
                                    {(settings.thresholds.high_product_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.high_product_compliance || 50} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_product_compliance: parseInt(e.target.value) || 50}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_ess_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_ess_compliance: e.target.checked ? 90 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.high_ess_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.high_ess_compliance || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_ess_compliance: parseInt(e.target.value) || 90}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_raw_policy_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_raw_policy_compliance: e.target.checked ? 90 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.high_raw_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.high_raw_policy_compliance || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_raw_policy_compliance: parseInt(e.target.value) || 90}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.auto_high_scan_age_days || 999) < 999} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_scan_age_days: e.target.checked ? 30 : 999}}))} />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    {(settings.thresholds.auto_high_scan_age_days || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.auto_high_scan_age_days || 30} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_scan_age_days: parseInt(e.target.value) || 30}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_tam_past_due || 999) < 999} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_tam_past_due: e.target.checked ? 20 : 999}}))} />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    {(settings.thresholds.high_tam_past_due || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.high_tam_past_due || 20} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_tam_past_due: parseInt(e.target.value) || 20}}))} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">No VRAM Scan Data</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Breakfix &gt; 0</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprBreakfix, essSiprBreakfix</div>
                                </div>
                            </div>
                        </div>

                        {/* MED Risk Column */}
                        <div className="border-2 border-amber-200 rounded-lg p-3 bg-amber-50">
                            <h4 className="font-bold text-amber-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-med">MED</span>
                                2+ triggers MED
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" step="0.1" value={settings.thresholds.med_ra_vph || 3.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_ra_vph: parseFloat(e.target.value) || 3.5}}))} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Raw Product Compliance</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.med_ess_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_ess_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.med_true_policy_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_true_policy_compliance: e.target.checked ? 95 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.med_true_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.med_true_policy_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_true_policy_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.med_raw_policy_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_raw_policy_compliance: e.target.checked ? 95 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.med_raw_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.med_raw_policy_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_raw_policy_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.med_scan_age_days || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_scan_age_days: parseInt(e.target.value) || 14}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.med_tam_past_due || 10} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_tam_past_due: parseInt(e.target.value) || 10}}))} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                            </div>
                            <div className="mt-3 p-2 bg-amber-100 rounded text-xs text-amber-700">
                                <strong>Note:</strong> If 2+ conditions are met, boat is MED risk.
                            </div>
                        </div>

                        {/* LOW Risk Column */}
                        <div className="border-2 border-green-200 rounded-lg p-3 bg-green-50">
                            <h4 className="font-bold text-green-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-low">LOW</span>
                                All criteria met
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" step="0.1" value={settings.thresholds.low_vph || 2.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_vph: parseFloat(e.target.value) || 2.5}}))} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Raw Product Compliance</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≥</span><input type="number" value={settings.thresholds.low_product_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_product_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.low_true_policy_compliance_enabled ?? 0) === 1} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_true_policy_compliance_enabled: e.target.checked ? 1 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.low_true_policy_compliance_enabled ?? 0) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≥</span><input type="number" value={settings.thresholds.low_true_policy_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_true_policy_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.low_raw_policy_compliance_enabled ?? 0) === 1} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_raw_policy_compliance_enabled: e.target.checked ? 1 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.low_raw_policy_compliance_enabled ?? 0) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≥</span><input type="number" value={settings.thresholds.low_raw_policy_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_raw_policy_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≤</span><input type="number" value={settings.thresholds.low_scan_age_days || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_scan_age_days: parseInt(e.target.value) || 14}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.low_tam_past_due_enabled ?? 0) === 1} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_tam_past_due_enabled: e.target.checked ? 1 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    {(settings.thresholds.low_tam_past_due_enabled ?? 0) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: ≤</span><input type="number" value={settings.thresholds.low_tam_past_due || 5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_tam_past_due: parseInt(e.target.value) || 5}}))} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">No Breakfix</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprBreakfix, essSiprBreakfix</div>
                                </div>
                            </div>
                            <div className="mt-3 p-2 bg-green-100 rounded text-xs text-green-700">
                                <strong>Note:</strong> Must meet ALL criteria to be LOW.
                            </div>
                        </div>
                    </div>

                    {/* Risk Equation Summary */}
                    <div className="mt-4 p-3 bg-slate-100 rounded border border-slate-300">
                        <h4 className="font-bold text-slate-700 mb-2 text-sm">Current Risk Equation</h4>
                        <div className="text-xs font-mono text-slate-600 space-y-1">
                            <div><span className="risk-high px-1 rounded">HIGH</span> = {generateDynamicLegend(settings.thresholds).high}</div>
                            <div><span className="risk-med px-1 rounded">MED</span> = {generateDynamicLegend(settings.thresholds).med}</div>
                            <div><span className="risk-low px-1 rounded">LOW</span> = {generateDynamicLegend(settings.thresholds).low}, No Breakfix</div>
                        </div>
                    </div>

                    <div className="mt-4 p-3 bg-slate-50 rounded border border-slate-200">
                        <h4 className="font-bold text-slate-700 mb-2">Scan Exempt Override</h4>
                        <p className="text-xs text-slate-500">When a boat is marked Scan Exempt, HIGH risk is downgraded to MED <strong>only if</strong> the sole reason for HIGH was "No VRAM Scan Data". Breakfix or other HIGH triggers are NOT affected. For NMCI boats, both NIPR and SIPR must be exempt.</p>
                    </div>

                    <div className="mt-4 flex gap-2">
                        <button onClick={() => setSettings(p => ({...p, thresholds: {...defaultThresholds, ...Object.fromEntries(Object.entries(p.thresholds).filter(([k]) => k.startsWith('color_')))}}))} className="btn-secondary text-sm">Reset to Defaults</button>
                    </div>
                </div>
            )}

            {subTab === 'colors' && (
                <div className="space-y-6">
                    {/* CSL/CSP Table Colors */}
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">CSL/CSP Table Color Scales</h3>
                        <p className="text-sm text-slate-500 mb-4">Color thresholds for CSL and CSP Summary tables.</p>

                        <div className="space-y-4">
                            {/* Product Compliance */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Product Compliance</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.color_product_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_product_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_product_red || 90}% to {settings.thresholds.color_product_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_product_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_product_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* True Policy Compliance */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">True Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.color_policy_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_policy_red || 90}% to {settings.thresholds.color_policy_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_policy_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* Raw Policy */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Raw Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.color_policy_raw_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_raw_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_policy_raw_red || 90}% to {settings.thresholds.color_policy_raw_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_policy_raw_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_raw_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* VPH */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">VPH</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" step="0.1" value={settings.thresholds.color_vph_green || 2.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_vph_green: parseFloat(e.target.value) || 2.5}}))} className="w-14 text-sm text-center" /></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_vph_green || 2.5} to {settings.thresholds.color_vph_red || 3.5}</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">≥</span><input type="number" step="0.1" value={settings.thresholds.color_vph_red || 3.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_vph_red: parseFloat(e.target.value) || 3.5}}))} className="w-14 text-sm text-center" /></div>
                            </div>

                            {/* Scan Age */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Scan Age</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≤</span><input type="number" value={settings.thresholds.color_scan_green || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_scan_green: parseFloat(e.target.value) || 14}}))} className="w-14 text-sm text-center" /> days</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_scan_green || 14}d to {settings.thresholds.color_scan_red || 14}d</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&gt;</span><input type="number" value={settings.thresholds.color_scan_red || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_scan_red: parseFloat(e.target.value) || 14}}))} className="w-14 text-sm text-center" /> days</div>
                            </div>

                            {/* Scan Integrity */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Scan Integrity</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.color_integrity_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_integrity_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_integrity_red || 90}% to {settings.thresholds.color_integrity_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_integrity_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_integrity_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* Percent Scanned */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Percent Scanned</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.color_scanned_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_scanned_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_scanned_red || 90}% to {settings.thresholds.color_scanned_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_scanned_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_scanned_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>
                        </div>

                        <div className="mt-4 flex gap-2">
                            <button onClick={() => setSettings(p => ({...p, thresholds: {...p.thresholds, color_product_green: 95, color_product_red: 90, color_policy_green: 95, color_policy_red: 90, color_policy_raw_green: 95, color_policy_raw_red: 90, color_vph_green: 2.5, color_vph_red: 3.5, color_scan_green: 14, color_scan_red: 14, color_integrity_green: 95, color_integrity_red: 90, color_scanned_green: 95, color_scanned_red: 90}}))} className="btn-secondary text-sm">Reset CSL/CSP to Defaults</button>
                        </div>
                    </div>

                    {/* HQ Status Table Colors */}
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">HQ Status Table Color Scales</h3>
                        <p className="text-sm text-slate-500 mb-4">Separate color thresholds for the HQ Status summary table.</p>

                        <div className="space-y-4">
                            {/* HQ Product Compliance */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Product Compliance</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.hq_color_product_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_product_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.hq_color_product_red || 90}% to {settings.thresholds.hq_color_product_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.hq_color_product_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_product_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* HQ True Policy */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">True Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.hq_color_policy_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.hq_color_policy_red || 90}% to {settings.thresholds.hq_color_policy_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.hq_color_policy_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* HQ Raw Policy */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Raw Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">≥</span><input type="number" value={settings.thresholds.hq_color_policy_raw_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_raw_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.hq_color_policy_raw_red || 90}% to {settings.thresholds.hq_color_policy_raw_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.hq_color_policy_raw_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_raw_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>
                        </div>

                        <div className="mt-4 flex gap-2">
                            <button onClick={() => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_product_green: 95, hq_color_product_red: 90, hq_color_policy_green: 95, hq_color_policy_red: 90, hq_color_policy_raw_green: 95, hq_color_policy_raw_red: 90}}))} className="btn-secondary text-sm">Reset HQ to Defaults</button>
                        </div>
                    </div>

                    <div className="p-3 bg-slate-50 rounded border border-slate-200">
                        <p className="text-xs text-slate-500"><strong>Note:</strong> Breakfix cells are always red when &gt; 0. Yellow is automatically calculated as the range between green and red thresholds.</p>
                    </div>
                </div>
            )}

            {subTab === 'legend' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">Risk Criteria Legend Text (Table)</h3>
                        <p className="text-sm text-slate-500 mb-4">Customize the legend text shown on CSL/CSP summary pages. Use <code className="bg-slate-100 px-1 rounded">{'{threshold_name}'}</code> to insert threshold values.</p>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-high">HIGH</span> Risk Criteria</label>
                                <textarea value={legend.high} onChange={(e) => updateLegend('high', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={2} placeholder="e.g., Breakfix > 0, Scan > {auto_high_scan_age_days}d" />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-med">MED</span> Risk Criteria</label>
                                <textarea value={legend.med} onChange={(e) => updateLegend('med', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={2} placeholder="e.g., Scan > {med_scan_age_days}d, VPH > {med_ra_vph}" />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-low">LOW</span> Risk Criteria</label>
                                <textarea value={legend.low} onChange={(e) => updateLegend('low', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={2} placeholder="e.g., No criteria met" />
                            </div>
                        </div>
                        <button onClick={() => setSettings(p => ({...p, legendText: JSON.parse(JSON.stringify(defaultLegendText))}))} className="btn-secondary mt-4 text-sm">Reset Table Legend</button>
                    </div>

                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">Help Modal Content (? Button)</h3>
                        <p className="text-sm text-slate-500 mb-4">The Risk Calculation Reference shown when clicking the ? button.</p>

                        <div className="flex items-center gap-3 mb-4 p-3 bg-slate-100 rounded border border-slate-200">
                            <label className="flex items-center cursor-pointer">
                                <input type="checkbox" checked={settings.useCustomHelpText || false} onChange={(e) => setSettings(p => ({...p, useCustomHelpText: e.target.checked}))} className="mr-2" />
                                <span className="text-sm font-medium text-slate-700">Use Custom Help Text</span>
                            </label>
                            <span className="text-xs text-slate-500">
                                {settings.useCustomHelpText ? '(Custom text below will be used - edit as needed)' : '(Auto-updates with threshold changes)'}
                            </span>
                        </div>

                        {settings.useCustomHelpText ? (
                        <div className="space-y-6">
                            <p className="text-sm text-slate-500 mb-2">Use <code className="bg-slate-100 px-1 rounded">{'{threshold_name}'}</code> to insert threshold values. Each item becomes a bullet point.</p>
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-high">HIGH</span> Risk Items</label>
                                {(helpModal.highItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('highItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., Breakfix > 0 - Any asset in breakfix" />
                                        <button onClick={() => removeHelpModalItem('highItems', i)} className="text-red-500 hover:text-red-700 px-2">×</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('highItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-med">MED</span> Risk Items (2+ triggers MED)</label>
                                {(helpModal.medItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('medItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., VPH > {med_ra_vph} - Vulnerabilities per host" />
                                        <button onClick={() => removeHelpModalItem('medItems', i)} className="text-red-500 hover:text-red-700 px-2">×</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('medItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-low">LOW</span> Risk Items</label>
                                {(helpModal.lowItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('lowItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., VPH < {low_vph} - Low vulnerabilities" />
                                        <button onClick={() => removeHelpModalItem('lowItems', i)} className="text-red-500 hover:text-red-700 px-2">×</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('lowItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Key Calculations</label>
                                {(helpModal.calcItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('calcItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., VPH = Vulnerabilities Per Host" />
                                        <button onClick={() => removeHelpModalItem('calcItems', i)} className="text-red-500 hover:text-red-700 px-2">×</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('calcItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Scan Exempt Explanation</label>
                                <textarea value={helpModal.scanExempt || ''} onChange={(e) => updateHelpModal('scanExempt', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={3} placeholder="Explain when Scan Exempt applies..." />
                            </div>
                            <button onClick={() => setSettings(p => ({...p, helpModalText: JSON.parse(JSON.stringify(defaultHelpModalText))}))} className="btn-secondary mt-4 text-sm">Reset to Default Text</button>
                        </div>
                        ) : (
                        <div className="space-y-4">
                            <p className="text-sm text-slate-500 mb-2">Preview of auto-generated help content based on current thresholds:</p>
                            {(() => {
                                const preview = generateDynamicHelpModal(settings.thresholds);
                                return (
                                    <div className="text-sm space-y-3 bg-slate-50 p-4 rounded border border-slate-200">
                                        <div><span className="font-semibold text-red-600">HIGH:</span> <span className="text-slate-600">{preview.highItems.length} items</span>
                                            <ul className="list-disc ml-5 text-xs text-slate-500 mt-1">{preview.highItems.slice(0,3).map((item, i) => <li key={i}>{item}</li>)}{preview.highItems.length > 3 && <li>...and {preview.highItems.length - 3} more</li>}</ul>
                                        </div>
                                        <div><span className="font-semibold text-amber-600">MED:</span> <span className="text-slate-600">{preview.medItems.length} items</span>
                                            <ul className="list-disc ml-5 text-xs text-slate-500 mt-1">{preview.medItems.slice(0,3).map((item, i) => <li key={i}>{item}</li>)}{preview.medItems.length > 3 && <li>...and {preview.medItems.length - 3} more</li>}</ul>
                                        </div>
                                        <div><span className="font-semibold text-green-600">LOW:</span> <span className="text-slate-600">{preview.lowItems.length} items</span>
                                            <ul className="list-disc ml-5 text-xs text-slate-500 mt-1">{preview.lowItems.slice(0,3).map((item, i) => <li key={i}>{item}</li>)}{preview.lowItems.length > 3 && <li>...and {preview.lowItems.length - 3} more</li>}</ul>
                                        </div>
                                    </div>
                                );
                            })()}
                            <p className="text-xs text-slate-400 italic">Enable "Use Custom Help Text" above to customize these items.</p>
                        </div>
                        )}
                    </div>

                    <div className="card p-4">
                        <h4 className="text-sm font-semibold text-slate-600 mb-2">Available Threshold Variables:</h4>
                        <div className="text-xs text-slate-500 font-mono flex flex-wrap gap-2">
                            {Object.keys(settings.thresholds).map(k => <span key={k} className="bg-slate-200 px-2 py-1 rounded">{`{${k}}`}</span>)}
                        </div>
                    </div>
                </div>
            )}

            {subTab === 'columns' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">Excel/ODS Schema Configuration</h3>
                        <p className="text-sm text-slate-500 mb-4">Configure fields to extract from each file type. <strong>Header Text</strong> appears on preview and generated reports. <strong>Excel Column</strong> must match the column header in your source files. Drag to reorder columns, toggle visibility.</p>
                        {['vram', 'ess', 'tam'].map(type => (
                            <div key={type} className="mb-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className={`font-bold ${schemaTypeColors[type]}`}>{schemaTypeLabels[type]}</h4>
                                    <button onClick={() => setNewFieldModal({ type, field: '', label: '', column: '' })} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Field</button>
                                </div>
                                <div className="border border-slate-200 rounded">
                                    <div className="grid grid-cols-12 gap-2 p-2 bg-slate-100 text-xs font-semibold text-slate-600 border-b">
                                        <div className="col-span-1"></div>
                                        <div className="col-span-1">Show</div>
                                        <div className="col-span-3">Header Text (Report)</div>
                                        <div className="col-span-3">Field ID</div>
                                        <div className="col-span-3">Excel Column (Source)</div>
                                        <div className="col-span-1"></div>
                                    </div>
                                    {(schema[type] || []).map((item, idx) => (
                                        <div key={item.field + idx} className="grid grid-cols-12 gap-2 p-2 items-center border-b border-slate-100 hover:bg-slate-50"
                                            draggable onDragStart={(e) => e.dataTransfer.setData('schemaIdx', JSON.stringify({type, idx}))}
                                            onDragOver={(e) => e.preventDefault()}
                                            onDrop={(e) => { e.preventDefault(); const from = JSON.parse(e.dataTransfer.getData('schemaIdx')); if (from.type === type) reorderSchema(type, from.idx, idx); }}>
                                            <div className="col-span-1 cursor-move text-slate-400" title="Drag to reorder">&#9776;</div>
                                            <div className="col-span-1"><input type="checkbox" checked={item.visible !== false} onChange={(e) => updateSchemaField(type, idx, { visible: e.target.checked })} /></div>
                                            <div className="col-span-3"><input value={item.label} onChange={(e) => updateSchemaField(type, idx, { label: e.target.value })} className="w-full text-sm p-1" /></div>
                                            <div className="col-span-3"><input value={item.field} onChange={(e) => updateSchemaField(type, idx, { field: e.target.value })} className="w-full text-sm p-1 font-mono text-xs" /></div>
                                            <div className="col-span-3"><input value={item.column} onChange={(e) => updateSchemaField(type, idx, { column: e.target.value })} className="w-full text-sm p-1" placeholder="Excel column header" /></div>
                                            <div className="col-span-1"><button onClick={() => removeSchemaField(type, idx)} className="text-red-500 hover:text-red-700 text-sm" title="Remove field">✕</button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {newFieldModal && (
                <div className="modal-overlay" onClick={() => setNewFieldModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Add New Field to {schemaTypeLabels[newFieldModal.type]}</h3>
                        <div className="space-y-3">
                            <div><label className="block text-sm text-slate-500 mb-1">Field ID (camelCase)</label><input value={newFieldModal.field} onChange={(e) => setNewFieldModal({...newFieldModal, field: e.target.value})} className="w-full font-mono" placeholder="e.g. customField" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Display Label</label><input value={newFieldModal.label} onChange={(e) => setNewFieldModal({...newFieldModal, label: e.target.value})} className="w-full" placeholder="e.g. Custom Field Name" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Excel Column Header</label><input value={newFieldModal.column} onChange={(e) => setNewFieldModal({...newFieldModal, column: e.target.value})} className="w-full" placeholder="Exact column name in Excel" /></div>
                        </div>
                        <div className="flex gap-2 mt-6">
                            <button onClick={() => { if (newFieldModal.field && newFieldModal.column) { addSchemaField(newFieldModal.type, newFieldModal.field, newFieldModal.label || newFieldModal.field, newFieldModal.column); setNewFieldModal(null); } }} className="btn-primary">Add Field</button>
                            <button onClick={() => setNewFieldModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {editingBoat && (
                <div className="modal-overlay" onClick={() => setEditingBoat(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">{editingBoat.isNew ? 'Add Boat' : 'Edit Boat'}</h3>
                        <div className="space-y-4">
                            <div><label className="block text-sm text-slate-500 mb-1">Boat Name (e.g. SSN-21)</label><input value={editingBoat.boat_name} onChange={(e) => setEditingBoat({...editingBoat, boat_name: e.target.value})} className="w-full" disabled={!editingBoat.isNew} /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Full Name</label><input value={editingBoat.boat_full_name} onChange={(e) => setEditingBoat({...editingBoat, boat_full_name: e.target.value})} className="w-full" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">ISIC</label><select value={editingBoat.isic} onChange={(e) => setEditingBoat({...editingBoat, isic: e.target.value})} className="w-full">{settings.isics.map(i => <option key={i.isic_name} value={i.isic_name}>{i.isic_name}</option>)}</select></div>
                            <div className="flex items-center gap-2 mt-2 p-3 bg-blue-50 rounded border border-blue-200">
                                <input type="checkbox" id="nmci-checkbox" checked={editingBoat.nmci || false} onChange={(e) => setEditingBoat({...editingBoat, nmci: e.target.checked})} />
                                <label htmlFor="nmci-checkbox" className="text-sm font-medium text-blue-800">NMCI Network (NIPR)</label>
                                <span className="text-xs text-blue-600 ml-2">Check if this boat uses NMCI for their NIPR network to ignore their NIPR VRAM scores for risk calculation</span>
                            </div>
                        </div>
                        <div className="flex gap-2 mt-6"><button onClick={saveBoat} className="btn-primary">Save</button><button onClick={() => setEditingBoat(null)} className="btn-secondary">Cancel</button></div>
                    </div>
                </div>
            )}

            {editingISIC && (
                <div className="modal-overlay" onClick={() => setEditingISIC(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">{editingISIC.isNew ? 'Add ISIC' : 'Edit ISIC'}</h3>
                        <div className="space-y-4">
                            <div><label className="block text-sm text-slate-500 mb-1">ISIC Name (e.g. COMSUBRON 1)</label><input value={editingISIC.isic_name} onChange={(e) => setEditingISIC({...editingISIC, isic_name: e.target.value})} className="w-full" disabled={!editingISIC.isNew} /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Short Name (e.g. CSS1)</label><input value={editingISIC.isic_short} onChange={(e) => setEditingISIC({...editingISIC, isic_short: e.target.value})} className="w-full" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">TYCOM</label><select value={editingISIC.tycom} onChange={(e) => setEditingISIC({...editingISIC, tycom: e.target.value})} className="w-full">{(settings.tycoms || ['CSL', 'CSP']).map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                        </div>
                        <div className="flex gap-2 mt-6"><button onClick={saveISIC} className="btn-primary">Save</button><button onClick={() => setEditingISIC(null)} className="btn-secondary">Cancel</button></div>
                    </div>
                </div>
            )}

            {showAuthorPrompt && (
                <div className="modal-overlay" onClick={() => setShowAuthorPrompt(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Enter Your Name</h3>
                        <p className="text-sm text-slate-500 mb-4">Your name will be recorded with this settings version for tracking purposes.</p>
                        <input value={authorName} onChange={(e) => setAuthorName(e.target.value)} placeholder="Your name" className="w-full mb-4" autoFocus onKeyDown={(e) => e.key === 'Enter' && saveAuthorAndSettings()} />
                        <div className="flex gap-2">
                            <button onClick={saveAuthorAndSettings} className="btn-primary" disabled={!authorName.trim()}>Save Settings</button>
                            <button onClick={() => setShowAuthorPrompt(false)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

        </div>
    );
};

// Name Prompt Modal
const NamePromptModal = ({ onSubmit, onCancel }) => {
    const [name, setName] = React.useState('');
    return (
        <div className="modal-overlay" onClick={onCancel}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-bold mb-4 text-slate-700">Enter Your Name</h3>
                <p className="text-sm text-slate-500 mb-4">This will be recorded in the report for attribution.</p>
                <input value={name} onChange={(e) => setName(e.target.value)} placeholder="Your name" className="w-full mb-4" autoFocus onKeyDown={(e) => e.key === 'Enter' && onSubmit(name)} />
                <div className="flex gap-2">
                    <button onClick={() => onSubmit(name)} className="btn-primary">Continue</button>
                    <button onClick={onCancel} className="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    );
};

// First Time Setup Modal
const FirstTimeSetupModal = ({ onImportSettings, onImportReport, onDismiss }) => {
    const [isDragging, setIsDragging] = React.useState(false);

    const handleDrop = async (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer?.files?.[0];
        if (file) {
            if (file.name.endsWith('.html')) {
                onImportReport(file);
            } else if (file.name.endsWith('.json')) {
                try {
                    const text = await file.text();
                    const settings = JSON.parse(text);
                    onImportSettings(settings);
                } catch (err) {
                    alert('Failed to parse settings file: ' + err.message);
                }
            } else {
                alert('Please drop a .html report file or a .json settings file');
            }
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '550px' }} onClick={(e) => e.stopPropagation()}>
                <h3 className="text-xl font-bold mb-2 text-slate-800">Welcome to Cyber Dashboard</h3>
                <p className="text-sm text-slate-600 mb-6">No settings configured yet. Import your settings to get started.</p>

                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <div className="flex items-start gap-3">
                        <span className="text-amber-500 text-lg">⚠</span>
                        <div className="text-sm text-amber-800">
                            <strong>Important:</strong> Once imported, your settings are saved in this browser's local storage. They will persist until you clear your browser cache/data, use a different browser, or use incognito/private mode.
                        </div>
                    </div>
                </div>

                <div
                    className={`drag-zone p-8 text-center mb-4 ${isDragging ? 'drag-active' : ''}`}
                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                    onDragLeave={() => setIsDragging(false)}
                    onDrop={handleDrop}
                >
                    <div className="text-4xl mb-3">📂</div>
                    <p className="text-slate-600 font-medium mb-2">Drop a file here to import settings</p>
                    <p className="text-sm text-slate-500">
                        Drop a previously generated <strong>report.html</strong> (settings will be extracted and saved)<br/>
                        or drop a <strong>settings.json</strong> file (will be saved automatically)
                    </p>
                </div>

                <div className="flex items-center gap-3 mb-4">
                    <div className="flex-1 border-t border-slate-200"></div>
                    <span className="text-sm text-slate-400">or</span>
                    <div className="flex-1 border-t border-slate-200"></div>
                </div>

                <div className="flex gap-3 justify-center">
                    <button onClick={onImportSettings} className="btn-primary">
                        Import settings.json
                    </button>
                    <button onClick={onDismiss} className="btn-secondary">
                        Start Fresh
                    </button>
                </div>

                <p className="text-xs text-slate-400 mt-4 text-center">
                    Starting fresh? You can configure boats, ISICs, and thresholds in the Settings tab.
                </p>
            </div>
        </div>
    );
};

// Main App
function App() {
    const [settings, setSettings] = React.useState(() => SettingsManager.load());
    const [currentTab, setCurrentTab] = React.useState('import');
    const [importedFiles, setImportedFiles] = React.useState({ vramNipr: null, vramSipr: null, essNipr: null, essSipr: null, tam: null });
    const [reportData, setReportData] = React.useState(null);
    const [alerts, setAlerts] = React.useState([]);
    const [namePrompt, setNamePrompt] = React.useState(null);
    const [isUsingImportedSettings, setIsUsingImportedSettings] = React.useState(false);
    const [showFirstTimeSetup, setShowFirstTimeSetup] = React.useState(false);

    // Check if settings are blank on first load (no boats and no ISICs configured)
    React.useEffect(() => {
        const isBlank = !settings.boats?.length && !settings.isics?.length;
        const hasStoredSettings = SettingsManager.hasSavedSettings();
        if (isBlank && !hasStoredSettings) {
            setShowFirstTimeSetup(true);
        }
    }, []);

    // Recalculate risk levels when thresholds change
    React.useEffect(() => {
        if (reportData && reportData.boats?.length > 0) {
            const updatedBoats = reportData.boats.map(b => {
                const { level, reasons } = calculateRisk(b, settings.thresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            // Only update if risk levels actually changed
            const hasChanges = updatedBoats.some((b, i) => b.riskLevel !== reportData.boats[i].riskLevel);
            if (hasChanges) {
                setReportData(prev => ({ ...prev, boats: updatedBoats }));
            }
        }
    }, [JSON.stringify(settings.thresholds)]);

    const handleReportImport = async (file, fromSetup = false) => {
        const result = await importReportHTML(file);
        if (result.error) { setAlerts([{ type: 'error', msg: result.error }]); }
        else {
            // Always ensure defaults to clean up obsolete keys and add missing ones
            const cleanedSettings = SettingsManager.ensureDefaults(result.settings);
            if (fromSetup) {
                // From first-time setup: save settings to localStorage permanently
                SettingsManager.save(cleanedSettings);
                setSettings(cleanedSettings);
                setShowFirstTimeSetup(false);
                setAlerts([{ type: 'info', msg: `✓ Settings saved! Extracted from report: ${cleanedSettings.boats?.length || 0} boats, ${cleanedSettings.isics?.length || 0} ISICs` }]);
            } else {
                // Normal import: use for session only
                setIsUsingImportedSettings(true);
                setSettings(cleanedSettings);
                setReportData(result.reportData);
                setCurrentTab('preview');
                setAlerts([{ type: 'info', msg: `Loaded report v${result.reportData.version} with ${result.reportData.boats.length} boats` }]);
                if (!result.valid) setAlerts(p => [...p, { type: 'warning', msg: 'Report hash invalid - data may have been modified' }]);
            }
        }
    };

    const handleFirstTimeImportSettings = async (settingsOrNull) => {
        if (settingsOrNull) {
            // Settings object passed directly from drag/drop
            const imported = SettingsManager.ensureDefaults(settingsOrNull);
            SettingsManager.save(imported);
            setSettings(imported);
            setShowFirstTimeSetup(false);
            setAlerts([{ type: 'info', msg: `✓ Settings saved! ${imported.boats?.length || 0} boats, ${imported.isics?.length || 0} ISICs configured` }]);
        } else {
            // Open file picker
            const result = await SettingsManager.importSettings();
            if (result.success) {
                SettingsManager.save(result.settings);
                setSettings(result.settings);
                setShowFirstTimeSetup(false);
                setAlerts([{ type: 'info', msg: `✓ Settings saved! ${result.settings.boats?.length || 0} boats, ${result.settings.isics?.length || 0} ISICs configured` }]);
            }
        }
    };

    const handleGlobalDrop = async (e) => {
        e.preventDefault();
        const file = e.dataTransfer?.files?.[0];
        if (!file) return;

        if (file.name.endsWith('.json')) {
            // JSON file: import settings only
            try {
                const text = await file.text();
                const settings = JSON.parse(text);
                const imported = SettingsManager.ensureDefaults(settings);
                SettingsManager.save(imported);
                setSettings(imported);
                setAlerts([{ type: 'info', msg: `✓ Settings saved! ${imported.boats?.length || 0} boats, ${imported.isics?.length || 0} ISICs configured` }]);
            } catch (err) {
                setAlerts([{ type: 'error', msg: 'Failed to parse settings file: ' + err.message }]);
            }
        } else if (file.name.endsWith('.html')) {
            // HTML report: extract and save settings only (discard report data)
            const result = await importReportHTML(file);
            if (result.error) {
                setAlerts([{ type: 'error', msg: result.error }]);
            } else {
                SettingsManager.save(result.settings);
                setSettings(result.settings);
                setAlerts([{ type: 'info', msg: `✓ Settings saved! Extracted from report: ${result.settings.boats?.length || 0} boats, ${result.settings.isics?.length || 0} ISICs` }]);
            }
        }
    };

    const requestName = (callback) => {
        setNamePrompt({ callback });
    };

    const handleNameSubmit = (name) => {
        if (namePrompt?.callback) namePrompt.callback(name);
        setNamePrompt(null);
    };

    return (
        <div className="min-h-screen" onDragOver={(e) => e.preventDefault()} onDrop={handleGlobalDrop}>
            <header className="bg-white border-b border-slate-200 px-6 py-4">
                <div className="flex justify-between items-center max-w-[95vw] mx-auto">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg flex items-center justify-center bg-white border border-slate-200"><img src="sublan.png" alt="Logo" className="w-8 h-8 object-contain" /></div>
                        <div><h1 className="text-xl font-bold text-slate-800">SUBFOR Cyber Risk Dashboard</h1><p className="text-xs text-slate-500">Compliments of COMSUBLANT</p></div>
                    </div>
                </div>
            </header>

            {alerts.length > 0 && <div className="max-w-[95vw] mx-auto px-6 pt-4">{alerts.map((a, i) => <div key={i} className={`p-3 rounded mb-2 flex justify-between items-center ${a.type === 'error' ? 'bg-red-100 text-red-700' : a.type === 'warning' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}><span>{a.msg}</span><button onClick={() => setAlerts(alerts.filter((_, j) => j !== i))} className="text-current opacity-50 hover:opacity-100">×</button></div>)}</div>}

            <nav className="border-b border-slate-200 px-6 bg-white"><div className="flex gap-1 max-w-[95vw] mx-auto">{['import', 'preview', 'settings'].map(tab => <button key={tab} onClick={() => setCurrentTab(tab)} className={`tab-btn ${currentTab === tab ? 'active' : ''}`}>{tab.charAt(0).toUpperCase() + tab.slice(1)}</button>)}</div></nav>

            <main className="max-w-[95vw] mx-auto p-6">
                {currentTab === 'import' && <ImportTab importedFiles={importedFiles} setImportedFiles={setImportedFiles} settings={settings} setSettings={setSettings} reportData={reportData} onProcess={(d) => { setReportData(d); setCurrentTab('preview'); }} onAlert={(a) => setAlerts(p => [...p, a])} onReportImport={handleReportImport} />}
                {currentTab === 'preview' && <PreviewTab reportData={reportData} setReportData={setReportData} settings={settings} setSettings={setSettings} onRequestName={requestName} />}
                {currentTab === 'settings' && <SettingsTab settings={settings} setSettings={setSettings} onAlert={(a) => setAlerts(p => [...p, a])} isUsingImportedSettings={isUsingImportedSettings} onSaveToMySettings={() => setIsUsingImportedSettings(false)} />}
            </main>

            <footer className="text-center py-6 text-slate-400 text-sm">SUBFOR Cyber Risk Dashboard v1.0</footer>

            {namePrompt && <NamePromptModal onSubmit={handleNameSubmit} onCancel={() => setNamePrompt(null)} />}

            {showFirstTimeSetup && (
                <FirstTimeSetupModal
                    onImportSettings={handleFirstTimeImportSettings}
                    onImportReport={(file) => handleReportImport(file, true)}
                    onDismiss={() => setShowFirstTimeSetup(false)}
                />
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
