<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Dashboard Generator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap');
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; min-height: 100vh; color: #1e293b; margin: 0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #e2e8f0; } ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .drag-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; background: #ffffff; border-radius: 8px; }
        .drag-zone:hover, .drag-zone.drag-active { border-color: #0891b2; background: #ecfeff; }
        .drag-zone.has-file { border-color: #10b981; background: #ecfdf5; }
        .risk-high { background: #fee2e2; color: #991b1b; font-weight: bold; }
        .risk-med { background: #fef3c7; color: #92400e; font-weight: bold; }
        .risk-low { background: #d1fae5; color: #065f46; }
        .alert-red { background: #fee2e2; } .alert-amber { background: #fef3c7; } .alert-blue { background: #dbeafe; }
        .tab-btn { position: relative; padding: 12px 24px; font-weight: 500; color: #64748b; transition: all 0.2s; background: none; border: none; cursor: pointer; }
        .tab-btn:hover { color: #0f172a; } .tab-btn.active { color: #0891b2; } .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #0891b2; }
        .btn-primary { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(8,145,178,0.3); } .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #475569; padding: 10px 20px; border-radius: 6px; font-weight: 500; border: none; cursor: pointer; } .btn-secondary:hover { background: #cbd5e1; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; }
        .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .data-table th { background: #f1f5f9; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 8px; letter-spacing: 0.3px; padding: 6px 3px; text-align: center; border: 1px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 4px 3px; text-align: center; border: 1px solid #e2e8f0; background: #ffffff; white-space: nowrap; }
        .table-scroll { overflow-x: auto; }
        .data-table td.boat-name { text-align: left; font-weight: 600; font-family: 'JetBrains Mono', monospace; color: #0891b2; }
        .col-ess-n { background: rgba(59,130,246,0.1) !important; } .col-ess-s { background: rgba(99,102,241,0.1) !important; }
        .col-vram-n { background: rgba(249,115,22,0.1) !important; } .col-vram-s { background: rgba(234,88,12,0.1) !important; }
        .col-ra { background: rgba(168,85,247,0.1) !important; } .col-tam { background: rgba(107,114,128,0.1) !important; } .col-status { background: rgba(16,185,129,0.1) !important; }
        input, select { background: #ffffff; border: 1px solid #cbd5e1; color: #1e293b; padding: 8px 12px; border-radius: 4px; }
        input:focus, select:focus { outline: none; border-color: #0891b2; box-shadow: 0 0 0 3px rgba(8,145,178,0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .overridden { box-shadow: inset 0 0 0 2px #7c3aed; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
<div id="root"></div>

<script type="application/json" id="app-settings">
{
    "_version": 1,
    "tycoms": ["CSL", "CSP"],
    "isics": [
        {"isic_name": "COMSUBDEVRON 5", "isic_short": "CSDS5", "tycom": "CSL", "active": true},
        {"isic_name": "COMSUBRON 4", "isic_short": "CSS4", "tycom": "CSL", "active": true},
        {"isic_name": "COMSUBRON 6", "isic_short": "CSS6", "tycom": "CSL", "active": true},
        {"isic_name": "COMSUBRON 8", "isic_short": "CSS8", "tycom": "CSL", "active": true},
        {"isic_name": "COMSUBRON 17", "isic_short": "CSS17", "tycom": "CSP", "active": true},
        {"isic_name": "COMSUBRON 19", "isic_short": "CSS19", "tycom": "CSP", "active": true},
        {"isic_name": "COMSUBRON 20", "isic_short": "CSS20", "tycom": "CSP", "active": true}
    ],
    "boats": [],
    "thresholds": {
        "auto_high_scan_age_days": 90,
        "auto_high_scan_integrity": 80,
        "auto_high_scan_percent": 80,
        "auto_high_ra_vph": 10,
        "auto_high_ra_crit": 50,
        "high_scan_age_days": 60,
        "high_scan_integrity": 90,
        "high_ra_vph": 5,
        "high_ra_crit": 20,
        "high_ess_compliance": 85,
        "high_tam_past_due": 5,
        "med_scan_age_days": 30,
        "med_ra_vph": 2.5,
        "med_ess_compliance": 95,
        "med_tam_past_due": 1
    },
    "display": {
        "color_scan_age_amber_days": 30,
        "color_scan_age_red_days": 90,
        "color_ra_vph_amber": 2.5,
        "color_ra_vph_red": 5,
        "color_scan_quality_red": 98
    },
    "user": {"default_name": ""},
    "schemaConfig": {
        "vram": [
            {"field": "siteName", "label": "Site/Boat Name", "column": "Site Name", "visible": true},
            {"field": "scanDate", "label": "Last Scan Date", "column": "Last Scan Date", "visible": true},
            {"field": "assets", "label": "Asset Count", "column": "Valid Assets", "visible": true},
            {"field": "raVph", "label": "RA VPH", "column": "RA VPH", "visible": true},
            {"field": "scanIntegrity", "label": "Scan Integrity %", "column": "Scan Integrity", "visible": true},
            {"field": "scanPercent", "label": "Percent Scanned", "column": "Percent Scanned", "visible": true},
            {"field": "raCrit", "label": "RA Critical", "column": "RA Crit", "visible": true},
            {"field": "raHigh", "label": "RA High", "column": "RA High", "visible": true},
            {"field": "scanExempt", "label": "Scan Exempt", "column": "Scan Exempt", "visible": true}
        ],
        "ess": [
            {"field": "shipName", "label": "Ship/Boat Name", "column": "Ships", "visible": true},
            {"field": "isic", "label": "ISIC Column", "column": "ISICs", "visible": true},
            {"field": "productCompliance", "label": "Product Compliance %", "column": "Product Compliance", "visible": true},
            {"field": "policyEnforced", "label": "Policy Enforced %", "column": "Policy Enforced", "visible": true},
            {"field": "breakfix", "label": "Breakfix Count", "column": "Assets in Breakfix", "visible": true},
            {"field": "assets", "label": "Asset Count", "column": "Asset Count", "visible": true}
        ],
        "tam": [
            {"field": "boatName", "label": "Boat Name", "column": "Boat", "visible": true},
            {"field": "pastDue", "label": "Past Due Count", "column": "# Past Due", "visible": true},
            {"field": "extensions", "label": "Extensions Count", "column": "# Extensions", "visible": true}
        ]
    },
    "tabConfig": [
        {"id": "csl", "label": "CSL Summary", "visible": true},
        {"id": "csp", "label": "CSP Summary", "visible": true},
        {"id": "hq", "label": "HQ Status", "visible": true},
        {"id": "analytics", "label": "Analytics", "visible": true},
        {"id": "changelog", "label": "Changes", "visible": true}
    ]
}
</script>

<script type="text/babel">
// Utilities
const normalizeBoatName = (name) => { if (!name) return ''; const upper = name.toUpperCase().trim(); const match = upper.match(/\b(SSN|SSBN|SSGN)\s*[-]?\s*(\d+)\b/); return match ? `${match[1]}-${match[2]}` : upper; };
const parseNumber = (val) => { if (val === null || val === undefined || val === '') return null; if (typeof val === 'number') return val; const num = parseFloat(String(val).replace(/[%,]/g, '')); return isNaN(num) ? null : num; };
const parsePercent = (val) => { if (val === null || val === undefined || val === '') return null; const num = parseFloat(String(val).replace('%', '')); return isNaN(num) ? null : num; };

// Default schema configuration - defines fields to extract from each file type
const defaultSchemaConfig = {
    vram: [
        {field: 'siteName', label: 'Site/Boat Name', column: 'Site Name', visible: true},
        {field: 'scanDate', label: 'Last Scan Date', column: 'Last Scan Date', visible: true},
        {field: 'assets', label: 'Asset Count', column: 'Valid Assets', visible: true},
        {field: 'raVph', label: 'RA VPH', column: 'RA VPH', visible: true},
        {field: 'scanIntegrity', label: 'Scan Integrity %', column: 'Scan Integrity', visible: true},
        {field: 'scanPercent', label: 'Percent Scanned', column: 'Percent Scanned', visible: true},
        {field: 'raCrit', label: 'RA Critical', column: 'RA Crit', visible: true},
        {field: 'raHigh', label: 'RA High', column: 'RA High', visible: true},
        {field: 'scanExempt', label: 'Scan Exempt', column: 'Scan Exempt', visible: true}
    ],
    ess: [
        {field: 'shipName', label: 'Ship/Boat Name', column: 'Ships', visible: true},
        {field: 'isic', label: 'ISIC Column', column: 'ISICs', visible: true},
        {field: 'productCompliance', label: 'Product Compliance %', column: 'Product Compliance', visible: true},
        {field: 'policyEnforced', label: 'Policy Enforced %', column: 'Policy Enforced', visible: true},
        {field: 'breakfix', label: 'Breakfix Count', column: 'Assets in Breakfix', visible: true},
        {field: 'assets', label: 'Asset Count', column: 'Asset Count', visible: true}
    ],
    tam: [
        {field: 'boatName', label: 'Boat Name', column: 'Boat', visible: true},
        {field: 'pastDue', label: 'Past Due Count', column: '# Past Due', visible: true},
        {field: 'extensions', label: 'Extensions Count', column: '# Extensions', visible: true}
    ]
};

// Build column map from schema config (field -> column name)
const buildColumnMap = (schemaArr) => {
    const map = {};
    for (const item of schemaArr) {
        if (item.visible !== false) map[item.field] = item.column;
    }
    return map;
};

// Settings Manager
const SettingsManager = {
    load() {
        try {
            const settings = JSON.parse(document.getElementById('app-settings').textContent);
            // Migrate old columnMappings to new schemaConfig format
            if (settings.columnMappings && !settings.schemaConfig) {
                settings.schemaConfig = this.migrateColumnMappings(settings.columnMappings);
                delete settings.columnMappings;
            }
            // Ensure schemaConfig exists with defaults
            if (!settings.schemaConfig) settings.schemaConfig = JSON.parse(JSON.stringify(defaultSchemaConfig));
            // Ensure tabConfig exists with defaults
            if (!settings.tabConfig) settings.tabConfig = [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}];
            return settings;
        } catch { return this.getDefaults(); }
    },
    migrateColumnMappings(old) {
        // Convert old array-based columnMappings to new schemaConfig format
        const labels = {
            vram: {siteName:'Site/Boat Name',scanDate:'Last Scan Date',assets:'Asset Count',raVph:'RA VPH',scanIntegrity:'Scan Integrity %',scanPercent:'Percent Scanned',raCrit:'RA Critical',raHigh:'RA High',scanExempt:'Scan Exempt'},
            ess: {shipName:'Ship/Boat Name',isic:'ISIC Column',productCompliance:'Product Compliance %',policyEnforced:'Policy Enforced %',breakfix:'Breakfix Count',assets:'Asset Count'},
            tam: {boatName:'Boat Name',pastDue:'Past Due Count',extensions:'Extensions Count'}
        };
        const result = {};
        for (const type of ['vram', 'ess', 'tam']) {
            result[type] = [];
            if (old[type]) {
                for (const [field, vals] of Object.entries(old[type])) {
                    const col = Array.isArray(vals) ? vals[0] : vals;
                    result[type].push({field, label: labels[type]?.[field] || field, column: col || '', visible: true});
                }
            }
        }
        return result;
    },
    getDefaults() { return { _version: 1, tycoms: ['CSL', 'CSP'], isics: [], boats: [], thresholds: {}, display: {}, user: { default_name: '' }, schemaConfig: JSON.parse(JSON.stringify(defaultSchemaConfig)), tabConfig: [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}] }; },
    saveApplication(settings) {
        const html = document.documentElement.outerHTML;
        const updated = '<!DOCTYPE html>\n' + html.replace(/(<script type="application\/json" id="app-settings">)([\s\S]*?)(<\/script>)/, `$1\n${JSON.stringify(settings, null, 4)}\n$3`);
        const blob = new Blob([updated], { type: 'text/html' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cyber-dashboard.html'; a.click();
    }
};

// Data Models
const createBoatData = (name, fullName, isic, tycom) => ({
    boatName: name, boatFullName: fullName, isic, tycom,
    essNiprAssets: null, essNiprBreakfix: null, essNiprProductCompliance: null, essNiprTruePolicy: null,
    essSiprAssets: null, essSiprBreakfix: null, essSiprProductCompliance: null, essSiprTruePolicy: null,
    vramNiprAssets: null, vramNiprScanDate: null, vramNiprRaVph: null, vramNiprScanIntegrity: null, vramNiprScanPercent: null, vramNiprRaCrit: null, vramNiprRaHigh: null, vramNiprScanExempt: false,
    vramSiprAssets: null, vramSiprScanDate: null, vramSiprRaVph: null, vramSiprScanIntegrity: null, vramSiprScanPercent: null, vramSiprRaCrit: null, vramSiprRaHigh: null, vramSiprScanExempt: false,
    tamPastDue: null, tamExtensions: null, riskLevel: 'LOW', riskReasons: [], overrides: [], notes: ''
});

// Parsers - use schema config from settings to build column maps
const parseVRAM = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.vram);
    const wb = XLSX.read(data, { type: 'array', cellDates: true }); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); const parsed = {};
    for (const row of rows) {
        const site = row[m.siteName]; if (!site) continue;
        const name = normalizeBoatName(site); if (!name) continue;
        let scanDate = null; const rawDate = row[m.scanDate];
        if (rawDate) { scanDate = rawDate instanceof Date ? rawDate : new Date(rawDate); if (isNaN(scanDate)) scanDate = null; }
        parsed[name] = { fullName: site, scanDate: scanDate?.toISOString() || null, assets: parseNumber(row[m.assets]), raVph: parseNumber(row[m.raVph]), scanIntegrity: parseNumber(row[m.scanIntegrity]), scanPercent: parseNumber(row[m.scanPercent]), raCrit: parseNumber(row[m.raCrit]), raHigh: parseNumber(row[m.raHigh]), scanExempt: String(row[m.scanExempt]).toLowerCase() === 'true' };
    }
    return { parsed, raw: rows };
};

const parseESS = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.ess);
    const wb = XLSX.read(data, { type: 'array' }); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); const parsed = {}; const isicMap = {};
    for (const row of rows) {
        const ship = row[m.shipName]; if (!ship) continue;
        const name = normalizeBoatName(ship); if (!name) continue;
        const isic = row[m.isic]; if (isic) isicMap[name] = String(isic).trim();
        const prodComp = parsePercent(row[m.productCompliance]); const polEnf = parsePercent(row[m.policyEnforced]);
        const truePolicy = (prodComp && polEnf && prodComp > 0) ? polEnf * (100 / prodComp) : null;
        parsed[name] = { assets: parseNumber(row[m.assets]), breakfix: parseNumber(row[m.breakfix]), productCompliance: prodComp, truePolicy };
    }
    return { parsed, isicMap, raw: rows };
};

const parseTAM = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.tam);
    const wb = XLSX.read(data, { type: 'array' }); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); const parsed = {};
    for (const row of rows) {
        const boat = row[m.boatName]; if (!boat) continue;
        const name = normalizeBoatName(boat); if (!name) continue;
        parsed[name] = { pastDue: parseNumber(row[m.pastDue]), extensions: parseNumber(row[m.extensions]) };
    }
    return { parsed, raw: rows };
};

// Merge Data
const mergeData = (sources, settings) => {
    const { vramNipr, vramSipr, essNipr, essSipr, tam } = sources;
    const boats = []; const unregistered = new Set(); const registry = {};
    for (const b of settings.boats) if (b.active !== false) registry[b.boat_name] = b;
    const allNames = new Set([...Object.keys(vramNipr?.parsed||{}), ...Object.keys(vramSipr?.parsed||{}), ...Object.keys(essNipr?.parsed||{}), ...Object.keys(essSipr?.parsed||{}), ...Object.keys(tam?.parsed||{})]);

    for (const name of Object.keys(registry)) {
        const reg = registry[name]; const boat = createBoatData(reg.boat_name, reg.boat_full_name, reg.isic, reg.tycom);
        const vn = vramNipr?.parsed?.[name]; if (vn) { boat.vramNiprAssets = vn.assets; boat.vramNiprScanDate = vn.scanDate; boat.vramNiprRaVph = vn.raVph; boat.vramNiprScanIntegrity = vn.scanIntegrity; boat.vramNiprScanPercent = vn.scanPercent; boat.vramNiprRaCrit = vn.raCrit; boat.vramNiprRaHigh = vn.raHigh; boat.vramNiprScanExempt = vn.scanExempt; }
        const vs = vramSipr?.parsed?.[name]; if (vs) { boat.vramSiprAssets = vs.assets; boat.vramSiprScanDate = vs.scanDate; boat.vramSiprRaVph = vs.raVph; boat.vramSiprScanIntegrity = vs.scanIntegrity; boat.vramSiprScanPercent = vs.scanPercent; boat.vramSiprRaCrit = vs.raCrit; boat.vramSiprRaHigh = vs.raHigh; boat.vramSiprScanExempt = vs.scanExempt; }
        const en = essNipr?.parsed?.[name]; if (en) { boat.essNiprAssets = en.assets; boat.essNiprBreakfix = en.breakfix; boat.essNiprProductCompliance = en.productCompliance; boat.essNiprTruePolicy = en.truePolicy; }
        const es = essSipr?.parsed?.[name]; if (es) { boat.essSiprAssets = es.assets; boat.essSiprBreakfix = es.breakfix; boat.essSiprProductCompliance = es.productCompliance; boat.essSiprTruePolicy = es.truePolicy; }
        const t = tam?.parsed?.[name]; if (t) { boat.tamPastDue = t.pastDue; boat.tamExtensions = t.extensions; }
        boats.push(boat);
    }
    for (const name of allNames) if (!registry[name]) unregistered.add(name);
    return { boats, unregistered: Array.from(unregistered) };
};

// Risk Calculator
const calculateRisk = (boat, thresholds) => {
    const reasons = []; let level = 'LOW';
    const scanAge = (d) => d ? Math.floor((new Date() - new Date(d)) / 86400000) : Infinity;
    const nAge = scanAge(boat.vramNiprScanDate); const sAge = scanAge(boat.vramSiprScanDate);

    if ((boat.essNiprBreakfix||0) > 0) { level = 'HIGH'; reasons.push(`NIPR BF: ${boat.essNiprBreakfix}`); }
    if ((boat.essSiprBreakfix||0) > 0) { level = 'HIGH'; reasons.push(`SIPR BF: ${boat.essSiprBreakfix}`); }
    if (nAge > thresholds.auto_high_scan_age_days) { level = 'HIGH'; reasons.push(`NIPR Scan: ${nAge}d`); }
    if (sAge > thresholds.auto_high_scan_age_days) { level = 'HIGH'; reasons.push(`SIPR Scan: ${sAge}d`); }
    if (boat.vramNiprScanIntegrity !== null && boat.vramNiprScanIntegrity < thresholds.auto_high_scan_integrity) { level = 'HIGH'; reasons.push(`NIPR Int: ${boat.vramNiprScanIntegrity}%`); }
    if (boat.vramNiprRaVph !== null && boat.vramNiprRaVph > thresholds.auto_high_ra_vph) { level = 'HIGH'; reasons.push(`NIPR VPH: ${boat.vramNiprRaVph}`); }

    if (level !== 'HIGH') {
        if (boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < thresholds.high_ess_compliance) { level = 'HIGH'; reasons.push(`NIPR Pol: ${boat.essNiprTruePolicy.toFixed(1)}%`); }
        if ((boat.tamPastDue||0) > thresholds.high_tam_past_due) { level = 'HIGH'; reasons.push(`TAMs: ${boat.tamPastDue}`); }
        if (nAge > thresholds.high_scan_age_days) { level = 'HIGH'; reasons.push(`NIPR Scan: ${nAge}d`); }
    }

    if (level !== 'HIGH') {
        if (boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < thresholds.med_ess_compliance) { level = 'MED'; reasons.push(`NIPR Pol: ${boat.essNiprTruePolicy.toFixed(1)}%`); }
        if (nAge > thresholds.med_scan_age_days) { level = 'MED'; reasons.push(`NIPR Scan: ${nAge}d`); }
        if (boat.vramNiprRaVph !== null && boat.vramNiprRaVph > thresholds.med_ra_vph) { level = 'MED'; reasons.push(`NIPR VPH: ${boat.vramNiprRaVph}`); }
        if ((boat.tamPastDue||0) > thresholds.med_tam_past_due) { level = 'MED'; reasons.push(`TAMs: ${boat.tamPastDue}`); }
    }

    if (level === 'HIGH' && (boat.vramNiprScanExempt || boat.vramSiprScanExempt)) {
        const scanKW = ['Scan:', 'Int:']; if (reasons.every(r => scanKW.some(k => r.includes(k)))) { level = 'MED'; reasons.push('Scan Exempt'); }
    }
    return { level, reasons };
};

const calculateAllRisks = (boats, thresholds) => { for (const b of boats) { const { level, reasons } = calculateRisk(b, thresholds); b.riskLevel = level; b.riskReasons = reasons; } return boats; };

// Aggregations
const aggregateByISIC = (boats, settings) => {
    const groups = {};
    for (const b of boats) {
        if (!groups[b.isic]) { const info = settings.isics.find(i => i.isic_name === b.isic) || { isic_name: b.isic, isic_short: b.isic.slice(0,6), tycom: b.tycom }; groups[b.isic] = { ...info, boats: [] }; }
        groups[b.isic].boats.push(b);
    }
    const aggs = Object.values(groups).map(g => {
        let nSum = 0, nCnt = 0, sSum = 0, sCnt = 0;
        const agg = { isicName: g.isic_name, isicShort: g.isic_short, tycom: g.tycom, boatCount: g.boats.length, niprBreakfixSum: 0, siprBreakfixSum: 0, highRiskCount: 0, scanExemptCount: 0, niprEssEnforcedAvg: 0, siprEssEnforcedAvg: 0 };
        for (const b of g.boats) {
            agg.niprBreakfixSum += b.essNiprBreakfix || 0; agg.siprBreakfixSum += b.essSiprBreakfix || 0;
            if (b.essNiprTruePolicy !== null) { nSum += b.essNiprTruePolicy; nCnt++; }
            if (b.essSiprTruePolicy !== null) { sSum += b.essSiprTruePolicy; sCnt++; }
            if (b.riskLevel === 'HIGH') agg.highRiskCount++;
            if (b.vramNiprScanExempt || b.vramSiprScanExempt) agg.scanExemptCount++;
        }
        agg.niprEssEnforcedAvg = nCnt > 0 ? nSum / nCnt : 0; agg.siprEssEnforcedAvg = sCnt > 0 ? sSum / sCnt : 0;
        return agg;
    });
    return { csl: aggs.filter(a => a.tycom === 'CSL'), csp: aggs.filter(a => a.tycom === 'CSP') };
};

// Encoding
const compressAndEncode = (data) => { const json = JSON.stringify(data); const b64 = btoa(unescape(encodeURIComponent(json))); let h = 0; for (let i = 0; i < json.length; i++) { h = ((h << 5) - h) + json.charCodeAt(i); h &= h; } return Math.abs(h).toString(16) + ':' + b64; };
const decodeAndDecompress = (str) => { const [hash, b64] = str.split(':'); const json = decodeURIComponent(escape(atob(b64))); const data = JSON.parse(json); let h = 0; for (let i = 0; i < json.length; i++) { h = ((h << 5) - h) + json.charCodeAt(i); h &= h; } return { data, valid: Math.abs(h).toString(16) === hash }; };

// Import Report
const importReportHTML = async (file) => new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const match = e.target.result.match(/<script type="application\/x-dashboard-report">([\s\S]*?)<\/script>/);
            if (!match) { resolve({ error: 'No embedded data' }); return; }
            const { data, valid } = decodeAndDecompress(match[1].trim());
            data.reportData.version++; data.reportData.lastModifiedAt = new Date().toISOString();
            resolve({ reportData: data.reportData, settings: data.settingsSnapshot, valid, error: null });
        } catch (err) { resolve({ error: err.message }); }
    };
    reader.readAsText(file);
});

// Report Generator
const generateReportHTML = (reportData, settings) => {
    const { boats } = reportData; const aggs = aggregateByISIC(boats, settings);
    const groupByISIC = (list) => { const g = {}; for (const b of list) { if (!g[b.isic]) g[b.isic] = []; g[b.isic].push(b); } return g; };
    const cslBoats = boats.filter(b => b.tycom === 'CSL'); const cspBoats = boats.filter(b => b.tycom === 'CSP');
    const cslByISIC = groupByISIC(cslBoats); const cspByISIC = groupByISIC(cspBoats);
    const embedded = compressAndEncode({ reportData, settingsSnapshot: settings, generatedAt: new Date().toISOString() });

    const fmt = (v, d=0) => v === null ? '-' : (d > 0 ? v.toFixed(d) : Math.round(v).toString());
    const fmtPct = (v) => v === null ? '-' : v.toFixed(1) + '%';
    const fmtDate = (d) => d ? `${new Date(d).getMonth()+1}/${new Date(d).getDate()}` : '-';

    // Stats for analytics
    const riskCounts = { HIGH: boats.filter(b => b.riskLevel === 'HIGH').length, MED: boats.filter(b => b.riskLevel === 'MED').length, LOW: boats.filter(b => b.riskLevel === 'LOW').length };
    const cslRiskCounts = { HIGH: cslBoats.filter(b => b.riskLevel === 'HIGH').length, MED: cslBoats.filter(b => b.riskLevel === 'MED').length, LOW: cslBoats.filter(b => b.riskLevel === 'LOW').length };
    const cspRiskCounts = { HIGH: cspBoats.filter(b => b.riskLevel === 'HIGH').length, MED: cspBoats.filter(b => b.riskLevel === 'MED').length, LOW: cspBoats.filter(b => b.riskLevel === 'LOW').length };
    const avgVph = boats.length > 0 ? (boats.reduce((s, b) => s + (b.vramNiprRaVph || 0), 0) / boats.length).toFixed(2) : 0;
    const totalBreakfix = boats.reduce((s, b) => s + (b.essNiprBreakfix || 0) + (b.essSiprBreakfix || 0), 0);
    const avgCompliance = boats.length > 0 ? (boats.reduce((s, b) => s + (b.essNiprProductCompliance || 0), 0) / boats.length).toFixed(1) : 0;

    const boatRow = (b) => `<tr><td class="boat-name">${b.boatName}</td><td>${fmt(b.essNiprAssets)}</td><td class="${(b.essNiprBreakfix||0)>0?'alert-red':''}">${fmt(b.essNiprBreakfix)}</td><td>${fmtPct(b.essNiprProductCompliance)}</td><td>${fmtPct(b.essNiprTruePolicy)}</td><td>${fmt(b.essSiprAssets)}</td><td class="${(b.essSiprBreakfix||0)>0?'alert-red':''}">${fmt(b.essSiprBreakfix)}</td><td>${fmtPct(b.essSiprProductCompliance)}</td><td>${fmtPct(b.essSiprTruePolicy)}</td><td>${fmt(b.vramNiprAssets)}</td><td>${fmtDate(b.vramNiprScanDate)}</td><td>${fmt(b.vramNiprRaVph,2)}</td><td>${fmtPct(b.vramNiprScanIntegrity)}</td><td>${fmtPct(b.vramNiprScanPercent)}</td><td>${fmt(b.vramSiprAssets)}</td><td>${fmtDate(b.vramSiprScanDate)}</td><td>${fmt(b.vramSiprRaVph,2)}</td><td>${fmtPct(b.vramSiprScanIntegrity)}</td><td>${fmtPct(b.vramSiprScanPercent)}</td><td>${fmt(b.vramNiprRaCrit)}</td><td>${fmt(b.vramNiprRaHigh)}</td><td>${fmt(b.tamPastDue)}</td><td>${fmt(b.tamExtensions)}</td><td class="risk-${b.riskLevel.toLowerCase()}">${b.riskLevel}</td><td class="${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'alert-blue':''}">${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'Y':'N'}</td><td style="font-size:6pt;max-width:50px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${b.notes||''}">${b.notes||'-'}</td></tr>`;

    const isicTable = (isic, boats) => `<div class="isic-section" data-isic="${isic}"><h3 style="background:#1e293b;color:white;padding:6px 10px;margin:12px 0 0;font-size:11px;">${isic}</h3><table class="summary-table"><thead><tr><th rowspan="2" style="width:70px">BOAT</th><th colspan="4" class="col-ess-n">ESS NIPR</th><th colspan="4" class="col-ess-s">ESS SIPR</th><th colspan="5" class="col-vram-n">VRAM NIPR</th><th colspan="5" class="col-vram-s">VRAM SIPR</th><th colspan="2" class="col-ra">RA</th><th colspan="2" class="col-tam">TAM</th><th colspan="3" class="col-status">STATUS</th></tr><tr><th class="col-ess-n">Assets</th><th class="col-ess-n">Breakfix</th><th class="col-ess-n">Prod%</th><th class="col-ess-n">Policy%</th><th class="col-ess-s">Assets</th><th class="col-ess-s">Breakfix</th><th class="col-ess-s">Prod%</th><th class="col-ess-s">Policy%</th><th class="col-vram-n">Assets</th><th class="col-vram-n">Scan</th><th class="col-vram-n">VPH</th><th class="col-vram-n">Integrity</th><th class="col-vram-n">Scanned</th><th class="col-vram-s">Assets</th><th class="col-vram-s">Scan</th><th class="col-vram-s">VPH</th><th class="col-vram-s">Integrity</th><th class="col-vram-s">Scanned</th><th class="col-ra">Critical</th><th class="col-ra">High</th><th class="col-tam">Overdue</th><th class="col-tam">Ext</th><th class="col-status">Risk</th><th class="col-status">Exempt</th><th class="col-status">Notes</th></tr></thead><tbody>${boats.map(boatRow).join('')}</tbody></table></div>`;

    const allOverrides = boats.flatMap(b => (b.overrides || []).map(o => ({ ...o, boatName: b.boatName })));
    const thresholdChanges = reportData.thresholdChanges || [];
    const hasChanges = allOverrides.length > 0 || thresholdChanges.length > 0;
    const changeCount = allOverrides.length + thresholdChanges.length;

    // Tab visibility helpers
    const tabConfig = settings.tabConfig || [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}];
    const isTabVisible = (id) => { const tab = tabConfig.find(t => t.id === id); return tab ? tab.visible : true; };
    const visibleTabs = tabConfig.filter(t => t.visible && (t.id !== 'changelog' || hasChanges));
    const firstVisibleTab = visibleTabs.length > 0 ? visibleTabs[0].id : 'csl';

    const hqTable = (list, label) => list.length === 0 ? '<p>No data</p>' : `<h3 style="font-size:11pt;margin:16px 0 8px;color:#1e293b;">${label}</h3><table class="summary-table hq-table"><thead><tr><th style="text-align:left;width:150px">Metric</th>${list.map(a=>`<th>${a.isicShort} (${a.boatCount})</th>`).join('')}</tr></thead><tbody><tr><td style="text-align:left;font-weight:600">NIPR Breakfix</td>${list.map(a=>`<td class="${a.niprBreakfixSum>0?'alert-red':''}">${a.niprBreakfixSum}</td>`).join('')}</tr><tr><td style="text-align:left;font-weight:600">NIPR ESS %</td>${list.map(a=>`<td>${a.niprEssEnforcedAvg.toFixed(1)}%</td>`).join('')}</tr><tr><td style="text-align:left;font-weight:600">High Risk</td>${list.map(a=>`<td class="${a.highRiskCount>0?'risk-high':''}">${a.highRiskCount}</td>`).join('')}</tr></tbody></table>`;

    // High risk boats table for analytics
    const highRiskBoats = boats.filter(b => b.riskLevel === 'HIGH');
    const highRiskTable = highRiskBoats.length === 0 ? '<p style="color:#065f46;font-weight:600;">No high-risk boats</p>' : `<table class="summary-table"><thead><tr><th style="text-align:left">Boat</th><th>ISIC</th><th>VPH</th><th>Breakfix</th><th style="text-align:left">Risk Reasons</th></tr></thead><tbody>${highRiskBoats.map(b => `<tr><td style="text-align:left;font-family:monospace;font-weight:600;">${b.boatName}</td><td>${b.isic}</td><td>${fmt(b.vramNiprRaVph,2)}</td><td class="${(b.essNiprBreakfix||0)>0?'alert-red':''}">${(b.essNiprBreakfix||0)+(b.essSiprBreakfix||0)}</td><td style="text-align:left;font-size:7pt;">${b.riskReasons?.join(', ') || '-'}</td></tr>`).join('')}</tbody></table>`;

    // VPH by ISIC for bar chart
    const isicVph = {};
    boats.forEach(b => { if (!isicVph[b.isic]) isicVph[b.isic] = []; isicVph[b.isic].push(b.vramNiprRaVph || 0); });
    const isicVphAvg = Object.entries(isicVph).map(([isic, vphs]) => ({ isic, avg: (vphs.reduce((a,b)=>a+b,0)/vphs.length).toFixed(2) }));

    return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Cyber Report ${new Date().toLocaleDateString()}</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Arial,sans-serif;font-size:9pt;line-height:1.3;background:#f1f5f9}
.header{background:#1e293b;color:white;padding:12px 24px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:16pt;font-weight:600}
.header-info{font-size:9pt;opacity:0.8}
.tabs{display:flex;background:#334155;padding:0 24px}
.tab-btn{padding:12px 24px;color:#94a3b8;font-weight:500;border:none;background:none;cursor:pointer;border-bottom:3px solid transparent}
.tab-btn:hover{color:white}
.tab-btn.active{color:white;border-bottom-color:#0ea5e9;background:#1e293b}
.tab-content{display:none;padding:24px;max-width:95vw;margin:0 auto}
.tab-content.active{display:block}
.page{background:white;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px}
.page-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #e2e8f0;padding-bottom:12px;margin-bottom:16px}
.page-header h2{font-size:14pt;color:#1e293b}
.toolbar{display:flex;gap:8px;align-items:center}
.toolbar button{background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:9pt}
.toolbar button:hover{background:#2563eb}
.toolbar button.purple{background:#7c3aed}
.toolbar button.purple:hover{background:#6d28d9}
.legend{display:flex;gap:16px;margin-bottom:12px;font-size:8pt;flex-wrap:wrap}
.legend span{display:flex;align-items:center;gap:4px}
.legend-box{width:14px;height:14px;border:1px solid #333;display:inline-block}
.summary-table{width:100%;border-collapse:collapse;font-size:8pt}
.summary-table th{background:#e2e8f0;color:#1e293b;font-weight:600;font-size:7pt;padding:5px 4px;text-align:center;border:1px solid #cbd5e1}
.summary-table td{padding:4px;text-align:center;border:1px solid #e2e8f0}
.summary-table td.boat-name{text-align:left;font-weight:600;font-family:monospace;background:#f8fafc}
.col-ess-n{background:rgba(59,130,246,0.2)!important}.col-ess-s{background:rgba(99,102,241,0.2)!important}
.col-vram-n{background:rgba(249,115,22,0.2)!important}.col-vram-s{background:rgba(234,88,12,0.2)!important}
.col-ra{background:rgba(168,85,247,0.2)!important}.col-tam{background:rgba(107,114,128,0.2)!important}.col-status{background:rgba(16,185,129,0.2)!important}
.risk-high{background:#fee2e2!important;color:#991b1b;font-weight:bold}
.risk-med{background:#fef3c7!important;color:#92400e;font-weight:bold}
.risk-low{background:#d1fae5!important;color:#065f46}
.alert-red{background:#fee2e2!important}.alert-amber{background:#fef3c7!important}.alert-blue{background:#dbeafe!important}
.hq-table th:first-child,.hq-table td:first-child{text-align:left}
.stat-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.stat-card h3{font-size:10pt;color:#64748b;margin-bottom:8px}
.stat-card .value{font-size:28pt;font-weight:700;color:#1e293b}
.stat-card .value.high{color:#dc2626}.stat-card .value.med{color:#d97706}.stat-card .value.low{color:#059669}
.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:24px}
.chart-box{background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.chart-box h3{font-size:11pt;color:#1e293b;margin-bottom:16px;border-bottom:1px solid #e2e8f0;padding-bottom:8px}
@media print{.no-print{display:none!important}body{background:white}.tab-content{display:block!important;padding:10px}.page{box-shadow:none;margin:0;page-break-inside:avoid}}
</style></head><body>
<div class="header no-print">
<h1>Cyber Status Report</h1>
<div class="header-info">Generated: ${new Date().toLocaleString()} by ${reportData.createdBy || 'Unknown'} | v${reportData.version}</div>
</div>
<div class="tabs no-print">
${(settings.tabConfig || []).filter(t => t.visible && (t.id !== 'changelog' || hasChanges)).map((t, i) => `<button class="tab-btn${i===0?' active':''}" onclick="showTab('${t.id}')">${t.id === 'changelog' ? `Changes (${changeCount})` : t.label}</button>`).join('')}
</div>

${isTabVisible('csl') ? `<div id="tab-csl" class="tab-content${firstVisibleTab==='csl'?' active':''}">
<div class="page">
<div class="page-header">
<h2>CSL Cyber Summary</h2>
<div class="toolbar">
<select onchange="filterISIC('csl',this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;">
<option value="">All Squadrons</option>${Object.keys(cslByISIC).map(i=>`<option value="${i}">${i}</option>`).join('')}
</select>
<button onclick="printTab('csl')">Print CSL</button>
<button onclick="exportToExcel()">Export Excel</button>
</div>
</div>
<div class="legend"><span><span class="legend-box risk-high"></span>High</span><span><span class="legend-box risk-med"></span>Med</span><span><span class="legend-box risk-low"></span>Low</span><span><span class="legend-box alert-red"></span>Critical</span><span><span class="legend-box alert-blue"></span>Exempt</span></div>
<div id="csl-content">${Object.entries(cslByISIC).map(([isic,boats])=>isicTable(isic,boats)).join('')}</div>
</div>
</div>` : ''}

${isTabVisible('csp') ? `<div id="tab-csp" class="tab-content${firstVisibleTab==='csp'?' active':''}">
<div class="page">
<div class="page-header">
<h2>CSP Cyber Summary</h2>
<div class="toolbar">
<select onchange="filterISIC('csp',this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;">
<option value="">All Squadrons</option>${Object.keys(cspByISIC).map(i=>`<option value="${i}">${i}</option>`).join('')}
</select>
<button onclick="printTab('csp')">Print CSP</button>
<button onclick="exportToExcel()">Export Excel</button>
</div>
</div>
<div class="legend"><span><span class="legend-box risk-high"></span>High</span><span><span class="legend-box risk-med"></span>Med</span><span><span class="legend-box risk-low"></span>Low</span><span><span class="legend-box alert-red"></span>Critical</span><span><span class="legend-box alert-blue"></span>Exempt</span></div>
<div id="csp-content">${Object.entries(cspByISIC).map(([isic,boats])=>isicTable(isic,boats)).join('')}</div>
</div>
</div>` : ''}

${isTabVisible('hq') ? `<div id="tab-hq" class="tab-content${firstVisibleTab==='hq'?' active':''}">
<div class="page">
<div class="page-header">
<h2>HQ Cyber Status</h2>
<div class="toolbar"><button onclick="printTab('hq')">Print HQ Status</button></div>
</div>
${hqTable(aggs.csl, 'CSL Status')}
${hqTable(aggs.csp, 'CSP Status')}
</div>
</div>` : ''}

${isTabVisible('analytics') ? `<div id="tab-analytics" class="tab-content${firstVisibleTab==='analytics'?' active':''}">
<div class="stat-cards">
<div class="stat-card"><h3>Total Boats</h3><div class="value">${boats.length}</div></div>
<div class="stat-card"><h3>High Risk</h3><div class="value high">${riskCounts.HIGH}</div></div>
<div class="stat-card"><h3>Medium Risk</h3><div class="value med">${riskCounts.MED}</div></div>
<div class="stat-card"><h3>Low Risk</h3><div class="value low">${riskCounts.LOW}</div></div>
<div class="stat-card"><h3>Avg NIPR VPH</h3><div class="value">${avgVph}</div></div>
<div class="stat-card"><h3>Total Breakfix</h3><div class="value ${totalBreakfix > 0 ? 'high' : ''}">${totalBreakfix}</div></div>
<div class="stat-card"><h3>Avg ESS Compliance</h3><div class="value">${avgCompliance}%</div></div>
<div class="stat-card"><h3>Scan Exempt</h3><div class="value">${boats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length}</div></div>
</div>
<div class="chart-grid">
<div class="chart-box"><h3>Risk Distribution - All</h3><canvas id="chart-risk-all"></canvas></div>
<div class="chart-box"><h3>Risk by TYCOM</h3><canvas id="chart-risk-tycom"></canvas></div>
<div class="chart-box"><h3>Average VPH by ISIC</h3><canvas id="chart-vph-isic"></canvas></div>
<div class="chart-box"><h3>High Risk Boats</h3>${highRiskTable}</div>
</div>
<div class="page">
<div class="page-header"><h2>Risk Summary by ISIC</h2><div class="toolbar"><button onclick="printTab('analytics')">Print Analytics</button></div></div>
<table class="summary-table"><thead><tr><th style="text-align:left">ISIC</th><th>Boats</th><th>High</th><th>Med</th><th>Low</th><th>Avg VPH</th><th>Breakfix</th></tr></thead>
<tbody>${Object.entries(groupByISIC(boats)).map(([isic, isicBoats]) => {
    const h = isicBoats.filter(b => b.riskLevel === 'HIGH').length;
    const m = isicBoats.filter(b => b.riskLevel === 'MED').length;
    const l = isicBoats.filter(b => b.riskLevel === 'LOW').length;
    const vph = (isicBoats.reduce((s, b) => s + (b.vramNiprRaVph || 0), 0) / isicBoats.length).toFixed(2);
    const bf = isicBoats.reduce((s, b) => s + (b.essNiprBreakfix || 0), 0);
    return `<tr><td style="text-align:left;font-weight:600">${isic}</td><td>${isicBoats.length}</td><td class="${h>0?'risk-high':''}">${h}</td><td class="${m>0?'risk-med':''}">${m}</td><td class="risk-low">${l}</td><td>${vph}</td><td class="${bf>0?'alert-red':''}">${bf}</td></tr>`;
}).join('')}</tbody></table>
</div>
</div>` : ''}

${(hasChanges && isTabVisible('changelog')) ? `<div id="tab-changelog" class="tab-content${firstVisibleTab==='changelog'?' active':''}">
<div class="page">
<div class="page-header"><h2>Change Log</h2><div class="toolbar"><button onclick="printTab('changelog')">Print Changes</button></div></div>
${thresholdChanges.length > 0 ? `<h3 style="font-size:11pt;margin:16px 0 8px;color:#b45309;">Threshold Adjustments</h3>
<table class="summary-table"><thead><tr><th style="text-align:left">Threshold</th><th>Default</th><th>Used</th><th>By</th><th>Time</th></tr></thead>
<tbody>${thresholdChanges.map(t => `<tr><td style="text-align:left">${t.field.replace(/_/g, ' ')}</td><td>${t.defaultValue}</td><td style="font-weight:bold;color:#b45309;">${t.newValue}</td><td>${t.user}</td><td>${new Date(t.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}
${allOverrides.length > 0 ? `<h3 style="font-size:11pt;margin:24px 0 8px;color:#7c3aed;">Value Overrides</h3>
<table class="summary-table"><thead><tr><th style="text-align:left">Boat</th><th style="text-align:left">Field</th><th>Original</th><th>New</th><th style="text-align:left">Reason</th><th>By</th><th>Time</th></tr></thead>
<tbody>${allOverrides.map(o => `<tr><td style="text-align:left;font-family:monospace;">${o.boatName}</td><td style="text-align:left">${o.field}</td><td>${o.originalValue}</td><td style="font-weight:bold;color:#7c3aed;">${o.overrideValue}</td><td style="text-align:left">${o.reason}</td><td>${o.user}</td><td>${new Date(o.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}
</div>
</div>` : ''}

<script type="application/x-dashboard-report">${embedded}<\/script>
<script>
const riskData = ${JSON.stringify(riskCounts)};
const cslRisk = ${JSON.stringify(cslRiskCounts)};
const cspRisk = ${JSON.stringify(cspRiskCounts)};
const isicVphData = ${JSON.stringify(isicVphAvg)};

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
    event.target.classList.add('active');
    if (id === 'analytics' && !window.chartsInit) { initCharts(); window.chartsInit = true; }
}
function printTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.getElementById('tab-' + id).style.display = 'block';
    window.print();
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = '');
    document.querySelector('.tab-content.active').style.display = 'block';
}
function filterISIC(p, v) {
    const c = document.getElementById(p + '-content');
    const s = c.querySelectorAll('.isic-section');
    s.forEach(x => x.style.display = !v || x.dataset.isic === v ? '' : 'none');
}
function exportToExcel() {
    const m = document.querySelector('script[type="application/x-dashboard-report"]');
    if (!m) { alert('No data'); return; }
    try {
        const [h, b64] = m.textContent.trim().split(':');
        const d = JSON.parse(decodeURIComponent(escape(atob(b64))));
        const wb = XLSX.utils.book_new();
        if (d.reportData.sourceData.vramNipr?.raw) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d.reportData.sourceData.vramNipr.raw), 'VRAM NIPR');
        if (d.reportData.sourceData.vramSipr?.raw) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d.reportData.sourceData.vramSipr.raw), 'VRAM SIPR');
        if (d.reportData.sourceData.essNipr?.raw) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d.reportData.sourceData.essNipr.raw), 'ESS NIPR');
        if (d.reportData.sourceData.essSipr?.raw) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d.reportData.sourceData.essSipr.raw), 'ESS SIPR');
        if (d.reportData.sourceData.tam?.raw) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d.reportData.sourceData.tam.raw), 'TAM');
        const calc = d.reportData.boats.map(b => ({ Boat: b.boatName, ISIC: b.isic, TYCOM: b.tycom, Risk: b.riskLevel, Reasons: b.riskReasons.join('; '), Notes: b.notes || '' }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(calc), 'Summary');
        XLSX.writeFile(wb, 'cyber-export-' + new Date().toISOString().slice(0, 10) + '.xlsx');
    } catch (e) { alert('Export failed: ' + e.message); }
}
function initCharts() {
    new Chart(document.getElementById('chart-risk-all'), {
        type: 'doughnut',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { plugins: { legend: { position: 'bottom' } } }
    });
    new Chart(document.getElementById('chart-risk-tycom'), {
        type: 'bar',
        data: { labels: ['CSL', 'CSP'], datasets: [
            { label: 'High', data: [cslRisk.HIGH, cspRisk.HIGH], backgroundColor: '#dc2626' },
            { label: 'Med', data: [cslRisk.MED, cspRisk.MED], backgroundColor: '#d97706' },
            { label: 'Low', data: [cslRisk.LOW, cspRisk.LOW], backgroundColor: '#059669' }
        ] },
        options: { plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
    });
    new Chart(document.getElementById('chart-vph-isic'), {
        type: 'bar',
        data: { labels: isicVphData.map(d => d.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'Avg VPH', data: isicVphData.map(d => d.avg), backgroundColor: '#3b82f6' }] },
        options: { indexAxis: 'y', plugins: { legend: { display: false } } }
    });
}
<\/script>
</body></html>`;
};

// Components
const DragDropZone = ({ label, file, onDrop, onClear }) => {
    const [drag, setDrag] = React.useState(false);
    return (
        <div className={`drag-zone p-6 text-center cursor-pointer ${drag ? 'drag-active' : ''} ${file ? 'has-file' : ''}`}
            onDragOver={(e) => { e.preventDefault(); setDrag(true); }} onDragLeave={() => setDrag(false)}
            onDrop={(e) => { e.preventDefault(); setDrag(false); if (e.dataTransfer.files[0]) onDrop(e.dataTransfer.files[0]); }}
            onClick={() => document.getElementById('file-' + label).click()}>
            <div className="font-medium text-slate-600 mb-2">{label}</div>
            {file ? <div className="flex items-center justify-center gap-2"><span className="text-emerald-600">[OK] {file.name}</span><button onClick={(e) => { e.stopPropagation(); onClear(); }} className="text-red-500 ml-2">x</button></div> : <div className="text-slate-400 text-sm">Drag & drop or click</div>}
            <input type="file" accept=".xlsx,.xls,.csv,.ods" onChange={(e) => { if (e.target.files[0]) onDrop(e.target.files[0]); }} className="hidden" id={'file-' + label} />
        </div>
    );
};

const ImportTab = ({ importedFiles, setImportedFiles, settings, setSettings, onProcess, onAlert, onReportImport }) => {
    const [reportDrag, setReportDrag] = React.useState(false);
    const handleDrop = (key) => (file) => { const r = new FileReader(); r.onload = (e) => setImportedFiles(p => ({...p, [key]: { name: file.name, data: new Uint8Array(e.target.result) }})); r.readAsArrayBuffer(file); };

    const handleReportDrop = async (e) => {
        e.preventDefault(); e.stopPropagation(); setReportDrag(false);
        const file = e.dataTransfer?.files?.[0];
        if (file?.name.endsWith('.html')) { onReportImport(file); }
        else { onAlert({ type: 'error', msg: 'Please drop an HTML report file' }); }
    };

    const handleReportClick = () => { document.getElementById('report-file-input').click(); };
    const handleReportFileChange = (e) => { if (e.target.files?.[0]) onReportImport(e.target.files[0]); };

    const process = () => {
        try {
            const schema = settings.schemaConfig || defaultSchemaConfig;
            const sources = {
                vramNipr: importedFiles.vramNipr ? parseVRAM(importedFiles.vramNipr.data, schema.vram) : null,
                vramSipr: importedFiles.vramSipr ? parseVRAM(importedFiles.vramSipr.data, schema.vram) : null,
                essNipr: importedFiles.essNipr ? parseESS(importedFiles.essNipr.data, schema.ess) : null,
                essSipr: importedFiles.essSipr ? parseESS(importedFiles.essSipr.data, schema.ess) : null,
                tam: importedFiles.tam ? parseTAM(importedFiles.tam.data, schema.tam) : null
            };
            const { boats, unregistered } = mergeData(sources, settings);
            calculateAllRisks(boats, settings.thresholds);
            const report = { boats, settingsSnapshot: JSON.parse(JSON.stringify(settings)), sourceData: sources, createdAt: new Date().toISOString(), createdBy: '', lastModifiedAt: new Date().toISOString(), lastModifiedBy: '', version: 1, sourceFiles: { vramNipr: importedFiles.vramNipr?.name, vramSipr: importedFiles.vramSipr?.name, essNipr: importedFiles.essNipr?.name, essSipr: importedFiles.essSipr?.name, tam: importedFiles.tam?.name } };
            if (unregistered.length > 0) onAlert({ type: 'warning', msg: `Unregistered: ${unregistered.slice(0,5).join(', ')}${unregistered.length>5?'...':''} - Add in Settings` });
            onProcess(report);
        } catch (err) { onAlert({ type: 'error', msg: err.message }); }
    };

    const slots = [{ key: 'vramNipr', label: 'VRAM NIPR' }, { key: 'vramSipr', label: 'VRAM SIPR' }, { key: 'essNipr', label: 'ESS NIPR' }, { key: 'essSipr', label: 'ESS SIPR' }, { key: 'tam', label: 'TAM Overdue' }];

    return (
        <div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <h2 className="text-2xl font-bold mb-4 text-slate-800">Import Data Files</h2>
                    <div className="grid grid-cols-2 gap-3">{slots.map(s => <DragDropZone key={s.key} label={s.label} file={importedFiles[s.key]} onDrop={handleDrop(s.key)} onClear={() => setImportedFiles(p => ({...p, [s.key]: null}))} />)}</div>
                </div>
                <div>
                    <h2 className="text-2xl font-bold mb-4 text-purple-700">Re-Edit Previous Report</h2>
                    <div className={`drag-zone p-8 text-center cursor-pointer h-full min-h-[200px] flex flex-col items-center justify-center ${reportDrag ? 'drag-active' : ''}`}
                        style={{borderColor: reportDrag ? '#7c3aed' : '#cbd5e1', background: reportDrag ? '#f5f3ff' : '#ffffff'}}
                        onDragOver={(e) => { e.preventDefault(); setReportDrag(true); }} onDragLeave={() => setReportDrag(false)} onDrop={handleReportDrop} onClick={handleReportClick}>
                        <div className="text-2xl mb-3 text-purple-600 font-bold">[RE-EDIT]</div>
                        <div className="font-medium text-slate-600 mb-2">Drop Generated Report HTML</div>
                        <div className="text-slate-400 text-sm">Re-edit with original settings & data</div>
                        <input type="file" accept=".html" onChange={handleReportFileChange} className="hidden" id="report-file-input" />
                    </div>
                </div>
            </div>
            <div className="flex gap-4 flex-wrap">
                <button onClick={process} disabled={!Object.values(importedFiles).some(f=>f)} className="btn-primary">Process & Preview</button>
                <button onClick={() => setImportedFiles({vramNipr:null,vramSipr:null,essNipr:null,essSipr:null,tam:null})} className="btn-secondary">Clear All</button>
            </div>
        </div>
    );
};

const PreviewTab = ({ reportData, setReportData, settings, onRequestName }) => {
    const [subTab, setSubTab] = React.useState('csl');
    const [selectedISIC, setSelectedISIC] = React.useState('');
    const [overrideModal, setOverrideModal] = React.useState(null);
    const [showOverrideLog, setShowOverrideLog] = React.useState(false);
    const [showThresholds, setShowThresholds] = React.useState(false);
    const [previewThresholds, setPreviewThresholds] = React.useState(null);
    const [notesModal, setNotesModal] = React.useState(null);

    // Initialize preview thresholds from settings if not set
    React.useEffect(() => {
        if (reportData && !previewThresholds) {
            setPreviewThresholds({ ...settings.thresholds });
        }
    }, [reportData, settings.thresholds]);

    if (!reportData) return <div className="text-center py-12 text-slate-400">No data loaded. Import files or drop a report.</div>;

    const activeThresholds = previewThresholds || settings.thresholds;
    const thresholdChanges = previewThresholds ? Object.keys(settings.thresholds).filter(k => settings.thresholds[k] !== previewThresholds[k]) : [];

    const { boats } = reportData; const aggs = aggregateByISIC(boats, settings);
    const current = subTab === 'csl' ? boats.filter(b => b.tycom === 'CSL') : subTab === 'csp' ? boats.filter(b => b.tycom === 'CSP') : [];
    const isics = [...new Set(current.map(b => b.isic))];
    const filtered = selectedISIC ? current.filter(b => b.isic === selectedISIC) : current;
    const groupByISIC = (list) => { const g = {}; for (const b of list) { if (!g[b.isic]) g[b.isic] = []; g[b.isic].push(b); } return g; };

    const allOverrides = boats.flatMap(b => (b.overrides || []).map(o => ({ ...o, boatName: b.boatName })));

    const generate = () => {
        onRequestName((name) => {
            const userName = name || 'Unknown';
            // Build threshold change log if thresholds were modified
            const thresholdLog = thresholdChanges.map(k => ({
                field: k,
                defaultValue: settings.thresholds[k],
                newValue: previewThresholds[k],
                reason: 'Adjusted for this report',
                timestamp: new Date().toISOString(),
                user: userName
            }));
            // Update boats with user name in overrides (replace "User" placeholder)
            const updatedBoats = reportData.boats.map(b => ({
                ...b,
                overrides: (b.overrides || []).map(o => ({
                    ...o,
                    user: o.user === 'User' ? userName : o.user
                }))
            }));
            const updatedReport = {
                ...reportData,
                boats: updatedBoats,
                createdBy: userName,
                lastModifiedBy: userName,
                thresholdChanges: thresholdLog,
                usedThresholds: previewThresholds || settings.thresholds
            };
            const html = generateReportHTML(updatedReport, settings);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], { type: 'text/html' })); a.download = `cyber-report-${new Date().toISOString().slice(0,10)}.html`; a.click();
        });
    };

    // Update the current user name for overrides
    const [currentUserName, setCurrentUserName] = React.useState('');

    const fmt = (v, d=0) => v === null ? '-' : (d > 0 ? v.toFixed(d) : Math.round(v).toString());
    const fmtPct = (v) => v === null ? '-' : v.toFixed(1) + '%';
    const fmtDate = (d) => d ? `${new Date(d).getMonth()+1}/${new Date(d).getDate()}` : '-';

    const fieldLabels = {
        essNiprAssets: 'ESS NIPR Assets', essNiprBreakfix: 'ESS NIPR Breakfix', essNiprProductCompliance: 'ESS NIPR Compliance', essNiprTruePolicy: 'ESS NIPR True Policy',
        essSiprAssets: 'ESS SIPR Assets', essSiprBreakfix: 'ESS SIPR Breakfix', essSiprProductCompliance: 'ESS SIPR Compliance', essSiprTruePolicy: 'ESS SIPR True Policy',
        vramNiprAssets: 'VRAM NIPR Assets', vramNiprRaVph: 'VRAM NIPR VPH', vramNiprScanIntegrity: 'VRAM NIPR Integrity', vramNiprScanPercent: 'VRAM NIPR Percent',
        vramSiprAssets: 'VRAM SIPR Assets', vramSiprRaVph: 'VRAM SIPR VPH', vramSiprScanIntegrity: 'VRAM SIPR Integrity', vramSiprScanPercent: 'VRAM SIPR Percent',
        vramNiprRaCrit: 'NIPR RA Critical', vramNiprRaHigh: 'NIPR RA High', tamPastDue: 'TAM Past Due', tamExtensions: 'TAM Extensions', riskLevel: 'Risk Level',
        vramNiprScanExempt: 'NIPR Scan Exempt', vramSiprScanExempt: 'SIPR Scan Exempt',
        vramNiprScanDate: 'NIPR Last Scan Date', vramSiprScanDate: 'SIPR Last Scan Date'
    };
    const dateFields = ['vramNiprScanDate', 'vramSiprScanDate'];

    // Recalculate risks with current thresholds when thresholds change
    const recalculateWithThresholds = (newThresholds) => {
        setPreviewThresholds(newThresholds);
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                const { level, reasons } = calculateRisk(b, newThresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
    };

    const resetThresholds = () => {
        setPreviewThresholds({ ...settings.thresholds });
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                const { level, reasons } = calculateRisk(b, settings.thresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
    };

    const openOverride = (boatName, field, currentValue) => {
        const boat = boats.find(b => b.boatName === boatName);
        const existingOverride = boat?.overrides?.find(o => o.field === field);
        setOverrideModal({ boatName, field, currentValue, newValue: existingOverride?.overrideValue ?? currentValue ?? '', reason: existingOverride?.reason || '', originalValue: existingOverride?.originalValue ?? currentValue });
    };

    const saveOverride = () => {
        if (!overrideModal) return;
        const { boatName, field, newValue, reason, originalValue } = overrideModal;
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                if (b.boatName !== boatName) return b;
                const overrides = (b.overrides || []).filter(o => o.field !== field);
                let parsedValue;
                if (field === 'riskLevel') {
                    parsedValue = newValue;
                } else if (field === 'vramNiprScanExempt' || field === 'vramSiprScanExempt') {
                    parsedValue = newValue === 'true' || newValue === true;
                } else if (dateFields.includes(field)) {
                    parsedValue = newValue ? new Date(newValue).toISOString() : null;
                } else {
                    parsedValue = parseFloat(newValue);
                }
                if (String(parsedValue) !== String(originalValue)) {
                    overrides.push({ field, originalValue, overrideValue: parsedValue, reason: reason || 'Manual override', timestamp: new Date().toISOString(), user: currentUserName || 'User' });
                }
                const updated = { ...b, [field]: parsedValue, overrides };
                if (field !== 'riskLevel' && !dateFields.includes(field)) { const { level, reasons } = calculateRisk(updated, activeThresholds); updated.riskLevel = level; updated.riskReasons = reasons; }
                return updated;
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
        setOverrideModal(null);
    };

    const isOverridden = (boat, field) => boat.overrides?.some(o => o.field === field);

    const openNotesEdit = (boatName, currentNotes) => {
        setNotesModal({ boatName, notes: currentNotes });
    };

    const saveNotes = () => {
        if (!notesModal) return;
        setReportData(prev => ({
            ...prev,
            boats: prev.boats.map(b => b.boatName === notesModal.boatName ? { ...b, notes: notesModal.notes } : b),
            lastModifiedAt: new Date().toISOString()
        }));
        setNotesModal(null);
    };

    const Cell = ({ boat, field, value, format = 'num', className = '' }) => {
        const overridden = isOverridden(boat, field);
        return <td className={`${className} ${overridden ? 'overridden' : ''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(boat.boatName, field, boat[field])} title={overridden ? 'Overridden - click to edit' : 'Click to override'}>{format === 'pct' ? fmtPct(value) : format === 'date' ? fmtDate(value) : format === 'num2' ? fmt(value, 2) : value ?? '-'}</td>;
    };

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-slate-800">Preview Report</h2>
                <div className="flex gap-2">
                    <button onClick={() => setShowThresholds(!showThresholds)} className={`btn-secondary text-sm ${thresholdChanges.length > 0 ? 'ring-2 ring-amber-400' : ''}`}>{showThresholds ? 'Hide' : 'Adjust'} Thresholds{thresholdChanges.length > 0 ? ` (${thresholdChanges.length})` : ''}</button>
                    {allOverrides.length > 0 && <button onClick={() => setShowOverrideLog(!showOverrideLog)} className="btn-secondary text-sm">{showOverrideLog ? 'Hide' : 'Show'} Override Log ({allOverrides.length})</button>}
                    <button onClick={generate} className="btn-success">Generate HTML Report</button>
                </div>
            </div>

            {showOverrideLog && allOverrides.length > 0 && (
                <div className="card p-4 mb-6">
                    <h3 className="text-lg font-bold mb-3 text-purple-700">Override Log</h3>
                    <div className="overflow-x-auto"><table className="data-table text-xs"><thead><tr><th>Boat</th><th>Field</th><th>Original</th><th>New</th><th>Reason</th><th>By</th><th>Time</th></tr></thead>
                    <tbody>{allOverrides.map((o, i) => <tr key={i}><td className="boat-name">{o.boatName}</td><td>{fieldLabels[o.field] || o.field}</td><td>{String(o.originalValue)}</td><td>{String(o.overrideValue)}</td><td>{o.reason}</td><td>{o.user}</td><td>{new Date(o.timestamp).toLocaleString()}</td></tr>)}</tbody></table></div>
                </div>
            )}

            {showThresholds && previewThresholds && (
                <div className="card p-4 mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-amber-700">Temporary Threshold Adjustments</h3>
                        <div className="flex gap-2">
                            {thresholdChanges.length > 0 && <span className="text-sm text-amber-600 bg-amber-50 px-2 py-1 rounded">{thresholdChanges.length} changed</span>}
                            <button onClick={resetThresholds} className="btn-secondary text-sm">Reset to Defaults</button>
                        </div>
                    </div>
                    <p className="text-sm text-slate-500 mb-4">These adjustments only apply to this preview session and will be logged in the generated report.</p>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        {Object.entries(previewThresholds).map(([k, v]) => (
                            <div key={k} className={`flex flex-col ${thresholdChanges.includes(k) ? 'bg-amber-50 p-2 rounded border border-amber-200' : ''}`}>
                                <label className="text-xs text-slate-500 mb-1">{k.replace(/_/g, ' ')}</label>
                                <div className="flex items-center gap-1">
                                    <input type="number" step="any" value={v} onChange={(e) => recalculateWithThresholds({...previewThresholds, [k]: parseFloat(e.target.value) || 0})} className="w-full text-right text-sm" />
                                    {thresholdChanges.includes(k) && <span className="text-amber-500 text-xs" title={`Default: ${settings.thresholds[k]}`}>*</span>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            <div className="flex gap-2 mb-4">
                {['csl', 'csp', 'hq'].map(t => <button key={t} onClick={() => { setSubTab(t); setSelectedISIC(''); }} className={`px-4 py-2 rounded font-medium uppercase text-sm ${subTab === t ? 'bg-cyan-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{t === 'hq' ? 'HQ Status' : `${t} Summary`}</button>)}
            </div>
            {(subTab === 'csl' || subTab === 'csp') && <div className="mb-4"><select value={selectedISIC} onChange={(e) => setSelectedISIC(e.target.value)} className="px-4 py-2 rounded"><option value="">All Squadrons</option>{isics.map(i => <option key={i} value={i}>{i}</option>)}</select><span className="ml-4 text-sm text-slate-500">Click any cell to override</span></div>}

            {subTab === 'hq' ? (
                <div className="card p-4">
                    <h3 className="text-lg font-bold mb-4 text-slate-700">CSL Status</h3>
                    <div className="overflow-x-auto mb-6"><table className="data-table"><thead><tr><th style={{textAlign:'left'}}>Metric</th>{aggs.csl.map(a => <th key={a.isicName}>{a.isicShort} ({a.boatCount})</th>)}</tr></thead><tbody><tr><td style={{textAlign:'left',fontWeight:600}}>NIPR Breakfix</td>{aggs.csl.map(a => <td key={a.isicName} className={a.niprBreakfixSum>0?'alert-red':''}>{a.niprBreakfixSum}</td>)}</tr><tr><td style={{textAlign:'left',fontWeight:600}}>NIPR ESS %</td>{aggs.csl.map(a => <td key={a.isicName}>{a.niprEssEnforcedAvg.toFixed(1)}%</td>)}</tr><tr><td style={{textAlign:'left',fontWeight:600}}>High Risk</td>{aggs.csl.map(a => <td key={a.isicName} className={a.highRiskCount>0?'risk-high':''}>{a.highRiskCount}</td>)}</tr></tbody></table></div>
                    <h3 className="text-lg font-bold mb-4 text-slate-700">CSP Status</h3>
                    <div className="overflow-x-auto"><table className="data-table"><thead><tr><th style={{textAlign:'left'}}>Metric</th>{aggs.csp.map(a => <th key={a.isicName}>{a.isicShort} ({a.boatCount})</th>)}</tr></thead><tbody><tr><td style={{textAlign:'left',fontWeight:600}}>NIPR Breakfix</td>{aggs.csp.map(a => <td key={a.isicName} className={a.niprBreakfixSum>0?'alert-red':''}>{a.niprBreakfixSum}</td>)}</tr><tr><td style={{textAlign:'left',fontWeight:600}}>NIPR ESS %</td>{aggs.csp.map(a => <td key={a.isicName}>{a.niprEssEnforcedAvg.toFixed(1)}%</td>)}</tr><tr><td style={{textAlign:'left',fontWeight:600}}>High Risk</td>{aggs.csp.map(a => <td key={a.isicName} className={a.highRiskCount>0?'risk-high':''}>{a.highRiskCount}</td>)}</tr></tbody></table></div>
                </div>
            ) : (
                <div className="card p-4 overflow-x-auto">
                    {Object.entries(groupByISIC(filtered)).map(([isic, isicBoats]) => (
                        <div key={isic} className="mb-6">
                            <h3 className="text-sm font-bold mb-2 px-3 py-2 rounded bg-slate-100 text-slate-700">{isic}</h3>
                            <table className="data-table">
                                <thead>
                                    <tr><th rowSpan="2" style={{width:'70px'}}>BOAT</th><th colSpan="4" className="col-ess-n">ESS NIPR</th><th colSpan="4" className="col-ess-s">ESS SIPR</th><th colSpan="5" className="col-vram-n">VRAM NIPR</th><th colSpan="5" className="col-vram-s">VRAM SIPR</th><th colSpan="2" className="col-ra">RA</th><th colSpan="2" className="col-tam">TAM</th><th colSpan="3" className="col-status">STATUS</th></tr>
                                    <tr><th className="col-ess-n">Assets</th><th className="col-ess-n">Breakfix</th><th className="col-ess-n">Prod%</th><th className="col-ess-n">Policy%</th><th className="col-ess-s">Assets</th><th className="col-ess-s">Breakfix</th><th className="col-ess-s">Prod%</th><th className="col-ess-s">Policy%</th><th className="col-vram-n">Assets</th><th className="col-vram-n">Scan</th><th className="col-vram-n">VPH</th><th className="col-vram-n">Integrity</th><th className="col-vram-n">Scanned</th><th className="col-vram-s">Assets</th><th className="col-vram-s">Scan</th><th className="col-vram-s">VPH</th><th className="col-vram-s">Integrity</th><th className="col-vram-s">Scanned</th><th className="col-ra">Critical</th><th className="col-ra">High</th><th className="col-tam">Overdue</th><th className="col-tam">Ext</th><th className="col-status">Risk</th><th className="col-status">Exempt</th><th className="col-status">Notes</th></tr>
                                </thead>
                                <tbody>{isicBoats.map(b => <tr key={b.boatName}>
                                    <td className="boat-name">{b.boatName}</td>
                                    <Cell boat={b} field="essNiprAssets" value={fmt(b.essNiprAssets)} />
                                    <Cell boat={b} field="essNiprBreakfix" value={fmt(b.essNiprBreakfix)} className={(b.essNiprBreakfix||0)>0?'alert-red':''} />
                                    <Cell boat={b} field="essNiprProductCompliance" value={b.essNiprProductCompliance} format="pct" />
                                    <Cell boat={b} field="essNiprTruePolicy" value={b.essNiprTruePolicy} format="pct" />
                                    <Cell boat={b} field="essSiprAssets" value={fmt(b.essSiprAssets)} />
                                    <Cell boat={b} field="essSiprBreakfix" value={fmt(b.essSiprBreakfix)} className={(b.essSiprBreakfix||0)>0?'alert-red':''} />
                                    <Cell boat={b} field="essSiprProductCompliance" value={b.essSiprProductCompliance} format="pct" />
                                    <Cell boat={b} field="essSiprTruePolicy" value={b.essSiprTruePolicy} format="pct" />
                                    <Cell boat={b} field="vramNiprAssets" value={fmt(b.vramNiprAssets)} />
                                    <Cell boat={b} field="vramNiprScanDate" value={b.vramNiprScanDate} format="date" />
                                    <Cell boat={b} field="vramNiprRaVph" value={b.vramNiprRaVph} format="num2" />
                                    <Cell boat={b} field="vramNiprScanIntegrity" value={b.vramNiprScanIntegrity} format="pct" />
                                    <Cell boat={b} field="vramNiprScanPercent" value={b.vramNiprScanPercent} format="pct" />
                                    <Cell boat={b} field="vramSiprAssets" value={fmt(b.vramSiprAssets)} />
                                    <Cell boat={b} field="vramSiprScanDate" value={b.vramSiprScanDate} format="date" />
                                    <Cell boat={b} field="vramSiprRaVph" value={b.vramSiprRaVph} format="num2" />
                                    <Cell boat={b} field="vramSiprScanIntegrity" value={b.vramSiprScanIntegrity} format="pct" />
                                    <Cell boat={b} field="vramSiprScanPercent" value={b.vramSiprScanPercent} format="pct" />
                                    <Cell boat={b} field="vramNiprRaCrit" value={fmt(b.vramNiprRaCrit)} />
                                    <Cell boat={b} field="vramNiprRaHigh" value={fmt(b.vramNiprRaHigh)} />
                                    <Cell boat={b} field="tamPastDue" value={fmt(b.tamPastDue)} />
                                    <Cell boat={b} field="tamExtensions" value={fmt(b.tamExtensions)} />
                                    <td className={`risk-${b.riskLevel.toLowerCase()} ${isOverridden(b,'riskLevel')?'overridden':''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(b.boatName, 'riskLevel', b.riskLevel)}>{b.riskLevel}</td>
                                    <td className={`${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'alert-blue':''} ${(isOverridden(b,'vramNiprScanExempt')||isOverridden(b,'vramSiprScanExempt'))?'overridden':''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(b.boatName, 'vramNiprScanExempt', b.vramNiprScanExempt)} title="Click to override scan exempt status">{(b.vramNiprScanExempt||b.vramSiprScanExempt)?'Y':'N'}</td>
                                    <td className="text-xs max-w-[60px] truncate cursor-pointer hover:bg-cyan-50" onClick={() => openNotesEdit(b.boatName, b.notes || '')} title={b.notes || 'Click to add note'}>{b.notes || '-'}</td>
                                </tr>)}</tbody>
                            </table>
                        </div>
                    ))}
                </div>
            )}

            {overrideModal && (
                <div className="modal-overlay" onClick={() => setOverrideModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-purple-700">Override Value</h3>
                        <div className="space-y-4">
                            <div className="text-sm text-slate-500">Boat: <span className="text-cyan-600 font-mono">{overrideModal.boatName}</span></div>
                            <div className="text-sm text-slate-500">Field: <span className="text-slate-800">{fieldLabels[overrideModal.field] || overrideModal.field}</span></div>
                            <div className="text-sm text-slate-500">Original: <span className="text-slate-600">{overrideModal.originalValue ?? 'null'}</span></div>
                            <div>
                                <label className="block text-sm text-slate-500 mb-1">New Value</label>
                                {overrideModal.field === 'riskLevel' ? (
                                    <select value={overrideModal.newValue} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full">
                                        <option value="LOW">LOW</option><option value="MED">MED</option><option value="HIGH">HIGH</option>
                                    </select>
                                ) : (overrideModal.field === 'vramNiprScanExempt' || overrideModal.field === 'vramSiprScanExempt') ? (
                                    <select value={String(overrideModal.newValue)} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full">
                                        <option value="false">No (N)</option><option value="true">Yes (Y)</option>
                                    </select>
                                ) : dateFields.includes(overrideModal.field) ? (
                                    <input type="date" value={overrideModal.newValue ? new Date(overrideModal.newValue).toISOString().split('T')[0] : ''} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full" />
                                ) : (
                                    <input type="number" step="any" value={overrideModal.newValue} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full" />
                                )}
                            </div>
                            <div>
                                <label className="block text-sm text-slate-500 mb-1">Reason for Override</label>
                                <input value={overrideModal.reason} onChange={(e) => setOverrideModal({...overrideModal, reason: e.target.value})} placeholder="Why is this being overridden?" className="w-full" />
                            </div>
                        </div>
                        <div className="flex gap-2 mt-6">
                            <button onClick={saveOverride} className="btn-primary">Save Override</button>
                            <button onClick={() => setOverrideModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {notesModal && (
                <div className="modal-overlay" onClick={() => setNotesModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Edit Note</h3>
                        <div className="text-sm text-slate-500 mb-2">Boat: <span className="text-cyan-600 font-mono">{notesModal.boatName}</span></div>
                        <input type="text" maxLength={30} value={notesModal.notes} onChange={(e) => setNotesModal({...notesModal, notes: e.target.value})} className="w-full mb-4" placeholder="Short note (3-5 words)" autoFocus onKeyDown={(e) => e.key === 'Enter' && saveNotes()} />
                        <div className="flex gap-2">
                            <button onClick={saveNotes} className="btn-primary">Save</button>
                            <button onClick={() => setNotesModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const SettingsTab = ({ settings, setSettings, onRequestName }) => {
    const [subTab, setSubTab] = React.useState('registry');
    const [editingBoat, setEditingBoat] = React.useState(null);

    const saveBoat = () => {
        if (!editingBoat.boat_name) return;
        const isic = settings.isics.find(i => i.isic_name === editingBoat.isic);
        const boat = { ...editingBoat, tycom: isic?.tycom || 'CSL' }; delete boat.isNew;
        setSettings(prev => ({ ...prev, boats: editingBoat.isNew ? [...prev.boats, boat] : prev.boats.map(b => b.boat_name === boat.boat_name ? boat : b) }));
        setEditingBoat(null);
    };

    const handleSaveApp = () => {
        onRequestName((name) => {
            const updatedSettings = { ...settings, user: { ...settings.user, default_name: name || '' } };
            SettingsManager.saveApplication(updatedSettings);
        });
    };

    // Schema config helpers
    const schema = settings.schemaConfig || JSON.parse(JSON.stringify(defaultSchemaConfig));
    const [newFieldModal, setNewFieldModal] = React.useState(null);

    const updateSchemaField = (type, idx, updates) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type][idx] = { ...newSchema[type][idx], ...updates };
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const reorderSchema = (type, fromIdx, toIdx) => {
        if (fromIdx === toIdx) return;
        const newSchema = JSON.parse(JSON.stringify(schema));
        const [moved] = newSchema[type].splice(fromIdx, 1);
        newSchema[type].splice(toIdx, 0, moved);
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const removeSchemaField = (type, idx) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type].splice(idx, 1);
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const addSchemaField = (type, field, label, column) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type].push({ field, label, column, visible: true });
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const schemaTypeLabels = { vram: 'VRAM Files', ess: 'ESS Files', tam: 'TAM Files' };
    const schemaTypeColors = { vram: 'cyan', ess: 'indigo', tam: 'orange' };

    return (
        <div>
            <h2 className="text-2xl font-bold mb-6 text-slate-800">Settings</h2>
            <div className="flex gap-2 mb-6">{['registry', 'thresholds', 'columns', 'tabs'].map(t => <button key={t} onClick={() => setSubTab(t)} className={`px-4 py-2 rounded font-medium capitalize text-sm ${subTab === t ? 'bg-cyan-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{t === 'columns' ? 'File Schema' : t === 'tabs' ? 'Report Tabs' : t}</button>)}</div>

            {subTab === 'registry' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Boats ({settings.boats.length})</h3>
                        <div className="overflow-x-auto"><table className="data-table"><thead><tr><th style={{textAlign:'left'}}>Name</th><th style={{textAlign:'left'}}>Full Name</th><th>ISIC</th><th>TYCOM</th><th>Actions</th></tr></thead><tbody>{settings.boats.map(b => <tr key={b.boat_name}><td className="boat-name">{b.boat_name}</td><td style={{textAlign:'left'}}>{b.boat_full_name}</td><td>{b.isic}</td><td>{b.tycom}</td><td><button onClick={() => setEditingBoat(b)} className="text-sm text-cyan-600">Edit</button></td></tr>)}</tbody></table></div>
                        <button onClick={() => setEditingBoat({ boat_name: '', boat_full_name: '', isic: settings.isics[0]?.isic_name || '', tycom: 'CSL', active: true, isNew: true })} className="btn-primary mt-4">+ Add Boat</button>
                    </div>
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-4 text-slate-700">ISICs</h3>
                        <table className="data-table"><thead><tr><th style={{textAlign:'left'}}>Name</th><th>Short</th><th>TYCOM</th></tr></thead><tbody>{settings.isics.map(i => <tr key={i.isic_name}><td style={{textAlign:'left'}}>{i.isic_name}</td><td>{i.isic_short}</td><td>{i.tycom}</td></tr>)}</tbody></table>
                    </div>
                </div>
            )}

            {subTab === 'thresholds' && (
                <div className="card p-4">
                    <h3 className="text-lg font-bold mb-4 text-slate-700">Risk Thresholds</h3>
                    <div className="grid grid-cols-2 gap-4">{Object.entries(settings.thresholds).map(([k, v]) => <div key={k} className="flex items-center gap-2"><label className="text-sm text-slate-500 flex-1">{k.replace(/_/g, ' ')}</label><input type="number" value={v} step="any" onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, [k]: parseFloat(e.target.value) || 0}}))} className="w-24 text-right" /></div>)}</div>
                </div>
            )}

            {subTab === 'columns' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">Excel/ODS Schema Configuration</h3>
                        <p className="text-sm text-slate-500 mb-4">Configure fields to extract from each file type. Drag to reorder, toggle visibility, edit column headers. Supports .xlsx, .xls, .csv, and .ods files.</p>
                        {['vram', 'ess', 'tam'].map(type => (
                            <div key={type} className="mb-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className={`font-bold text-${schemaTypeColors[type]}-700`}>{schemaTypeLabels[type]}</h4>
                                    <button onClick={() => setNewFieldModal({ type, field: '', label: '', column: '' })} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Field</button>
                                </div>
                                <div className="border border-slate-200 rounded">
                                    <div className="grid grid-cols-12 gap-2 p-2 bg-slate-100 text-xs font-semibold text-slate-600 border-b">
                                        <div className="col-span-1"></div>
                                        <div className="col-span-1">Use</div>
                                        <div className="col-span-3">Field Label</div>
                                        <div className="col-span-3">Field ID</div>
                                        <div className="col-span-3">Excel Column</div>
                                        <div className="col-span-1"></div>
                                    </div>
                                    {(schema[type] || []).map((item, idx) => (
                                        <div key={item.field + idx} className="grid grid-cols-12 gap-2 p-2 items-center border-b border-slate-100 hover:bg-slate-50"
                                            draggable onDragStart={(e) => e.dataTransfer.setData('schemaIdx', JSON.stringify({type, idx}))}
                                            onDragOver={(e) => e.preventDefault()}
                                            onDrop={(e) => { e.preventDefault(); const from = JSON.parse(e.dataTransfer.getData('schemaIdx')); if (from.type === type) reorderSchema(type, from.idx, idx); }}>
                                            <div className="col-span-1 cursor-move text-slate-400" title="Drag to reorder">&#9776;</div>
                                            <div className="col-span-1"><input type="checkbox" checked={item.visible !== false} onChange={(e) => updateSchemaField(type, idx, { visible: e.target.checked })} /></div>
                                            <div className="col-span-3"><input value={item.label} onChange={(e) => updateSchemaField(type, idx, { label: e.target.value })} className="w-full text-sm p-1" /></div>
                                            <div className="col-span-3"><input value={item.field} onChange={(e) => updateSchemaField(type, idx, { field: e.target.value })} className="w-full text-sm p-1 font-mono text-xs" /></div>
                                            <div className="col-span-3"><input value={item.column} onChange={(e) => updateSchemaField(type, idx, { column: e.target.value })} className="w-full text-sm p-1" placeholder="Excel column header" /></div>
                                            <div className="col-span-1"><button onClick={() => removeSchemaField(type, idx)} className="text-red-500 hover:text-red-700 text-sm" title="Remove field"></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {newFieldModal && (
                <div className="modal-overlay" onClick={() => setNewFieldModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Add New Field to {schemaTypeLabels[newFieldModal.type]}</h3>
                        <div className="space-y-3">
                            <div><label className="block text-sm text-slate-500 mb-1">Field ID (camelCase)</label><input value={newFieldModal.field} onChange={(e) => setNewFieldModal({...newFieldModal, field: e.target.value})} className="w-full font-mono" placeholder="e.g. customField" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Display Label</label><input value={newFieldModal.label} onChange={(e) => setNewFieldModal({...newFieldModal, label: e.target.value})} className="w-full" placeholder="e.g. Custom Field Name" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Excel Column Header</label><input value={newFieldModal.column} onChange={(e) => setNewFieldModal({...newFieldModal, column: e.target.value})} className="w-full" placeholder="Exact column name in Excel" /></div>
                        </div>
                        <div className="flex gap-2 mt-6">
                            <button onClick={() => { if (newFieldModal.field && newFieldModal.column) { addSchemaField(newFieldModal.type, newFieldModal.field, newFieldModal.label || newFieldModal.field, newFieldModal.column); setNewFieldModal(null); } }} className="btn-primary">Add Field</button>
                            <button onClick={() => setNewFieldModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {subTab === 'tabs' && (
                <div className="card p-4">
                    <h3 className="text-lg font-bold mb-4 text-slate-700">Report Tab Configuration</h3>
                    <p className="text-sm text-slate-500 mb-4">Drag to reorder tabs. Uncheck to hide a tab from the generated report.</p>
                    <div className="space-y-2">
                        {(settings.tabConfig || []).map((tab, idx) => (
                            <div key={tab.id} className="flex items-center gap-3 p-3 bg-slate-50 rounded border border-slate-200 hover:bg-slate-100" draggable onDragStart={(e) => e.dataTransfer.setData('tabIdx', idx)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => { e.preventDefault(); const fromIdx = parseInt(e.dataTransfer.getData('tabIdx')); if (fromIdx === idx) return; const newConfig = [...settings.tabConfig]; const [moved] = newConfig.splice(fromIdx, 1); newConfig.splice(idx, 0, moved); setSettings(p => ({...p, tabConfig: newConfig})); }}>
                                <span className="cursor-move text-slate-400 text-lg" title="Drag to reorder">&#9776;</span>
                                <input type="checkbox" checked={tab.visible} onChange={(e) => { const newConfig = [...settings.tabConfig]; newConfig[idx] = {...tab, visible: e.target.checked}; setSettings(p => ({...p, tabConfig: newConfig})); }} className="w-4 h-4" />
                                <span className="font-medium text-slate-700 flex-1">{tab.label}</span>
                                <span className="text-xs text-slate-400">({tab.id})</span>
                            </div>
                        ))}
                    </div>
                    <p className="text-xs text-slate-400 mt-4">Note: The "Changes" tab only appears when there are overrides or threshold adjustments.</p>
                </div>
            )}

            {editingBoat && (
                <div className="modal-overlay" onClick={() => setEditingBoat(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">{editingBoat.isNew ? 'Add Boat' : 'Edit Boat'}</h3>
                        <div className="space-y-4">
                            <div><label className="block text-sm text-slate-500 mb-1">Boat Name (e.g. SSN-21)</label><input value={editingBoat.boat_name} onChange={(e) => setEditingBoat({...editingBoat, boat_name: e.target.value})} className="w-full" disabled={!editingBoat.isNew} /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Full Name</label><input value={editingBoat.boat_full_name} onChange={(e) => setEditingBoat({...editingBoat, boat_full_name: e.target.value})} className="w-full" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">ISIC</label><select value={editingBoat.isic} onChange={(e) => setEditingBoat({...editingBoat, isic: e.target.value})} className="w-full">{settings.isics.map(i => <option key={i.isic_name} value={i.isic_name}>{i.isic_name}</option>)}</select></div>
                        </div>
                        <div className="flex gap-2 mt-6"><button onClick={saveBoat} className="btn-primary">Save</button><button onClick={() => setEditingBoat(null)} className="btn-secondary">Cancel</button></div>
                    </div>
                </div>
            )}

            <div className="mt-8 pt-4 border-t border-slate-200"><button onClick={handleSaveApp} className="btn-success">Save Application (Download Updated HTML)</button></div>
        </div>
    );
};

// Name Prompt Modal
const NamePromptModal = ({ onSubmit, onCancel }) => {
    const [name, setName] = React.useState('');
    return (
        <div className="modal-overlay" onClick={onCancel}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-bold mb-4 text-slate-700">Enter Your Name</h3>
                <p className="text-sm text-slate-500 mb-4">This will be recorded in the report for attribution.</p>
                <input value={name} onChange={(e) => setName(e.target.value)} placeholder="Your name" className="w-full mb-4" autoFocus onKeyDown={(e) => e.key === 'Enter' && onSubmit(name)} />
                <div className="flex gap-2">
                    <button onClick={() => onSubmit(name)} className="btn-primary">Continue</button>
                    <button onClick={onCancel} className="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    );
};

// Main App
function App() {
    const [settings, setSettings] = React.useState(() => SettingsManager.load());
    const [currentTab, setCurrentTab] = React.useState('import');
    const [importedFiles, setImportedFiles] = React.useState({ vramNipr: null, vramSipr: null, essNipr: null, essSipr: null, tam: null });
    const [reportData, setReportData] = React.useState(null);
    const [alerts, setAlerts] = React.useState([]);
    const [namePrompt, setNamePrompt] = React.useState(null);

    const handleReportImport = async (file) => {
        const result = await importReportHTML(file);
        if (result.error) { setAlerts([{ type: 'error', msg: result.error }]); }
        else {
            setSettings(result.settings);
            setReportData(result.reportData);
            setCurrentTab('preview');
            setAlerts([{ type: 'info', msg: `Loaded report v${result.reportData.version} with ${result.reportData.boats.length} boats` }]);
            if (!result.valid) setAlerts(p => [...p, { type: 'warning', msg: 'Report hash invalid - data may have been modified' }]);
        }
    };

    const handleGlobalDrop = async (e) => {
        e.preventDefault();
        const file = e.dataTransfer?.files?.[0];
        if (file?.name.endsWith('.html')) { handleReportImport(file); }
    };

    const requestName = (callback) => {
        setNamePrompt({ callback });
    };

    const handleNameSubmit = (name) => {
        if (namePrompt?.callback) namePrompt.callback(name);
        setNamePrompt(null);
    };

    return (
        <div className="min-h-screen" onDragOver={(e) => e.preventDefault()} onDrop={handleGlobalDrop}>
            <header className="bg-white border-b border-slate-200 px-6 py-4">
                <div className="flex justify-between items-center max-w-[95vw] mx-auto">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg flex items-center justify-center font-bold bg-gradient-to-br from-cyan-500 to-cyan-600 text-white">CD</div>
                        <div><h1 className="text-xl font-bold text-slate-800">Cyber Dashboard Generator</h1><p className="text-xs text-slate-500">Drop Excel files or a report HTML to begin</p></div>
                    </div>
                </div>
            </header>

            {alerts.length > 0 && <div className="max-w-[95vw] mx-auto px-6 pt-4">{alerts.map((a, i) => <div key={i} className={`p-3 rounded mb-2 flex justify-between items-center ${a.type === 'error' ? 'bg-red-100 text-red-700' : a.type === 'warning' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}><span>{a.msg}</span><button onClick={() => setAlerts(alerts.filter((_, j) => j !== i))} className="text-current opacity-50 hover:opacity-100"></button></div>)}</div>}

            <nav className="border-b border-slate-200 px-6 bg-white"><div className="flex gap-1 max-w-[95vw] mx-auto">{['import', 'preview', 'settings'].map(tab => <button key={tab} onClick={() => setCurrentTab(tab)} className={`tab-btn ${currentTab === tab ? 'active' : ''}`}>{tab.charAt(0).toUpperCase() + tab.slice(1)}</button>)}</div></nav>

            <main className="max-w-[95vw] mx-auto p-6">
                {currentTab === 'import' && <ImportTab importedFiles={importedFiles} setImportedFiles={setImportedFiles} settings={settings} setSettings={setSettings} onProcess={(d) => { setReportData(d); setCurrentTab('preview'); }} onAlert={(a) => setAlerts(p => [...p, a])} onReportImport={handleReportImport} />}
                {currentTab === 'preview' && <PreviewTab reportData={reportData} setReportData={setReportData} settings={settings} onRequestName={requestName} />}
                {currentTab === 'settings' && <SettingsTab settings={settings} setSettings={setSettings} onRequestName={requestName} />}
            </main>

            <footer className="text-center py-6 text-slate-400 text-sm">Cyber Dashboard Generator v1.0</footer>

            {namePrompt && <NamePromptModal onSubmit={handleNameSubmit} onCancel={() => setNamePrompt(null)} />}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
