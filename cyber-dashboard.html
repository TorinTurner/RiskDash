<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUBFOR Cyber Risk Dashboard</title>
    <script src="libs/react.production.min.js"></script>
    <script src="libs/react-dom.production.min.js"></script>
    <script src="libs/babel.min.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    <script src="libs/tailwind.min.js"></script>
    <script src="libs/chart.min.js"></script>
    <style>
        /* Fonts - using system fonts for air-gapped access */
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f8fafc; min-height: 100vh; color: #1e293b; margin: 0; }
        .font-mono { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #e2e8f0; } ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .drag-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; background: #ffffff; border-radius: 8px; }
        .drag-zone:hover, .drag-zone.drag-active { border-color: #0891b2; background: #ecfeff; }
        .drag-zone.has-file { border-color: #10b981; background: #ecfdf5; }
        .risk-high { background: #fee2e2 !important; color: #991b1b !important; font-weight: bold; }
        .risk-med { background: #fef3c7 !important; color: #92400e !important; font-weight: bold; }
        .risk-low { background: #d1fae5 !important; color: #065f46 !important; }
        .alert-red { background: #fee2e2; } .alert-amber { background: #fef3c7; } .alert-blue { background: #dbeafe; }
        .tab-btn { position: relative; padding: 12px 24px; font-weight: 500; color: #64748b; transition: all 0.2s; background: none; border: none; cursor: pointer; }
        .tab-btn:hover { color: #0f172a; } .tab-btn.active { color: #0891b2; } .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #0891b2; }
        .btn-primary { background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(8,145,178,0.3); } .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #475569; padding: 10px 20px; border-radius: 6px; font-weight: 500; border: none; cursor: pointer; } .btn-secondary:hover { background: #cbd5e1; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; }
        .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .data-table th { background: #f1f5f9; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 9px; letter-spacing: 0.3px; padding: 6px 4px; text-align: center; border: 1px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 5px 4px; text-align: center; border: 1px solid #e2e8f0; background: #ffffff; white-space: nowrap; }
        .data-table.settings-table { font-size: 14px; }
        .data-table.settings-table th { font-size: 12px; padding: 10px 12px; }
        .data-table.settings-table td { padding: 8px 12px; }
        .data-table.settings-table td.boat-name { font-size: 14px; }
        .data-table.hq-preview-table { font-size: 14px; }
        .data-table.hq-preview-table th { font-size: 12px; padding: 12px 16px; font-weight: 600; }
        .data-table.hq-preview-table td { padding: 10px 16px; font-size: 14px; }
        .table-scroll { overflow-x: auto; }
        .data-table td.boat-name { text-align: left; font-weight: 600; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; color: #0891b2; }
        .data-table .isic-header, .data-table .isic-cell { background: #1e293b; color: white; font-weight: 700; text-align: center; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); padding: 8px 4px; font-size: 9px; width: 28px; min-width: 28px; max-width: 28px; }
        .data-table .isic-first-row td { border-top: 2px solid #1e293b; }
        .col-ess-n { background: rgba(59,130,246,0.1) !important; } .col-ess-s { background: rgba(99,102,241,0.1) !important; }
        .col-vram-n { background: rgba(249,115,22,0.1) !important; } .col-vram-s { background: rgba(234,88,12,0.1) !important; }
        .col-ra { background: rgba(168,85,247,0.1) !important; } .col-tam { background: rgba(107,114,128,0.1) !important; } .col-status { background: rgba(16,185,129,0.1) !important; }
        input, select { background: #ffffff; border: 1px solid #cbd5e1; color: #1e293b; padding: 8px 12px; border-radius: 4px; }
        input:focus, select:focus { outline: none; border-color: #0891b2; box-shadow: 0 0 0 3px rgba(8,145,178,0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .overridden { box-shadow: inset 0 0 0 2px #7c3aed; }
        @media print { .no-print { display: none !important; } }
        @page { margin: 0; size: landscape; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="application/json" id="app-settings">
{
    "_version": 1,
    "tycoms": ["CSL", "CSP"],
    "isics": [],
    "boats": [],
    "thresholds": {},
    "display": {},
    "user": {"default_name": ""}
}
</script>

<script type="text/babel">
// Utilities
const normalizeBoatName = (name) => { if (!name) return ''; const upper = name.toUpperCase().trim(); const match = upper.match(/\b(SSN|SSBN|SSGN)\s*[-]?\s*(\d+)\b/); return match ? `${match[1]}-${match[2]}` : upper; };
const parseNumber = (val) => {
    if (val === null || val === undefined || val === '') return null;
    if (typeof val === 'number') return val;
    const strVal = String(val).trim().toLowerCase();
    // Handle 'None' as 0
    if (strVal === 'none') return 0;
    const num = parseFloat(strVal.replace(/[%,]/g, ''));
    return isNaN(num) ? null : num;
};
const parsePercent = (val) => {
    if (val === null || val === undefined || val === '') return null;
    const strVal = String(val).trim().toLowerCase();
    // Handle 'None' as 0
    if (strVal === 'none') return 0;
    const num = parseFloat(strVal.replace('%', ''));
    return isNaN(num) ? null : num;
};

// Helper to find header row in first 5 rows of sheet
const findHeaderRow = (wb, sheetName, columnMap) => {
    const sheet = wb.Sheets[sheetName];
    if (!sheet) return { headerRow: 0, data: [] };

    const range = XLSX.utils.decode_range(sheet['!ref'] || 'A1');
    const requiredColumns = Object.values(columnMap).filter(c => c);

    // Check first 5 rows for header match
    for (let rowIdx = 0; rowIdx <= Math.min(4, range.e.r); rowIdx++) {
        const rowValues = [];
        for (let colIdx = 0; colIdx <= range.e.c; colIdx++) {
            const cellAddr = XLSX.utils.encode_cell({ r: rowIdx, c: colIdx });
            const cell = sheet[cellAddr];
            rowValues.push(cell ? String(cell.v || '').trim() : '');
        }

        // Count how many required columns match
        const matchCount = requiredColumns.filter(col => rowValues.some(v => v.toLowerCase() === col.toLowerCase())).length;

        // If we find at least 2 matching columns, use this row as header
        if (matchCount >= 2) {
            // Parse from this row onwards
            const opts = { range: rowIdx, header: 1 };
            const rawData = XLSX.utils.sheet_to_json(sheet, { range: rowIdx });
            return { headerRow: rowIdx, data: rawData };
        }
    }

    // Default: use first row as header
    return { headerRow: 0, data: XLSX.utils.sheet_to_json(sheet) };
};

// Default schema configuration - defines fields to extract from each file type
const defaultSchemaConfig = {
    vram: [
        {field: 'siteName', label: 'Site/Boat Name', column: 'Site Name', visible: true},
        {field: 'scanDate', label: 'Last Scan Date', column: 'Last Scan Date', visible: true},
        {field: 'assets', label: 'Asset Count', column: 'Valid Assets', visible: true},
        {field: 'raVph', label: 'RA VPH', column: 'RA VPH', visible: true},
        {field: 'raCrit', label: 'RA Critical', column: 'RA Critical', visible: false},
        {field: 'raHigh', label: 'RA High', column: 'RA High', visible: true},
        {field: 'scanIntegrity', label: 'Scan Integrity %', column: 'Scan Integrity', visible: true},
        {field: 'scanPercent', label: 'Percent Scanned', column: 'Percent Scanned', visible: true},
        {field: 'scanExempt', label: 'Scan Exempt', column: 'Scan Exempt', visible: true}
    ],
    ess: [
        {field: 'shipName', label: 'Ship/Boat Name', column: 'Ships', visible: true},
        {field: 'isic', label: 'ISIC Column', column: 'ISICs', visible: true},
        {field: 'productCompliance', label: 'Product Compliance %', column: 'Product Compliance', visible: true},
        {field: 'policyEnforced', label: 'Policy Enforced %', column: 'Policy Enforced', visible: true},
        {field: 'truePolicy', label: 'True Policy % (Calculated)', column: '[CALCULATED - NOT IN ESS SHEET]', visible: true},
        {field: 'breakfix', label: 'Breakfix Count', column: 'Assets in Breakfix', visible: true},
        {field: 'assets', label: 'Asset Count', column: 'Asset Count', visible: true}
    ],
    tam: [
        {field: 'boatName', label: 'Boat Name', column: 'Boat', visible: true},
        {field: 'pastDue', label: 'Past Due Count', column: '# Past Due', visible: true},
        {field: 'extensions', label: 'Extensions Count', column: '# Extensions', visible: true}
    ]
};

// Build column map from schema config (field -> column name)
const buildColumnMap = (schemaArr) => {
    const map = {};
    for (const item of schemaArr) {
        if (item.visible !== false) map[item.field] = item.column;
    }
    return map;
};

// Default analytics configuration
const defaultAnalyticsConfig = {
    statCards: [
        {id: 'totalBoats', label: 'Total Boats', visible: true},
        {id: 'highRisk', label: 'High Risk', visible: true},
        {id: 'medRisk', label: 'Medium Risk', visible: true},
        {id: 'lowRisk', label: 'Low Risk', visible: true},
        {id: 'avgVph', label: 'Avg RA VPH', visible: true},
        {id: 'totalBreakfix', label: 'Total Breakfix', visible: true},
        {id: 'avgCompliance', label: 'Avg ESS Compliance', visible: true},
        {id: 'scanExempt', label: 'Scan Exempt', visible: true}
    ],
    charts: [
        {id: 'riskDistribution', label: 'Risk Distribution - All', visible: true},
        {id: 'riskByTycom', label: 'Risk by TYCOM', visible: true},
        {id: 'vphByIsic', label: 'Average VPH by ISIC', visible: true},
        {id: 'highRiskTable', label: 'High Risk Boats Table', visible: true}
    ],
    rankings: [
        {id: 'worstBoatsVph', label: 'Worst Boats by VPH', visible: true, count: 5},
        {id: 'bestBoatsVph', label: 'Best Boats by VPH', visible: false, count: 5},
        {id: 'worstBoatsCompliance', label: 'Worst Boats by Compliance', visible: true, count: 5},
        {id: 'bestBoatsCompliance', label: 'Best Boats by Compliance', visible: false, count: 5},
        {id: 'worstIsicsRisk', label: 'Worst ISICs by High Risk Count', visible: true, count: 3},
        {id: 'bestIsicsRisk', label: 'Best ISICs by Low Risk %', visible: false, count: 3},
        {id: 'worstIsicsVph', label: 'Worst ISICs by Avg VPH', visible: false, count: 3},
        {id: 'boatsWithBreakfix', label: 'Boats with Breakfix Issues', visible: true, count: 5},
        {id: 'tycomComparison', label: 'TYCOM vs TYCOM Comparison', visible: true, count: 0}
    ],
    summaryColumns: [
        {id: 'isic', label: 'ISIC', visible: true},
        {id: 'boats', label: 'Boats', visible: true},
        {id: 'high', label: 'High', visible: true},
        {id: 'med', label: 'Med', visible: true},
        {id: 'low', label: 'Low', visible: true},
        {id: 'avgVph', label: 'Avg VPH', visible: true},
        {id: 'breakfix', label: 'Breakfix', visible: true}
    ]
};

// Default HQ Status layout - controls which metrics are shown and their order
const defaultHQStatusLayout = [
    { id: 'niprProdComp', label: 'NIPR Prod Compliance', visible: true },
    { id: 'niprPolEnf', label: 'NIPR True Policy', visible: true },
    { id: 'niprPolRaw', label: 'NIPR Policy Enforced (Raw)', visible: false },
    { id: 'niprBreakfix', label: 'NIPR Breakfix', visible: true },
    { id: 'siprProdComp', label: 'SIPR Prod Compliance', visible: true },
    { id: 'siprPolEnf', label: 'SIPR True Policy', visible: true },
    { id: 'siprPolRaw', label: 'SIPR Policy Enforced (Raw)', visible: false },
    { id: 'siprBreakfix', label: 'SIPR Breakfix', visible: true },
    { id: 'highRisk', label: 'High Risk', visible: true },
    { id: 'scanExempt', label: 'Scan Exempt', visible: true },
];

// Default analytics layout (drag/drop grid) - also controls generated report visibility
const defaultAnalyticsLayout = [
    { id: 'totalBoats', type: 'stat', row: 0, col: 0 },
    { id: 'highRisk', type: 'stat', row: 0, col: 1 },
    { id: 'medRisk', type: 'stat', row: 0, col: 2 },
    { id: 'lowRisk', type: 'stat', row: 0, col: 3 },
    { id: 'avgVph', type: 'stat', row: 1, col: 0 },
    { id: 'totalBreakfix', type: 'stat', row: 1, col: 1 },
    { id: 'avgCompliance', type: 'stat', row: 1, col: 2 },
    { id: 'scanExempt', type: 'stat', row: 1, col: 3 },
    { id: 'riskDistribution', type: 'chart', row: 2, col: 0, width: 2 },
    { id: 'highRiskTable', type: 'chart', row: 2, col: 2, width: 2 },
    { id: 'worstBoatsVph', type: 'ranking', row: 3, col: 0 },
    { id: 'worstBoatsCompliance', type: 'ranking', row: 3, col: 1 },
    { id: 'boatsWithBreakfix', type: 'ranking', row: 3, col: 2 },
    { id: 'riskSummaryByIsic', type: 'table', row: 4, col: 0, width: 4 },
];

// Default legend text - updated to match new baseline risk criteria
const defaultLegendText = {
    high: 'Breakfix &gt; 0 OR No VRAM Scan (TAM &gt;{high_tam_past_due} optional)',
    med: '2+ of: VPH &gt;{med_ra_vph}, Prod/Policy compliance &lt;{med_ess_compliance}%, Scan &gt;{med_scan_age_days}d, TAM &gt;{med_tam_past_due}',
    low: 'VPH &lt;{low_vph}, Scans within {low_scan_age_days}d, Compliance &gt;{low_ess_compliance}%'
};

// Default threshold values for the new risk criteria
// Baseline: HIGH = Breakfix OR No Scan | MED = 2+ of criteria | LOW = all criteria met
const defaultThresholds = {
    // LOW risk thresholds (must meet ALL to be LOW)
    low_vph: 2.5,
    low_scan_age_days: 14,
    low_product_compliance: 95,      // Separate threshold for product compliance
    low_true_policy_compliance: 95,  // Separate threshold for true policy compliance
    // MED risk thresholds (2+ conditions trigger MED)
    med_ra_vph: 3.5,
    med_ess_compliance: 95,
    med_scan_age_days: 14,
    med_tam_past_due: 10,
    // HIGH risk thresholds (auto-HIGH if exceeded) - disabled by default except TAMs
    // Set to extreme values to effectively disable (Breakfix + No Scan are always HIGH)
    auto_high_ra_vph: 999,           // Disabled - VPH doesn't auto-trigger HIGH
    auto_high_scan_age_days: 999,    // Disabled - Old scans don't auto-trigger HIGH (No scan does)
    high_ess_compliance: 90,         // Enabled - True Policy compliance < 90% triggers HIGH
    high_raw_policy_compliance: 0,   // Disabled - Raw Policy compliance doesn't auto-trigger HIGH
    high_product_compliance: 0,      // Disabled - Low product compliance doesn't auto-trigger HIGH
    high_tam_past_due: 20,           // Optional - TAMs > 20 triggers HIGH (can be adjusted)
    // MED risk - policy toggles (both can be enabled/disabled independently)
    med_true_policy_compliance: 95,  // True policy threshold for MED (enabled by default)
    med_raw_policy_compliance: 0,    // Raw policy threshold for MED (disabled by default)
    // CSL/CSP Table Color scale thresholds (green/red, yellow is between)
    color_product_green: 95, color_product_red: 90,
    color_policy_green: 95, color_policy_red: 90,
    color_policy_raw_green: 95, color_policy_raw_red: 90,
    color_vph_green: 2.5, color_vph_red: 3.5,
    color_scan_green: 14, color_scan_red: 14,
    // HQ Status Table Color scale thresholds (separate from CSL/CSP)
    hq_color_product_green: 95, hq_color_product_red: 90,
    hq_color_policy_green: 95, hq_color_policy_red: 90,
    hq_color_policy_raw_green: 95, hq_color_policy_raw_red: 90,
    // LOW risk toggleable criteria (1 = enabled, 0 = disabled)
    low_product_compliance_enabled: 0,       // Disabled by default
    low_true_policy_compliance_enabled: 1,   // Enabled by default
};

// Default help modal text (? button content) - editable in settings
const defaultHelpModalText = {
    highItems: [
        'Breakfix > 0 - Any asset in either enclave in breakfix',
        'No VRAM Scan Data - Unable to assess risk without scan data',
        'TAM Past Due > {high_tam_past_due} - Optional HIGH trigger (adjustable)'
    ],
    medItems: [
        'VPH > {med_ra_vph} - Vulnerabilities per host above threshold',
        'Product/Policy Compliance < {med_ess_compliance}% - ESS compliance below threshold',
        'Scan Age > {med_scan_age_days} days - VRAM scan older than threshold',
        'TAM Past Due > {med_tam_past_due} - Too many overdue TAMs'
    ],
    lowItems: [
        'VPH < {low_vph} - Low vulnerabilities per host',
        'Scans within {low_scan_age_days} days - Recent scan data',
        'Compliance > {low_ess_compliance}% - High product and policy compliance',
        'No HIGH risk triggers present'
    ],
    calcItems: [
        'Scan Age = Days since last VRAM scan date',
        'VPH = Vulnerabilities Per Host (from VRAM RA VPH column)',
        'True Policy % = PolicyEnforced Ã— ProductCompliance / 100'
    ],
    scanExempt: 'If a boat is marked Scan Exempt, HIGH risk is downgraded to MED only when HIGH is due to "No VRAM Scan Data". Breakfix or other HIGH triggers (like TAMs > {high_tam_past_due}) are NOT affected by Scan Exempt status. For NMCI boats, both NIPR and SIPR must be exempt to apply the override.'
};

// Settings Manager with localStorage
const SETTINGS_STORAGE_KEY = 'cyberDashboard_settings';
const SETTINGS_VERSION = '1.0';

const SettingsManager = {
    // Get embedded defaults from HTML
    getEmbeddedDefaults() {
        try {
            return JSON.parse(document.getElementById('app-settings').textContent);
        } catch { return null; }
    },

    // Ensure settings have all required fields and versioning
    ensureDefaults(settings, options = {}) {
        if (!settings.schemaConfig) {
            settings.schemaConfig = JSON.parse(JSON.stringify(defaultSchemaConfig));
        } else {
            // Merge in any missing schema fields from defaults
            for (const type of ['vram', 'ess', 'tam']) {
                if (!settings.schemaConfig[type]) {
                    settings.schemaConfig[type] = JSON.parse(JSON.stringify(defaultSchemaConfig[type]));
                } else {
                    const existingFields = new Set(settings.schemaConfig[type].map(f => f.field));
                    for (const defaultField of defaultSchemaConfig[type]) {
                        if (!existingFields.has(defaultField.field)) {
                            settings.schemaConfig[type].push(JSON.parse(JSON.stringify(defaultField)));
                        }
                    }
                }
            }
        }
        if (!settings.tabConfig) settings.tabConfig = [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}];
        if (!settings.analyticsConfig) settings.analyticsConfig = JSON.parse(JSON.stringify(defaultAnalyticsConfig));
        if (!settings.analyticsLayout) settings.analyticsLayout = JSON.parse(JSON.stringify(defaultAnalyticsLayout));
        if (!settings.hqStatusLayout) {
            settings.hqStatusLayout = JSON.parse(JSON.stringify(defaultHQStatusLayout));
        } else {
            // Merge in any missing HQ metrics from defaults
            const existingIds = new Set(settings.hqStatusLayout.map(m => m.id));
            for (const defaultMetric of defaultHQStatusLayout) {
                if (!existingIds.has(defaultMetric.id)) {
                    settings.hqStatusLayout.push(JSON.parse(JSON.stringify(defaultMetric)));
                }
            }
        }
        if (!settings.legendText) settings.legendText = JSON.parse(JSON.stringify(defaultLegendText));
        if (!settings.helpModalText) settings.helpModalText = JSON.parse(JSON.stringify(defaultHelpModalText));
        // Ensure thresholds are populated with defaults if empty or missing
        if (!settings.thresholds || Object.keys(settings.thresholds).length === 0) {
            settings.thresholds = JSON.parse(JSON.stringify(defaultThresholds));
        } else {
            // Merge in any missing threshold keys from defaults
            for (const key of Object.keys(defaultThresholds)) {
                if (settings.thresholds[key] === undefined) {
                    settings.thresholds[key] = defaultThresholds[key];
                }
            }
            // Remove obsolete threshold keys (e.g., ra_crit was removed)
            const obsoleteKeys = ['auto_high_ra_crit', 'high_ra_crit', 'med_ra_crit', 'low_ra_crit', 'auto_high_scan_integrity', 'high_scan_age_days'];
            for (const key of obsoleteKeys) {
                delete settings.thresholds[key];
            }
        }

        // Initialize versioning if missing
        if (!settings._settingsVersion) {
            settings._settingsVersion = SETTINGS_VERSION;
            settings._settingsAuthor = options.author || 'Unknown';
            settings._settingsModified = new Date().toISOString();
            settings._settingsHistory = [];
        }

        // Migrate old columnMappings
        if (settings.columnMappings && !settings.schemaConfig) {
            settings.schemaConfig = this.migrateColumnMappings(settings.columnMappings);
            delete settings.columnMappings;
        }
        return settings;
    },

    // Load settings from localStorage, fall back to embedded defaults
    load() {
        try {
            const stored = localStorage.getItem(SETTINGS_STORAGE_KEY);
            if (stored) {
                const settings = JSON.parse(stored);
                return this.ensureDefaults(settings);
            }
        } catch (err) {
            console.error('Failed to load settings from localStorage:', err);
        }

        // Fall back to embedded defaults
        const embedded = this.getEmbeddedDefaults();
        if (embedded) {
            return this.ensureDefaults(embedded, { author: 'Default' });
        }
        return this.getDefaults();
    },

    // Save settings to localStorage
    save(settings) {
        try {
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(settings));
            return { success: true };
        } catch (err) {
            console.error('Failed to save settings to localStorage:', err);
            return { success: false, error: err.message };
        }
    },

    // Update settings version info when user makes changes
    updateVersion(settings, authorName) {
        const now = new Date().toISOString();
        const prevVersion = settings._settingsVersion || '1.0';
        const prevAuthor = settings._settingsAuthor || 'Unknown';
        const prevModified = settings._settingsModified;

        // Add to history
        if (!settings._settingsHistory) settings._settingsHistory = [];
        if (prevModified) {
            settings._settingsHistory.push({
                version: prevVersion,
                author: prevAuthor,
                modified: prevModified,
                savedAt: now
            });
            // Keep only last 10 history entries
            if (settings._settingsHistory.length > 10) {
                settings._settingsHistory = settings._settingsHistory.slice(-10);
            }
        }

        // Increment version
        const [major, minor] = prevVersion.split('.').map(Number);
        settings._settingsVersion = `${major}.${minor + 1}`;
        settings._settingsAuthor = authorName || prevAuthor;
        settings._settingsModified = now;

        return settings;
    },

    // Export settings as JSON download
    exportSettings(settings) {
        const jsonStr = JSON.stringify(settings, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `settings-v${settings._settingsVersion || '1.0'}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
    },

    // Import settings from JSON file
    importSettings() {
        return new Promise((resolve) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const text = await file.text();
                        const settings = JSON.parse(text);
                        resolve({ success: true, settings: this.ensureDefaults(settings) });
                    } catch (err) {
                        resolve({ success: false, error: err.message });
                    }
                } else {
                    resolve({ success: false, error: 'No file selected' });
                }
            };
            input.click();
        });
    },

    // Clear localStorage settings
    clear() {
        try {
            localStorage.removeItem(SETTINGS_STORAGE_KEY);
            return { success: true };
        } catch (err) {
            return { success: false, error: err.message };
        }
    },

    // Check if localStorage has saved settings
    hasSavedSettings() {
        return localStorage.getItem(SETTINGS_STORAGE_KEY) !== null;
    },

    migrateColumnMappings(old) {
        const labels = {
            vram: {siteName:'Site/Boat Name',scanDate:'Last Scan Date',assets:'Asset Count',raVph:'RA VPH',raCrit:'RA Critical',raHigh:'RA High',scanIntegrity:'Scan Integrity %',scanPercent:'Percent Scanned',scanExempt:'Scan Exempt'},
            ess: {shipName:'Ship/Boat Name',isic:'ISIC Column',productCompliance:'Product Compliance %',policyEnforced:'Policy Enforced %',truePolicy:'True Policy % (Calculated)',breakfix:'Breakfix Count',assets:'Asset Count'},
            tam: {boatName:'Boat Name',pastDue:'Past Due Count',extensions:'Extensions Count'}
        };
        const result = {};
        for (const type of ['vram', 'ess', 'tam']) {
            result[type] = [];
            if (old[type]) {
                for (const [field, vals] of Object.entries(old[type])) {
                    const col = Array.isArray(vals) ? vals[0] : vals;
                    result[type].push({field, label: labels[type]?.[field] || field, column: col || '', visible: true});
                }
            }
        }
        return result;
    },

    getDefaults() {
        return {
            _version: 1,
            _settingsVersion: SETTINGS_VERSION,
            _settingsAuthor: 'Default',
            _settingsModified: new Date().toISOString(),
            _settingsHistory: [],
            tycoms: ['CSL', 'CSP'],
            isics: [],
            boats: [],
            thresholds: JSON.parse(JSON.stringify(defaultThresholds)),
            display: {},
            user: { default_name: '' },
            schemaConfig: JSON.parse(JSON.stringify(defaultSchemaConfig)),
            tabConfig: [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}],
            analyticsConfig: JSON.parse(JSON.stringify(defaultAnalyticsConfig)),
            analyticsLayout: JSON.parse(JSON.stringify(defaultAnalyticsLayout)),
            hqStatusLayout: JSON.parse(JSON.stringify(defaultHQStatusLayout)),
            legendText: JSON.parse(JSON.stringify(defaultLegendText)),
            helpModalText: JSON.parse(JSON.stringify(defaultHelpModalText))
        };
    }
};

// Data Models
const createBoatData = (name, fullName, isic, tycom, isNmci = false) => ({
    boatName: name, boatFullName: fullName, isic, tycom, isNmci,
    essNiprAssets: null, essNiprBreakfix: null, essNiprProductCompliance: null, essNiprPolicyEnforced: null, essNiprTruePolicy: null,
    essSiprAssets: null, essSiprBreakfix: null, essSiprProductCompliance: null, essSiprPolicyEnforced: null, essSiprTruePolicy: null,
    vramNiprAssets: null, vramNiprScanDate: null, vramNiprRaVph: null, vramNiprRaCrit: null, vramNiprScanIntegrity: null, vramNiprScanPercent: null, vramNiprRaHigh: null, vramNiprScanExempt: false,
    vramSiprAssets: null, vramSiprScanDate: null, vramSiprRaVph: null, vramSiprRaCrit: null, vramSiprScanIntegrity: null, vramSiprScanPercent: null, vramSiprRaHigh: null, vramSiprScanExempt: false,
    tamPastDue: null, tamExtensions: null, riskLevel: 'LOW', riskReasons: [], overrides: [], notes: '',
    customFields: {} // Stores custom schema fields: { vramNipr: {}, vramSipr: {}, essNipr: {}, essSipr: {}, tam: {} }
});

// Standard fields for each schema type (used to identify custom fields)
const standardFields = {
    vram: ['siteName', 'scanDate', 'assets', 'raVph', 'raCrit', 'raHigh', 'scanIntegrity', 'scanPercent', 'scanExempt'],
    ess: ['shipName', 'isic', 'productCompliance', 'policyEnforced', 'truePolicy', 'breakfix', 'assets'],
    tam: ['boatName', 'pastDue', 'extensions']
};

// Get custom fields from schema (fields not in standard list)
const getCustomFields = (schemaArr, type) => {
    if (!schemaArr) return [];
    return schemaArr.filter(s => !standardFields[type].includes(s.field) && s.visible !== false);
};

// Parsers - use schema config from settings to build column maps
const parseVRAM = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.vram);
    const customFieldDefs = getCustomFields(schemaArr || defaultSchemaConfig.vram, 'vram');
    const wb = XLSX.read(data, { type: 'array', cellDates: true });
    // Find header row in first 5 rows
    const { data: rows } = findHeaderRow(wb, wb.SheetNames[0], m);
    const parsed = {};
    for (const row of rows) {
        const site = row[m.siteName]; if (!site) continue;
        const name = normalizeBoatName(site); if (!name) continue;
        let scanDate = null; const rawDate = row[m.scanDate];
        if (rawDate) { scanDate = rawDate instanceof Date ? rawDate : new Date(rawDate); if (isNaN(scanDate)) scanDate = null; }
        const custom = {};
        for (const cf of customFieldDefs) {
            if (m[cf.field]) custom[cf.field] = parseNumber(row[m[cf.field]]) ?? row[m[cf.field]] ?? null;
        }
        parsed[name] = { fullName: site, scanDate: scanDate?.toISOString() || null, assets: parseNumber(row[m.assets]), raVph: parseNumber(row[m.raVph]), raCrit: parseNumber(row[m.raCrit]), scanIntegrity: parseNumber(row[m.scanIntegrity]), scanPercent: parseNumber(row[m.scanPercent]), raHigh: parseNumber(row[m.raHigh]), scanExempt: String(row[m.scanExempt]).toLowerCase() === 'true', custom };
    }
    return { parsed, raw: rows, customFieldDefs };
};

const parseESS = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.ess);
    const customFieldDefs = getCustomFields(schemaArr || defaultSchemaConfig.ess, 'ess');
    const wb = XLSX.read(data, { type: 'array' });
    // Find header row in first 5 rows
    const { data: rows } = findHeaderRow(wb, wb.SheetNames[0], m);
    const parsed = {}; const isicMap = {};
    for (const row of rows) {
        const ship = row[m.shipName]; if (!ship) continue;
        const name = normalizeBoatName(ship); if (!name) continue;
        const isic = row[m.isic]; if (isic) isicMap[name] = String(isic).trim();
        const prodComp = parsePercent(row[m.productCompliance]); const polEnf = parsePercent(row[m.policyEnforced]);
        const truePolicy = (prodComp !== null && polEnf !== null) ? (polEnf * prodComp / 100) : null;
        const custom = {};
        for (const cf of customFieldDefs) {
            if (m[cf.field]) custom[cf.field] = parseNumber(row[m[cf.field]]) ?? row[m[cf.field]] ?? null;
        }
        parsed[name] = { assets: parseNumber(row[m.assets]), breakfix: parseNumber(row[m.breakfix]), productCompliance: prodComp, policyEnforced: polEnf, truePolicy, custom };
    }
    return { parsed, isicMap, raw: rows, customFieldDefs };
};

const parseTAM = (data, schemaArr) => {
    const m = buildColumnMap(schemaArr || defaultSchemaConfig.tam);
    const customFieldDefs = getCustomFields(schemaArr || defaultSchemaConfig.tam, 'tam');
    const wb = XLSX.read(data, { type: 'array' });
    // Find header row in first 5 rows
    const { data: rows } = findHeaderRow(wb, wb.SheetNames[0], m);
    const parsed = {};
    for (const row of rows) {
        const boat = row[m.boatName]; if (!boat) continue;
        const name = normalizeBoatName(boat); if (!name) continue;
        const custom = {};
        for (const cf of customFieldDefs) {
            if (m[cf.field]) custom[cf.field] = parseNumber(row[m[cf.field]]) ?? row[m[cf.field]] ?? null;
        }
        parsed[name] = { pastDue: parseNumber(row[m.pastDue]), extensions: parseNumber(row[m.extensions]), custom };
    }
    return { parsed, raw: rows, customFieldDefs };
};

// Merge Data
const mergeData = (sources, settings) => {
    const { vramNipr, vramSipr, essNipr, essSipr, tam } = sources;
    const boats = []; const unregistered = new Set(); const registry = {};
    for (const b of settings.boats) if (b.active !== false) registry[b.boat_name] = b;
    const allNames = new Set([...Object.keys(vramNipr?.parsed||{}), ...Object.keys(vramSipr?.parsed||{}), ...Object.keys(essNipr?.parsed||{}), ...Object.keys(essSipr?.parsed||{}), ...Object.keys(tam?.parsed||{})]);

    for (const name of Object.keys(registry)) {
        const reg = registry[name]; const boat = createBoatData(reg.boat_name, reg.boat_full_name, reg.isic, reg.tycom, reg.nmci === true);
        boat.customFields = { vramNipr: {}, vramSipr: {}, essNipr: {}, essSipr: {}, tam: {} };
        // For NMCI boats, skip NIPR data entirely - mark columns as NMCI
        if (!boat.isNmci) {
            const vn = vramNipr?.parsed?.[name]; if (vn) { boat.vramNiprAssets = vn.assets; boat.vramNiprScanDate = vn.scanDate; boat.vramNiprRaVph = vn.raVph; boat.vramNiprRaCrit = vn.raCrit; boat.vramNiprScanIntegrity = vn.scanIntegrity; boat.vramNiprScanPercent = vn.scanPercent; boat.vramNiprRaHigh = vn.raHigh; boat.vramNiprScanExempt = vn.scanExempt; if (vn.custom) boat.customFields.vramNipr = vn.custom; }
            const en = essNipr?.parsed?.[name]; if (en) { boat.essNiprAssets = en.assets; boat.essNiprBreakfix = en.breakfix; boat.essNiprProductCompliance = en.productCompliance; boat.essNiprPolicyEnforced = en.policyEnforced; boat.essNiprTruePolicy = en.truePolicy; if (en.custom) boat.customFields.essNipr = en.custom; }
        }
        const vs = vramSipr?.parsed?.[name]; if (vs) { boat.vramSiprAssets = vs.assets; boat.vramSiprScanDate = vs.scanDate; boat.vramSiprRaVph = vs.raVph; boat.vramSiprRaCrit = vs.raCrit; boat.vramSiprScanIntegrity = vs.scanIntegrity; boat.vramSiprScanPercent = vs.scanPercent; boat.vramSiprRaHigh = vs.raHigh; boat.vramSiprScanExempt = vs.scanExempt; if (vs.custom) boat.customFields.vramSipr = vs.custom; }
        const es = essSipr?.parsed?.[name]; if (es) { boat.essSiprAssets = es.assets; boat.essSiprBreakfix = es.breakfix; boat.essSiprProductCompliance = es.productCompliance; boat.essSiprPolicyEnforced = es.policyEnforced; boat.essSiprTruePolicy = es.truePolicy; if (es.custom) boat.customFields.essSipr = es.custom; }
        const t = tam?.parsed?.[name]; if (t) { boat.tamPastDue = t.pastDue; boat.tamExtensions = t.extensions; if (t.custom) boat.customFields.tam = t.custom; }
        boats.push(boat);
    }
    for (const name of allNames) if (!registry[name]) unregistered.add(name);
    return { boats, unregistered: Array.from(unregistered) };
};

// Risk Calculator
// RISK CRITERIA (all thresholds are configurable in Settings > Thresholds):
// HIGH: Breakfix > 0, no VRAM data, Product Compliance < {high_product_compliance}%, VPH > {auto_high_ra_vph},
//       Scan > {auto_high_scan_age_days}d, Policy Compliance < {high_ess_compliance}%, TAMs > {high_tam_past_due}
// MED: 2+ of: VPH > {med_ra_vph}, Compliance < {med_ess_compliance}%, Scan > {med_scan_age_days}d, TAMs > {med_tam_past_due}
// LOW: VPH < {low_vph}, Scans within {low_scan_age_days}d, Compliance > {low_ess_compliance}%, no HIGH triggers
// NOTE: For NMCI boats, NIPR data is ignored entirely (they use Navy network, not SUBFOR)
const calculateRisk = (boat, thresholds) => {
    const reasons = [];
    let level = 'LOW';
    let highDueToNoScans = false;
    const isNmci = boat.isNmci === true;

    const scanAge = (d) => {
        if (!d) return null;
        const date = new Date(d);
        if (isNaN(date.getTime())) return null;
        const age = Math.floor((new Date() - date) / 86400000);
        return (isFinite(age) && age >= 0) ? age : null;
    };

    const nAge = isNmci ? null : scanAge(boat.vramNiprScanDate);
    const sAge = scanAge(boat.vramSiprScanDate);

    // Check if we have VRAM data - if no VRAM data at all, it's HIGH risk (can't assess)
    // For NMCI boats, only check SIPR data (NIPR is on NMCI network)
    const hasNiprVramData = isNmci ? true : (boat.vramNiprScanDate !== null || boat.vramNiprRaVph !== null || boat.vramNiprAssets !== null);
    const hasSiprVramData = boat.vramSiprScanDate !== null || boat.vramSiprRaVph !== null || boat.vramSiprAssets !== null;
    const hasAnyVramData = hasNiprVramData || hasSiprVramData;

    // Check if we have ESS data
    // For NMCI boats, only check SIPR data
    const hasNiprEssData = isNmci ? true : (boat.essNiprProductCompliance !== null || boat.essNiprBreakfix !== null || boat.essNiprAssets !== null);
    const hasSiprEssData = boat.essSiprProductCompliance !== null || boat.essSiprBreakfix !== null || boat.essSiprAssets !== null;
    const hasAnyEssData = hasNiprEssData || hasSiprEssData;

    // HIGH RISK TRIGGERS
    // 1. Any asset in breakfix (either enclave) - skip NIPR for NMCI boats
    if (!isNmci && (boat.essNiprBreakfix || 0) > 0) {
        level = 'HIGH';
        reasons.push(`NIPR Breakfix: ${boat.essNiprBreakfix}`);
    }
    if ((boat.essSiprBreakfix || 0) > 0) {
        level = 'HIGH';
        reasons.push(`SIPR Breakfix: ${boat.essSiprBreakfix}`);
    }

    // 2. No VRAM scan data (can't assess risk) - for NMCI, only require SIPR
    if (!hasAnyVramData || (isNmci && !hasSiprVramData)) {
        level = 'HIGH';
        reasons.push('No VRAM data');
        highDueToNoScans = true;
    }

    // 3. ESS Product Compliance < high_product_compliance (critical compliance failure) - skip NIPR for NMCI
    const highProductComplianceThreshold = thresholds.high_product_compliance || 50;
    if (!isNmci && boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < highProductComplianceThreshold) {
        level = 'HIGH';
        reasons.push(`NIPR Prod: ${boat.essNiprProductCompliance.toFixed(1)}%`);
    }
    if (boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < highProductComplianceThreshold) {
        level = 'HIGH';
        reasons.push(`SIPR Prod: ${boat.essSiprProductCompliance.toFixed(1)}%`);
    }

    // 4. VPH exceeds auto_high_ra_vph threshold (critical vulnerability level) - skip NIPR for NMCI
    const autoHighVphThreshold = thresholds.auto_high_ra_vph || 5;
    if (!isNmci && boat.vramNiprRaVph !== null && boat.vramNiprRaVph > autoHighVphThreshold) {
        level = 'HIGH';
        reasons.push(`NIPR VPH: ${boat.vramNiprRaVph.toFixed(2)}`);
    }
    if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph > autoHighVphThreshold) {
        level = 'HIGH';
        reasons.push(`SIPR VPH: ${boat.vramSiprRaVph.toFixed(2)}`);
    }

    // 5. Scan age exceeds auto_high_scan_age_days threshold (critically outdated scans) - skip NIPR for NMCI
    const autoHighScanAgeThreshold = thresholds.auto_high_scan_age_days || 30;
    if (!isNmci && nAge !== null && nAge > autoHighScanAgeThreshold) {
        level = 'HIGH';
        reasons.push(`NIPR Scan: ${nAge}d`);
    }
    if (sAge !== null && sAge > autoHighScanAgeThreshold) {
        level = 'HIGH';
        reasons.push(`SIPR Scan: ${sAge}d`);
    }

    // 6. ESS True Policy Compliance below high_ess_compliance threshold - skip NIPR for NMCI
    const highEssComplianceThreshold = thresholds.high_ess_compliance || 0;
    if (highEssComplianceThreshold > 0) {
        if (!isNmci && boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < highEssComplianceThreshold) {
            level = 'HIGH';
            reasons.push(`NIPR True Policy: ${boat.essNiprTruePolicy.toFixed(1)}%`);
        }
        if (boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < highEssComplianceThreshold) {
            level = 'HIGH';
            reasons.push(`SIPR True Policy: ${boat.essSiprTruePolicy.toFixed(1)}%`);
        }
    }

    // 6b. ESS Raw Policy Compliance below high_raw_policy_compliance threshold - skip NIPR for NMCI
    const highRawPolicyThreshold = thresholds.high_raw_policy_compliance || 0;
    if (highRawPolicyThreshold > 0) {
        if (!isNmci && boat.essNiprPolicyEnforced !== null && boat.essNiprPolicyEnforced < highRawPolicyThreshold) {
            level = 'HIGH';
            reasons.push(`NIPR Raw Policy: ${boat.essNiprPolicyEnforced.toFixed(1)}%`);
        }
        if (boat.essSiprPolicyEnforced !== null && boat.essSiprPolicyEnforced < highRawPolicyThreshold) {
            level = 'HIGH';
            reasons.push(`SIPR Raw Policy: ${boat.essSiprPolicyEnforced.toFixed(1)}%`);
        }
    }

    // 7. TAM past due exceeds high_tam_past_due threshold (critical maintenance backlog)
    const highTamThreshold = thresholds.high_tam_past_due || 20;
    if ((boat.tamPastDue || 0) > highTamThreshold) {
        level = 'HIGH';
        reasons.push(`TAMs: ${boat.tamPastDue}`);
    }

    // If not already HIGH, check MEDIUM criteria
    if (level !== 'HIGH') {
        // MED RISK: 2 or more of the following conditions
        let medConditionCount = 0;
        const medReasons = [];

        // Condition 1: Any enclave VPH > 3.5 (or threshold med_ra_vph) - skip NIPR for NMCI
        const vphThreshold = thresholds.med_ra_vph || 3.5;
        if (!isNmci && boat.vramNiprRaVph !== null && boat.vramNiprRaVph > vphThreshold) {
            medConditionCount++;
            medReasons.push(`NIPR VPH: ${boat.vramNiprRaVph.toFixed(2)}`);
        }
        if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph > vphThreshold) {
            medConditionCount++;
            medReasons.push(`SIPR VPH: ${boat.vramSiprRaVph.toFixed(2)}`);
        }

        // Condition 2: Product Compliance - always enabled - skip NIPR for NMCI
        const complianceThreshold = thresholds.med_ess_compliance || 95;
        if (!isNmci && boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < complianceThreshold) {
            medConditionCount++;
            medReasons.push(`NIPR Prod: ${boat.essNiprProductCompliance.toFixed(1)}%`);
        }
        if (boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < complianceThreshold) {
            medConditionCount++;
            medReasons.push(`SIPR Prod: ${boat.essSiprProductCompliance.toFixed(1)}%`);
        }

        // Condition 2b: True Policy compliance check (toggleable) - skip NIPR for NMCI
        const truePolicyThreshold = thresholds.med_true_policy_compliance || 0;
        if (truePolicyThreshold > 0) {
            if (!isNmci && boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < truePolicyThreshold) {
                medConditionCount++;
                medReasons.push(`NIPR True Policy: ${boat.essNiprTruePolicy.toFixed(1)}%`);
            }
            if (boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < truePolicyThreshold) {
                medConditionCount++;
                medReasons.push(`SIPR True Policy: ${boat.essSiprTruePolicy.toFixed(1)}%`);
            }
        }

        // Condition 2c: Raw Policy compliance check (toggleable) - skip NIPR for NMCI
        const rawPolicyThreshold = thresholds.med_raw_policy_compliance || 0;
        if (rawPolicyThreshold > 0) {
            if (!isNmci && boat.essNiprPolicyEnforced !== null && boat.essNiprPolicyEnforced < rawPolicyThreshold) {
                medConditionCount++;
                medReasons.push(`NIPR Raw Policy: ${boat.essNiprPolicyEnforced.toFixed(1)}%`);
            }
            if (boat.essSiprPolicyEnforced !== null && boat.essSiprPolicyEnforced < rawPolicyThreshold) {
                medConditionCount++;
                medReasons.push(`SIPR Raw Policy: ${boat.essSiprPolicyEnforced.toFixed(1)}%`);
            }
        }

        // Condition 3: Any enclave with scan greater than 14 days - skip NIPR for NMCI
        const scanThreshold = thresholds.med_scan_age_days || 14;
        if (!isNmci && nAge !== null && nAge > scanThreshold) {
            medConditionCount++;
            medReasons.push(`NIPR Scan: ${nAge}d`);
        }
        if (sAge !== null && sAge > scanThreshold) {
            medConditionCount++;
            medReasons.push(`SIPR Scan: ${sAge}d`);
        }

        // Condition 4: TAMs past due > 10 (or threshold med_tam_past_due)
        const tamThreshold = thresholds.med_tam_past_due || 10;
        if ((boat.tamPastDue || 0) > tamThreshold) {
            medConditionCount++;
            medReasons.push(`TAMs: ${boat.tamPastDue}`);
        }

        // If 2 or more conditions, it's MED risk
        if (medConditionCount >= 2) {
            level = 'MED';
            reasons.push(...medReasons);
        } else if (medConditionCount === 1) {
            // Still track single condition issues but remain LOW
            // (unless VPH is above the higher threshold)
        }

        // Note: Per risk criteria, HIGH is ONLY for breakfix or no VRAM data
        // VPH conditions only contribute to MED risk threshold calculation
    }

    // Check if LOW risk criteria are actually met (for reporting purposes)
    // LOW: VPH <2.5, scans within 14 days, compliance >95% (if enabled)
    if (level === 'LOW') {
        const lowVphThreshold = thresholds.low_vph || 2.5;
        const lowScanThreshold = thresholds.low_scan_age_days || 14;
        const lowProductThreshold = thresholds.low_product_compliance || 95;
        const lowTruePolicyThreshold = thresholds.low_true_policy_compliance || 95;
        const productCompEnabled = (thresholds.low_product_compliance_enabled ?? 0) === 1;
        const truePolicyEnabled = (thresholds.low_true_policy_compliance_enabled ?? 1) === 1;

        // Verify LOW criteria
        let meetsLowCriteria = true;
        if (boat.vramNiprRaVph !== null && boat.vramNiprRaVph >= lowVphThreshold) meetsLowCriteria = false;
        if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph >= lowVphThreshold) meetsLowCriteria = false;
        if (nAge !== null && nAge > lowScanThreshold) meetsLowCriteria = false;
        if (sAge !== null && sAge > lowScanThreshold) meetsLowCriteria = false;
        // Only check product compliance if enabled
        if (productCompEnabled) {
            if (boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < lowProductThreshold) meetsLowCriteria = false;
            if (boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < lowProductThreshold) meetsLowCriteria = false;
        }
        // Only check true policy compliance if enabled
        if (truePolicyEnabled) {
            if (boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < lowTruePolicyThreshold) meetsLowCriteria = false;
            if (boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < lowTruePolicyThreshold) meetsLowCriteria = false;
        }

        if (!meetsLowCriteria) {
            // Upgrade to MED if doesn't meet LOW criteria but not bad enough for HIGH
            level = 'MED';
            if (boat.vramNiprRaVph !== null && boat.vramNiprRaVph >= lowVphThreshold) reasons.push(`NIPR VPH: ${boat.vramNiprRaVph.toFixed(2)}`);
            if (boat.vramSiprRaVph !== null && boat.vramSiprRaVph >= lowVphThreshold) reasons.push(`SIPR VPH: ${boat.vramSiprRaVph.toFixed(2)}`);
            if (nAge !== null && nAge > lowScanThreshold) reasons.push(`NIPR Scan: ${nAge}d`);
            if (sAge !== null && sAge > lowScanThreshold) reasons.push(`SIPR Scan: ${sAge}d`);
            if (productCompEnabled && boat.essNiprProductCompliance !== null && boat.essNiprProductCompliance < lowProductThreshold) reasons.push(`NIPR Prod: ${boat.essNiprProductCompliance.toFixed(1)}%`);
            if (truePolicyEnabled && boat.essNiprTruePolicy !== null && boat.essNiprTruePolicy < lowTruePolicyThreshold) reasons.push(`NIPR True Policy: ${boat.essNiprTruePolicy.toFixed(1)}%`);
            if (productCompEnabled && boat.essSiprProductCompliance !== null && boat.essSiprProductCompliance < lowProductThreshold) reasons.push(`SIPR Prod: ${boat.essSiprProductCompliance.toFixed(1)}%`);
            if (truePolicyEnabled && boat.essSiprTruePolicy !== null && boat.essSiprTruePolicy < lowTruePolicyThreshold) reasons.push(`SIPR True Policy: ${boat.essSiprTruePolicy.toFixed(1)}%`);
        }
    }

    // Scan Exempt Logic:
    // - For NMCI boats: Only apply exemption if BOTH NIPR AND SIPR are exempt
    //   (If only NIPR is exempt, ignore it since NMCI doesn't use NIPR)
    // - For non-NMCI boats: Apply exemption if either enclave is exempt
    // - Only downgrades HIGH to MED if HIGH was SOLELY due to no VRAM data
    // - Breakfix or other HIGH reasons are NOT overridden by Scan Exempt
    if (level === 'HIGH') {
        let isScanExempt = false;
        if (boat.isNmci) {
            // NMCI boats: only exempt if BOTH enclaves are exempt
            // (since NMCI doesn't use NIPR, only NIPR exempt = not truly exempt)
            isScanExempt = boat.vramNiprScanExempt && boat.vramSiprScanExempt;
        } else {
            // Non-NMCI boats: exempt if either enclave is exempt
            isScanExempt = boat.vramNiprScanExempt || boat.vramSiprScanExempt;
        }

        if (isScanExempt && highDueToNoScans && reasons.every(r => r.includes('VRAM data'))) {
            level = 'MED';
            reasons.push('Scan Exempt');
        }
    }

    return { level, reasons };
};

const calculateAllRisks = (boats, thresholds) => { for (const b of boats) { const { level, reasons } = calculateRisk(b, thresholds); b.riskLevel = level; b.riskReasons = reasons; } return boats; };

// Aggregations
const aggregateByISIC = (boats, settings) => {
    const groups = {};
    for (const b of boats) {
        if (!groups[b.isic]) { const info = settings.isics.find(i => i.isic_name === b.isic) || { isic_name: b.isic, isic_short: b.isic.slice(0,6), tycom: b.tycom }; groups[b.isic] = { ...info, boats: [] }; }
        groups[b.isic].boats.push(b);
    }
    const aggs = Object.values(groups).map(g => {
        let nProdSum = 0, nProdCnt = 0, nPolSum = 0, nPolCnt = 0, nPolRawSum = 0, nPolRawCnt = 0;
        let sProdSum = 0, sProdCnt = 0, sPolSum = 0, sPolCnt = 0, sPolRawSum = 0, sPolRawCnt = 0;
        const agg = { isicName: g.isic_name, isicShort: g.isic_short, tycom: g.tycom, boatCount: g.boats.length, niprBreakfixSum: 0, siprBreakfixSum: 0, highRiskCount: 0, scanExemptCount: 0, niprProdCompAvg: 0, niprPolEnfAvg: 0, niprPolRawAvg: 0, siprProdCompAvg: 0, siprPolEnfAvg: 0, siprPolRawAvg: 0 };
        for (const b of g.boats) {
            // Skip NIPR values for NMCI boats
            if (!b.isNmci) {
                agg.niprBreakfixSum += b.essNiprBreakfix || 0;
                if (b.essNiprProductCompliance !== null) { nProdSum += b.essNiprProductCompliance; nProdCnt++; }
                if (b.essNiprTruePolicy !== null) { nPolSum += b.essNiprTruePolicy; nPolCnt++; }
                if (b.essNiprPolicyEnforced !== null) { nPolRawSum += b.essNiprPolicyEnforced; nPolRawCnt++; }
            }
            agg.siprBreakfixSum += b.essSiprBreakfix || 0;
            if (b.essSiprProductCompliance !== null) { sProdSum += b.essSiprProductCompliance; sProdCnt++; }
            if (b.essSiprTruePolicy !== null) { sPolSum += b.essSiprTruePolicy; sPolCnt++; }
            if (b.essSiprPolicyEnforced !== null) { sPolRawSum += b.essSiprPolicyEnforced; sPolRawCnt++; }
            if (b.riskLevel === 'HIGH') agg.highRiskCount++;
            if (b.vramNiprScanExempt || b.vramSiprScanExempt) agg.scanExemptCount++;
        }
        agg.niprProdCompAvg = nProdCnt > 0 ? Math.min(100, nProdSum / nProdCnt) : 0;
        agg.niprPolEnfAvg = nPolCnt > 0 ? Math.min(100, nPolSum / nPolCnt) : 0;
        agg.niprPolRawAvg = nPolRawCnt > 0 ? Math.min(100, nPolRawSum / nPolRawCnt) : 0;
        agg.siprProdCompAvg = sProdCnt > 0 ? Math.min(100, sProdSum / sProdCnt) : 0;
        agg.siprPolEnfAvg = sPolCnt > 0 ? Math.min(100, sPolSum / sPolCnt) : 0;
        agg.siprPolRawAvg = sPolRawCnt > 0 ? Math.min(100, sPolRawSum / sPolRawCnt) : 0;
        return agg;
    });
    return { csl: aggs.filter(a => a.tycom === 'CSL'), csp: aggs.filter(a => a.tycom === 'CSP') };
};

// Encoding
const compressAndEncode = (data) => { const json = JSON.stringify(data); const b64 = btoa(unescape(encodeURIComponent(json))); let h = 0; for (let i = 0; i < json.length; i++) { h = ((h << 5) - h) + json.charCodeAt(i); h &= h; } return Math.abs(h).toString(16) + ':' + b64; };
const decodeAndDecompress = (str) => { const [hash, b64] = str.split(':'); const json = decodeURIComponent(escape(atob(b64))); const data = JSON.parse(json); let h = 0; for (let i = 0; i < json.length; i++) { h = ((h << 5) - h) + json.charCodeAt(i); h &= h; } return { data, valid: Math.abs(h).toString(16) === hash }; };

// Import Report
const importReportHTML = async (file) => new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const match = e.target.result.match(/<script type="application\/x-dashboard-report">([\s\S]*?)<\/script>/);
            if (!match) { resolve({ error: 'No embedded data' }); return; }
            const { data, valid } = decodeAndDecompress(match[1].trim());
            data.reportData.version++; data.reportData.lastModifiedAt = new Date().toISOString();
            resolve({ reportData: data.reportData, settings: data.settingsSnapshot, valid, error: null });
        } catch (err) { resolve({ error: err.message }); }
    };
    reader.readAsText(file);
});

// Report Generator
const generateReportHTML = (reportData, settings) => {
    const { boats } = reportData; const aggs = aggregateByISIC(boats, settings);
    const groupByISIC = (list) => { const g = {}; for (const b of list) { if (!g[b.isic]) g[b.isic] = []; g[b.isic].push(b); } return g; };
    const cslBoats = boats.filter(b => b.tycom === 'CSL'); const cspBoats = boats.filter(b => b.tycom === 'CSP');
    const cslByISIC = groupByISIC(cslBoats); const cspByISIC = groupByISIC(cspBoats);
    const embedded = compressAndEncode({ reportData, settingsSnapshot: settings, generatedAt: new Date().toISOString() });

    const fmt = (v, d=0) => v == null ? '-' : (d > 0 ? v.toFixed(d) : Math.round(v).toString());
    const fmtPct = (v) => v == null ? '-' : Math.min(100, v).toFixed(1) + '%';
    const fmtDate = (d) => d ? `${new Date(d).getMonth()+1}/${new Date(d).getDate()}` : '-';
    // ===================================================================================
    // COLOR CLASSIFICATION FUNCTIONS
    // ===================================================================================
    // Boundary Behavior: "Boundary Gets Better Color"
    // - Values exactly on a threshold boundary are assigned the better/healthier color
    // - For compliance metrics (higher is better): boundary value gets the better color
    //   Example: If green >= 95 and red < 90, then 95 = GREEN, 90 = YELLOW (not red)
    // - For VPH (lower is better): boundary value gets the better color
    //   Example: If green <= 2.5 and red > 3.5, then 2.5 = GREEN, 3.5 = YELLOW (not red)
    // ===================================================================================
    const sth = settings.thresholds || defaultThresholds;

    // Product Compliance (higher is better):
    //   GREEN: value >= green_threshold (e.g., >= 95)
    //   RED:   value < red_threshold (e.g., < 90)
    //   YELLOW: red_threshold <= value < green_threshold (e.g., 90-94.99)
    const prodCompClass = (v) => v === null ? '' : v >= (sth.color_product_green || 95) ? 'risk-low' : v < (sth.color_product_red || 90) ? 'risk-high' : 'risk-med';

    // Policy Compliance / True Policy (higher is better):
    //   GREEN: value >= green_threshold | RED: value < red_threshold | YELLOW: between
    const policyCompClass = (v) => v === null ? '' : v >= (sth.color_policy_green || 95) ? 'risk-low' : v < (sth.color_policy_red || 90) ? 'risk-high' : 'risk-med';

    // Policy Enforced Raw (higher is better):
    //   GREEN: value >= green_threshold | RED: value < red_threshold | YELLOW: between
    const policyRawClass = (v) => v === null ? '' : v >= (sth.color_policy_raw_green || 95) ? 'risk-low' : v < (sth.color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';

    // Generic compliance class (backward compat)
    const compClass = prodCompClass;

    // VPH - Vulnerabilities Per Host (lower is better):
    //   GREEN: value <= green_threshold (e.g., <= 2.5) - boundary gets better color
    //   RED:   value > red_threshold (e.g., > 3.5) - boundary gets better color
    //   YELLOW: green_threshold < value <= red_threshold (e.g., 2.51-3.5)
    const vphClass = (v) => v === null ? '' : v <= (sth.color_vph_green || 2.5) ? 'risk-low' : v > (sth.color_vph_red || 3.5) ? 'risk-high' : 'risk-med';

    // Scan Age in days (lower is better):
    //   GREEN: age <= green_threshold (e.g., <= 14 days)
    //   RED:   age > red_threshold (e.g., > 14 days)
    //   YELLOW: between (if thresholds differ)
    const scanAgeClass = (d) => {
        if (!d) return 'risk-high';
        const date = new Date(d);
        if (isNaN(date.getTime())) return 'risk-high';
        const age = Math.floor((new Date() - date) / 86400000);
        return age <= (sth.color_scan_green || 14) ? 'risk-low' : age > (sth.color_scan_red || 14) ? 'risk-high' : 'risk-med';
    };

    // Format legend text by substituting threshold values
    const legendText = settings.legendText || defaultLegendText;
    const formatLegend = (text) => {
        return text.replace(/\{(\w+)\}/g, (match, key) => {
            return settings.thresholds[key] !== undefined ? settings.thresholds[key] : match;
        }).replace(/</g, '&lt;').replace(/>/g, '&gt;');
    };

    // Help modal text (? button content)
    const helpModalText = settings.helpModalText || defaultHelpModalText;
    const formatHelpText = (text) => {
        if (!text) return '';
        return text.replace(/\{(\w+)\}/g, (match, key) => {
            return settings.thresholds[key] !== undefined ? settings.thresholds[key] : match;
        });
    };

    // Stats for analytics
    const riskCounts = { HIGH: boats.filter(b => b.riskLevel === 'HIGH').length, MED: boats.filter(b => b.riskLevel === 'MED').length, LOW: boats.filter(b => b.riskLevel === 'LOW').length };
    const cslRiskCounts = { HIGH: cslBoats.filter(b => b.riskLevel === 'HIGH').length, MED: cslBoats.filter(b => b.riskLevel === 'MED').length, LOW: cslBoats.filter(b => b.riskLevel === 'LOW').length };
    const cspRiskCounts = { HIGH: cspBoats.filter(b => b.riskLevel === 'HIGH').length, MED: cspBoats.filter(b => b.riskLevel === 'MED').length, LOW: cspBoats.filter(b => b.riskLevel === 'LOW').length };
    // Avg VPH: average of all VPH values (NIPR for non-NMCI, SIPR for all) - only count non-null values
    const vphValues = boats.flatMap(b => {
        const vals = [];
        if (!b.isNmci && b.vramNiprRaVph !== null) vals.push(b.vramNiprRaVph);
        if (b.vramSiprRaVph !== null) vals.push(b.vramSiprRaVph);
        return vals;
    });
    const avgVph = vphValues.length > 0 ? (vphValues.reduce((s, v) => s + v, 0) / vphValues.length).toFixed(2) : 0;
    // Total breakfix: sum all (NIPR only for non-NMCI boats)
    const totalBreakfix = boats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
    // Avg compliance: average of all compliance values (NIPR for non-NMCI, SIPR for all) - only count non-null
    const compValues = boats.flatMap(b => {
        const vals = [];
        if (!b.isNmci && b.essNiprProductCompliance !== null) vals.push(b.essNiprProductCompliance);
        if (b.essSiprProductCompliance !== null) vals.push(b.essSiprProductCompliance);
        return vals;
    });
    const avgCompliance = compValues.length > 0 ? Math.min(100, compValues.reduce((s, v) => s + v, 0) / compValues.length).toFixed(1) : 0;

    // TYCOM data for charts (defined at outer scope so it's available for the script section)
    const tycomData = {};
    boats.forEach(b => {
        if (!tycomData[b.tycom]) tycomData[b.tycom] = {boats:0,high:0,med:0,low:0,vphVals:[],bfSum:0,compVals:[]};
        const t=tycomData[b.tycom]; t.boats++;
        if(b.riskLevel==='HIGH')t.high++; if(b.riskLevel==='MED')t.med++; if(b.riskLevel==='LOW')t.low++;
        if (!b.isNmci && b.vramNiprRaVph !== null) t.vphVals.push(b.vramNiprRaVph);
        if (b.vramSiprRaVph !== null) t.vphVals.push(b.vramSiprRaVph);
        t.bfSum += (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);
        if (!b.isNmci && b.essNiprProductCompliance !== null) t.compVals.push(b.essNiprProductCompliance);
        if (b.essSiprProductCompliance !== null) t.compVals.push(b.essSiprProductCompliance);
    });

    // Get label and visibility from schema config
    const schema = settings.schemaConfig || defaultSchemaConfig;
    const getLabel = (type, field, fallback) => {
        const item = schema[type]?.find(s => s.field === field);
        return item?.label || fallback;
    };
    const isVisible = (type, field) => {
        const item = schema[type]?.find(s => s.field === field);
        return item?.visible !== false;
    };

    // Custom fields for each type (visible fields not in standard list)
    const essCustomFields = getCustomFields(schema.ess, 'ess');
    const vramCustomFields = getCustomFields(schema.vram, 'vram');
    const tamCustomFields = getCustomFields(schema.tam, 'tam');

    // Get visible standard fields in schema order (excluding meta fields)
    const getVisibleStandardFields = (schemaArray, metaFields) => {
        return schemaArray.filter(f => f.visible !== false && !metaFields.includes(f.field) && standardFields[schemaArray === schema.ess ? 'ess' : schemaArray === schema.vram ? 'vram' : 'tam'].includes(f.field));
    };
    const essMetaFields = ['shipName', 'isic'];
    const vramMetaFields = ['siteName', 'scanExempt'];
    const tamMetaFields = ['boatName'];

    const essVisibleFields = getVisibleStandardFields(schema.ess, essMetaFields);
    const vramVisibleFields = getVisibleStandardFields(schema.vram, vramMetaFields);
    const tamVisibleFields = getVisibleStandardFields(schema.tam, tamMetaFields);

    // Column counts based on schema order
    const essNiprCount = essVisibleFields.length + essCustomFields.length;
    const essSiprCount = essNiprCount;
    const vramNiprCount = vramVisibleFields.length + vramCustomFields.length;
    const vramSiprCount = vramNiprCount;
    const tamCount = tamVisibleFields.length + tamCustomFields.length;
    const showVramExempt = isVisible('vram', 'scanExempt');
    const statusCount = 1 + (showVramExempt ? 1 : 0) + 1;

    // Field renderers for ESS (NIPR and SIPR)
    const essNiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.essNiprAssets)}</td>`,
        breakfix: (b) => `<td class="${(b.essNiprBreakfix||0)>0?'risk-high':''}">${fmt(b.essNiprBreakfix)}</td>`,
        productCompliance: (b) => `<td class="${prodCompClass(b.essNiprProductCompliance)}">${fmtPct(b.essNiprProductCompliance)}</td>`,
        policyEnforced: (b) => `<td class="${policyRawClass(b.essNiprPolicyEnforced)}">${fmtPct(b.essNiprPolicyEnforced)}</td>`,
        truePolicy: (b) => `<td class="${policyCompClass(b.essNiprTruePolicy)}">${fmtPct(b.essNiprTruePolicy)}</td>`
    };
    const essSiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.essSiprAssets)}</td>`,
        breakfix: (b) => `<td class="${(b.essSiprBreakfix||0)>0?'risk-high':''}">${fmt(b.essSiprBreakfix)}</td>`,
        productCompliance: (b) => `<td class="${prodCompClass(b.essSiprProductCompliance)}">${fmtPct(b.essSiprProductCompliance)}</td>`,
        policyEnforced: (b) => `<td class="${policyRawClass(b.essSiprPolicyEnforced)}">${fmtPct(b.essSiprPolicyEnforced)}</td>`,
        truePolicy: (b) => `<td class="${policyCompClass(b.essSiprTruePolicy)}">${fmtPct(b.essSiprTruePolicy)}</td>`
    };

    // Field renderers for VRAM (NIPR and SIPR)
    const vramNiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.vramNiprAssets)}</td>`,
        scanDate: (b) => `<td class="${scanAgeClass(b.vramNiprScanDate)}">${fmtDate(b.vramNiprScanDate)}</td>`,
        raVph: (b) => `<td class="${vphClass(b.vramNiprRaVph)}">${fmt(b.vramNiprRaVph,2)}</td>`,
        raCrit: (b) => `<td>${fmt(b.vramNiprRaCrit)}</td>`,
        raHigh: (b) => `<td>${fmt(b.vramNiprRaHigh)}</td>`,
        scanIntegrity: (b) => `<td>${fmtPct(b.vramNiprScanIntegrity)}</td>`,
        scanPercent: (b) => `<td>${fmtPct(b.vramNiprScanPercent)}</td>`
    };
    const vramSiprCellRenderers = {
        assets: (b) => `<td>${fmt(b.vramSiprAssets)}</td>`,
        scanDate: (b) => `<td class="${scanAgeClass(b.vramSiprScanDate)}">${fmtDate(b.vramSiprScanDate)}</td>`,
        raVph: (b) => `<td class="${vphClass(b.vramSiprRaVph)}">${fmt(b.vramSiprRaVph,2)}</td>`,
        raCrit: (b) => `<td>${fmt(b.vramSiprRaCrit)}</td>`,
        raHigh: (b) => `<td>${fmt(b.vramSiprRaHigh)}</td>`,
        scanIntegrity: (b) => `<td>${fmtPct(b.vramSiprScanIntegrity)}</td>`,
        scanPercent: (b) => `<td>${fmtPct(b.vramSiprScanPercent)}</td>`
    };

    // Field renderers for TAM
    const tamCellRenderers = {
        pastDue: (b) => `<td class="${(b.tamPastDue||0)>10?'risk-high':''}">${fmt(b.tamPastDue)}</td>`,
        extensions: (b) => `<td>${fmt(b.tamExtensions)}</td>`
    };

    // Helper to format custom field value
    const fmtCustom = (v) => v === null || v === undefined ? '-' : (typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(2)) : String(v));

    // Helper for NMCI cell display in generated reports
    const nmciCell = `<td class="nmci-cell" style="background:#dbeafe;color:#1d4ed8;font-size:7pt;font-weight:600;">NMCI</td>`;

    const boatCells = (b) => {
        const isNmci = b.isNmci === true;
        let cells = `<td class="boat-name">${b.boatFullName || b.boatName}</td>`;
        // ESS NIPR - render in schema order (show NMCI for NMCI boats)
        for (const f of essVisibleFields) {
            const renderer = essNiprCellRenderers[f.field];
            if (renderer) cells += isNmci ? nmciCell : renderer(b);
        }
        for (const cf of essCustomFields) cells += isNmci ? nmciCell : `<td>${fmtCustom(b.customFields?.essNipr?.[cf.field])}</td>`;
        // ESS SIPR - render in schema order
        for (const f of essVisibleFields) {
            const renderer = essSiprCellRenderers[f.field];
            if (renderer) cells += renderer(b);
        }
        for (const cf of essCustomFields) cells += `<td>${fmtCustom(b.customFields?.essSipr?.[cf.field])}</td>`;
        // VRAM NIPR - render in schema order (show NMCI for NMCI boats)
        for (const f of vramVisibleFields) {
            const renderer = vramNiprCellRenderers[f.field];
            if (renderer) cells += isNmci ? nmciCell : renderer(b);
        }
        for (const cf of vramCustomFields) cells += isNmci ? nmciCell : `<td>${fmtCustom(b.customFields?.vramNipr?.[cf.field])}</td>`;
        // VRAM SIPR - render in schema order
        for (const f of vramVisibleFields) {
            const renderer = vramSiprCellRenderers[f.field];
            if (renderer) cells += renderer(b);
        }
        for (const cf of vramCustomFields) cells += `<td>${fmtCustom(b.customFields?.vramSipr?.[cf.field])}</td>`;
        // TAM - render in schema order
        for (const f of tamVisibleFields) {
            const renderer = tamCellRenderers[f.field];
            if (renderer) cells += renderer(b);
        }
        for (const cf of tamCustomFields) cells += `<td>${fmtCustom(b.customFields?.tam?.[cf.field])}</td>`;
        // Status
        cells += `<td class="risk-${b.riskLevel.toLowerCase()}">${b.riskLevel}</td>`;
        if (showVramExempt) cells += `<td class="${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'alert-blue':''}">${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'Y':'N'}</td>`;
        cells += `<td class="notes-cell" style="font-size:6pt;max-width:80px;" title="${b.notes||''}">${b.notes||'-'}</td>`;
        return cells;
    };

    const summaryTable = (byISIC) => {
        const entries = Object.entries(byISIC);
        if (entries.length === 0) return '<p>No data</p>';
        let bodyRows = '';
        for (const [isic, isicBoats] of entries) {
            isicBoats.forEach((b, i) => {
                bodyRows += `<tr class="${i === 0 ? 'isic-first-row' : ''}">`;
                if (i === 0) bodyRows += `<td rowspan="${isicBoats.length}" class="isic-cell">${isic}</td>`;
                bodyRows += boatCells(b) + '</tr>';
            });
        }
        // Build header row 1 with group spans
        let hdr1 = '<tr><th rowspan="2" class="isic-header">ISIC</th><th rowspan="2" style="width:70px">BOAT</th>';
        if (essNiprCount > 0) hdr1 += `<th colspan="${essNiprCount}" class="col-ess-n">ESS NIPR</th>`;
        if (essSiprCount > 0) hdr1 += `<th colspan="${essSiprCount}" class="col-ess-s">ESS SIPR</th>`;
        if (vramNiprCount > 0) hdr1 += `<th colspan="${vramNiprCount}" class="col-vram-n">VRAM NIPR</th>`;
        if (vramSiprCount > 0) hdr1 += `<th colspan="${vramSiprCount}" class="col-vram-s">VRAM SIPR</th>`;
        if (tamCount > 0) hdr1 += `<th colspan="${tamCount}" class="col-tam">TAM</th>`;
        hdr1 += `<th colspan="${statusCount}" class="col-status">STATUS</th></tr>`;
        // Build header row 2 with individual column names (in schema order, using label from schema config)
        let hdr2 = '<tr>';
        // ESS NIPR headers - in schema order
        for (const f of essVisibleFields) hdr2 += `<th class="col-ess-n">${f.label || f.field}</th>`;
        for (const cf of essCustomFields) hdr2 += `<th class="col-ess-n">${cf.label || cf.field}</th>`;
        // ESS SIPR headers - in schema order
        for (const f of essVisibleFields) hdr2 += `<th class="col-ess-s">${f.label || f.field}</th>`;
        for (const cf of essCustomFields) hdr2 += `<th class="col-ess-s">${cf.label || cf.field}</th>`;
        // VRAM NIPR headers - in schema order
        for (const f of vramVisibleFields) hdr2 += `<th class="col-vram-n">${f.label || f.field}</th>`;
        for (const cf of vramCustomFields) hdr2 += `<th class="col-vram-n">${cf.label || cf.field}</th>`;
        // VRAM SIPR headers - in schema order
        for (const f of vramVisibleFields) hdr2 += `<th class="col-vram-s">${f.label || f.field}</th>`;
        for (const cf of vramCustomFields) hdr2 += `<th class="col-vram-s">${cf.label || cf.field}</th>`;
        // TAM headers - in schema order
        for (const f of tamVisibleFields) hdr2 += `<th class="col-tam">${f.label || f.field}</th>`;
        for (const cf of tamCustomFields) hdr2 += `<th class="col-tam">${cf.label || cf.field}</th>`;
        // Status headers
        hdr2 += '<th class="col-status">Risk</th>';
        if (showVramExempt) hdr2 += '<th class="col-status">Scan Exempt</th>';
        hdr2 += '<th class="col-status">Notes</th></tr>';
        return `<table class="summary-table"><thead>${hdr1}${hdr2}</thead><tbody>${bodyRows}</tbody></table>`;
    };

    const allOverrides = boats.flatMap(b => (b.overrides || []).map(o => ({ ...o, boatName: b.boatName })));
    const thresholdChanges = reportData.thresholdChanges || [];
    const settingsHistory = settings._settingsHistory || [];
    const dataUpdates = reportData.dataUpdates || [];
    const hasChanges = allOverrides.length > 0 || thresholdChanges.length > 0 || settingsHistory.length > 0 || dataUpdates.length > 0;
    const changeCount = allOverrides.length + thresholdChanges.length + (settingsHistory.length > 0 ? 1 : 0) + dataUpdates.length;

    // Tab visibility helpers
    const tabConfig = settings.tabConfig || [{id:'csl',label:'CSL Summary',visible:true},{id:'csp',label:'CSP Summary',visible:true},{id:'hq',label:'HQ Status',visible:true},{id:'analytics',label:'Analytics',visible:true},{id:'changelog',label:'Changes',visible:true}];
    const isTabVisible = (id) => { const tab = tabConfig.find(t => t.id === id); return tab ? tab.visible : true; };
    const visibleTabs = tabConfig.filter(t => t.visible && (t.id !== 'changelog' || hasChanges));
    const firstVisibleTab = visibleTabs.length > 0 ? visibleTabs[0].id : 'csl';
    const pageInfo = `<div class="page-info print-only">Generated: ${new Date().toLocaleString()} by ${reportData.createdBy || 'Unknown'} | v${reportData.version}</div>`;

    // ===================================================================================
    // HQ STATUS TABLE - COLOR CLASSIFICATION FUNCTIONS
    // ===================================================================================
    // Uses same "Boundary Gets Better Color" logic as CSL/CSP tables (see above)
    // These use separate HQ-specific thresholds (hq_color_*) for independent control
    // ===================================================================================
    const th = settings.thresholds || defaultThresholds;

    // HQ Product Compliance: GREEN >= threshold, RED < threshold, YELLOW = between
    const hqProdClass = (v) => v === null ? '' : v >= (th.hq_color_product_green || 95) ? 'risk-low' : v < (th.hq_color_product_red || 90) ? 'risk-high' : 'risk-med';

    // HQ Policy Compliance: GREEN >= threshold, RED < threshold, YELLOW = between
    const hqPolicyClass = (v) => v === null ? '' : v >= (th.hq_color_policy_green || 95) ? 'risk-low' : v < (th.hq_color_policy_red || 90) ? 'risk-high' : 'risk-med';

    // HQ Policy Raw: GREEN >= threshold, RED < threshold, YELLOW = between
    const hqPolicyRawClass = (v) => v === null ? '' : v >= (th.hq_color_policy_raw_green || 95) ? 'risk-low' : v < (th.hq_color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';

    // HQ Status table with customizable metrics based on hqStatusLayout
    const hqLayout = settings.hqStatusLayout || defaultHQStatusLayout;
    const visibleHqMetrics = hqLayout.filter(m => m.visible);
    const getHqMetricRow = (metric, list) => {
        const getValue = (a) => {
            switch(metric.id) {
                case 'niprProdComp': return { value: a.niprProdCompAvg.toFixed(1) + '%', className: hqProdClass(a.niprProdCompAvg) };
                case 'niprPolEnf': return { value: a.niprPolEnfAvg.toFixed(1) + '%', className: hqPolicyClass(a.niprPolEnfAvg) };
                case 'niprPolRaw': return { value: a.niprPolRawAvg.toFixed(1) + '%', className: hqPolicyRawClass(a.niprPolRawAvg) };
                case 'niprBreakfix': return { value: a.niprBreakfixSum, className: a.niprBreakfixSum > 0 ? 'risk-high' : '' };
                case 'siprProdComp': return { value: a.siprProdCompAvg.toFixed(1) + '%', className: hqProdClass(a.siprProdCompAvg) };
                case 'siprPolEnf': return { value: a.siprPolEnfAvg.toFixed(1) + '%', className: hqPolicyClass(a.siprPolEnfAvg) };
                case 'siprPolRaw': return { value: a.siprPolRawAvg.toFixed(1) + '%', className: hqPolicyRawClass(a.siprPolRawAvg) };
                case 'siprBreakfix': return { value: a.siprBreakfixSum, className: a.siprBreakfixSum > 0 ? 'risk-high' : '' };
                case 'highRisk': return { value: a.highRiskCount, className: a.highRiskCount > 0 ? 'risk-high' : '' };
                case 'scanExempt': return { value: a.scanExemptCount, className: a.scanExemptCount > 0 ? 'alert-blue' : '' };
                default: return { value: '-', className: '' };
            }
        };
        return `<tr><td style="text-align:left;font-weight:600">${metric.label}</td>${list.map(a => { const { value, className } = getValue(a); return `<td class="${className}">${value}</td>`; }).join('')}</tr>`;
    };
    const hqTable = (list, label) => list.length === 0 ? '<p>No data</p>' : `<h3 style="font-size:11pt;margin:16px 0 8px;color:#1e293b;">${label}</h3><table class="summary-table hq-table"><thead><tr><th style="text-align:left;width:150px">Metric</th>${list.map(a=>`<th>${a.isicShort} (${a.boatCount})</th>`).join('')}</tr></thead><tbody>${visibleHqMetrics.map(m => getHqMetricRow(m, list)).join('')}</tbody></table>`;

    // High risk boats table for analytics - show max VPH across enclaves
    const highRiskBoats = boats.filter(b => b.riskLevel === 'HIGH');
    const getBoatVph = (b) => {
        const nipr = b.isNmci ? null : b.vramNiprRaVph;
        const sipr = b.vramSiprRaVph;
        if (nipr !== null && sipr !== null) return Math.max(nipr, sipr);
        return nipr !== null ? nipr : sipr;
    };
    const getBoatBreakfix = (b) => (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);
    const highRiskTable = highRiskBoats.length === 0 ? '<p style="color:#065f46;font-weight:600;">No high-risk boats</p>' : `<table class="summary-table"><thead><tr><th style="text-align:left">Boat</th><th>ISIC</th><th>VPH</th><th>Breakfix</th><th style="text-align:left">Risk Reasons</th></tr></thead><tbody>${highRiskBoats.map(b => `<tr><td style="text-align:left;font-family:monospace;font-weight:600;">${b.boatFullName || b.boatName}</td><td>${b.isic}</td><td>${fmt(getBoatVph(b),2)}</td><td class="${getBoatBreakfix(b)>0?'alert-red':''}">${getBoatBreakfix(b)}</td><td style="text-align:left;font-size:7pt;">${b.riskReasons?.join(', ') || '-'}</td></tr>`).join('')}</tbody></table>`;

    // VPH by ISIC for bar chart - use both enclaves, handle NMCI
    const isicVph = {};
    boats.forEach(b => {
        if (!isicVph[b.isic]) isicVph[b.isic] = [];
        if (!b.isNmci && b.vramNiprRaVph !== null) isicVph[b.isic].push(b.vramNiprRaVph);
        if (b.vramSiprRaVph !== null) isicVph[b.isic].push(b.vramSiprRaVph);
    });
    const isicVphAvg = Object.entries(isicVph).map(([isic, vphs]) => ({ isic, avg: vphs.length > 0 ? (vphs.reduce((a,b)=>a+b,0)/vphs.length).toFixed(2) : '0' }));

    return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Cyber Report ${new Date().toLocaleDateString()}</title>
<script src="libs/chart.min.js"><\/script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Arial,sans-serif;font-size:9pt;line-height:1.3;background:#f1f5f9}
.header{background:#1e293b;color:white;padding:12px 24px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:16pt;font-weight:600}
.header-info{font-size:9pt;opacity:0.8}
.tabs{display:flex;background:#334155;padding:0 24px}
.tab-btn{padding:12px 24px;color:#94a3b8;font-weight:500;border:none;background:none;cursor:pointer;border-bottom:3px solid transparent}
.tab-btn:hover{color:white}
.tab-btn.active{color:white;border-bottom-color:#0ea5e9;background:#1e293b}
.tab-content{display:none;padding:24px;max-width:95vw;margin:0 auto}
.tab-content.active{display:block}
.page{background:white;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);margin-bottom:20px}
.page-header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #e2e8f0;padding-bottom:12px;margin-bottom:16px}
.page-header h2{font-size:14pt;color:#1e293b}
.toolbar{display:flex;gap:8px;align-items:center}
.toolbar button{background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:9pt}
.toolbar button:hover{background:#2563eb}
.toolbar button.purple{background:#7c3aed}
.toolbar button.purple:hover{background:#6d28d9}
.legend{display:flex;gap:16px;margin-bottom:12px;font-size:8pt;flex-wrap:wrap}
.legend span{display:flex;align-items:center;gap:4px}
.legend-box{width:14px;height:14px;border:1px solid #333;display:inline-block}
.risk-criteria{font-size:7pt;color:#475569;margin-bottom:12px;padding:8px 12px;background:#f8fafc;border-radius:4px;border:1px solid #e2e8f0}
.risk-criteria span{padding:2px 6px;border-radius:3px;font-weight:600}
.summary-table{width:100%;border-collapse:collapse;font-size:8pt}
.summary-table th{background:#e2e8f0;color:#1e293b;font-weight:600;font-size:7pt;padding:5px 4px;text-align:center;border:1px solid #cbd5e1}
.summary-table td{padding:4px;text-align:center;border:1px solid #e2e8f0}
.summary-table td.boat-name{text-align:left;font-weight:600;font-family:monospace;background:#f8fafc;white-space:normal;overflow-wrap:break-word;word-break:keep-all;max-height:36px;overflow:hidden;line-height:1.2}
.summary-table .isic-header,.summary-table .isic-cell{background:#1e293b;color:white;font-weight:700;text-align:center;writing-mode:vertical-rl;text-orientation:mixed;transform:rotate(180deg);padding:4px 2px;font-size:7pt;width:20px;min-width:20px;max-width:20px}
.summary-table td.notes-cell{white-space:normal;overflow-wrap:break-word;word-break:keep-all;max-height:36px;overflow:hidden;line-height:1.2;text-align:left}
.summary-table .isic-first-row td{border-top:2px solid #1e293b}
.col-ess-n{background:rgba(59,130,246,0.2)!important}.col-ess-s{background:rgba(99,102,241,0.2)!important}
.col-vram-n{background:rgba(249,115,22,0.2)!important}.col-vram-s{background:rgba(234,88,12,0.2)!important}
.col-ra{background:rgba(168,85,247,0.2)!important}.col-tam{background:rgba(107,114,128,0.2)!important}.col-status{background:rgba(16,185,129,0.2)!important}
.risk-high{background:#fee2e2!important;color:#991b1b!important;font-weight:bold}
.risk-med{background:#fef3c7!important;color:#92400e!important;font-weight:bold}
.risk-low{background:#d1fae5!important;color:#065f46!important}
.alert-red{background:#fee2e2!important}.alert-amber{background:#fef3c7!important}.alert-blue{background:#dbeafe!important}
.hq-table{font-size:11pt}
.hq-table th{font-size:10pt;padding:10px 12px}
.hq-table td{padding:8px 12px;font-size:11pt}
.hq-table th:first-child,.hq-table td:first-child{text-align:left;white-space:normal;word-wrap:break-word;min-width:120px}
.stat-cards{display:grid;gap:16px;margin-bottom:24px;width:100%}
.stat-card{background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.stat-card h3{font-size:10pt;color:#64748b;margin-bottom:8px}
.stat-card .value{font-size:28pt;font-weight:700;color:#1e293b}
.stat-card .value.high{color:#dc2626}.stat-card .value.med{color:#d97706}.stat-card .value.low{color:#059669}
.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:24px}
.chart-box{background:white;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.chart-box h3{font-size:11pt;color:#1e293b;margin-bottom:16px;border-bottom:1px solid #e2e8f0;padding-bottom:8px}
.rankings-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;width:100%}
.ranking-box{background:white;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;overflow:hidden}
.ranking-box.wide{grid-column:1/-1}
.ranking-box h4{font-size:10pt;color:#0891b2;margin:0 0 12px 0;padding-bottom:8px;border-bottom:1px solid #e2e8f0}
.ranking-box .mini-table{width:100%;table-layout:fixed}
.ranking-box .mini-table td,.ranking-box .mini-table th{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mini-table{width:100%;border-collapse:collapse;font-size:9pt}
.mini-table th{background:#f1f5f9;padding:6px 8px;text-align:left;font-weight:600;color:#475569;border-bottom:1px solid #e2e8f0}
.mini-table td{padding:5px 8px;border-bottom:1px solid #f1f5f9}
.mini-table tr:last-child td{border-bottom:none}
.print-only{display:none}
.print-header{padding:0;margin-bottom:16px}
.print-header h1{font-size:14pt;font-weight:600;color:#1e293b;margin-bottom:4px}
.print-header .date{font-size:9pt;color:#475569}
.page-info{font-size:9pt;color:#475569;margin-bottom:8px}
@media print{
    .no-print{display:none!important}
    .print-only{display:block!important}
    body{background:white;-webkit-print-color-adjust:exact;print-color-adjust:exact}
    .tab-content{display:none!important;padding:10px}
    .tab-content.print-active{display:block!important}
    .page{box-shadow:none;margin:0 0 15px 0;page-break-inside:avoid;border:none;padding:10px;overflow:hidden!important}
    .isic-section{page-break-inside:avoid}
    .analytics-grid{display:grid!important;grid-template-columns:repeat(4,1fr)!important;gap:8px!important;grid-auto-rows:minmax(80px,auto)!important}
    .stat-cards{display:grid!important;gap:8px!important}
    .stat-card{padding:8px!important;page-break-inside:avoid;overflow:hidden!important}
    .stat-card h3{font-size:8pt!important;margin-bottom:4px!important}
    .stat-card .value{font-size:16pt!important}
    .chart-grid{display:grid!important;grid-template-columns:repeat(2,1fr)!important;gap:10px!important}
    .chart-box{padding:10px!important;page-break-inside:avoid;max-height:220px!important;max-width:100%!important;overflow:hidden!important}
    .chart-box h3{font-size:9pt!important;margin-bottom:8px!important}
    .chart-box canvas{max-height:160px!important;max-width:100%!important;width:auto!important;height:auto!important;object-fit:contain!important}
    .rankings-grid{display:grid!important;grid-template-columns:repeat(3,1fr)!important;gap:8px!important;width:100%!important}
    .ranking-box{padding:8px!important;page-break-inside:avoid;overflow:hidden!important;box-sizing:border-box!important}
    .ranking-box h4{font-size:7pt!important;margin-bottom:4px!important}
    .mini-table{font-size:6pt!important;width:100%!important;table-layout:fixed!important}
    .mini-table th,.mini-table td{padding:2px 3px!important;overflow:hidden!important;text-overflow:ellipsis!important;white-space:nowrap!important}
    .summary-table{font-size:6pt!important;width:100%!important;table-layout:fixed!important}
    .summary-table th{padding:2px 1px!important;font-size:5pt!important;overflow:hidden!important;text-overflow:ellipsis!important}
    .summary-table td{padding:2px 1px!important;overflow:hidden!important;text-overflow:ellipsis!important;white-space:nowrap!important}
    .summary-table td.boat-name{white-space:normal!important;overflow-wrap:break-word!important;word-break:keep-all!important;max-height:36px!important;line-height:1.2!important}
    .summary-table td.notes-cell{white-space:normal!important;overflow-wrap:break-word!important;word-break:keep-all!important;max-height:36px!important;line-height:1.2!important}
    .summary-table .isic-first-row td{border-top:2px solid #1e293b!important}
    .summary-table .isic-header,.summary-table .isic-cell{font-size:5pt!important;width:16px!important;min-width:16px!important;max-width:16px!important;padding:2px 1px!important}
    /* Keep table header with table body - prevent splitting */
    .summary-table thead{display:table-header-group!important}
    .summary-table tbody{display:table-row-group!important}
    .summary-table tr{page-break-inside:avoid!important;break-inside:avoid!important}
    .hq-table th:first-child,.hq-table td:first-child{white-space:normal!important;word-wrap:break-word!important;min-width:100px!important;max-width:150px!important}
    .page-header{page-break-after:avoid!important;break-after:avoid!important}
    .page-header + .table-wrapper,.page-header + div{page-break-before:avoid!important;break-before:avoid!important}
    .table-wrapper{page-break-inside:auto!important}
    h2{font-size:12pt!important;page-break-after:avoid!important}
    h3{font-size:10pt!important;page-break-after:avoid!important}
    .legend-box{page-break-inside:avoid!important;break-inside:avoid!important}
}
@media print and (orientation:landscape){
    .analytics-grid{grid-template-columns:repeat(4,1fr)!important;gap:6px!important}
    .chart-grid{grid-template-columns:repeat(2,1fr)!important}
    .stat-cards{grid-template-columns:repeat(4,1fr)!important}
    .chart-box{max-height:200px!important}
    .chart-box canvas{max-height:140px!important}
}
@page{margin:0;size:landscape}
</style></head><body>
<div class="header no-print">
<div><h1>SUBFOR Cyber Risk Dashboard</h1><div class="header-info">Generated: ${new Date().toLocaleString()} by ${reportData.createdBy || 'Unknown'} | v${reportData.version}</div></div>
<button onclick="showHelpModal()" style="background:#64748b;color:white;border:none;padding:10px 16px;border-radius:6px;font-weight:600;cursor:pointer;" title="Calculation Help">?</button>
</div>
<div class="tabs no-print">
${tabConfig.filter(t => t.visible && (t.id !== 'changelog' || hasChanges)).map((t, i) => `<button class="tab-btn${i===0?' active':''}" onclick="showTab('${t.id}')">${t.id === 'changelog' ? `Changes (${changeCount})` : t.label}</button>`).join('')}
</div>

${isTabVisible('csl') ? `<div id="tab-csl" class="tab-content${firstVisibleTab==='csl'?' active':''}">
<div class="page">
<div class="page-header no-print">
<h2>CSL Cyber Summary</h2>
<div class="toolbar">
<select onchange="filterISIC('csl',this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;">
<option value="">All Squadrons</option>${Object.keys(cslByISIC).map(i=>`<option value="${i}">${i}</option>`).join('')}
</select>
<button onclick="printTab('csl')">Print CSL</button>
</div>
</div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">CSL Cyber Summary</h2>
${pageInfo}
<div class="legend"><span><span class="legend-box risk-high"></span>High</span><span><span class="legend-box risk-med"></span>Med</span><span><span class="legend-box risk-low"></span>Low</span><span><span class="legend-box alert-red"></span>Critical</span><span><span class="legend-box alert-blue"></span>Exempt</span></div>
<div class="risk-criteria">
<strong>Risk Criteria:</strong>
<span class="risk-high">HIGH</span> = ${formatLegend(legendText.high)}
&nbsp;|&nbsp;
<span class="risk-med">MED</span> = ${formatLegend(legendText.med)}
&nbsp;|&nbsp;
<span class="risk-low">LOW</span> = ${formatLegend(legendText.low)}
</div>
<div id="csl-content">${summaryTable(cslByISIC)}</div>
</div>
</div>` : ''}

${isTabVisible('csp') ? `<div id="tab-csp" class="tab-content${firstVisibleTab==='csp'?' active':''}">
<div class="page">
<div class="page-header no-print">
<h2>CSP Cyber Summary</h2>
<div class="toolbar">
<select onchange="filterISIC('csp',this.value)" style="padding:6px 12px;border-radius:4px;border:1px solid #cbd5e1;">
<option value="">All Squadrons</option>${Object.keys(cspByISIC).map(i=>`<option value="${i}">${i}</option>`).join('')}
</select>
<button onclick="printTab('csp')">Print CSP</button>
</div>
</div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">CSP Cyber Summary</h2>
${pageInfo}
<div class="legend"><span><span class="legend-box risk-high"></span>High</span><span><span class="legend-box risk-med"></span>Med</span><span><span class="legend-box risk-low"></span>Low</span><span><span class="legend-box alert-red"></span>Critical</span><span><span class="legend-box alert-blue"></span>Exempt</span></div>
<div class="risk-criteria">
<strong>Risk Criteria:</strong>
<span class="risk-high">HIGH</span> = ${formatLegend(legendText.high)}
&nbsp;|&nbsp;
<span class="risk-med">MED</span> = ${formatLegend(legendText.med)}
&nbsp;|&nbsp;
<span class="risk-low">LOW</span> = ${formatLegend(legendText.low)}
</div>
<div id="csp-content">${summaryTable(cspByISIC)}</div>
</div>
</div>` : ''}

${isTabVisible('hq') ? `<div id="tab-hq" class="tab-content${firstVisibleTab==='hq'?' active':''}">
<div class="page">
<div class="page-header no-print">
<h2>HQ Cyber Status</h2>
<div class="toolbar"><button onclick="printTab('hq')">Print HQ Status</button></div>
</div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">HQ Cyber Status</h2>
${pageInfo}
${hqTable(aggs.csl, 'CSL Status')}
${hqTable(aggs.csp, 'CSP Status')}
</div>
</div>` : ''}

${isTabVisible('analytics') ? (() => {
    // Use analyticsLayout for visibility and positioning
    const al = settings.analyticsLayout || defaultAnalyticsLayout;
    const getLayoutItem = (id) => al.find(item => item.id === id);
    const isInLayout = (id) => al.some(item => item.id === id);
    const scanExemptCount = boats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length;

    // Helper functions for boat data
    const getBoatMaxVph = (b) => {
        const nipr = b.isNmci ? null : b.vramNiprRaVph;
        const sipr = b.vramSiprRaVph;
        if (nipr !== null && sipr !== null) return Math.max(nipr, sipr);
        return nipr !== null ? nipr : sipr;
    };
    const getBoatMinCompliance = (b) => {
        const nipr = b.isNmci ? null : b.essNiprProductCompliance;
        const sipr = b.essSiprProductCompliance;
        if (nipr !== null && sipr !== null) return Math.min(nipr, sipr);
        return nipr !== null ? nipr : sipr;
    };
    const getBoatTotalBreakfix = (b) => (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);

    // ISIC data for rankings
    const isicData = Object.entries(groupByISIC(boats)).map(([isic, ib]) => {
        const vphVals = ib.flatMap(b => {
            const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph);
            if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v;
        });
        return {isic, boats: ib.length, high: ib.filter(b=>b.riskLevel==='HIGH').length, med: ib.filter(b=>b.riskLevel==='MED').length, low: ib.filter(b=>b.riskLevel==='LOW').length, lowPct: ib.length ? (ib.filter(b=>b.riskLevel==='LOW').length/ib.length*100) : 0, avgVph: vphVals.length > 0 ? vphVals.reduce((s,v)=>s+v,0)/vphVals.length : 0};
    });

    // Pie chart using CSS conic-gradient
    const total = boats.length || 1;
    const highPct = (riskCounts.HIGH / total) * 100;
    const medPct = (riskCounts.MED / total) * 100;
    const pieGradient = `conic-gradient(#dc2626 0% ${highPct}%, #d97706 ${highPct}% ${highPct + medPct}%, #059669 ${highPct + medPct}% 100%)`;

    // TYCOM data
    const tycomData = {};
    boats.forEach(b => {
        if (!tycomData[b.tycom]) tycomData[b.tycom] = {boats:0,high:0,med:0,low:0,vphVals:[],bfSum:0,compVals:[]};
        const t=tycomData[b.tycom]; t.boats++;
        if(b.riskLevel==='HIGH')t.high++; if(b.riskLevel==='MED')t.med++; if(b.riskLevel==='LOW')t.low++;
        if (!b.isNmci && b.vramNiprRaVph !== null) t.vphVals.push(b.vramNiprRaVph);
        if (b.vramSiprRaVph !== null) t.vphVals.push(b.vramSiprRaVph);
        t.bfSum += getBoatTotalBreakfix(b);
        if (!b.isNmci && b.essNiprProductCompliance !== null) t.compVals.push(b.essNiprProductCompliance);
        if (b.essSiprProductCompliance !== null) t.compVals.push(b.essSiprProductCompliance);
    });

    // Render a widget by ID with explicit grid positioning
    const renderWidget = (id) => {
        const item = getLayoutItem(id);
        if (!item) return '';
        const w = item.width || 1;
        const h = item.height || 1;
        // Use explicit grid positioning to ensure consistent order with preview
        const style = `grid-column: ${item.col + 1} / span ${w}; grid-row: ${item.row + 1} / span ${h};`;

        switch(id) {
            case 'totalBoats': return `<div class="stat-card" style="${style}"><h3>Total Boats</h3><div class="value">${boats.length}</div></div>`;
            case 'highRisk': return `<div class="stat-card" style="${style}"><h3>High Risk</h3><div class="value high">${riskCounts.HIGH}</div></div>`;
            case 'medRisk': return `<div class="stat-card" style="${style}"><h3>Medium Risk</h3><div class="value med">${riskCounts.MED}</div></div>`;
            case 'lowRisk': return `<div class="stat-card" style="${style}"><h3>Low Risk</h3><div class="value low">${riskCounts.LOW}</div></div>`;
            case 'avgVph': return `<div class="stat-card" style="${style}"><h3>Avg RA VPH</h3><div class="value">${avgVph}</div></div>`;
            case 'totalBreakfix': return `<div class="stat-card" style="${style}"><h3>Total Breakfix</h3><div class="value ${totalBreakfix > 0 ? 'high' : ''}">${totalBreakfix}</div></div>`;
            case 'avgCompliance': return `<div class="stat-card" style="${style}"><h3>Avg ESS Compliance</h3><div class="value">${avgCompliance}%</div></div>`;
            case 'scanExempt': return `<div class="stat-card" style="${style}"><h3>Scan Exempt</h3><div class="value">${scanExemptCount}</div></div>`;
            case 'riskPieChart': return `<div class="chart-box" style="${style}"><h3>Risk Pie Chart</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskPieChart"></canvas></div></div>`;
            case 'riskDonutChart': return `<div class="chart-box" style="${style}"><h3>Risk Donut</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskDonutChart"></canvas></div></div>`;
            case 'riskDistribution': return `<div class="chart-box" style="${style}"><h3>Risk Bar Chart</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskDistribution"></canvas></div></div>`;
            case 'highRiskTable': {
                const highRiskBoats = boats.filter(b => b.riskLevel === 'HIGH').slice(0, h > 1 ? 10 : 5);
                const showReasons = w > 1;
                const tableContent = showReasons
                    ? `<table class="mini-table"><thead><tr><th style="text-align:left">Boat</th><th style="text-align:left">Reason</th></tr></thead><tbody>${highRiskBoats.map(b => `<tr><td style="font-family:monospace">${b.boatFullName || b.boatName}</td><td style="font-size:7pt;color:#dc2626">${b.riskReasons?.join(', ') || '-'}</td></tr>`).join('')}</tbody></table>`
                    : `<table class="mini-table"><thead><tr><th>Boat</th></tr></thead><tbody>${highRiskBoats.map(b => `<tr><td>${b.boatFullName || b.boatName}</td></tr>`).join('')}</tbody></table>`;
                return `<div class="chart-box" style="${style}"><h3>High Risk Boats (${boats.filter(b => b.riskLevel === 'HIGH').length})</h3>${highRiskBoats.length === 0 ? '<div style="color:#059669;font-weight:500;padding:16px;">No high-risk boats</div>' : tableContent}</div>`;
            }
            case 'riskByTycom': return `<div class="chart-box" style="${style}"><h3>Risk by TYCOM</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-riskByTycom"></canvas></div></div>`;
            case 'vphByIsic': return `<div class="chart-box" style="${style}"><h3>VPH by ISIC</h3><div style="flex:1;position:relative;min-height:150px;"><canvas id="analytics-chart-vphByIsic"></canvas></div></div>`;
            case 'worstBoatsVph': {
                const sorted = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(b)||0) - (getBoatMaxVph(a)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'bestBoatsVph': {
                const sorted = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(a)||0) - (getBoatMaxVph(b)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Best Boats by VPH</h4><table class="mini-table"><thead><tr><th>Boat</th><th>VPH</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-low">${(getBoatMaxVph(b)||0).toFixed(2)}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstBoatsCompliance': {
                const sorted = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(a)||0) - (getBoatMinCompliance(b)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Worst Boats by Compliance</h4><table class="mini-table"><thead><tr><th>Boat</th><th>Compliance</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-high">${Math.min(100, getBoatMinCompliance(b)||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'bestBoatsCompliance': {
                const sorted = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(b)||0) - (getBoatMinCompliance(a)||0)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Best Boats by Compliance</h4><table class="mini-table"><thead><tr><th>Boat</th><th>Compliance</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="risk-low">${Math.min(100, getBoatMinCompliance(b)||0).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'boatsWithBreakfix': {
                const sorted = [...boats].filter(b => getBoatTotalBreakfix(b) > 0).sort((a,b) => getBoatTotalBreakfix(b) - getBoatTotalBreakfix(a)).slice(0, h > 1 ? 10 : 5);
                return `<div class="ranking-box" style="${style}"><h4>Boats with Breakfix</h4>${sorted.length === 0 ? '<div style="color:#059669;padding:8px;">None</div>' : `<table class="mini-table"><thead><tr><th>Boat</th><th>Breakfix</th></tr></thead><tbody>${sorted.map(b => `<tr><td>${b.boatFullName || b.boatName}</td><td class="alert-red">${getBoatTotalBreakfix(b)}</td></tr>`).join('')}</tbody></table>`}</div>`;
            }
            case 'worstIsicsRisk': {
                const sorted = [...isicData].sort((a,b) => b.high - a.high).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Worst ISICs by High Risk</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>High</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-high">${i.high}</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'bestIsicsRisk': {
                const sorted = [...isicData].sort((a,b) => b.lowPct - a.lowPct).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Best ISICs by Low Risk %</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>Low %</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-low">${i.lowPct.toFixed(0)}%</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'worstIsicsVph': {
                const sorted = [...isicData].sort((a,b) => b.avgVph - a.avgVph).slice(0, h > 1 ? 6 : 3);
                return `<div class="ranking-box" style="${style}"><h4>Worst ISICs by Avg VPH</h4><table class="mini-table"><thead><tr><th>ISIC</th><th>Avg VPH</th><th>Boats</th></tr></thead><tbody>${sorted.map(i => `<tr><td>${i.isic}</td><td class="risk-high">${i.avgVph.toFixed(2)}</td><td>${i.boats}</td></tr>`).join('')}</tbody></table></div>`;
            }
            case 'tycomComparison': {
                const rows = Object.entries(tycomData).map(([tycom,d]) => {
                    const avgVph = d.vphVals.length > 0 ? d.vphVals.reduce((s,v)=>s+v,0)/d.vphVals.length : 0;
                    const comp = d.compVals.length > 0 ? Math.min(100, d.compVals.reduce((s,v)=>s+v,0)/d.compVals.length) : null;
                    return `<tr><td style="font-weight:600">${tycom}</td><td>${d.boats}</td><td class="${d.high>0?'risk-high':''}">${d.high}</td><td class="${d.med>0?'risk-med':''}">${d.med}</td><td class="risk-low">${d.low}</td><td>${avgVph.toFixed(2)}</td><td class="${d.bfSum>0?'alert-red':''}">${d.bfSum}</td><td class="${comp!==null?compClass(comp):''}">${comp!==null?comp.toFixed(1)+'%':'-'}</td></tr>`;
                }).join('');
                return `<div class="ranking-box" style="${style}"><h4>TYCOM Comparison</h4><table class="mini-table"><thead><tr><th>TYCOM</th><th>Boats</th><th>High</th><th>Med</th><th>Low</th><th>Avg VPH</th><th>Breakfix</th><th>Compliance</th></tr></thead><tbody>${rows}</tbody></table></div>`;
            }
            case 'riskSummaryByIsic': {
                const summaryRows = isicData.sort((a,b) => b.high - a.high).map(i => {
                    const isicBoats = boats.filter(b => b.isic === i.isic);
                    const bf = isicBoats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
                    return `<tr><td style="text-align:left;font-weight:600">${i.isic}</td><td>${i.boats}</td><td class="${i.high>0?'risk-high':''}">${i.high}</td><td class="${i.med>0?'risk-med':''}">${i.med}</td><td class="risk-low">${i.low}</td><td>${i.avgVph.toFixed(2)}</td><td class="${bf>0?'alert-red':''}">${bf}</td></tr>`;
                }).join('');
                return `<div class="ranking-box" style="${style}"><h4>Risk Summary by ISIC</h4><table class="mini-table"><thead><tr><th style="text-align:left">ISIC</th><th>Boats</th><th>High</th><th>Med</th><th>Low</th><th>Avg VPH</th><th>Breakfix</th></tr></thead><tbody>${summaryRows}</tbody></table></div>`;
            }
            default: return '';
        }
    };

    // Sort layout items by row then col for proper grid placement
    const sortedLayout = [...al].sort((a, b) => {
        if (a.row !== b.row) return a.row - b.row;
        return a.col - b.col;
    });

    // Calculate max row for grid
    const maxRow = Math.max(...al.map(l => l.row + (l.height || 1) - 1), 0) + 1;

    // Render all widgets in order
    const gridWidgets = sortedLayout.map(item => renderWidget(item.id)).filter(Boolean).join('');

    return `<div id="tab-analytics" class="tab-content${firstVisibleTab==='analytics'?' active':''}">
<div class="page-header no-print" style="margin-bottom:16px;"><h2>Analytics</h2><div class="toolbar"><button onclick="printTab('analytics')">Print Analytics</button></div></div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">Analytics</h2>
${pageInfo}
<div class="analytics-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;grid-auto-rows:minmax(100px,auto);">
${gridWidgets}
</div>
</div>`;
})() : ''}

${(hasChanges && isTabVisible('changelog')) ? `<div id="tab-changelog" class="tab-content${firstVisibleTab==='changelog'?' active':''}">
<div class="page">
<div class="page-header no-print"><h2>Change Log</h2><div class="toolbar"><button onclick="printTab('changelog')">Print Changes</button></div></div>
<h2 class="print-only" style="font-size:14pt;color:#1e293b;margin-bottom:4px;">Change Log</h2>
${pageInfo}

<div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:6px;padding:12px 16px;margin-bottom:16px;">
<h4 style="font-size:10pt;color:#0369a1;margin:0 0 8px;">Current Settings</h4>
<p style="font-size:9pt;color:#0c4a6e;margin:0;">Version <strong>${settings._settingsVersion || '1.0'}</strong> by <strong>${settings._settingsAuthor || 'Unknown'}</strong> â€¢ Last modified: ${settings._settingsModified ? new Date(settings._settingsModified).toLocaleString() : 'Unknown'}</p>
</div>

${settingsHistory.length > 0 ? `<h3 style="font-size:11pt;margin:16px 0 8px;color:#0891b2;">Settings Version History</h3>
<table class="summary-table"><thead><tr><th>Version</th><th style="text-align:left">Author</th><th style="text-align:left">Modified</th></tr></thead>
<tbody>${settingsHistory.slice().reverse().map(h => `<tr><td style="font-weight:bold;">${h.version}</td><td style="text-align:left">${h.author}</td><td style="text-align:left">${new Date(h.modified).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}

${thresholdChanges.length > 0 ? `<h3 style="font-size:11pt;margin:16px 0 8px;color:#b45309;">Threshold Adjustments</h3>
<table class="summary-table"><thead><tr><th style="text-align:left">Threshold</th><th>Default</th><th>Used</th><th>By</th><th>Time</th></tr></thead>
<tbody>${thresholdChanges.map(t => `<tr><td style="text-align:left">${t.field.replace(/_/g, ' ')}</td><td>${t.defaultValue}</td><td style="font-weight:bold;color:#b45309;">${t.newValue}</td><td>${t.user}</td><td>${new Date(t.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}

${allOverrides.length > 0 ? `<h3 style="font-size:11pt;margin:24px 0 8px;color:#7c3aed;">Value Overrides</h3>
<table class="summary-table"><thead><tr><th style="text-align:left">Boat</th><th style="text-align:left">Field</th><th>Original</th><th>New</th><th style="text-align:left">Reason</th><th>By</th><th>Time</th></tr></thead>
<tbody>${allOverrides.map(o => `<tr><td style="text-align:left;font-family:monospace;">${o.boatName}</td><td style="text-align:left">${o.field}</td><td>${o.originalValue}</td><td style="font-weight:bold;color:#7c3aed;">${o.overrideValue}</td><td style="text-align:left">${o.reason}</td><td>${o.user}</td><td>${new Date(o.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}

${dataUpdates.length > 0 ? `<h3 style="font-size:11pt;margin:24px 0 8px;color:#0891b2;">Data Source Updates</h3>
<table class="summary-table"><thead><tr><th>Update</th><th style="text-align:left">Sources</th><th style="text-align:left">Files</th><th>By</th><th>Time</th></tr></thead>
<tbody>${dataUpdates.map((u, i) => `<tr><td style="font-weight:bold;">#${i + 1}</td><td style="text-align:left">${u.sources.join(', ')}</td><td style="text-align:left;font-size:7pt;">${u.files.join(', ')}</td><td>${u.user}</td><td>${new Date(u.timestamp).toLocaleString()}</td></tr>`).join('')}</tbody></table>` : ''}
</div>
</div>` : ''}

<script type="application/x-dashboard-report">${embedded}<\/script>
<script>
const riskData = ${JSON.stringify(riskCounts)};
const cslRisk = ${JSON.stringify(cslRiskCounts)};
const cspRisk = ${JSON.stringify(cspRiskCounts)};
const isicVphData = ${JSON.stringify(isicVphAvg)};
const tycomChartData = ${JSON.stringify(Object.entries(tycomData).map(([tycom, d]) => ({ tycom, high: d.high, med: d.med, low: d.low })))};

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + id).classList.add('active');
    event.target.classList.add('active');
    if (id === 'analytics' && !window.chartsInit) { initCharts(); window.chartsInit = true; }
}
function printTab(id) {
    // Add print-active class to the tab we want to print
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('print-active'));
    document.getElementById('tab-' + id).classList.add('print-active');
    window.print();
    // Remove print-active class after printing
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('print-active'));
}
function filterISIC(p, v) {
    const c = document.getElementById(p + '-content');
    const rows = c.querySelectorAll('tbody tr');
    let currentISIC = '';
    rows.forEach(row => {
        const isicCell = row.querySelector('.isic-cell');
        if (isicCell) currentISIC = isicCell.textContent;
        row.style.display = !v || currentISIC === v ? '' : 'none';
    });
}
function initCharts() {
    const el1 = document.getElementById('chart-risk-all');
    if (el1) new Chart(el1, {
        type: 'doughnut',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { plugins: { legend: { position: 'bottom' } } }
    });
    const el2 = document.getElementById('chart-risk-tycom');
    if (el2) new Chart(el2, {
        type: 'bar',
        data: { labels: ['CSL', 'CSP'], datasets: [
            { label: 'High', data: [cslRisk.HIGH, cspRisk.HIGH], backgroundColor: '#dc2626' },
            { label: 'Med', data: [cslRisk.MED, cspRisk.MED], backgroundColor: '#d97706' },
            { label: 'Low', data: [cslRisk.LOW, cspRisk.LOW], backgroundColor: '#059669' }
        ] },
        options: { plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
    });
    const el3 = document.getElementById('chart-vph-isic');
    if (el3) new Chart(el3, {
        type: 'bar',
        data: { labels: isicVphData.map(d => d.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'Avg VPH', data: isicVphData.map(d => d.avg), backgroundColor: '#3b82f6' }] },
        options: { indexAxis: 'y', plugins: { legend: { display: false } } }
    });
    // Analytics section charts
    const pieChart = document.getElementById('analytics-chart-riskPieChart');
    if (pieChart) new Chart(pieChart, {
        type: 'pie',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
    });
    const donutChart = document.getElementById('analytics-chart-riskDonutChart');
    if (donutChart) new Chart(donutChart, {
        type: 'doughnut',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
    });
    const barChart = document.getElementById('analytics-chart-riskDistribution');
    if (barChart) new Chart(barChart, {
        type: 'bar',
        data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskData.HIGH, riskData.MED, riskData.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    const tycomChart = document.getElementById('analytics-chart-riskByTycom');
    if (tycomChart) new Chart(tycomChart, {
        type: 'bar',
        data: {
            labels: tycomChartData.map(t => t.tycom),
            datasets: [
                { label: 'High', data: tycomChartData.map(t => t.high), backgroundColor: '#dc2626' },
                { label: 'Med', data: tycomChartData.map(t => t.med), backgroundColor: '#d97706' },
                { label: 'Low', data: tycomChartData.map(t => t.low), backgroundColor: '#059669' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
    });
    const vphChart = document.getElementById('analytics-chart-vphByIsic');
    if (vphChart) new Chart(vphChart, {
        type: 'bar',
        data: { labels: isicVphData.slice(0,8).map(d => d.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'Avg VPH', data: isicVphData.slice(0,8).map(d => d.avg), backgroundColor: '#3b82f6' }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
    });
}
function showHelpModal() { document.getElementById('help-modal').style.display = 'flex'; }
function hideHelpModal() { document.getElementById('help-modal').style.display = 'none'; }
<\/script>
<div id="help-modal" class="no-print" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;" onclick="hideHelpModal()">
<div style="background:white;border-radius:12px;padding:24px;max-width:600px;max-height:80vh;overflow:auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
<h3 style="font-size:16pt;font-weight:bold;margin-bottom:16px;color:#334155;">Risk Calculation Reference</h3>
<div style="font-size:10pt;">
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#dc2626;margin-bottom:6px;">HIGH Risk</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.highItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#d97706;margin-bottom:6px;">MEDIUM Risk (2 or more of the following)</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.medItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#059669;margin-bottom:6px;">LOW Risk</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.lowItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div style="margin-bottom:16px;">
<h4 style="font-weight:bold;color:#334155;margin-bottom:6px;">Key Calculations</h4>
<ul style="margin-left:20px;color:#475569;list-style:disc;">
${(helpModalText.calcItems || []).map(item => `<li>${formatHelpText(item)}</li>`).join('')}
</ul>
</div>
<div>
<h4 style="font-weight:bold;color:#0ea5e9;margin-bottom:6px;">Scan Exempt</h4>
<p style="color:#475569;">${formatHelpText(helpModalText.scanExempt || '')}</p>
</div>
</div>
<div style="margin-top:20px;"><button onclick="hideHelpModal()" style="background:#0ea5e9;color:white;border:none;padding:10px 24px;border-radius:6px;font-weight:600;cursor:pointer;">Close</button></div>
</div>
</div>
</body></html>`;
};

// Components
const DragDropZone = ({ label, file, onDrop, onClear }) => {
    const [drag, setDrag] = React.useState(false);
    return (
        <div className={`drag-zone p-6 text-center cursor-pointer ${drag ? 'drag-active' : ''} ${file ? 'has-file' : ''}`}
            onDragOver={(e) => { e.preventDefault(); setDrag(true); }} onDragLeave={() => setDrag(false)}
            onDrop={(e) => { e.preventDefault(); setDrag(false); if (e.dataTransfer.files[0]) onDrop(e.dataTransfer.files[0]); }}
            onClick={() => document.getElementById('file-' + label).click()}>
            <div className="font-medium text-slate-600 mb-2">{label}</div>
            {file ? <div className="flex items-center justify-center gap-2"><span className="text-emerald-600">[OK] {file.name}</span><button onClick={(e) => { e.stopPropagation(); onClear(); }} className="text-red-500 ml-2">x</button></div> : <div className="text-slate-400 text-sm">Drag & drop or click</div>}
            <input type="file" accept=".xlsx,.xls,.csv,.ods" onChange={(e) => { if (e.target.files[0]) onDrop(e.target.files[0]); }} className="hidden" id={'file-' + label} />
        </div>
    );
};

const ImportTab = ({ importedFiles, setImportedFiles, settings, setSettings, reportData, onProcess, onAlert, onReportImport }) => {
    const [reportDrag, setReportDrag] = React.useState(false);
    const handleDrop = (key) => (file) => { const r = new FileReader(); r.onload = (e) => setImportedFiles(p => ({...p, [key]: { name: file.name, data: new Uint8Array(e.target.result) }})); r.readAsArrayBuffer(file); };

    const handleReportDrop = async (e) => {
        e.preventDefault(); e.stopPropagation(); setReportDrag(false);
        const file = e.dataTransfer?.files?.[0];
        if (file?.name.endsWith('.html')) { onReportImport(file); }
        else { onAlert({ type: 'error', msg: 'Please drop an HTML report file' }); }
    };

    const handleReportClick = () => { document.getElementById('report-file-input').click(); };
    const handleReportFileChange = (e) => { if (e.target.files?.[0]) onReportImport(e.target.files[0]); };

    const process = () => {
        try {
            const schema = settings.schemaConfig || defaultSchemaConfig;
            const sources = {
                vramNipr: importedFiles.vramNipr ? parseVRAM(importedFiles.vramNipr.data, schema.vram) : null,
                vramSipr: importedFiles.vramSipr ? parseVRAM(importedFiles.vramSipr.data, schema.vram) : null,
                essNipr: importedFiles.essNipr ? parseESS(importedFiles.essNipr.data, schema.ess) : null,
                essSipr: importedFiles.essSipr ? parseESS(importedFiles.essSipr.data, schema.ess) : null,
                tam: importedFiles.tam ? parseTAM(importedFiles.tam.data, schema.tam) : null
            };

            // Check if this is an update to existing report
            const isUpdate = reportData && reportData.boats && reportData.boats.length > 0;
            const updatedSources = Object.entries(sources).filter(([k, v]) => v !== null).map(([k]) => k);

            // Strip raw data from sources to reduce file size (only keep parsed data needed for merging)
            const stripRaw = (src) => src ? { parsed: src.parsed, customFieldDefs: src.customFieldDefs, isicMap: src.isicMap } : null;

            let boats, report;
            if (isUpdate && updatedSources.length > 0) {
                // Merge new sources with existing source data
                const mergedSources = { ...reportData.sourceData };
                Object.entries(sources).forEach(([key, val]) => { if (val !== null) mergedSources[key] = stripRaw(val); });
                const result = mergeData(mergedSources, settings);
                boats = result.boats;

                // Preserve overrides only for fields NOT being updated by new data
                // Map sources to the fields they update
                const sourceFields = {
                    vramNipr: ['vramNiprScanDate', 'vramNiprAssets', 'vramNiprRaVph'],
                    vramSipr: ['vramSiprScanDate', 'vramSiprAssets', 'vramSiprRaVph'],
                    essNipr: ['essNiprProductCompliance', 'essNiprPolicyEnforced', 'essNiprBreakfix', 'essNiprAssets'],
                    essSipr: ['essSiprProductCompliance', 'essSiprPolicyEnforced', 'essSiprBreakfix', 'essSiprAssets'],
                    tam: ['tamPastDue', 'tamExtensions']
                };
                // Get all fields being updated by new sources
                const updatedFields = new Set(updatedSources.flatMap(src => sourceFields[src] || []));

                boats.forEach(newBoat => {
                    const oldBoat = reportData.boats.find(b => b.boatName === newBoat.boatName);
                    // Only keep overrides for fields NOT being updated
                    if (oldBoat?.overrides?.length) {
                        newBoat.overrides = oldBoat.overrides.filter(o => !updatedFields.has(o.field));
                    }
                    if (oldBoat?.notes) newBoat.notes = oldBoat.notes;
                });

                calculateAllRisks(boats, settings.thresholds);

                // Build update changelog entry
                const sourceLabels = { vramNipr: 'VRAM NIPR', vramSipr: 'VRAM SIPR', essNipr: 'ESS NIPR', essSipr: 'ESS SIPR', tam: 'TAM' };
                const updateEntry = { type: 'dataUpdate', sources: updatedSources.map(k => sourceLabels[k] || k), files: updatedSources.map(k => importedFiles[k]?.name).filter(Boolean), timestamp: new Date().toISOString(), user: 'User' };

                report = {
                    ...reportData,
                    boats,
                    sourceData: mergedSources,
                    lastModifiedAt: new Date().toISOString(),
                    version: (reportData.version || 1) + 1,
                    sourceFiles: { ...reportData.sourceFiles, ...Object.fromEntries(updatedSources.map(k => [k, importedFiles[k]?.name])) },
                    dataUpdates: [...(reportData.dataUpdates || []), updateEntry]
                };
                onAlert({ type: 'info', msg: `Updated ${updatedSources.map(k => sourceLabels[k]).join(', ')} - overrides for updated fields were replaced with new data` });
            } else {
                // Fresh report - strip raw data to reduce file size
                const result = mergeData(sources, settings);
                boats = result.boats;
                calculateAllRisks(boats, settings.thresholds);
                const strippedSources = { vramNipr: stripRaw(sources.vramNipr), vramSipr: stripRaw(sources.vramSipr), essNipr: stripRaw(sources.essNipr), essSipr: stripRaw(sources.essSipr), tam: stripRaw(sources.tam) };
                report = { boats, settingsSnapshot: JSON.parse(JSON.stringify(settings)), sourceData: strippedSources, createdAt: new Date().toISOString(), createdBy: '', lastModifiedAt: new Date().toISOString(), lastModifiedBy: '', version: 1, sourceFiles: { vramNipr: importedFiles.vramNipr?.name, vramSipr: importedFiles.vramSipr?.name, essNipr: importedFiles.essNipr?.name, essSipr: importedFiles.essSipr?.name, tam: importedFiles.tam?.name }, dataUpdates: [] };
                if (result.unregistered.length > 0) onAlert({ type: 'warning', msg: `Unregistered: ${result.unregistered.slice(0,5).join(', ')}${result.unregistered.length>5?'...':''} - Add in Settings` });
            }
            onProcess(report);
        } catch (err) { onAlert({ type: 'error', msg: err.message }); }
    };

    const slots = [{ key: 'vramNipr', label: 'VRAM NIPR' }, { key: 'vramSipr', label: 'VRAM SIPR' }, { key: 'essNipr', label: 'ESS NIPR' }, { key: 'essSipr', label: 'ESS SIPR' }, { key: 'tam', label: 'TAM Overdue' }];
    const hasExistingReport = reportData && reportData.boats && reportData.boats.length > 0;
    const hasNewFiles = Object.values(importedFiles).some(f => f);

    return (
        <div>
            {hasExistingReport && (
                <div className="mb-4 p-3 bg-cyan-50 border border-cyan-200 rounded-lg flex items-center gap-3">
                    <span className="text-cyan-700 font-medium">Active Report: v{reportData.version || 1}</span>
                    <span className="text-cyan-600 text-sm">({reportData.boats.length} boats)</span>
                    <span className="text-cyan-500 text-sm">â€¢ Drop new files below to update data sources (overrides for updated fields will be replaced)</span>
                </div>
            )}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <h2 className="text-2xl font-bold mb-4 text-slate-800">{hasExistingReport ? 'Update Data Sources' : 'Import Data Files'}</h2>
                    <div className="grid grid-cols-2 gap-3">{slots.map(s => <DragDropZone key={s.key} label={s.label} file={importedFiles[s.key]} onDrop={handleDrop(s.key)} onClear={() => setImportedFiles(p => ({...p, [s.key]: null}))} />)}</div>
                </div>
                <div>
                    <h2 className="text-2xl font-bold mb-4 text-purple-700">Re-Edit Previous Report</h2>
                    <div className={`drag-zone p-8 text-center cursor-pointer h-full min-h-[200px] flex flex-col items-center justify-center ${reportDrag ? 'drag-active' : ''}`}
                        style={{borderColor: reportDrag ? '#7c3aed' : '#cbd5e1', background: reportDrag ? '#f5f3ff' : '#ffffff'}}
                        onDragOver={(e) => { e.preventDefault(); setReportDrag(true); }} onDragLeave={() => setReportDrag(false)} onDrop={handleReportDrop} onClick={handleReportClick}>
                        <div className="text-2xl mb-3 text-purple-600 font-bold">[RE-EDIT]</div>
                        <div className="font-medium text-slate-600 mb-2">Drop Generated Report HTML</div>
                        <div className="text-slate-400 text-sm">Re-edit with original settings & data</div>
                        <input type="file" accept=".html" onChange={handleReportFileChange} className="hidden" id="report-file-input" />
                    </div>
                </div>
            </div>
            <div className="flex gap-4 flex-wrap">
                <button onClick={process} disabled={!hasNewFiles} className="btn-primary">{hasExistingReport && hasNewFiles ? 'Update & Preview' : 'Process & Preview'}</button>
                <button onClick={() => setImportedFiles({vramNipr:null,vramSipr:null,essNipr:null,essSipr:null,tam:null})} className="btn-secondary">Clear All</button>
            </div>
        </div>
    );
};

// HQ Status Preview Component with customizable metrics
const HQStatusPreview = ({ boats, settings, onLayoutChange }) => {
    const [layout, setLayout] = React.useState(() => settings.hqStatusLayout || defaultHQStatusLayout);
    const [draggedIdx, setDraggedIdx] = React.useState(null);
    const [showAddModal, setShowAddModal] = React.useState(false);

    // Get color thresholds from settings
    const th = settings.thresholds || defaultThresholds;

    // Compute aggregates by ISIC and TYCOM
    const groupByISIC = (boats) => boats.reduce((acc, b) => { (acc[b.isic] = acc[b.isic] || []).push(b); return acc; }, {});

    // Color class functions using HQ-specific thresholds
    const prodCompClass = (v) => v === null ? '' : v >= (th.hq_color_product_green || 95) ? 'risk-low' : v < (th.hq_color_product_red || 90) ? 'risk-high' : 'risk-med';
    const policyCompClass = (v) => v === null ? '' : v >= (th.hq_color_policy_green || 95) ? 'risk-low' : v < (th.hq_color_policy_red || 90) ? 'risk-high' : 'risk-med';
    const policyRawClass = (v) => v === null ? '' : v >= (th.hq_color_policy_raw_green || 95) ? 'risk-low' : v < (th.hq_color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';

    const aggregateByISIC = (boats) => {
        const groups = groupByISIC(boats);
        return Object.entries(groups).map(([isic, isicBoats]) => {
            const nProdVals = isicBoats.filter(b => !b.isNmci && b.essNiprProductCompliance !== null).map(b => b.essNiprProductCompliance);
            const nPolVals = isicBoats.filter(b => !b.isNmci && b.essNiprTruePolicy !== null).map(b => b.essNiprTruePolicy);
            const nPolRawVals = isicBoats.filter(b => !b.isNmci && b.essNiprPolicyEnforced !== null).map(b => b.essNiprPolicyEnforced);
            const sProdVals = isicBoats.filter(b => b.essSiprProductCompliance !== null).map(b => b.essSiprProductCompliance);
            const sPolVals = isicBoats.filter(b => b.essSiprTruePolicy !== null).map(b => b.essSiprTruePolicy);
            const sPolRawVals = isicBoats.filter(b => b.essSiprPolicyEnforced !== null).map(b => b.essSiprPolicyEnforced);
            return {
                isicName: isic,
                isicShort: isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS'),
                boatCount: isicBoats.length,
                niprProdCompAvg: nProdVals.length ? nProdVals.reduce((s,v)=>s+v,0)/nProdVals.length : 0,
                niprPolEnfAvg: nPolVals.length ? nPolVals.reduce((s,v)=>s+v,0)/nPolVals.length : 0,
                niprPolRawAvg: nPolRawVals.length ? nPolRawVals.reduce((s,v)=>s+v,0)/nPolRawVals.length : 0,
                niprBreakfixSum: isicBoats.reduce((s,b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)), 0),
                siprProdCompAvg: sProdVals.length ? sProdVals.reduce((s,v)=>s+v,0)/sProdVals.length : 0,
                siprPolEnfAvg: sPolVals.length ? sPolVals.reduce((s,v)=>s+v,0)/sPolVals.length : 0,
                siprPolRawAvg: sPolRawVals.length ? sPolRawVals.reduce((s,v)=>s+v,0)/sPolRawVals.length : 0,
                siprBreakfixSum: isicBoats.reduce((s,b) => s + (b.essSiprBreakfix || 0), 0),
                highRiskCount: isicBoats.filter(b => b.riskLevel === 'HIGH').length,
                scanExemptCount: isicBoats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length
            };
        }).sort((a,b) => a.isicName.localeCompare(b.isicName));
    };

    const cslBoats = boats.filter(b => b.tycom === 'CSL');
    const cspBoats = boats.filter(b => b.tycom === 'CSP');
    const aggs = { csl: aggregateByISIC(cslBoats), csp: aggregateByISIC(cspBoats) };

    const visibleMetrics = layout.filter(m => m.visible);

    const getMetricValue = (agg, metricId) => {
        switch(metricId) {
            case 'niprProdComp': return { value: agg.niprProdCompAvg.toFixed(1) + '%', className: prodCompClass(agg.niprProdCompAvg) };
            case 'niprPolEnf': return { value: agg.niprPolEnfAvg.toFixed(1) + '%', className: policyCompClass(agg.niprPolEnfAvg) };
            case 'niprPolRaw': return { value: agg.niprPolRawAvg.toFixed(1) + '%', className: policyRawClass(agg.niprPolRawAvg) };
            case 'niprBreakfix': return { value: agg.niprBreakfixSum, className: agg.niprBreakfixSum > 0 ? 'risk-high' : '' };
            case 'siprProdComp': return { value: agg.siprProdCompAvg.toFixed(1) + '%', className: prodCompClass(agg.siprProdCompAvg) };
            case 'siprPolEnf': return { value: agg.siprPolEnfAvg.toFixed(1) + '%', className: policyCompClass(agg.siprPolEnfAvg) };
            case 'siprPolRaw': return { value: agg.siprPolRawAvg.toFixed(1) + '%', className: policyRawClass(agg.siprPolRawAvg) };
            case 'siprBreakfix': return { value: agg.siprBreakfixSum, className: agg.siprBreakfixSum > 0 ? 'risk-high' : '' };
            case 'highRisk': return { value: agg.highRiskCount, className: agg.highRiskCount > 0 ? 'risk-high' : '' };
            case 'scanExempt': return { value: agg.scanExemptCount, className: agg.scanExemptCount > 0 ? 'alert-blue' : '' };
            default: return { value: '-', className: '' };
        }
    };

    const handleDragStart = (idx) => setDraggedIdx(idx);
    const handleDragOver = (e) => e.preventDefault();
    const handleDrop = (targetIdx) => {
        if (draggedIdx === null || draggedIdx === targetIdx) return;
        const newLayout = [...layout];
        const [dragged] = newLayout.splice(draggedIdx, 1);
        newLayout.splice(targetIdx, 0, dragged);
        setLayout(newLayout);
        setDraggedIdx(null);
        if (onLayoutChange) onLayoutChange(newLayout);
    };

    const toggleVisibility = (idx) => {
        const newLayout = [...layout];
        newLayout[idx] = { ...newLayout[idx], visible: !newLayout[idx].visible };
        setLayout(newLayout);
        if (onLayoutChange) onLayoutChange(newLayout);
    };

    const renderTable = (tycom, aggs) => (
        <div className="mb-6">
            <h3 className="text-lg font-bold mb-3 text-slate-700">{tycom} Status</h3>
            <div className="overflow-x-auto">
                <table className="data-table hq-preview-table">
                    <thead>
                        <tr>
                            <th style={{textAlign:'left'}}>Metric</th>
                            {aggs.map(a => <th key={a.isicName}>{a.isicShort} ({a.boatCount})</th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {visibleMetrics.map(metric => (
                            <tr key={metric.id}>
                                <td style={{textAlign:'left',fontWeight:600}}>{metric.label}</td>
                                {aggs.map(a => {
                                    const { value, className } = getMetricValue(a, metric.id);
                                    return <td key={a.isicName} className={className}>{value}</td>;
                                })}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );

    return (
        <div className="card p-4">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-slate-700">HQ Status Preview</h3>
                <button onClick={() => setShowAddModal(!showAddModal)} className="px-3 py-1 bg-cyan-600 text-white rounded text-sm">{showAddModal ? 'Hide' : 'Configure'} Metrics</button>
            </div>

            {showAddModal && (
                <div className="mb-4 p-4 bg-slate-50 rounded border border-slate-200">
                    <p className="text-sm text-slate-600 mb-3">Drag to reorder, click checkbox to show/hide:</p>
                    <div className="space-y-2">
                        {layout.map((metric, idx) => (
                            <div key={metric.id} draggable onDragStart={() => handleDragStart(idx)} onDragOver={handleDragOver} onDrop={() => handleDrop(idx)}
                                className="flex items-center gap-3 p-2 bg-white rounded border border-slate-200 cursor-move hover:bg-slate-50">
                                <span className="text-slate-400">â˜°</span>
                                <input type="checkbox" checked={metric.visible} onChange={() => toggleVisibility(idx)} />
                                <span className={`text-sm ${metric.visible ? 'text-slate-700' : 'text-slate-400'}`}>{metric.label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {renderTable('CSL', aggs.csl)}
            {renderTable('CSP', aggs.csp)}
        </div>
    );
};

// Analytics Preview Component with drag/drop grid
const AnalyticsPreview = ({ boats, settings, onLayoutChange }) => {
    const [showSidebar, setShowSidebar] = React.useState(false);
    const [draggedItem, setDraggedItem] = React.useState(null);
    const [layout, setLayout] = React.useState(() => {
        // Initialize from settings or use default
        return settings.analyticsLayout || defaultAnalyticsLayout;
    });
    const chartRefs = React.useRef({});

    // Compute analytics data
    const riskCounts = { HIGH: boats.filter(b => b.riskLevel === 'HIGH').length, MED: boats.filter(b => b.riskLevel === 'MED').length, LOW: boats.filter(b => b.riskLevel === 'LOW').length };
    const vphValues = boats.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
    const avgVph = vphValues.length > 0 ? (vphValues.reduce((s, v) => s + v, 0) / vphValues.length).toFixed(2) : '0';
    const totalBreakfix = boats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
    const compValues = boats.flatMap(b => { const v = []; if (!b.isNmci && b.essNiprProductCompliance !== null) v.push(b.essNiprProductCompliance); if (b.essSiprProductCompliance !== null) v.push(b.essSiprProductCompliance); return v; });
    const avgCompliance = compValues.length > 0 ? Math.min(100, compValues.reduce((s, v) => s + v, 0) / compValues.length).toFixed(1) : '0';
    const scanExemptCount = boats.filter(b => b.vramNiprScanExempt || b.vramSiprScanExempt).length;

    // Helper functions
    const getBoatMaxVph = (b) => { const nipr = b.isNmci ? null : b.vramNiprRaVph; const sipr = b.vramSiprRaVph; if (nipr !== null && sipr !== null) return Math.max(nipr, sipr); return nipr !== null ? nipr : sipr; };
    const getBoatMinCompliance = (b) => { const nipr = b.isNmci ? null : b.essNiprProductCompliance; const sipr = b.essSiprProductCompliance; if (nipr !== null && sipr !== null) return Math.min(nipr, sipr); return nipr !== null ? nipr : sipr; };
    const getBoatTotalBreakfix = (b) => (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0);

    // Rankings data
    const worstVph = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(b)||0) - (getBoatMaxVph(a)||0)).slice(0, 5);
    const bestVph = [...boats].filter(b => getBoatMaxVph(b) != null).sort((a,b) => (getBoatMaxVph(a)||0) - (getBoatMaxVph(b)||0)).slice(0, 5);
    const worstCompliance = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(a)||0) - (getBoatMinCompliance(b)||0)).slice(0, 5);
    const bestCompliance = [...boats].filter(b => getBoatMinCompliance(b) != null).sort((a,b) => (getBoatMinCompliance(b)||0) - (getBoatMinCompliance(a)||0)).slice(0, 5);
    const boatsBreakfix = [...boats].filter(b => getBoatTotalBreakfix(b) > 0).sort((a,b) => getBoatTotalBreakfix(b) - getBoatTotalBreakfix(a)).slice(0, 5);
    const highRiskBoats = boats.filter(b => b.riskLevel === 'HIGH');

    // ISIC data for rankings
    const groupByISIC = (boats) => boats.reduce((acc, b) => { acc[b.isic] = acc[b.isic] || []; acc[b.isic].push(b); return acc; }, {});
    const isicData = Object.entries(groupByISIC(boats)).map(([isic, ib]) => {
        const vphVals = ib.flatMap(b => { const v = []; if (!b.isNmci && b.vramNiprRaVph !== null) v.push(b.vramNiprRaVph); if (b.vramSiprRaVph !== null) v.push(b.vramSiprRaVph); return v; });
        return { isic, boats: ib.length, high: ib.filter(b=>b.riskLevel==='HIGH').length, low: ib.filter(b=>b.riskLevel==='LOW').length, lowPct: ib.length ? (ib.filter(b=>b.riskLevel==='LOW').length/ib.length*100) : 0, avgVph: vphVals.length > 0 ? vphVals.reduce((s,v)=>s+v,0)/vphVals.length : 0 };
    });
    const worstIsicsRisk = [...isicData].sort((a,b) => b.high - a.high).slice(0, 5);
    const bestIsicsRisk = [...isicData].sort((a,b) => b.lowPct - a.lowPct).slice(0, 5);
    const worstIsicsVph = [...isicData].sort((a,b) => b.avgVph - a.avgVph).slice(0, 5);

    // TYCOM data
    const groupByTycom = (boats) => boats.reduce((acc, b) => { const t = b.tycom || 'Unknown'; acc[t] = acc[t] || []; acc[t].push(b); return acc; }, {});
    const tycomData = Object.entries(groupByTycom(boats)).map(([tycom, tb]) => ({
        tycom, boats: tb.length, high: tb.filter(b=>b.riskLevel==='HIGH').length, med: tb.filter(b=>b.riskLevel==='MED').length, low: tb.filter(b=>b.riskLevel==='LOW').length
    }));

    // Available elements for sidebar
    const availableElements = [
        { id: 'totalBoats', type: 'stat', label: 'Total Boats' },
        { id: 'highRisk', type: 'stat', label: 'High Risk Count' },
        { id: 'medRisk', type: 'stat', label: 'Medium Risk Count' },
        { id: 'lowRisk', type: 'stat', label: 'Low Risk Count' },
        { id: 'avgVph', type: 'stat', label: 'Avg VPH' },
        { id: 'totalBreakfix', type: 'stat', label: 'Total Breakfix' },
        { id: 'avgCompliance', type: 'stat', label: 'Avg Compliance' },
        { id: 'scanExempt', type: 'stat', label: 'Scan Exempt' },
        { id: 'riskPieChart', type: 'chart', label: 'Risk Pie Chart' },
        { id: 'riskDonutChart', type: 'chart', label: 'Risk Donut Chart' },
        { id: 'riskDistribution', type: 'chart', label: 'Risk Bar Chart' },
        { id: 'riskByTycom', type: 'chart', label: 'Risk by TYCOM' },
        { id: 'vphByIsic', type: 'chart', label: 'VPH by ISIC' },
        { id: 'highRiskTable', type: 'chart', label: 'High Risk Boats Table' },
        { id: 'worstBoatsVph', type: 'ranking', label: 'Worst Boats by VPH' },
        { id: 'bestBoatsVph', type: 'ranking', label: 'Best Boats by VPH' },
        { id: 'worstBoatsCompliance', type: 'ranking', label: 'Worst by Compliance' },
        { id: 'bestBoatsCompliance', type: 'ranking', label: 'Best by Compliance' },
        { id: 'boatsWithBreakfix', type: 'ranking', label: 'Boats with Breakfix' },
        { id: 'worstIsicsRisk', type: 'ranking', label: 'Worst ISICs by Risk' },
        { id: 'bestIsicsRisk', type: 'ranking', label: 'Best ISICs by Risk' },
        { id: 'worstIsicsVph', type: 'ranking', label: 'Worst ISICs by VPH' },
        { id: 'tycomComparison', type: 'ranking', label: 'TYCOM Comparison' },
        { id: 'riskSummaryByIsic', type: 'table', label: 'Risk Summary by ISIC' },
    ];

    const activeIds = layout.map(l => l.id);
    const inactiveElements = availableElements.filter(e => !activeIds.includes(e.id));

    // Initialize Chart.js charts
    React.useEffect(() => {
        if (typeof Chart === 'undefined') return;

        const initChart = (id, config) => {
            const canvas = document.getElementById(`preview-chart-${id}`);
            if (!canvas) return;
            if (chartRefs.current[id]) {
                chartRefs.current[id].destroy();
            }
            chartRefs.current[id] = new Chart(canvas, config);
        };

        // Risk Pie Chart
        if (activeIds.includes('riskPieChart')) {
            initChart('riskPieChart', {
                type: 'pie',
                data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskCounts.HIGH, riskCounts.MED, riskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }

        // Risk Donut Chart
        if (activeIds.includes('riskDonutChart')) {
            initChart('riskDonutChart', {
                type: 'doughnut',
                data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskCounts.HIGH, riskCounts.MED, riskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } } }
            });
        }

        // Risk Bar Chart
        if (activeIds.includes('riskDistribution')) {
            initChart('riskDistribution', {
                type: 'bar',
                data: { labels: ['High', 'Medium', 'Low'], datasets: [{ data: [riskCounts.HIGH, riskCounts.MED, riskCounts.LOW], backgroundColor: ['#dc2626', '#d97706', '#059669'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        // Risk by TYCOM Chart
        if (activeIds.includes('riskByTycom')) {
            initChart('riskByTycom', {
                type: 'bar',
                data: {
                    labels: tycomData.map(t => t.tycom),
                    datasets: [
                        { label: 'High', data: tycomData.map(t => t.high), backgroundColor: '#dc2626' },
                        { label: 'Med', data: tycomData.map(t => t.med), backgroundColor: '#d97706' },
                        { label: 'Low', data: tycomData.map(t => t.low), backgroundColor: '#059669' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8, font: { size: 10 } } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        }

        // VPH by ISIC Chart
        if (activeIds.includes('vphByIsic')) {
            const sortedIsic = [...isicData].sort((a,b) => b.avgVph - a.avgVph).slice(0, 8);
            initChart('vphByIsic', {
                type: 'bar',
                data: { labels: sortedIsic.map(i => i.isic.replace('COMSUBRON ', 'CSS').replace('COMSUBDEVRON ', 'CSDS')), datasets: [{ label: 'Avg VPH', data: sortedIsic.map(i => i.avgVph), backgroundColor: '#3b82f6' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        return () => {
            Object.values(chartRefs.current).forEach(chart => chart?.destroy());
        };
    }, [layout, riskCounts.HIGH, riskCounts.MED, riskCounts.LOW, tycomData, isicData]);

    const handleDragStart = (item) => setDraggedItem(item);
    const handleDragEnd = () => setDraggedItem(null);

    const handleDrop = (targetRow, targetCol) => {
        if (!draggedItem) return;

        const draggedWidth = draggedItem.width || 1;
        const draggedHeight = draggedItem.height || 1;

        // Check if target cell already has an item
        const existingItem = layout.find(l => l.row === targetRow && l.col === targetCol);

        // Check if target cell is covered by a multi-cell widget
        const isCovered = layout.some(item => {
            if (item.id === draggedItem.id) return false;
            const iw = item.width || 1;
            const ih = item.height || 1;
            const inWidthRange = targetCol >= item.col && targetCol < item.col + iw;
            const inHeightRange = targetRow >= item.row && targetRow < item.row + ih;
            const isOrigin = targetRow === item.row && targetCol === item.col;
            return inWidthRange && inHeightRange && !isOrigin;
        });

        // Check if dropping widget would go off grid or overlap another widget
        const wouldOverlap = (draggedWidth > 1 || draggedHeight > 1) && (
            targetCol + draggedWidth > 4 ||
            layout.some(l => {
                if (l.id === draggedItem.id) return false;
                const lw = l.width || 1;
                const lh = l.height || 1;
                // Check if any cell in the dragged widget's area would overlap with this layout item
                for (let r = targetRow; r < targetRow + draggedHeight; r++) {
                    for (let c = targetCol; c < targetCol + draggedWidth; c++) {
                        if (r >= l.row && r < l.row + lh && c >= l.col && c < l.col + lw) return true;
                    }
                }
                return false;
            })
        );

        if (isCovered || wouldOverlap) {
            setDraggedItem(null);
            return;
        }

        if (draggedItem.isNew) {
            // Adding from sidebar - only if cell is empty
            if (!existingItem) {
                setLayout(prev => {
                    const newLayout = [...prev, { id: draggedItem.id, type: draggedItem.type, row: targetRow, col: targetCol, width: 1, height: 1 }];
                    if (onLayoutChange) onLayoutChange(newLayout);
                    return newLayout;
                });
            }
        } else {
            // Moving existing item - swap positions if target has item
            if (existingItem && existingItem.id !== draggedItem.id) {
                // Swap: move existing item to dragged item's old position
                const draggedOld = layout.find(l => l.id === draggedItem.id);
                setLayout(prev => {
                    const newLayout = prev.map(item => {
                        if (item.id === draggedItem.id) return { ...item, row: targetRow, col: targetCol };
                        if (item.id === existingItem.id) return { ...item, row: draggedOld?.row, col: draggedOld?.col };
                        return item;
                    });
                    if (onLayoutChange) onLayoutChange(newLayout);
                    return newLayout;
                });
            } else if (!existingItem) {
                // Move to empty cell (preserve width/height)
                setLayout(prev => {
                    const newLayout = prev.map(item => item.id === draggedItem.id ? { ...item, row: targetRow, col: targetCol } : item);
                    if (onLayoutChange) onLayoutChange(newLayout);
                    return newLayout;
                });
            }
        }
        setDraggedItem(null);
    };

    const removeItem = (id) => {
        setLayout(prev => {
            const newLayout = prev.filter(item => item.id !== id);
            if (onLayoutChange) onLayoutChange(newLayout);
            return newLayout;
        });
    };

    // Render element content
    const renderElement = (item) => {
        const statStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full";
        const chartStyle = "bg-white rounded-lg p-4 shadow border border-slate-200 h-full flex flex-col";
        const valueStyle = "text-3xl font-bold";
        const labelStyle = "text-sm text-slate-500";

        switch(item.id) {
            case 'totalBoats': return <div className={statStyle}><div className={labelStyle}>Total Boats</div><div className={valueStyle}>{boats.length}</div></div>;
            case 'highRisk': return <div className={statStyle}><div className={labelStyle}>High Risk</div><div className={`${valueStyle} text-red-600`}>{riskCounts.HIGH}</div></div>;
            case 'medRisk': return <div className={statStyle}><div className={labelStyle}>Medium Risk</div><div className={`${valueStyle} text-amber-600`}>{riskCounts.MED}</div></div>;
            case 'lowRisk': return <div className={statStyle}><div className={labelStyle}>Low Risk</div><div className={`${valueStyle} text-emerald-600`}>{riskCounts.LOW}</div></div>;
            case 'avgVph': return <div className={statStyle}><div className={labelStyle}>Avg RA VPH</div><div className={valueStyle}>{avgVph}</div></div>;
            case 'totalBreakfix': return <div className={statStyle}><div className={labelStyle}>Total Breakfix</div><div className={`${valueStyle} ${totalBreakfix > 0 ? 'text-red-600' : ''}`}>{totalBreakfix}</div></div>;
            case 'avgCompliance': return <div className={statStyle}><div className={labelStyle}>Avg ESS Compliance</div><div className={valueStyle}>{avgCompliance}%</div></div>;
            case 'scanExempt': return <div className={statStyle}><div className={labelStyle}>Scan Exempt</div><div className={valueStyle}>{scanExemptCount}</div></div>;
            case 'riskPieChart': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Risk Pie Chart</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskPieChart"></canvas>
                    </div>
                </div>
            );
            case 'riskDonutChart': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Risk Donut</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskDonutChart"></canvas>
                    </div>
                </div>
            );
            case 'riskDistribution': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Risk Bar Chart</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskDistribution"></canvas>
                    </div>
                </div>
            );
            case 'highRiskTable': {
                const showReasons = (item.width || 1) > 1;
                const maxBoats = (item.height || 1) > 1 ? 10 : 5;
                return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">High Risk Boats ({highRiskBoats.length})</div>
                    {highRiskBoats.length === 0 ? <div className="text-emerald-600 font-medium">No high-risk boats</div> : (
                        <div className="text-sm flex-1 overflow-auto">
                            {showReasons ? (
                                <table className="w-full text-left">
                                    <thead><tr><th className="pb-1 border-b border-slate-200 text-slate-500 font-medium">Boat</th><th className="pb-1 border-b border-slate-200 text-slate-500 font-medium">Reason</th></tr></thead>
                                    <tbody>
                                        {highRiskBoats.slice(0,maxBoats).map(b => <tr key={b.boatName} className="border-b border-slate-100"><td className="py-1 font-mono text-cyan-600">{b.boatName}</td><td className="py-1 text-xs text-red-600">{b.riskReasons?.join(', ') || '-'}</td></tr>)}
                                    </tbody>
                                </table>
                            ) : (
                                highRiskBoats.slice(0,maxBoats).map(b => <div key={b.boatName} className="py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span></div>)
                            )}
                            {highRiskBoats.length > maxBoats && <div className="text-slate-400 text-xs mt-1">+{highRiskBoats.length - maxBoats} more</div>}
                        </div>
                    )}
                </div>
            );
            }
            case 'worstBoatsVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst Boats by VPH</div>
                    <div className="text-sm flex-1 overflow-auto">{worstVph.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-red-600">{(getBoatMaxVph(b)||0).toFixed(2)}</span></div>)}</div>
                </div>
            );
            case 'bestBoatsVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Best Boats by VPH</div>
                    <div className="text-sm flex-1 overflow-auto">{bestVph.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-emerald-600">{(getBoatMaxVph(b)||0).toFixed(2)}</span></div>)}</div>
                </div>
            );
            case 'worstBoatsCompliance': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst by Compliance</div>
                    <div className="text-sm flex-1 overflow-auto">{worstCompliance.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-red-600">{(getBoatMinCompliance(b)||0).toFixed(1)}%</span></div>)}</div>
                </div>
            );
            case 'bestBoatsCompliance': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Best by Compliance</div>
                    <div className="text-sm flex-1 overflow-auto">{bestCompliance.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-emerald-600">{(getBoatMinCompliance(b)||0).toFixed(1)}%</span></div>)}</div>
                </div>
            );
            case 'boatsWithBreakfix': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Boats with Breakfix</div>
                    {boatsBreakfix.length === 0 ? <div className="text-emerald-600">None</div> : (
                        <div className="text-sm flex-1 overflow-auto">{boatsBreakfix.map(b => <div key={b.boatName} className="flex justify-between py-1 border-b border-slate-100"><span className="font-mono text-cyan-600">{b.boatName}</span><span className="text-red-600">{getBoatTotalBreakfix(b)}</span></div>)}</div>
                    )}
                </div>
            );
            case 'riskByTycom': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">Risk by TYCOM</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-riskByTycom"></canvas>
                    </div>
                </div>
            );
            case 'vphByIsic': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-2">VPH by ISIC</div>
                    <div className="flex-1 relative" style={{minHeight: '120px'}}>
                        <canvas id="preview-chart-vphByIsic"></canvas>
                    </div>
                </div>
            );
            case 'worstIsicsRisk': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst ISICs by Risk</div>
                    <div className="text-sm flex-1 overflow-auto">{worstIsicsRisk.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-red-600">{i.high} high</span></div>)}</div>
                </div>
            );
            case 'bestIsicsRisk': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Best ISICs by Risk</div>
                    <div className="text-sm flex-1 overflow-auto">{bestIsicsRisk.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-emerald-600">{i.lowPct.toFixed(0)}% low</span></div>)}</div>
                </div>
            );
            case 'worstIsicsVph': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Worst ISICs by VPH</div>
                    <div className="text-sm flex-1 overflow-auto">{worstIsicsVph.map(i => <div key={i.isic} className="flex justify-between py-1 border-b border-slate-100"><span>{i.isic}</span><span className="text-red-600">{i.avgVph.toFixed(2)}</span></div>)}</div>
                </div>
            );
            case 'tycomComparison': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">TYCOM Comparison</div>
                    <div className="text-sm flex-1 overflow-auto">
                        <div className="grid grid-cols-5 gap-1 text-xs font-medium text-slate-500 mb-1"><span>TYCOM</span><span>Boats</span><span>High</span><span>Med</span><span>Low</span></div>
                        {tycomData.map(t => <div key={t.tycom} className="grid grid-cols-5 gap-1 text-xs py-1 border-b border-slate-100"><span className="truncate">{t.tycom}</span><span>{t.boats}</span><span className="text-red-600">{t.high}</span><span className="text-amber-600">{t.med}</span><span className="text-emerald-600">{t.low}</span></div>)}
                    </div>
                </div>
            );
            case 'riskSummaryByIsic': return (
                <div className={chartStyle}>
                    <div className="font-bold text-slate-700 mb-3">Risk Summary by ISIC</div>
                    <div className="text-sm flex-1 overflow-auto">
                        <div className="grid grid-cols-7 gap-1 text-xs font-medium text-slate-500 mb-1 sticky top-0 bg-white"><span>ISIC</span><span>Boats</span><span>High</span><span>Med</span><span>Low</span><span>VPH</span><span>BF</span></div>
                        {isicData.sort((a,b) => b.high - a.high).map(i => {
                            const isicBoats = boats.filter(b => b.isic === i.isic);
                            const bf = isicBoats.reduce((s, b) => s + (b.isNmci ? 0 : (b.essNiprBreakfix || 0)) + (b.essSiprBreakfix || 0), 0);
                            const med = isicBoats.filter(b => b.riskLevel === 'MED').length;
                            return <div key={i.isic} className="grid grid-cols-7 gap-1 text-xs py-1 border-b border-slate-100"><span className="truncate font-medium">{i.isic}</span><span>{i.boats}</span><span className={i.high > 0 ? 'text-red-600 font-bold' : ''}>{i.high}</span><span className={med > 0 ? 'text-amber-600 font-bold' : ''}>{med}</span><span className="text-emerald-600">{i.low}</span><span>{i.avgVph.toFixed(2)}</span><span className={bf > 0 ? 'text-red-600' : ''}>{bf}</span></div>;
                        })}
                    </div>
                </div>
            );
            default: return <div className="bg-slate-100 rounded-lg p-4">{item.id}</div>;
        }
    };

    // Cycle through sizes: 1x1 -> 2x1 -> 4x1 -> 1x2 -> 2x2 -> 4x2 -> 1x1 (auto-saves)
    const cycleSize = (id) => {
        setLayout(prev => {
            const newLayout = prev.map(item => {
                if (item.id === id) {
                    const w = item.width || 1;
                    const h = item.height || 1;
                    let newW = 1, newH = 1;
                    if (w === 1 && h === 1) { newW = 2; newH = 1; }      // 1x1 -> 2x1
                    else if (w === 2 && h === 1) { newW = 4; newH = 1; } // 2x1 -> 4x1 (full width)
                    else if (w === 4 && h === 1) { newW = 1; newH = 2; } // 4x1 -> 1x2
                    else if (w === 1 && h === 2) { newW = 2; newH = 2; } // 1x2 -> 2x2
                    else if (w === 2 && h === 2) { newW = 4; newH = 2; } // 2x2 -> 4x2 (full width tall)
                    else { newW = 1; newH = 1; }                         // 4x2 -> 1x1
                    // Ensure we don't go off grid - full width items must be at col 0
                    let newCol = item.col;
                    if (newW === 4) { newCol = 0; }
                    else if (newW === 2) { newCol = Math.min(item.col, 2); }
                    return { ...item, width: newW, height: newH, col: newCol };
                }
                return item;
            });
            // Auto-save to settings
            if (onLayoutChange) onLayoutChange(newLayout);
            return newLayout;
        });
    };

    // Check if a cell is covered by a multi-cell widget
    const isCellCovered = (row, col) => {
        return layout.some(item => {
            const iw = item.width || 1;
            const ih = item.height || 1;
            // Check if this cell falls within the item's area (but not the origin cell)
            const inWidthRange = col >= item.col && col < item.col + iw;
            const inHeightRange = row >= item.row && row < item.row + ih;
            const isOrigin = row === item.row && col === item.col;
            return inWidthRange && inHeightRange && !isOrigin;
        });
    };

    // Grid cells (4 columns x many rows)
    const maxRow = Math.max(...layout.map(l => l.row + (l.height || 1) - 1), 3) + 1;
    const gridCells = [];
    for (let row = 0; row <= maxRow; row++) {
        for (let col = 0; col < 4; col++) {
            // Skip cells that are covered by multi-cell widgets
            if (!isCellCovered(row, col)) {
                gridCells.push({ row, col });
            }
        }
    }

    return (
        <div className="flex gap-4">
            <div className="flex-1">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold text-slate-700">Analytics Preview</h3>
                    <div className="flex gap-2">
                        <button onClick={() => setShowSidebar(!showSidebar)} className="px-3 py-1 bg-cyan-600 text-white rounded text-sm">{showSidebar ? 'Hide' : 'Add'} Widgets</button>
                        <span className="text-xs text-slate-400 self-center">Auto-saves</span>
                    </div>
                </div>
                <div className="grid grid-cols-4 gap-3 min-h-[400px]" style={{gridAutoRows: 'minmax(100px, auto)'}}>
                    {gridCells.map(cell => {
                        const item = layout.find(l => l.row === cell.row && l.col === cell.col);
                        const itemWidth = item?.width || 1;
                        const itemHeight = item?.height || 1;
                        const sizeLabel = `${itemWidth}x${itemHeight}`;
                        return (
                            <div
                                key={`${cell.row}-${cell.col}`}
                                className={`relative rounded border-2 border-dashed ${item ? 'border-transparent' : 'border-slate-200 bg-slate-50'} ${draggedItem ? 'hover:bg-cyan-50 hover:border-cyan-400' : ''}`}
                                style={{
                                    gridColumn: `${cell.col + 1} / span ${itemWidth}`,
                                    gridRow: `${cell.row + 1} / span ${itemHeight}`
                                }}
                                onDragOver={(e) => { e.preventDefault(); }}
                                onDrop={() => handleDrop(cell.row, cell.col)}
                            >
                                {item && (
                                    <div
                                        draggable
                                        onDragStart={() => handleDragStart(item)}
                                        onDragEnd={handleDragEnd}
                                        className="cursor-move h-full"
                                    >
                                        <button onClick={() => removeItem(item.id)} className="absolute top-1 right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs z-10 hover:bg-red-600">Ã—</button>
                                        <button onClick={() => cycleSize(item.id)} className="absolute top-1 right-7 px-1 h-5 bg-blue-500 text-white rounded text-xs z-10 hover:bg-blue-600" title="Cycle size: 1x1 â†’ 2x1 â†’ 4x1 â†’ 1x2 â†’ 2x2 â†’ 4x2">
                                            {sizeLabel}
                                        </button>
                                        {renderElement(item)}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
            {showSidebar && (
                <div className="w-64 bg-slate-100 rounded-lg p-4">
                    <h4 className="font-bold text-slate-700 mb-3">Available Widgets</h4>
                    <p className="text-xs text-slate-500 mb-3">Drag widgets to the grid to add them</p>
                    <div className="space-y-2">
                        {inactiveElements.map(el => (
                            <div
                                key={el.id}
                                draggable
                                onDragStart={() => handleDragStart({ ...el, isNew: true })}
                                onDragEnd={handleDragEnd}
                                className="p-2 bg-white rounded border border-slate-200 cursor-move hover:bg-cyan-50 hover:border-cyan-400 text-sm"
                            >
                                {el.label}
                            </div>
                        ))}
                        {inactiveElements.length === 0 && <div className="text-slate-400 text-sm">All widgets are on the grid</div>}
                    </div>
                </div>
            )}
        </div>
    );
};

const PreviewTab = ({ reportData, setReportData, settings, setSettings, onRequestName }) => {
    const [subTab, setSubTab] = React.useState('csl');
    const [selectedISIC, setSelectedISIC] = React.useState('');
    const [overrideModal, setOverrideModal] = React.useState(null);
    const [showOverrideLog, setShowOverrideLog] = React.useState(false);
    const [showThresholds, setShowThresholds] = React.useState(false);
    const [previewThresholds, setPreviewThresholds] = React.useState(null);
    const [notesModal, setNotesModal] = React.useState(null);
    const [showHelp, setShowHelp] = React.useState(false);
    const [showGenerateConfirm, setShowGenerateConfirm] = React.useState(false);

    // Sync preview thresholds when settings change
    React.useEffect(() => {
        if (reportData) {
            setPreviewThresholds({ ...settings.thresholds });
        }
    }, [reportData, JSON.stringify(settings.thresholds)]);

    if (!reportData) return <div className="text-center py-12 text-slate-400">No data loaded. Import files or drop a report.</div>;

    const activeThresholds = previewThresholds || settings.thresholds;
    const thresholdChanges = previewThresholds ? Object.keys(settings.thresholds).filter(k => settings.thresholds[k] !== previewThresholds[k]) : [];

    const { boats } = reportData; const aggs = aggregateByISIC(boats, settings);
    const current = subTab === 'csl' ? boats.filter(b => b.tycom === 'CSL') : subTab === 'csp' ? boats.filter(b => b.tycom === 'CSP') : [];
    const isics = [...new Set(current.map(b => b.isic))];
    const filtered = selectedISIC ? current.filter(b => b.isic === selectedISIC) : current;
    const groupByISIC = (list) => { const g = {}; for (const b of list) { if (!g[b.isic]) g[b.isic] = []; g[b.isic].push(b); } return g; };

    // Schema visibility helpers
    const schema = settings.schemaConfig || defaultSchemaConfig;
    const isVisible = (type, field) => { const item = schema[type]?.find(s => s.field === field); return item?.visible !== false; };

    // Get visible standard fields in schema order (excluding meta fields)
    const getVisibleStandardFields = (schemaArray, metaFields, type) => {
        return schemaArray.filter(f => f.visible !== false && !metaFields.includes(f.field) && standardFields[type].includes(f.field));
    };
    const essMetaFields = ['shipName', 'isic'];
    const vramMetaFields = ['siteName', 'scanExempt'];
    const tamMetaFields = ['boatName'];

    const essVisibleFields = getVisibleStandardFields(schema.ess, essMetaFields, 'ess');
    const vramVisibleFields = getVisibleStandardFields(schema.vram, vramMetaFields, 'vram');
    const tamVisibleFields = getVisibleStandardFields(schema.tam, tamMetaFields, 'tam');

    // Custom fields
    const essCustomFields = getCustomFields(schema.ess, 'ess');
    const vramCustomFields = getCustomFields(schema.vram, 'vram');
    const tamCustomFields = getCustomFields(schema.tam, 'tam');
    const fmtCustom = (v) => v === null || v === undefined ? '-' : (typeof v === 'number' ? (Number.isInteger(v) ? v : v.toFixed(2)) : String(v));

    // Column counts based on schema order
    const essNiprCount = essVisibleFields.length + essCustomFields.length;
    const essSiprCount = essNiprCount;
    const vramNiprCount = vramVisibleFields.length + vramCustomFields.length;
    const vramSiprCount = vramNiprCount;
    const tamCount = tamVisibleFields.length + tamCustomFields.length;
    const showVramExempt = isVisible('vram', 'scanExempt');
    const statusCount = 1 + (showVramExempt ? 1 : 0) + 1;

    const allOverrides = boats.flatMap(b => (b.overrides || []).map(o => ({ ...o, boatName: b.boatName })));

    const generate = () => {
        onRequestName((name) => {
            const userName = name || 'Unknown';
            // Build threshold change log if thresholds were modified
            const thresholdLog = thresholdChanges.map(k => ({
                field: k,
                defaultValue: settings.thresholds[k],
                newValue: previewThresholds[k],
                reason: 'Adjusted for this report',
                timestamp: new Date().toISOString(),
                user: userName
            }));
            // Update boats with user name in overrides (replace "User" placeholder)
            const updatedBoats = reportData.boats.map(b => ({
                ...b,
                overrides: (b.overrides || []).map(o => ({
                    ...o,
                    user: o.user === 'User' ? userName : o.user
                }))
            }));
            // Update dataUpdates with user name (replace "User" placeholder)
            const updatedDataUpdates = (reportData.dataUpdates || []).map(u => ({
                ...u,
                user: u.user === 'User' ? userName : u.user
            }));
            const updatedReport = {
                ...reportData,
                boats: updatedBoats,
                dataUpdates: updatedDataUpdates,
                createdBy: userName,
                lastModifiedBy: userName,
                thresholdChanges: thresholdLog,
                usedThresholds: previewThresholds || settings.thresholds
            };
            const html = generateReportHTML(updatedReport, settings);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], { type: 'text/html' })); a.download = `cyber-report-${new Date().toISOString().slice(0,10)}.html`; a.click();
        });
    };

    // Update the current user name for overrides
    const [currentUserName, setCurrentUserName] = React.useState('');

    const fmt = (v, d=0) => v == null ? '-' : (d > 0 ? v.toFixed(d) : Math.round(v).toString());
    const fmtPct = (v) => v == null ? '-' : Math.min(100, v).toFixed(1) + '%';
    const fmtDate = (d) => d ? `${new Date(d).getMonth()+1}/${new Date(d).getDate()}` : '-';
    // Updated color classes using activeThresholds for real-time updates with separate thresholds per metric
    // Product Compliance: green/yellow/red
    const prodCompClass = (v) => v === null ? '' : v >= (activeThresholds.color_product_green || 95) ? 'risk-low' : v < (activeThresholds.color_product_red || 90) ? 'risk-high' : 'risk-med';
    // Policy Compliance (True Policy): green/yellow/red
    const policyCompClass = (v) => v === null ? '' : v >= (activeThresholds.color_policy_green || 95) ? 'risk-low' : v < (activeThresholds.color_policy_red || 90) ? 'risk-high' : 'risk-med';
    // Policy Enforced Raw: green/yellow/red
    const policyRawClass = (v) => v === null ? '' : v >= (activeThresholds.color_policy_raw_green || 95) ? 'risk-low' : v < (activeThresholds.color_policy_raw_red || 90) ? 'risk-high' : 'risk-med';
    // Generic compliance class (backward compat, uses product thresholds)
    const compClass = prodCompClass;
    // VPH: green < threshold, red >= threshold, else yellow
    const vphClass = (v) => v === null ? '' : v < (activeThresholds.color_vph_green || 2.5) ? 'risk-low' : v >= (activeThresholds.color_vph_red || 3.5) ? 'risk-high' : 'risk-med';
    // Scan age: green <= threshold, red > threshold
    const scanAgeClass = (d) => {
        if (!d) return 'risk-high';
        const date = new Date(d);
        if (isNaN(date.getTime())) return 'risk-high';
        const age = Math.floor((new Date() - date) / 86400000);
        return age <= (activeThresholds.color_scan_green || 14) ? 'risk-low' : age > (activeThresholds.color_scan_red || 14) ? 'risk-high' : 'risk-med';
    };

    const fieldLabels = {
        essNiprAssets: 'ESS NIPR Assets', essNiprBreakfix: 'ESS NIPR Breakfix', essNiprProductCompliance: 'ESS NIPR Compliance', essNiprPolicyEnforced: 'ESS NIPR Policy Enforced', essNiprTruePolicy: 'ESS NIPR True Policy',
        essSiprAssets: 'ESS SIPR Assets', essSiprBreakfix: 'ESS SIPR Breakfix', essSiprProductCompliance: 'ESS SIPR Compliance', essSiprPolicyEnforced: 'ESS SIPR Policy Enforced', essSiprTruePolicy: 'ESS SIPR True Policy',
        vramNiprAssets: 'VRAM NIPR Assets', vramNiprRaVph: 'VRAM NIPR VPH', vramNiprRaCrit: 'VRAM NIPR RA Critical', vramNiprRaHigh: 'VRAM NIPR RA High', vramNiprScanIntegrity: 'VRAM NIPR Integrity', vramNiprScanPercent: 'VRAM NIPR Percent',
        vramSiprAssets: 'VRAM SIPR Assets', vramSiprRaVph: 'VRAM SIPR VPH', vramSiprRaCrit: 'VRAM SIPR RA Critical', vramSiprRaHigh: 'VRAM SIPR RA High', vramSiprScanIntegrity: 'VRAM SIPR Integrity', vramSiprScanPercent: 'VRAM SIPR Percent',
        tamPastDue: 'TAM Past Due', tamExtensions: 'TAM Extensions', riskLevel: 'Risk Level',
        vramNiprScanExempt: 'NIPR Scan Exempt', vramSiprScanExempt: 'SIPR Scan Exempt',
        vramNiprScanDate: 'NIPR Last Scan Date', vramSiprScanDate: 'SIPR Last Scan Date'
    };
    const dateFields = ['vramNiprScanDate', 'vramSiprScanDate'];

    // Recalculate risks with current thresholds when thresholds change
    const recalculateWithThresholds = (newThresholds) => {
        setPreviewThresholds(newThresholds);
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                const { level, reasons } = calculateRisk(b, newThresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
    };

    const resetThresholds = () => {
        setPreviewThresholds({ ...settings.thresholds });
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                const { level, reasons } = calculateRisk(b, settings.thresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
    };

    const openOverride = (boatName, field, currentValue) => {
        const boat = boats.find(b => b.boatName === boatName);
        const existingOverride = boat?.overrides?.find(o => o.field === field);
        setOverrideModal({ boatName, field, currentValue, newValue: existingOverride?.overrideValue ?? currentValue ?? '', reason: existingOverride?.reason || '', originalValue: existingOverride?.originalValue ?? currentValue });
    };

    const saveOverride = () => {
        if (!overrideModal) return;
        const { boatName, field, newValue, reason, originalValue } = overrideModal;
        setReportData(prev => {
            const updatedBoats = prev.boats.map(b => {
                if (b.boatName !== boatName) return b;
                const overrides = (b.overrides || []).filter(o => o.field !== field);
                let parsedValue;
                if (field === 'riskLevel') {
                    parsedValue = newValue;
                } else if (field === 'vramNiprScanExempt' || field === 'vramSiprScanExempt') {
                    parsedValue = newValue === 'true' || newValue === true;
                } else if (dateFields.includes(field)) {
                    parsedValue = newValue ? new Date(newValue).toISOString() : null;
                } else {
                    parsedValue = parseFloat(newValue);
                }
                if (String(parsedValue) !== String(originalValue)) {
                    overrides.push({ field, originalValue, overrideValue: parsedValue, reason: reason || 'Manual override', timestamp: new Date().toISOString(), user: currentUserName || 'User' });
                }
                const updated = { ...b, [field]: parsedValue, overrides };
                if (field !== 'riskLevel' && !dateFields.includes(field)) { const { level, reasons } = calculateRisk(updated, activeThresholds); updated.riskLevel = level; updated.riskReasons = reasons; }
                return updated;
            });
            return { ...prev, boats: updatedBoats, lastModifiedAt: new Date().toISOString() };
        });
        setOverrideModal(null);
    };

    const isOverridden = (boat, field) => boat.overrides?.some(o => o.field === field);

    const openNotesEdit = (boatName, currentNotes) => {
        setNotesModal({ boatName, notes: currentNotes });
    };

    const saveNotes = () => {
        if (!notesModal) return;
        setReportData(prev => ({
            ...prev,
            boats: prev.boats.map(b => b.boatName === notesModal.boatName ? { ...b, notes: notesModal.notes } : b),
            lastModifiedAt: new Date().toISOString()
        }));
        setNotesModal(null);
    };

    // Check if field is a NIPR field (for NMCI display)
    const isNiprField = (field) => field && (field.includes('Nipr') || field.includes('nipr'));

    const Cell = ({ boat, field, value, format = 'num', className = '' }) => {
        const overridden = isOverridden(boat, field);
        // For NMCI boats, show "NMCI" instead of data for NIPR fields
        if (boat.isNmci && isNiprField(field)) {
            return <td className="bg-blue-100 text-blue-700 text-xs font-semibold" title="This boat uses NMCI for NIPR network">NMCI</td>;
        }
        return <td className={`${className} ${overridden ? 'overridden' : ''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(boat.boatName, field, boat[field])} title={overridden ? 'Overridden - click to edit' : 'Click to override'}>{format === 'pct' ? fmtPct(value) : format === 'date' ? fmtDate(value) : format === 'num2' ? fmt(value, 2) : value ?? '-'}</td>;
    };

    // Cell renderer configs for dynamic schema-based rendering
    const essNiprCellConfigs = {
        assets: (b) => ({ field: 'essNiprAssets', value: fmt(b.essNiprAssets) }),
        breakfix: (b) => ({ field: 'essNiprBreakfix', value: fmt(b.essNiprBreakfix), className: (b.essNiprBreakfix||0)>0?'risk-high':'' }),
        productCompliance: (b) => ({ field: 'essNiprProductCompliance', value: b.essNiprProductCompliance, format: 'pct', className: prodCompClass(b.essNiprProductCompliance) }),
        policyEnforced: (b) => ({ field: 'essNiprPolicyEnforced', value: b.essNiprPolicyEnforced, format: 'pct', className: policyRawClass(b.essNiprPolicyEnforced) }),
        truePolicy: (b) => ({ field: 'essNiprTruePolicy', value: b.essNiprTruePolicy, format: 'pct', className: policyCompClass(b.essNiprTruePolicy) })
    };
    const essSiprCellConfigs = {
        assets: (b) => ({ field: 'essSiprAssets', value: fmt(b.essSiprAssets) }),
        breakfix: (b) => ({ field: 'essSiprBreakfix', value: fmt(b.essSiprBreakfix), className: (b.essSiprBreakfix||0)>0?'risk-high':'' }),
        productCompliance: (b) => ({ field: 'essSiprProductCompliance', value: b.essSiprProductCompliance, format: 'pct', className: prodCompClass(b.essSiprProductCompliance) }),
        policyEnforced: (b) => ({ field: 'essSiprPolicyEnforced', value: b.essSiprPolicyEnforced, format: 'pct', className: policyRawClass(b.essSiprPolicyEnforced) }),
        truePolicy: (b) => ({ field: 'essSiprTruePolicy', value: b.essSiprTruePolicy, format: 'pct', className: policyCompClass(b.essSiprTruePolicy) })
    };
    const vramNiprCellConfigs = {
        assets: (b) => ({ field: 'vramNiprAssets', value: fmt(b.vramNiprAssets) }),
        scanDate: (b) => ({ field: 'vramNiprScanDate', value: b.vramNiprScanDate, format: 'date', className: scanAgeClass(b.vramNiprScanDate) }),
        raVph: (b) => ({ field: 'vramNiprRaVph', value: b.vramNiprRaVph, format: 'num2', className: vphClass(b.vramNiprRaVph) }),
        raCrit: (b) => ({ field: 'vramNiprRaCrit', value: fmt(b.vramNiprRaCrit) }),
        raHigh: (b) => ({ field: 'vramNiprRaHigh', value: fmt(b.vramNiprRaHigh) }),
        scanIntegrity: (b) => ({ field: 'vramNiprScanIntegrity', value: b.vramNiprScanIntegrity, format: 'pct' }),
        scanPercent: (b) => ({ field: 'vramNiprScanPercent', value: b.vramNiprScanPercent, format: 'pct' })
    };
    const vramSiprCellConfigs = {
        assets: (b) => ({ field: 'vramSiprAssets', value: fmt(b.vramSiprAssets) }),
        scanDate: (b) => ({ field: 'vramSiprScanDate', value: b.vramSiprScanDate, format: 'date', className: scanAgeClass(b.vramSiprScanDate) }),
        raVph: (b) => ({ field: 'vramSiprRaVph', value: b.vramSiprRaVph, format: 'num2', className: vphClass(b.vramSiprRaVph) }),
        raCrit: (b) => ({ field: 'vramSiprRaCrit', value: fmt(b.vramSiprRaCrit) }),
        raHigh: (b) => ({ field: 'vramSiprRaHigh', value: fmt(b.vramSiprRaHigh) }),
        scanIntegrity: (b) => ({ field: 'vramSiprScanIntegrity', value: b.vramSiprScanIntegrity, format: 'pct' }),
        scanPercent: (b) => ({ field: 'vramSiprScanPercent', value: b.vramSiprScanPercent, format: 'pct' })
    };
    const tamCellConfigs = {
        pastDue: (b) => ({ field: 'tamPastDue', value: fmt(b.tamPastDue), className: (b.tamPastDue||0)>10?'risk-high':'' }),
        extensions: (b) => ({ field: 'tamExtensions', value: fmt(b.tamExtensions) })
    };

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-slate-800">Preview Report</h2>
                <div className="flex gap-2">
                    <button onClick={() => setShowHelp(true)} className="btn-secondary text-sm" title="Calculation Help">?</button>
                    <button onClick={() => setShowThresholds(!showThresholds)} className={`btn-secondary text-sm ${thresholdChanges.length > 0 ? 'ring-2 ring-amber-400' : ''}`}>{showThresholds ? 'Hide' : 'Adjust'} Thresholds{thresholdChanges.length > 0 ? ` (${thresholdChanges.length})` : ''}</button>
                    {allOverrides.length > 0 && <button onClick={() => setShowOverrideLog(!showOverrideLog)} className="btn-secondary text-sm">{showOverrideLog ? 'Hide' : 'Show'} Override Log ({allOverrides.length})</button>}
                    <button onClick={() => setShowGenerateConfirm(true)} className="btn-success">Generate HTML Report</button>
                </div>
            </div>

            {showOverrideLog && allOverrides.length > 0 && (
                <div className="card p-4 mb-6">
                    <h3 className="text-lg font-bold mb-3 text-purple-700">Override Log</h3>
                    <div className="overflow-x-auto"><table className="data-table text-xs"><thead><tr><th>Boat</th><th>Field</th><th>Original</th><th>New</th><th>Reason</th><th>By</th><th>Time</th></tr></thead>
                    <tbody>{allOverrides.map((o, i) => <tr key={i}><td className="boat-name">{o.boatName}</td><td>{fieldLabels[o.field] || o.field}</td><td>{String(o.originalValue)}</td><td>{String(o.overrideValue)}</td><td>{o.reason}</td><td>{o.user}</td><td>{new Date(o.timestamp).toLocaleString()}</td></tr>)}</tbody></table></div>
                </div>
            )}

            {showThresholds && previewThresholds && (
                <div className="card p-4 mb-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-amber-700">Temporary Threshold Adjustments</h3>
                        <div className="flex gap-2">
                            {thresholdChanges.length > 0 && <span className="text-sm text-amber-600 bg-amber-50 px-2 py-1 rounded">{thresholdChanges.length} changed</span>}
                            <button onClick={resetThresholds} className="btn-secondary text-sm">Reset to Defaults</button>
                        </div>
                    </div>
                    <p className="text-sm text-slate-500 mb-4">These adjustments only apply to this preview session and will be logged in the generated report.</p>

                    {/* HIGH Risk Thresholds */}
                    <div className="mb-4">
                        <h4 className="text-xs font-bold mb-2 flex items-center gap-2"><span className="inline-block px-2 py-0.5 rounded text-xs risk-high">HIGH</span></h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 pl-2 border-l-4 border-red-300">
                            {Object.entries(previewThresholds).filter(([k]) => k.startsWith('auto_high_') || k.startsWith('high_')).map(([k, v]) => (
                                <div key={k} className={`flex flex-col ${thresholdChanges.includes(k) ? 'bg-amber-50 p-2 rounded border border-amber-200' : ''}`}>
                                    <label className="text-xs text-slate-500 mb-1">{k.replace(/_/g, ' ')}</label>
                                    <div className="flex items-center gap-1">
                                        <input type="number" step="any" key={`${k}-${v}`} defaultValue={v} onBlur={(e) => { const val = parseFloat(e.target.value); if (!isNaN(val)) recalculateWithThresholds({...previewThresholds, [k]: val}); }} onKeyDown={(e) => { if (e.key === 'Enter') { const val = parseFloat(e.target.value); if (!isNaN(val)) recalculateWithThresholds({...previewThresholds, [k]: val}); }}} className="w-full text-right text-sm" />
                                        {thresholdChanges.includes(k) && <span className="text-amber-500 text-xs" title={`Default: ${settings.thresholds[k]}`}>*</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* MED Risk Thresholds */}
                    <div className="mb-4">
                        <h4 className="text-xs font-bold mb-2 flex items-center gap-2"><span className="inline-block px-2 py-0.5 rounded text-xs risk-med">MED</span></h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 pl-2 border-l-4 border-amber-300">
                            {Object.entries(previewThresholds).filter(([k]) => k.startsWith('med_')).map(([k, v]) => (
                                <div key={k} className={`flex flex-col ${thresholdChanges.includes(k) ? 'bg-amber-50 p-2 rounded border border-amber-200' : ''}`}>
                                    <label className="text-xs text-slate-500 mb-1">{k.replace(/_/g, ' ')}</label>
                                    <div className="flex items-center gap-1">
                                        <input type="number" step="any" key={`${k}-${v}`} defaultValue={v} onBlur={(e) => { const val = parseFloat(e.target.value); if (!isNaN(val)) recalculateWithThresholds({...previewThresholds, [k]: val}); }} onKeyDown={(e) => { if (e.key === 'Enter') { const val = parseFloat(e.target.value); if (!isNaN(val)) recalculateWithThresholds({...previewThresholds, [k]: val}); }}} className="w-full text-right text-sm" />
                                        {thresholdChanges.includes(k) && <span className="text-amber-500 text-xs" title={`Default: ${settings.thresholds[k]}`}>*</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* LOW Risk Thresholds */}
                    <div>
                        <h4 className="text-xs font-bold mb-2 flex items-center gap-2"><span className="inline-block px-2 py-0.5 rounded text-xs risk-low">LOW</span></h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 pl-2 border-l-4 border-green-300">
                            {Object.entries(previewThresholds).filter(([k]) => k.startsWith('low_')).map(([k, v]) => (
                                <div key={k} className={`flex flex-col ${thresholdChanges.includes(k) ? 'bg-amber-50 p-2 rounded border border-amber-200' : ''}`}>
                                    <label className="text-xs text-slate-500 mb-1">{k.replace(/_/g, ' ')}</label>
                                    <div className="flex items-center gap-1">
                                        <input type="number" step="any" key={`${k}-${v}`} defaultValue={v} onBlur={(e) => { const val = parseFloat(e.target.value); if (!isNaN(val)) recalculateWithThresholds({...previewThresholds, [k]: val}); }} onKeyDown={(e) => { if (e.key === 'Enter') { const val = parseFloat(e.target.value); if (!isNaN(val)) recalculateWithThresholds({...previewThresholds, [k]: val}); }}} className="w-full text-right text-sm" />
                                        {thresholdChanges.includes(k) && <span className="text-amber-500 text-xs" title={`Default: ${settings.thresholds[k]}`}>*</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            <div className="flex gap-2 mb-4">
                {['csl', 'csp', 'hq', 'analytics'].map(t => <button key={t} onClick={() => { setSubTab(t); setSelectedISIC(''); }} className={`px-4 py-2 rounded font-medium uppercase text-sm ${subTab === t ? 'bg-cyan-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{t === 'hq' ? 'HQ Status' : t === 'analytics' ? 'Analytics' : `${t} Summary`}</button>)}
            </div>
            {(subTab === 'csl' || subTab === 'csp') && <div className="mb-4"><select value={selectedISIC} onChange={(e) => setSelectedISIC(e.target.value)} className="px-4 py-2 rounded"><option value="">All Squadrons</option>{isics.map(i => <option key={i} value={i}>{i}</option>)}</select><span className="ml-4 text-sm text-slate-500">Click any cell to override</span></div>}

            {subTab === 'hq' ? (
                <HQStatusPreview boats={boats} settings={settings} onLayoutChange={(newLayout) => setSettings(prev => ({ ...prev, hqStatusLayout: newLayout }))} />
            ) : subTab === 'analytics' ? (
                <AnalyticsPreview boats={boats} settings={settings} onLayoutChange={(newLayout) => setSettings(prev => ({ ...prev, analyticsLayout: newLayout }))} />
            ) : (
                <div className="card p-4 overflow-x-auto">
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th rowSpan="2" className="isic-header">ISIC</th>
                                <th rowSpan="2" style={{width:'70px'}}>BOAT</th>
                                {essNiprCount > 0 && <th colSpan={essNiprCount} className="col-ess-n">ESS NIPR</th>}
                                {essSiprCount > 0 && <th colSpan={essSiprCount} className="col-ess-s">ESS SIPR</th>}
                                {vramNiprCount > 0 && <th colSpan={vramNiprCount} className="col-vram-n">VRAM NIPR</th>}
                                {vramSiprCount > 0 && <th colSpan={vramSiprCount} className="col-vram-s">VRAM SIPR</th>}
                                {tamCount > 0 && <th colSpan={tamCount} className="col-tam">TAM</th>}
                                <th colSpan={statusCount} className="col-status">STATUS</th>
                            </tr>
                            <tr>
                                {/* ESS NIPR headers - in schema order (using label from schema config) */}
                                {essVisibleFields.map(f => <th key={`essn-${f.field}`} className="col-ess-n">{f.label || f.field}</th>)}
                                {essCustomFields.map(cf => <th key={`essn-c-${cf.field}`} className="col-ess-n">{cf.label || cf.field}</th>)}
                                {/* ESS SIPR headers - in schema order */}
                                {essVisibleFields.map(f => <th key={`esss-${f.field}`} className="col-ess-s">{f.label || f.field}</th>)}
                                {essCustomFields.map(cf => <th key={`esss-c-${cf.field}`} className="col-ess-s">{cf.label || cf.field}</th>)}
                                {/* VRAM NIPR headers - in schema order */}
                                {vramVisibleFields.map(f => <th key={`vramn-${f.field}`} className="col-vram-n">{f.label || f.field}</th>)}
                                {vramCustomFields.map(cf => <th key={`vramn-c-${cf.field}`} className="col-vram-n">{cf.label || cf.field}</th>)}
                                {/* VRAM SIPR headers - in schema order */}
                                {vramVisibleFields.map(f => <th key={`vrams-${f.field}`} className="col-vram-s">{f.label || f.field}</th>)}
                                {vramCustomFields.map(cf => <th key={`vrams-c-${cf.field}`} className="col-vram-s">{cf.label || cf.field}</th>)}
                                {/* TAM headers - in schema order */}
                                {tamVisibleFields.map(f => <th key={`tam-${f.field}`} className="col-tam">{f.label || f.field}</th>)}
                                {tamCustomFields.map(cf => <th key={`tam-c-${cf.field}`} className="col-tam">{cf.label || cf.field}</th>)}
                                <th className="col-status">Risk</th>
                                {showVramExempt && <th className="col-status">Scan Exempt</th>}
                                <th className="col-status">Notes</th>
                            </tr>
                        </thead>
                        <tbody>{Object.entries(groupByISIC(filtered)).map(([isic, isicBoats]) =>
                            isicBoats.map((b, idx) => <tr key={b.boatName} className={idx === 0 ? 'isic-first-row' : ''}>
                                {idx === 0 && <td rowSpan={isicBoats.length} className="isic-cell">{isic}</td>}
                                <td className="boat-name" style={{overflowWrap:'break-word',wordBreak:'keep-all',whiteSpace:'normal',maxHeight:'36px',overflow:'hidden',lineHeight:'1.2'}}>{b.boatFullName || b.boatName}</td>
                                {/* ESS NIPR cells - in schema order */}
                                {essVisibleFields.map(f => { const cfg = essNiprCellConfigs[f.field]; return cfg ? <Cell key={`essn-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {essCustomFields.map(cf => <td key={`essn-c-${cf.field}`}>{fmtCustom(b.customFields?.essNipr?.[cf.field])}</td>)}
                                {/* ESS SIPR cells - in schema order */}
                                {essVisibleFields.map(f => { const cfg = essSiprCellConfigs[f.field]; return cfg ? <Cell key={`esss-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {essCustomFields.map(cf => <td key={`esss-c-${cf.field}`}>{fmtCustom(b.customFields?.essSipr?.[cf.field])}</td>)}
                                {/* VRAM NIPR cells - in schema order */}
                                {vramVisibleFields.map(f => { const cfg = vramNiprCellConfigs[f.field]; return cfg ? <Cell key={`vramn-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {vramCustomFields.map(cf => <td key={`vramn-c-${cf.field}`}>{fmtCustom(b.customFields?.vramNipr?.[cf.field])}</td>)}
                                {/* VRAM SIPR cells - in schema order */}
                                {vramVisibleFields.map(f => { const cfg = vramSiprCellConfigs[f.field]; return cfg ? <Cell key={`vrams-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {vramCustomFields.map(cf => <td key={`vrams-c-${cf.field}`}>{fmtCustom(b.customFields?.vramSipr?.[cf.field])}</td>)}
                                {/* TAM cells - in schema order */}
                                {tamVisibleFields.map(f => { const cfg = tamCellConfigs[f.field]; return cfg ? <Cell key={`tam-${f.field}`} boat={b} {...cfg(b)} /> : null; })}
                                {tamCustomFields.map(cf => <td key={`tam-c-${cf.field}`}>{fmtCustom(b.customFields?.tam?.[cf.field])}</td>)}
                                <td className={`risk-${b.riskLevel.toLowerCase()} ${isOverridden(b,'riskLevel')?'overridden':''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(b.boatName, 'riskLevel', b.riskLevel)}>{b.riskLevel}</td>
                                {showVramExempt && <td className={`${(b.vramNiprScanExempt||b.vramSiprScanExempt)?'alert-blue':''} ${(isOverridden(b,'vramNiprScanExempt')||isOverridden(b,'vramSiprScanExempt'))?'overridden':''} cursor-pointer hover:bg-cyan-50`} onClick={() => openOverride(b.boatName, 'vramNiprScanExempt', b.vramNiprScanExempt)} title="Click to override scan exempt status">{(b.vramNiprScanExempt||b.vramSiprScanExempt)?'Y':'N'}</td>}
                                <td className="text-xs max-w-[80px] cursor-pointer hover:bg-cyan-50" style={{overflowWrap:'break-word',wordBreak:'keep-all',whiteSpace:'normal',maxHeight:'36px',overflow:'hidden',lineHeight:'1.2'}} onClick={() => openNotesEdit(b.boatName, b.notes || '')} title={b.notes || 'Click to add note'}>{b.notes || '-'}</td>
                            </tr>)
                        )}</tbody>
                    </table>
                </div>
            )}

            {overrideModal && (
                <div className="modal-overlay" onClick={() => setOverrideModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-purple-700">Override Value</h3>
                        <div className="space-y-4">
                            <div className="text-sm text-slate-500">Boat: <span className="text-cyan-600 font-mono">{overrideModal.boatName}</span></div>
                            <div className="text-sm text-slate-500">Field: <span className="text-slate-800">{fieldLabels[overrideModal.field] || overrideModal.field}</span></div>
                            <div className="text-sm text-slate-500">Original: <span className="text-slate-600">{overrideModal.originalValue ?? 'null'}</span></div>
                            <div>
                                <label className="block text-sm text-slate-500 mb-1">New Value</label>
                                {overrideModal.field === 'riskLevel' ? (
                                    <select value={overrideModal.newValue} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full">
                                        <option value="LOW">LOW</option><option value="MED">MED</option><option value="HIGH">HIGH</option>
                                    </select>
                                ) : (overrideModal.field === 'vramNiprScanExempt' || overrideModal.field === 'vramSiprScanExempt') ? (
                                    <select value={String(overrideModal.newValue)} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full">
                                        <option value="false">No (N)</option><option value="true">Yes (Y)</option>
                                    </select>
                                ) : dateFields.includes(overrideModal.field) ? (
                                    <input type="date" value={overrideModal.newValue ? new Date(overrideModal.newValue).toISOString().split('T')[0] : ''} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full" />
                                ) : (
                                    <input type="number" step="any" value={overrideModal.newValue} onChange={(e) => setOverrideModal({...overrideModal, newValue: e.target.value})} className="w-full" />
                                )}
                            </div>
                            <div>
                                <label className="block text-sm text-slate-500 mb-1">Reason for Override</label>
                                <input value={overrideModal.reason} onChange={(e) => setOverrideModal({...overrideModal, reason: e.target.value})} placeholder="Why is this being overridden?" className="w-full" />
                            </div>
                        </div>
                        <div className="flex gap-2 mt-6">
                            <button onClick={saveOverride} className="btn-primary">Save Override</button>
                            <button onClick={() => setOverrideModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {notesModal && (
                <div className="modal-overlay" onClick={() => setNotesModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Edit Note</h3>
                        <div className="text-sm text-slate-500 mb-2">Boat: <span className="text-cyan-600 font-mono">{notesModal.boatName}</span></div>
                        <input type="text" maxLength={30} value={notesModal.notes} onChange={(e) => setNotesModal({...notesModal, notes: e.target.value})} className="w-full mb-4" placeholder="Short note (3-5 words)" autoFocus onKeyDown={(e) => e.key === 'Enter' && saveNotes()} />
                        <div className="flex gap-2">
                            <button onClick={saveNotes} className="btn-primary">Save</button>
                            <button onClick={() => setNotesModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {showHelp && (
                <div className="modal-overlay" onClick={() => setShowHelp(false)}>
                    <div className="modal-content" style={{maxWidth:'650px',maxHeight:'80vh',overflow:'auto'}} onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Risk Calculation Reference</h3>
                        <div className="text-sm space-y-4">
                            <div className="p-3 bg-red-50 rounded border border-red-200">
                                <h4 className="font-bold text-red-600 mb-2">HIGH Risk</h4>
                                <ul className="list-disc ml-5 text-slate-700 space-y-1">
                                    <li><strong>Breakfix &gt; 0</strong> - Any asset in NIPR or SIPR enclave in breakfix</li>
                                    <li><strong>No VRAM Scan Data</strong> - Unable to assess risk (no scan data available)</li>
                                    <li><strong>VPH &gt; {activeThresholds.auto_high_ra_vph || 5}</strong> - Critical vulnerabilities per host</li>
                                </ul>
                            </div>
                            <div className="p-3 bg-amber-50 rounded border border-amber-200">
                                <h4 className="font-bold text-amber-600 mb-2">MEDIUM Risk (2+ of the following)</h4>
                                <ul className="list-disc ml-5 text-slate-700 space-y-1">
                                    <li><strong>VPH &gt; {activeThresholds.med_ra_vph || 3.5}</strong> - Any enclave VPH exceeds threshold</li>
                                    <li><strong>Product or Policy Compliance &lt; {activeThresholds.med_ess_compliance || 95}%</strong> - Below threshold</li>
                                    <li><strong>Scan Age &gt; {activeThresholds.med_scan_age_days || 14} days</strong> - Any enclave scan older than threshold</li>
                                    <li><strong>TAMs Past Due &gt; {activeThresholds.med_tam_past_due || 10}</strong> - Too many overdue TAMs</li>
                                </ul>
                            </div>
                            <div className="p-3 bg-green-50 rounded border border-green-200">
                                <h4 className="font-bold text-green-600 mb-2">LOW Risk (All conditions met)</h4>
                                <ul className="list-disc ml-5 text-slate-700 space-y-1">
                                    <li><strong>VPH &lt; {activeThresholds.low_vph || 2.5}</strong> - All enclaves below threshold</li>
                                    <li><strong>Scans within {activeThresholds.low_scan_age_days || 14} days</strong> - All enclaves current</li>
                                    <li><strong>Product &amp; Policy Compliance &gt; {activeThresholds.low_ess_compliance || 95}%</strong> - All above threshold</li>
                                    <li>No breakfix issues in any enclave</li>
                                </ul>
                            </div>
                            <div className="p-3 bg-blue-50 rounded border border-blue-200">
                                <h4 className="font-bold text-blue-600 mb-2">Scan Exempt Override</h4>
                                <p className="text-slate-700">If a boat is marked as Scan Exempt, HIGH risk will only be downgraded to MED if the HIGH status was solely due to missing/old scan data. Breakfix or other HIGH triggers are NOT overridden by scan exempt status.</p>
                            </div>
                            <div>
                                <h4 className="font-bold text-slate-700 mb-1">Key Calculations</h4>
                                <ul className="list-disc ml-5 text-slate-600 space-y-1">
                                    <li><strong>Scan Age</strong> = Days since last VRAM scan date</li>
                                    <li><strong>VPH</strong> = Vulnerabilities Per Host (from VRAM RA VPH column)</li>
                                    <li><strong>True Policy %</strong> = <code className="bg-slate-100 px-1 rounded">PolicyEnforced Ã— ProductCompliance / 100</code></li>
                                </ul>
                            </div>
                        </div>
                        <div className="mt-6"><button onClick={() => setShowHelp(false)} className="btn-primary">Close</button></div>
                    </div>
                </div>
            )}

            {showGenerateConfirm && (
                <div className="modal-overlay" onClick={() => setShowGenerateConfirm(false)}>
                    <div className="modal-content" style={{maxWidth:'500px'}} onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Generate Report</h3>
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                            <div className="flex items-start gap-3">
                                <span className="text-amber-500 text-xl">&#9888;</span>
                                <div className="text-sm text-amber-800">
                                    <strong>Important for Charts to Display:</strong>
                                    <p className="mt-2">For the Analytics page charts to display correctly in the generated report, you must:</p>
                                    <ol className="list-decimal ml-5 mt-2 space-y-1">
                                        <li>Place the downloaded report file in the <strong>same location</strong> as this dashboard tool</li>
                                        <li>Ensure the <strong>libs/</strong> folder is present in the same directory</li>
                                    </ol>
                                    <p className="mt-2 text-xs">The report requires the local Chart.js library from the libs folder to render charts.</p>
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button onClick={() => setShowGenerateConfirm(false)} className="btn-secondary">Cancel</button>
                            <button onClick={() => { setShowGenerateConfirm(false); generate(); }} className="btn-success">Continue &amp; Generate</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const SettingsTab = ({ settings, setSettings, onAlert, isUsingImportedSettings, onSaveToMySettings }) => {
    const [subTab, setSubTab] = React.useState('registry');
    const [editingBoat, setEditingBoat] = React.useState(null);
    const [editingISIC, setEditingISIC] = React.useState(null);
    const [authorName, setAuthorName] = React.useState(settings.user?.default_name || '');
    const [showAuthorPrompt, setShowAuthorPrompt] = React.useState(false);

    const saveBoat = () => {
        if (!editingBoat.boat_name) return;
        const isic = settings.isics.find(i => i.isic_name === editingBoat.isic);
        const boat = { ...editingBoat, tycom: isic?.tycom || 'CSL' }; delete boat.isNew;
        setSettings(prev => ({ ...prev, boats: editingBoat.isNew ? [...prev.boats, boat] : prev.boats.map(b => b.boat_name === boat.boat_name ? boat : b) }));
        setEditingBoat(null);
    };

    const deleteBoat = (boatName) => {
        if (confirm(`Delete boat "${boatName}"?`)) {
            setSettings(prev => ({ ...prev, boats: prev.boats.filter(b => b.boat_name !== boatName) }));
        }
    };

    const saveISIC = () => {
        if (!editingISIC.isic_name) return;
        const isic = { ...editingISIC }; delete isic.isNew;
        setSettings(prev => {
            const newIsics = editingISIC.isNew ? [...prev.isics, isic] : prev.isics.map(i => i.isic_name === isic.isic_name ? isic : i);
            // Update tycom on all boats belonging to this ISIC
            const newBoats = prev.boats.map(b => b.isic === isic.isic_name ? { ...b, tycom: isic.tycom } : b);
            return { ...prev, isics: newIsics, boats: newBoats };
        });
        setEditingISIC(null);
    };

    const deleteISIC = (isicName) => {
        const boatsUsingISIC = settings.boats.filter(b => b.isic === isicName);
        if (boatsUsingISIC.length > 0) {
            onAlert && onAlert({ type: 'error', msg: `Cannot delete ISIC: ${boatsUsingISIC.length} boats are assigned to it` });
            return;
        }
        if (confirm(`Delete ISIC "${isicName}"?`)) {
            setSettings(prev => ({ ...prev, isics: prev.isics.filter(i => i.isic_name !== isicName) }));
        }
    };

    // Auto-save to localStorage whenever settings change
    React.useEffect(() => {
        if (!isUsingImportedSettings) {
            SettingsManager.save(settings);
        }
    }, [settings, isUsingImportedSettings]);

    const handleImportSettings = async () => {
        const result = await SettingsManager.importSettings();
        if (result.success) {
            setSettings(result.settings);
            SettingsManager.save(result.settings);
            onAlert && onAlert({ type: 'info', msg: `Settings imported (v${result.settings._settingsVersion} by ${result.settings._settingsAuthor})` });
        } else if (result.error) {
            onAlert && onAlert({ type: 'error', msg: 'Failed to import: ' + result.error });
        }
    };

    const handleExportSettings = () => {
        SettingsManager.exportSettings(settings);
        onAlert && onAlert({ type: 'info', msg: `Settings exported as settings-v${settings._settingsVersion}.json` });
    };

    const handleSaveAsMySettings = () => {
        if (!authorName.trim()) {
            setShowAuthorPrompt(true);
            return;
        }
        const updated = SettingsManager.updateVersion({...settings}, authorName);
        updated.user = { ...updated.user, default_name: authorName };
        setSettings(updated);
        SettingsManager.save(updated);
        onSaveToMySettings && onSaveToMySettings();
        onAlert && onAlert({ type: 'info', msg: `Settings saved as v${updated._settingsVersion}` });
    };

    const handleResetToDefaults = () => {
        if (confirm('Reset all settings to defaults? This cannot be undone.')) {
            SettingsManager.clear();
            const defaults = SettingsManager.getDefaults();
            setSettings(defaults);
            onAlert && onAlert({ type: 'info', msg: 'Settings reset to defaults' });
        }
    };

    const saveAuthorAndSettings = () => {
        if (!authorName.trim()) return;
        setShowAuthorPrompt(false);
        const updated = SettingsManager.updateVersion({...settings}, authorName);
        updated.user = { ...updated.user, default_name: authorName };
        setSettings(updated);
        SettingsManager.save(updated);
        onSaveToMySettings && onSaveToMySettings();
        onAlert && onAlert({ type: 'info', msg: `Settings saved as v${updated._settingsVersion}` });
    };

    // Legend text helpers
    const legend = settings.legendText || JSON.parse(JSON.stringify(defaultLegendText));
    const updateLegend = (key, value) => {
        setSettings(prev => ({ ...prev, legendText: { ...prev.legendText, [key]: value } }));
    };

    // Help modal text helpers (? button content)
    const helpModal = settings.helpModalText || JSON.parse(JSON.stringify(defaultHelpModalText));
    const updateHelpModal = (key, value) => {
        setSettings(prev => ({ ...prev, helpModalText: { ...prev.helpModalText, [key]: value } }));
    };
    const updateHelpModalItem = (key, index, value) => {
        setSettings(prev => {
            const items = [...(prev.helpModalText?.[key] || defaultHelpModalText[key])];
            items[index] = value;
            return { ...prev, helpModalText: { ...prev.helpModalText, [key]: items } };
        });
    };
    const addHelpModalItem = (key) => {
        setSettings(prev => {
            const items = [...(prev.helpModalText?.[key] || defaultHelpModalText[key]), ''];
            return { ...prev, helpModalText: { ...prev.helpModalText, [key]: items } };
        });
    };
    const removeHelpModalItem = (key, index) => {
        setSettings(prev => {
            const items = [...(prev.helpModalText?.[key] || defaultHelpModalText[key])];
            items.splice(index, 1);
            return { ...prev, helpModalText: { ...prev.helpModalText, [key]: items } };
        });
    };

    // Schema config helpers
    const schema = settings.schemaConfig || JSON.parse(JSON.stringify(defaultSchemaConfig));
    const [newFieldModal, setNewFieldModal] = React.useState(null);

    const updateSchemaField = (type, idx, updates) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type][idx] = { ...newSchema[type][idx], ...updates };
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const reorderSchema = (type, fromIdx, toIdx) => {
        if (fromIdx === toIdx) return;
        const newSchema = JSON.parse(JSON.stringify(schema));
        const [moved] = newSchema[type].splice(fromIdx, 1);
        newSchema[type].splice(toIdx, 0, moved);
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const removeSchemaField = (type, idx) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type].splice(idx, 1);
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const addSchemaField = (type, field, label, column) => {
        const newSchema = JSON.parse(JSON.stringify(schema));
        newSchema[type].push({ field, label, column, visible: true });
        setSettings(prev => ({ ...prev, schemaConfig: newSchema }));
    };

    const schemaTypeLabels = { vram: 'VRAM Files', ess: 'ESS Files', tam: 'TAM Files' };
    const schemaTypeColors = { vram: 'text-cyan-700', ess: 'text-indigo-700', tam: 'text-orange-700' };

    return (
        <div>
            {/* Warning Box */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-3">
                    <span className="text-blue-500 text-xl">â„¹</span>
                    <div>
                        <h4 className="font-semibold text-blue-800 mb-1">Settings are saved automatically in this browser</h4>
                        <p className="text-sm text-blue-700">Changes are auto-saved to your browser's local storage. Use <strong>Export</strong> to backup or share settings, and <strong>Import</strong> to restore from a backup file.</p>
                        {isUsingImportedSettings && <p className="text-sm text-amber-700 mt-2 font-medium">You're currently using settings from an imported report. Click "Save to My Settings" to make these your default.</p>}
                    </div>
                </div>
            </div>

            {/* Header with version info */}
            <div className="flex justify-between items-start mb-6">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800">Settings</h2>
                    <p className="text-sm text-slate-500 mt-1">
                        v{settings._settingsVersion || '1.0'} by {settings._settingsAuthor || 'Unknown'}
                        {settings._settingsModified && <span className="ml-2">â€¢ Last modified: {new Date(settings._settingsModified).toLocaleDateString()}</span>}
                    </p>
                </div>
                <div className="flex gap-2 flex-wrap justify-end">
                    <button onClick={handleImportSettings} className="btn-secondary text-sm">Import</button>
                    <button onClick={handleExportSettings} className="btn-secondary text-sm">Export</button>
                    {isUsingImportedSettings && <button onClick={handleSaveAsMySettings} className="btn-success text-sm">Save to My Settings</button>}
                    <button onClick={handleResetToDefaults} className="text-sm text-red-600 hover:text-red-800 px-3">Reset</button>
                </div>
            </div>

            <div className="flex gap-2 mb-6 flex-wrap">{['registry', 'riskconfig', 'colors', 'legend', 'columns'].map(t => <button key={t} onClick={() => setSubTab(t)} className={`px-4 py-2 rounded font-medium capitalize text-sm ${subTab === t ? 'bg-cyan-600 text-white' : 'bg-slate-200 text-slate-600'}`}>{t === 'columns' ? 'File Schema' : t === 'legend' ? 'Risk Legend' : t === 'colors' ? 'Color Scales' : t === 'riskconfig' ? 'Risk Builder' : t}</button>)}</div>

            {subTab === 'registry' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Boats ({settings.boats.length})</h3>
                        <div className="overflow-x-auto"><table className="data-table settings-table"><thead><tr><th style={{textAlign:'left'}}>Name</th><th style={{textAlign:'left'}}>Full Name</th><th>ISIC</th><th>TYCOM</th><th>NMCI</th><th>Actions</th></tr></thead><tbody>{settings.boats.map(b => <tr key={b.boat_name}><td className="boat-name">{b.boat_name}</td><td style={{textAlign:'left'}}>{b.boat_full_name}</td><td>{b.isic}</td><td>{b.tycom}</td><td className={b.nmci ? 'bg-blue-100 text-blue-700 font-semibold' : ''}>{b.nmci ? 'Yes' : 'No'}</td><td><button onClick={() => setEditingBoat(b)} className="text-cyan-600 mr-3">Edit</button><button onClick={() => deleteBoat(b.boat_name)} className="text-red-500">Delete</button></td></tr>)}</tbody></table></div>
                        <button onClick={() => setEditingBoat({ boat_name: '', boat_full_name: '', isic: settings.isics[0]?.isic_name || '', tycom: 'CSL', active: true, nmci: false, isNew: true })} className="btn-primary mt-4">+ Add Boat</button>
                    </div>
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-4 text-slate-700">ISICs ({settings.isics.length})</h3>
                        <table className="data-table settings-table"><thead><tr><th style={{textAlign:'left'}}>Name</th><th>Short</th><th>TYCOM</th><th>Actions</th></tr></thead><tbody>{settings.isics.map(i => <tr key={i.isic_name}><td style={{textAlign:'left'}}>{i.isic_name}</td><td>{i.isic_short}</td><td>{i.tycom}</td><td><button onClick={() => setEditingISIC(i)} className="text-cyan-600 mr-3">Edit</button><button onClick={() => deleteISIC(i.isic_name)} className="text-red-500">Delete</button></td></tr>)}</tbody></table>
                        <button onClick={() => setEditingISIC({ isic_name: '', isic_short: '', tycom: 'CSL', isNew: true })} className="btn-primary mt-4">+ Add ISIC</button>
                    </div>
                </div>
            )}

            {subTab === 'riskconfig' && (
                <div className="card p-4">
                    <h3 className="text-lg font-bold mb-2 text-slate-700">Risk Criteria Builder</h3>
                    <p className="text-sm text-slate-500 mb-4">Configure which criteria trigger each risk level. Toggle criteria on/off and adjust thresholds. Baseline: HIGH = Breakfix or No Scan, MED = 2+ conditions, LOW = all criteria met.</p>

                    <div className="grid grid-cols-3 gap-4">
                        {/* HIGH Risk Column */}
                        <div className="border-2 border-red-200 rounded-lg p-3 bg-red-50">
                            <h4 className="font-bold text-red-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-high">HIGH</span>
                                Auto-triggers HIGH
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Breakfix &gt; 0</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprBreakfix, essSiprBreakfix</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">No VRAM Scan Data</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_tam_past_due || 999) < 999} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_tam_past_due: e.target.checked ? 20 : 999}}))} />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    {(settings.thresholds.high_tam_past_due || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.high_tam_past_due || 20} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_tam_past_due: parseInt(e.target.value) || 20}}))} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.auto_high_ra_vph || 999) < 999} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_ra_vph: e.target.checked ? 5 : 999}}))} />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    {(settings.thresholds.auto_high_ra_vph || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" step="0.1" value={settings.thresholds.auto_high_ra_vph || 5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_ra_vph: parseFloat(e.target.value) || 5}}))} className="w-16 text-sm p-1" /></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.auto_high_scan_age_days || 999) < 999} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_scan_age_days: e.target.checked ? 30 : 999}}))} />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    {(settings.thresholds.auto_high_scan_age_days || 999) < 999 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.auto_high_scan_age_days || 30} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, auto_high_scan_age_days: parseInt(e.target.value) || 30}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_ess_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_ess_compliance: e.target.checked ? 90 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.high_ess_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.high_ess_compliance || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_ess_compliance: parseInt(e.target.value) || 90}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_raw_policy_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_raw_policy_compliance: e.target.checked ? 90 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.high_raw_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.high_raw_policy_compliance || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_raw_policy_compliance: parseInt(e.target.value) || 90}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-red-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.high_product_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_product_compliance: e.target.checked ? 50 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Product Compliance</span>
                                    </div>
                                    {(settings.thresholds.high_product_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.high_product_compliance || 50} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, high_product_compliance: parseInt(e.target.value) || 50}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                            </div>
                        </div>

                        {/* MED Risk Column */}
                        <div className="border-2 border-amber-200 rounded-lg p-3 bg-amber-50">
                            <h4 className="font-bold text-amber-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-med">MED</span>
                                2+ triggers MED
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" step="0.1" value={settings.thresholds.med_ra_vph || 3.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_ra_vph: parseFloat(e.target.value) || 3.5}}))} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Product Compliance</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.med_ess_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_ess_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.med_true_policy_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_true_policy_compliance: e.target.checked ? 95 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.med_true_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.med_true_policy_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_true_policy_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.med_raw_policy_compliance || 0) > 0} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_raw_policy_compliance: e.target.checked ? 95 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Raw Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.med_raw_policy_compliance || 0) > 0 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" value={settings.thresholds.med_raw_policy_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_raw_policy_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprPolicyEnforced, essSiprPolicyEnforced</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.med_scan_age_days || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_scan_age_days: parseInt(e.target.value) || 14}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-amber-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">TAM Past Due</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &gt;</span><input type="number" value={settings.thresholds.med_tam_past_due || 10} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, med_tam_past_due: parseInt(e.target.value) || 10}}))} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">tamPastDue</div>
                                </div>
                            </div>
                            <div className="mt-3 p-2 bg-amber-100 rounded text-xs text-amber-700">
                                <strong>Note:</strong> If 2+ conditions are met, boat is MED risk.
                            </div>
                        </div>

                        {/* LOW Risk Column */}
                        <div className="border-2 border-green-200 rounded-lg p-3 bg-green-50">
                            <h4 className="font-bold text-green-700 mb-3 flex items-center gap-2">
                                <span className="inline-block px-2 py-1 rounded text-xs risk-low">LOW</span>
                                All criteria met
                            </h4>
                            <div className="space-y-2">
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">No Breakfix</span>
                                    </div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprBreakfix, essSiprBreakfix</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">VPH</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: &lt;</span><input type="number" step="0.1" value={settings.thresholds.low_vph || 2.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_vph: parseFloat(e.target.value) || 2.5}}))} className="w-16 text-sm p-1" /></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprRaVph, vramSiprRaVph</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={true} disabled className="opacity-50" />
                                        <span className="text-sm font-medium text-slate-700">Scan Age</span>
                                    </div>
                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: â‰¤</span><input type="number" value={settings.thresholds.low_scan_age_days || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_scan_age_days: parseInt(e.target.value) || 14}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">days</span></div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">vramNiprScanDate, vramSiprScanDate</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.low_product_compliance_enabled ?? 0) === 1} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_product_compliance_enabled: e.target.checked ? 1 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">Product Compliance</span>
                                    </div>
                                    {(settings.thresholds.low_product_compliance_enabled ?? 0) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: â‰¥</span><input type="number" value={settings.thresholds.low_product_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_product_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprProductCompliance, essSiprProductCompliance</div>
                                </div>
                                <div className="p-2 bg-white rounded border border-green-200">
                                    <div className="flex items-center gap-2">
                                        <input type="checkbox" checked={(settings.thresholds.low_true_policy_compliance_enabled ?? 1) === 1} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_true_policy_compliance_enabled: e.target.checked ? 1 : 0}}))} />
                                        <span className="text-sm font-medium text-slate-700">True Policy Compliance</span>
                                    </div>
                                    {(settings.thresholds.low_true_policy_compliance_enabled ?? 1) === 1 && <div className="flex items-center gap-2 mt-1"><span className="text-xs text-slate-500">Threshold: â‰¥</span><input type="number" value={settings.thresholds.low_true_policy_compliance || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, low_true_policy_compliance: parseInt(e.target.value) || 95}}))} className="w-16 text-sm p-1" /><span className="text-xs text-slate-500">%</span></div>}
                                    <div className="text-xs text-slate-400 mt-1 font-mono">essNiprTruePolicy, essSiprTruePolicy</div>
                                </div>
                            </div>
                            <div className="mt-3 p-2 bg-green-100 rounded text-xs text-green-700">
                                <strong>Note:</strong> Must meet ALL criteria to be LOW.
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 p-3 bg-slate-50 rounded border border-slate-200">
                        <h4 className="font-bold text-slate-700 mb-2">Scan Exempt Override</h4>
                        <p className="text-xs text-slate-500">When a boat is marked Scan Exempt, HIGH risk is downgraded to MED <strong>only if</strong> the sole reason for HIGH was "No VRAM Scan Data". Breakfix or other HIGH triggers are NOT affected. For NMCI boats, both NIPR and SIPR must be exempt.</p>
                    </div>

                    <div className="mt-4 flex gap-2">
                        <button onClick={() => setSettings(p => ({...p, thresholds: {...defaultThresholds, ...Object.fromEntries(Object.entries(p.thresholds).filter(([k]) => k.startsWith('color_')))}}))} className="btn-secondary text-sm">Reset to Defaults</button>
                    </div>
                </div>
            )}

            {subTab === 'colors' && (
                <div className="space-y-6">
                    {/* CSL/CSP Table Colors */}
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">CSL/CSP Table Color Scales</h3>
                        <p className="text-sm text-slate-500 mb-4">Color thresholds for CSL and CSP Summary tables.</p>

                        <div className="space-y-4">
                            {/* Product Compliance */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Product Compliance</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">â‰¥</span><input type="number" value={settings.thresholds.color_product_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_product_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_product_red || 90}% to {settings.thresholds.color_product_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_product_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_product_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* True Policy Compliance */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">True Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">â‰¥</span><input type="number" value={settings.thresholds.color_policy_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_policy_red || 90}% to {settings.thresholds.color_policy_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_policy_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* Raw Policy */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Raw Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">â‰¥</span><input type="number" value={settings.thresholds.color_policy_raw_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_raw_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_policy_raw_red || 90}% to {settings.thresholds.color_policy_raw_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.color_policy_raw_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_policy_raw_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* VPH */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">VPH</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" step="0.1" value={settings.thresholds.color_vph_green || 2.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_vph_green: parseFloat(e.target.value) || 2.5}}))} className="w-14 text-sm text-center" /></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_vph_green || 2.5} to {settings.thresholds.color_vph_red || 3.5}</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">â‰¥</span><input type="number" step="0.1" value={settings.thresholds.color_vph_red || 3.5} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_vph_red: parseFloat(e.target.value) || 3.5}}))} className="w-14 text-sm text-center" /></div>
                            </div>

                            {/* Scan Age */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Scan Age</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">â‰¤</span><input type="number" value={settings.thresholds.color_scan_green || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_scan_green: parseFloat(e.target.value) || 14}}))} className="w-14 text-sm text-center" /> days</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.color_scan_green || 14}d to {settings.thresholds.color_scan_red || 14}d</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&gt;</span><input type="number" value={settings.thresholds.color_scan_red || 14} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, color_scan_red: parseFloat(e.target.value) || 14}}))} className="w-14 text-sm text-center" /> days</div>
                            </div>
                        </div>

                        <div className="mt-4 flex gap-2">
                            <button onClick={() => setSettings(p => ({...p, thresholds: {...p.thresholds, color_product_green: 95, color_product_red: 90, color_policy_green: 95, color_policy_red: 90, color_policy_raw_green: 95, color_policy_raw_red: 90, color_vph_green: 2.5, color_vph_red: 3.5, color_scan_green: 14, color_scan_red: 14}}))} className="btn-secondary text-sm">Reset CSL/CSP to Defaults</button>
                        </div>
                    </div>

                    {/* HQ Status Table Colors */}
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">HQ Status Table Color Scales</h3>
                        <p className="text-sm text-slate-500 mb-4">Separate color thresholds for the HQ Status summary table.</p>

                        <div className="space-y-4">
                            {/* HQ Product Compliance */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Product Compliance</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">â‰¥</span><input type="number" value={settings.thresholds.hq_color_product_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_product_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.hq_color_product_red || 90}% to {settings.thresholds.hq_color_product_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.hq_color_product_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_product_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* HQ True Policy */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">True Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">â‰¥</span><input type="number" value={settings.thresholds.hq_color_policy_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.hq_color_policy_red || 90}% to {settings.thresholds.hq_color_policy_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.hq_color_policy_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>

                            {/* HQ Raw Policy */}
                            <div className="flex items-center gap-4 p-3 bg-slate-50 rounded">
                                <span className="text-sm font-medium text-slate-700 w-40">Raw Policy</span>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-low"></span><span className="text-xs text-slate-500">â‰¥</span><input type="number" value={settings.thresholds.hq_color_policy_raw_green || 95} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_raw_green: parseFloat(e.target.value) || 95}}))} className="w-14 text-sm text-center" />%</div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-med"></span><span className="text-xs text-slate-500">{settings.thresholds.hq_color_policy_raw_red || 90}% to {settings.thresholds.hq_color_policy_raw_green || 95}%</span></div>
                                <div className="flex items-center gap-1"><span className="inline-block w-3 h-3 rounded risk-high"></span><span className="text-xs text-slate-500">&lt;</span><input type="number" value={settings.thresholds.hq_color_policy_raw_red || 90} onChange={(e) => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_policy_raw_red: parseFloat(e.target.value) || 90}}))} className="w-14 text-sm text-center" />%</div>
                            </div>
                        </div>

                        <div className="mt-4 flex gap-2">
                            <button onClick={() => setSettings(p => ({...p, thresholds: {...p.thresholds, hq_color_product_green: 95, hq_color_product_red: 90, hq_color_policy_green: 95, hq_color_policy_red: 90, hq_color_policy_raw_green: 95, hq_color_policy_raw_red: 90}}))} className="btn-secondary text-sm">Reset HQ to Defaults</button>
                        </div>
                    </div>

                    <div className="p-3 bg-slate-50 rounded border border-slate-200">
                        <p className="text-xs text-slate-500"><strong>Note:</strong> Breakfix cells are always red when &gt; 0. Yellow is automatically calculated as the range between green and red thresholds.</p>
                    </div>
                </div>
            )}

            {subTab === 'legend' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">Risk Criteria Legend Text (Table)</h3>
                        <p className="text-sm text-slate-500 mb-4">Customize the legend text shown on CSL/CSP summary pages. Use <code className="bg-slate-100 px-1 rounded">{'{threshold_name}'}</code> to insert threshold values.</p>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-high">HIGH</span> Risk Criteria</label>
                                <textarea value={legend.high} onChange={(e) => updateLegend('high', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={2} placeholder="e.g., Breakfix > 0, Scan > {auto_high_scan_age_days}d" />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-med">MED</span> Risk Criteria</label>
                                <textarea value={legend.med} onChange={(e) => updateLegend('med', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={2} placeholder="e.g., Scan > {med_scan_age_days}d, VPH > {med_ra_vph}" />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-low">LOW</span> Risk Criteria</label>
                                <textarea value={legend.low} onChange={(e) => updateLegend('low', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={2} placeholder="e.g., No criteria met" />
                            </div>
                        </div>
                        <button onClick={() => setSettings(p => ({...p, legendText: JSON.parse(JSON.stringify(defaultLegendText))}))} className="btn-secondary mt-4 text-sm">Reset Table Legend</button>
                    </div>

                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">Help Modal Content (? Button)</h3>
                        <p className="text-sm text-slate-500 mb-4">Customize the content shown when clicking the ? button. Use <code className="bg-slate-100 px-1 rounded">{'{threshold_name}'}</code> to insert threshold values. Each item becomes a bullet point.</p>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-high">HIGH</span> Risk Items</label>
                                {(helpModal.highItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('highItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., Breakfix > 0 - Any asset in breakfix" />
                                        <button onClick={() => removeHelpModalItem('highItems', i)} className="text-red-500 hover:text-red-700 px-2">Ã—</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('highItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-med">MED</span> Risk Items (2+ triggers MED)</label>
                                {(helpModal.medItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('medItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., VPH > {med_ra_vph} - Vulnerabilities per host" />
                                        <button onClick={() => removeHelpModalItem('medItems', i)} className="text-red-500 hover:text-red-700 px-2">Ã—</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('medItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2"><span className="inline-block px-2 py-1 rounded text-xs risk-low">LOW</span> Risk Items</label>
                                {(helpModal.lowItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('lowItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., VPH < {low_vph} - Low vulnerabilities" />
                                        <button onClick={() => removeHelpModalItem('lowItems', i)} className="text-red-500 hover:text-red-700 px-2">Ã—</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('lowItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Key Calculations</label>
                                {(helpModal.calcItems || []).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item} onChange={(e) => updateHelpModalItem('calcItems', i, e.target.value)} className="flex-1 p-2 border border-slate-300 rounded text-sm font-mono" placeholder="e.g., VPH = Vulnerabilities Per Host" />
                                        <button onClick={() => removeHelpModalItem('calcItems', i)} className="text-red-500 hover:text-red-700 px-2">Ã—</button>
                                    </div>
                                ))}
                                <button onClick={() => addHelpModalItem('calcItems')} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Item</button>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold mb-2">Scan Exempt Explanation</label>
                                <textarea value={helpModal.scanExempt || ''} onChange={(e) => updateHelpModal('scanExempt', e.target.value)} className="w-full p-2 border border-slate-300 rounded text-sm font-mono" rows={3} placeholder="Explain when Scan Exempt applies..." />
                            </div>
                        </div>

                        <button onClick={() => setSettings(p => ({...p, helpModalText: JSON.parse(JSON.stringify(defaultHelpModalText))}))} className="btn-secondary mt-4 text-sm">Reset Help Modal</button>
                    </div>

                    <div className="card p-4">
                        <h4 className="text-sm font-semibold text-slate-600 mb-2">Available Threshold Variables:</h4>
                        <div className="text-xs text-slate-500 font-mono flex flex-wrap gap-2">
                            {Object.keys(settings.thresholds).map(k => <span key={k} className="bg-slate-200 px-2 py-1 rounded">{`{${k}}`}</span>)}
                        </div>
                    </div>
                </div>
            )}

            {subTab === 'columns' && (
                <div className="space-y-6">
                    <div className="card p-4">
                        <h3 className="text-lg font-bold mb-2 text-slate-700">Excel/ODS Schema Configuration</h3>
                        <p className="text-sm text-slate-500 mb-4">Configure fields to extract from each file type. <strong>Header Text</strong> appears on preview and generated reports. <strong>Excel Column</strong> must match the column header in your source files. Drag to reorder columns, toggle visibility.</p>
                        {['vram', 'ess', 'tam'].map(type => (
                            <div key={type} className="mb-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className={`font-bold ${schemaTypeColors[type]}`}>{schemaTypeLabels[type]}</h4>
                                    <button onClick={() => setNewFieldModal({ type, field: '', label: '', column: '' })} className="text-xs text-cyan-600 hover:text-cyan-800">+ Add Field</button>
                                </div>
                                <div className="border border-slate-200 rounded">
                                    <div className="grid grid-cols-12 gap-2 p-2 bg-slate-100 text-xs font-semibold text-slate-600 border-b">
                                        <div className="col-span-1"></div>
                                        <div className="col-span-1">Show</div>
                                        <div className="col-span-3">Header Text (Report)</div>
                                        <div className="col-span-3">Field ID</div>
                                        <div className="col-span-3">Excel Column (Source)</div>
                                        <div className="col-span-1"></div>
                                    </div>
                                    {(schema[type] || []).map((item, idx) => (
                                        <div key={item.field + idx} className="grid grid-cols-12 gap-2 p-2 items-center border-b border-slate-100 hover:bg-slate-50"
                                            draggable onDragStart={(e) => e.dataTransfer.setData('schemaIdx', JSON.stringify({type, idx}))}
                                            onDragOver={(e) => e.preventDefault()}
                                            onDrop={(e) => { e.preventDefault(); const from = JSON.parse(e.dataTransfer.getData('schemaIdx')); if (from.type === type) reorderSchema(type, from.idx, idx); }}>
                                            <div className="col-span-1 cursor-move text-slate-400" title="Drag to reorder">&#9776;</div>
                                            <div className="col-span-1"><input type="checkbox" checked={item.visible !== false} onChange={(e) => updateSchemaField(type, idx, { visible: e.target.checked })} /></div>
                                            <div className="col-span-3"><input value={item.label} onChange={(e) => updateSchemaField(type, idx, { label: e.target.value })} className="w-full text-sm p-1" /></div>
                                            <div className="col-span-3"><input value={item.field} onChange={(e) => updateSchemaField(type, idx, { field: e.target.value })} className="w-full text-sm p-1 font-mono text-xs" /></div>
                                            <div className="col-span-3"><input value={item.column} onChange={(e) => updateSchemaField(type, idx, { column: e.target.value })} className="w-full text-sm p-1" placeholder="Excel column header" /></div>
                                            <div className="col-span-1"><button onClick={() => removeSchemaField(type, idx)} className="text-red-500 hover:text-red-700 text-sm" title="Remove field">âœ•</button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {newFieldModal && (
                <div className="modal-overlay" onClick={() => setNewFieldModal(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Add New Field to {schemaTypeLabels[newFieldModal.type]}</h3>
                        <div className="space-y-3">
                            <div><label className="block text-sm text-slate-500 mb-1">Field ID (camelCase)</label><input value={newFieldModal.field} onChange={(e) => setNewFieldModal({...newFieldModal, field: e.target.value})} className="w-full font-mono" placeholder="e.g. customField" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Display Label</label><input value={newFieldModal.label} onChange={(e) => setNewFieldModal({...newFieldModal, label: e.target.value})} className="w-full" placeholder="e.g. Custom Field Name" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Excel Column Header</label><input value={newFieldModal.column} onChange={(e) => setNewFieldModal({...newFieldModal, column: e.target.value})} className="w-full" placeholder="Exact column name in Excel" /></div>
                        </div>
                        <div className="flex gap-2 mt-6">
                            <button onClick={() => { if (newFieldModal.field && newFieldModal.column) { addSchemaField(newFieldModal.type, newFieldModal.field, newFieldModal.label || newFieldModal.field, newFieldModal.column); setNewFieldModal(null); } }} className="btn-primary">Add Field</button>
                            <button onClick={() => setNewFieldModal(null)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

            {editingBoat && (
                <div className="modal-overlay" onClick={() => setEditingBoat(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">{editingBoat.isNew ? 'Add Boat' : 'Edit Boat'}</h3>
                        <div className="space-y-4">
                            <div><label className="block text-sm text-slate-500 mb-1">Boat Name (e.g. SSN-21)</label><input value={editingBoat.boat_name} onChange={(e) => setEditingBoat({...editingBoat, boat_name: e.target.value})} className="w-full" disabled={!editingBoat.isNew} /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Full Name</label><input value={editingBoat.boat_full_name} onChange={(e) => setEditingBoat({...editingBoat, boat_full_name: e.target.value})} className="w-full" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">ISIC</label><select value={editingBoat.isic} onChange={(e) => setEditingBoat({...editingBoat, isic: e.target.value})} className="w-full">{settings.isics.map(i => <option key={i.isic_name} value={i.isic_name}>{i.isic_name}</option>)}</select></div>
                            <div className="flex items-center gap-2 mt-2 p-3 bg-blue-50 rounded border border-blue-200">
                                <input type="checkbox" id="nmci-checkbox" checked={editingBoat.nmci || false} onChange={(e) => setEditingBoat({...editingBoat, nmci: e.target.checked})} />
                                <label htmlFor="nmci-checkbox" className="text-sm font-medium text-blue-800">NMCI Network (NIPR)</label>
                                <span className="text-xs text-blue-600 ml-2">Check if this boat uses NMCI for their NIPR network to ignore their NIPR VRAM scores for risk calculation</span>
                            </div>
                        </div>
                        <div className="flex gap-2 mt-6"><button onClick={saveBoat} className="btn-primary">Save</button><button onClick={() => setEditingBoat(null)} className="btn-secondary">Cancel</button></div>
                    </div>
                </div>
            )}

            {editingISIC && (
                <div className="modal-overlay" onClick={() => setEditingISIC(null)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">{editingISIC.isNew ? 'Add ISIC' : 'Edit ISIC'}</h3>
                        <div className="space-y-4">
                            <div><label className="block text-sm text-slate-500 mb-1">ISIC Name (e.g. COMSUBRON 1)</label><input value={editingISIC.isic_name} onChange={(e) => setEditingISIC({...editingISIC, isic_name: e.target.value})} className="w-full" disabled={!editingISIC.isNew} /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">Short Name (e.g. CSS1)</label><input value={editingISIC.isic_short} onChange={(e) => setEditingISIC({...editingISIC, isic_short: e.target.value})} className="w-full" /></div>
                            <div><label className="block text-sm text-slate-500 mb-1">TYCOM</label><select value={editingISIC.tycom} onChange={(e) => setEditingISIC({...editingISIC, tycom: e.target.value})} className="w-full">{(settings.tycoms || ['CSL', 'CSP']).map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                        </div>
                        <div className="flex gap-2 mt-6"><button onClick={saveISIC} className="btn-primary">Save</button><button onClick={() => setEditingISIC(null)} className="btn-secondary">Cancel</button></div>
                    </div>
                </div>
            )}

            {showAuthorPrompt && (
                <div className="modal-overlay" onClick={() => setShowAuthorPrompt(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold mb-4 text-slate-700">Enter Your Name</h3>
                        <p className="text-sm text-slate-500 mb-4">Your name will be recorded with this settings version for tracking purposes.</p>
                        <input value={authorName} onChange={(e) => setAuthorName(e.target.value)} placeholder="Your name" className="w-full mb-4" autoFocus onKeyDown={(e) => e.key === 'Enter' && saveAuthorAndSettings()} />
                        <div className="flex gap-2">
                            <button onClick={saveAuthorAndSettings} className="btn-primary" disabled={!authorName.trim()}>Save Settings</button>
                            <button onClick={() => setShowAuthorPrompt(false)} className="btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            )}

        </div>
    );
};

// Name Prompt Modal
const NamePromptModal = ({ onSubmit, onCancel }) => {
    const [name, setName] = React.useState('');
    return (
        <div className="modal-overlay" onClick={onCancel}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-bold mb-4 text-slate-700">Enter Your Name</h3>
                <p className="text-sm text-slate-500 mb-4">This will be recorded in the report for attribution.</p>
                <input value={name} onChange={(e) => setName(e.target.value)} placeholder="Your name" className="w-full mb-4" autoFocus onKeyDown={(e) => e.key === 'Enter' && onSubmit(name)} />
                <div className="flex gap-2">
                    <button onClick={() => onSubmit(name)} className="btn-primary">Continue</button>
                    <button onClick={onCancel} className="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    );
};

// First Time Setup Modal
const FirstTimeSetupModal = ({ onImportSettings, onImportReport, onDismiss }) => {
    const [isDragging, setIsDragging] = React.useState(false);

    const handleDrop = async (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer?.files?.[0];
        if (file) {
            if (file.name.endsWith('.html')) {
                onImportReport(file);
            } else if (file.name.endsWith('.json')) {
                try {
                    const text = await file.text();
                    const settings = JSON.parse(text);
                    onImportSettings(settings);
                } catch (err) {
                    alert('Failed to parse settings file: ' + err.message);
                }
            } else {
                alert('Please drop a .html report file or a .json settings file');
            }
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '550px' }} onClick={(e) => e.stopPropagation()}>
                <h3 className="text-xl font-bold mb-2 text-slate-800">Welcome to Cyber Dashboard</h3>
                <p className="text-sm text-slate-600 mb-6">No settings configured yet. Import your settings to get started.</p>

                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <div className="flex items-start gap-3">
                        <span className="text-amber-500 text-lg">âš </span>
                        <div className="text-sm text-amber-800">
                            <strong>Important:</strong> Once imported, your settings are saved in this browser's local storage. They will persist until you clear your browser cache/data, use a different browser, or use incognito/private mode.
                        </div>
                    </div>
                </div>

                <div
                    className={`drag-zone p-8 text-center mb-4 ${isDragging ? 'drag-active' : ''}`}
                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                    onDragLeave={() => setIsDragging(false)}
                    onDrop={handleDrop}
                >
                    <div className="text-4xl mb-3">ðŸ“‚</div>
                    <p className="text-slate-600 font-medium mb-2">Drop a file here to import settings</p>
                    <p className="text-sm text-slate-500">
                        Drop a previously generated <strong>report.html</strong> (settings will be extracted and saved)<br/>
                        or drop a <strong>settings.json</strong> file (will be saved automatically)
                    </p>
                </div>

                <div className="flex items-center gap-3 mb-4">
                    <div className="flex-1 border-t border-slate-200"></div>
                    <span className="text-sm text-slate-400">or</span>
                    <div className="flex-1 border-t border-slate-200"></div>
                </div>

                <div className="flex gap-3 justify-center">
                    <button onClick={onImportSettings} className="btn-primary">
                        Import settings.json
                    </button>
                    <button onClick={onDismiss} className="btn-secondary">
                        Start Fresh
                    </button>
                </div>

                <p className="text-xs text-slate-400 mt-4 text-center">
                    Starting fresh? You can configure boats, ISICs, and thresholds in the Settings tab.
                </p>
            </div>
        </div>
    );
};

// Main App
function App() {
    const [settings, setSettings] = React.useState(() => SettingsManager.load());
    const [currentTab, setCurrentTab] = React.useState('import');
    const [importedFiles, setImportedFiles] = React.useState({ vramNipr: null, vramSipr: null, essNipr: null, essSipr: null, tam: null });
    const [reportData, setReportData] = React.useState(null);
    const [alerts, setAlerts] = React.useState([]);
    const [namePrompt, setNamePrompt] = React.useState(null);
    const [isUsingImportedSettings, setIsUsingImportedSettings] = React.useState(false);
    const [showFirstTimeSetup, setShowFirstTimeSetup] = React.useState(false);

    // Check if settings are blank on first load
    React.useEffect(() => {
        const isBlank = !settings.boats?.length && !settings.isics?.length && !Object.keys(settings.thresholds || {}).length;
        const hasStoredSettings = SettingsManager.hasSavedSettings();
        if (isBlank && !hasStoredSettings) {
            setShowFirstTimeSetup(true);
        }
    }, []);

    // Recalculate risk levels when thresholds change
    React.useEffect(() => {
        if (reportData && reportData.boats?.length > 0) {
            const updatedBoats = reportData.boats.map(b => {
                const { level, reasons } = calculateRisk(b, settings.thresholds);
                return { ...b, riskLevel: level, riskReasons: reasons };
            });
            // Only update if risk levels actually changed
            const hasChanges = updatedBoats.some((b, i) => b.riskLevel !== reportData.boats[i].riskLevel);
            if (hasChanges) {
                setReportData(prev => ({ ...prev, boats: updatedBoats }));
            }
        }
    }, [JSON.stringify(settings.thresholds)]);

    const handleReportImport = async (file, fromSetup = false) => {
        const result = await importReportHTML(file);
        if (result.error) { setAlerts([{ type: 'error', msg: result.error }]); }
        else {
            // Always ensure defaults to clean up obsolete keys and add missing ones
            const cleanedSettings = SettingsManager.ensureDefaults(result.settings);
            if (fromSetup) {
                // From first-time setup: save settings to localStorage permanently
                SettingsManager.save(cleanedSettings);
                setSettings(cleanedSettings);
                setShowFirstTimeSetup(false);
                setAlerts([{ type: 'info', msg: `âœ“ Settings saved! Extracted from report: ${cleanedSettings.boats?.length || 0} boats, ${cleanedSettings.isics?.length || 0} ISICs` }]);
            } else {
                // Normal import: use for session only
                setIsUsingImportedSettings(true);
                setSettings(cleanedSettings);
                setReportData(result.reportData);
                setCurrentTab('preview');
                setAlerts([{ type: 'info', msg: `Loaded report v${result.reportData.version} with ${result.reportData.boats.length} boats` }]);
                if (!result.valid) setAlerts(p => [...p, { type: 'warning', msg: 'Report hash invalid - data may have been modified' }]);
            }
        }
    };

    const handleFirstTimeImportSettings = async (settingsOrNull) => {
        if (settingsOrNull) {
            // Settings object passed directly from drag/drop
            const imported = SettingsManager.ensureDefaults(settingsOrNull);
            SettingsManager.save(imported);
            setSettings(imported);
            setShowFirstTimeSetup(false);
            setAlerts([{ type: 'info', msg: `âœ“ Settings saved! ${imported.boats?.length || 0} boats, ${imported.isics?.length || 0} ISICs configured` }]);
        } else {
            // Open file picker
            const result = await SettingsManager.importSettings();
            if (result.success) {
                SettingsManager.save(result.settings);
                setSettings(result.settings);
                setShowFirstTimeSetup(false);
                setAlerts([{ type: 'info', msg: `âœ“ Settings saved! ${result.settings.boats?.length || 0} boats, ${result.settings.isics?.length || 0} ISICs configured` }]);
            }
        }
    };

    const handleGlobalDrop = async (e) => {
        e.preventDefault();
        const file = e.dataTransfer?.files?.[0];
        if (!file) return;

        if (file.name.endsWith('.json')) {
            // JSON file: import settings only
            try {
                const text = await file.text();
                const settings = JSON.parse(text);
                const imported = SettingsManager.ensureDefaults(settings);
                SettingsManager.save(imported);
                setSettings(imported);
                setAlerts([{ type: 'info', msg: `âœ“ Settings saved! ${imported.boats?.length || 0} boats, ${imported.isics?.length || 0} ISICs configured` }]);
            } catch (err) {
                setAlerts([{ type: 'error', msg: 'Failed to parse settings file: ' + err.message }]);
            }
        } else if (file.name.endsWith('.html')) {
            // HTML report: extract and save settings only (discard report data)
            const result = await importReportHTML(file);
            if (result.error) {
                setAlerts([{ type: 'error', msg: result.error }]);
            } else {
                SettingsManager.save(result.settings);
                setSettings(result.settings);
                setAlerts([{ type: 'info', msg: `âœ“ Settings saved! Extracted from report: ${result.settings.boats?.length || 0} boats, ${result.settings.isics?.length || 0} ISICs` }]);
            }
        }
    };

    const requestName = (callback) => {
        setNamePrompt({ callback });
    };

    const handleNameSubmit = (name) => {
        if (namePrompt?.callback) namePrompt.callback(name);
        setNamePrompt(null);
    };

    return (
        <div className="min-h-screen" onDragOver={(e) => e.preventDefault()} onDrop={handleGlobalDrop}>
            <header className="bg-white border-b border-slate-200 px-6 py-4">
                <div className="flex justify-between items-center max-w-[95vw] mx-auto">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-lg flex items-center justify-center font-bold bg-gradient-to-br from-cyan-500 to-cyan-600 text-white">CD</div>
                        <div><h1 className="text-xl font-bold text-slate-800">SUBFOR Cyber Risk Dashboard</h1><p className="text-xs text-slate-500">Compliments of COMSUBLANT</p></div>
                    </div>
                </div>
            </header>

            {alerts.length > 0 && <div className="max-w-[95vw] mx-auto px-6 pt-4">{alerts.map((a, i) => <div key={i} className={`p-3 rounded mb-2 flex justify-between items-center ${a.type === 'error' ? 'bg-red-100 text-red-700' : a.type === 'warning' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}><span>{a.msg}</span><button onClick={() => setAlerts(alerts.filter((_, j) => j !== i))} className="text-current opacity-50 hover:opacity-100">Ã—</button></div>)}</div>}

            <nav className="border-b border-slate-200 px-6 bg-white"><div className="flex gap-1 max-w-[95vw] mx-auto">{['import', 'preview', 'settings'].map(tab => <button key={tab} onClick={() => setCurrentTab(tab)} className={`tab-btn ${currentTab === tab ? 'active' : ''}`}>{tab.charAt(0).toUpperCase() + tab.slice(1)}</button>)}</div></nav>

            <main className="max-w-[95vw] mx-auto p-6">
                {currentTab === 'import' && <ImportTab importedFiles={importedFiles} setImportedFiles={setImportedFiles} settings={settings} setSettings={setSettings} reportData={reportData} onProcess={(d) => { setReportData(d); setCurrentTab('preview'); }} onAlert={(a) => setAlerts(p => [...p, a])} onReportImport={handleReportImport} />}
                {currentTab === 'preview' && <PreviewTab reportData={reportData} setReportData={setReportData} settings={settings} setSettings={setSettings} onRequestName={requestName} />}
                {currentTab === 'settings' && <SettingsTab settings={settings} setSettings={setSettings} onAlert={(a) => setAlerts(p => [...p, a])} isUsingImportedSettings={isUsingImportedSettings} onSaveToMySettings={() => setIsUsingImportedSettings(false)} />}
            </main>

            <footer className="text-center py-6 text-slate-400 text-sm">SUBFOR Cyber Risk Dashboard v1.0</footer>

            {namePrompt && <NamePromptModal onSubmit={handleNameSubmit} onCancel={() => setNamePrompt(null)} />}

            {showFirstTimeSetup && (
                <FirstTimeSetupModal
                    onImportSettings={handleFirstTimeImportSettings}
                    onImportReport={(file) => handleReportImport(file, true)}
                    onDismiss={() => setShowFirstTimeSetup(false)}
                />
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
